import { Modal } from '@/components/ui/Modal'

interface HelpGuideProps {
  open: boolean
  onClose: () => void
}

export function HelpGuide({ open, onClose }: HelpGuideProps) {
  return (
    <Modal open={open} onClose={onClose} title="Как пользоваться калькулятором" wide>
      <div className="space-y-6 text-sm text-gray-700 leading-relaxed">
        <Section title="Общая идея">
          <p>
            Калькулятор помогает методисту составить обоснованную смету на разработку образовательных
            продуктов. Вы проходите 4 шага: описываете контекст проекта, добавляете состав работ,
            настраиваете ценообразование и получаете готовую смету для клиента.
          </p>
          <p>
            Итоговая стоимость рассчитывается автоматически и учитывает все параметры: трудоёмкость,
            контекстный коэффициент, ставку, правки, скидки и налоги.
          </p>
        </Section>

        <Section title="Шаг 1. Что за проект?" badge="Контекстный коэффициент">
          <p>
            Выберите параметры, описывающие проект: тип проекта, знакомство с темой, методику работы,
            тип клиента и сроки. Каждый параметр задаёт множитель, а их произведение даёт{' '}
            <strong>контекстный коэффициент</strong> — он увеличивает трудозатраты по всем позициям.
          </p>
          <Tip>
            Если стандартные варианты не подходят — выберите «Другое» и задайте название и множитель
            вручную.
          </Tip>
        </Section>

        <Section title="Шаг 2. Что делаем?" badge="Состав работ">
          <p>
            Добавляйте элементы сметы — отдельные работы с названием, количеством и трудоёмкостью
            (часов на единицу). Элементы можно группировать в контейнеры для удобства.
          </p>
          <ul className="list-disc pl-5 space-y-1">
            <li>
              <strong>Вручную:</strong> введите название и нажмите «+ Добавить». Затем задайте количество
              и часы на единицу.
            </li>
            <li>
              <strong>Из библиотеки:</strong> нажмите «Из библиотеки» и выберите готовые элементы
              с предустановленными параметрами.
            </li>
            <li>
              <strong>Группы:</strong> «+ Добавить группу» создаёт контейнер. Перетаскивайте элементы
              внутрь для визуальной группировки.
            </li>
          </ul>
          <Tip>
            Кликните на строку элемента, чтобы раскрыть настройки: роль исполнителя, уровень качества,
            модель ценообразования, диапазон трудоёмкости (PERT) и уровень уверенности в оценке.
          </Tip>
        </Section>

        <Section title="Шаг 3. Сколько стоит?" badge="Ценообразование">
          <p>Здесь задаётся всё, что влияет на финальную цену:</p>
          <ul className="list-disc pl-5 space-y-1">
            <li>
              <strong>Ставка (₽/час):</strong> можно задать напрямую или рассчитать через «Помощник
              ставки» на основе зарплаты и типа проекта.
            </li>
            <li>
              <strong>Детализация:</strong> таблица всех позиций со стоимостью. Можно вручную
              скорректировать стоимость любой строки (иконка ручки).
            </li>
            <li>
              <strong>Правки и доработки:</strong> процент от стоимости, закладываемый на итерации
              с клиентом.
            </li>
            <li>
              <strong>Целевая цена:</strong> справочный индикатор — показывает, укладывается ли
              смета в бюджет клиента. На расчёт не влияет.
            </li>
            <li>
              <strong>Бюджет времени:</strong> справочный индикатор — проверяет, укладываются ли
              часы в ресурсный бюджет. Задайте диапазон периода (мин–макс месяцев)
              и нагрузки (мин–макс часов/неделю). Левое поле — минимум, правое — максимум.
              На итоговую стоимость не влияет.
            </li>
          </ul>
          <p>
            В разделе «Финансовые настройки» можно включить налог и объёмные скидки.
          </p>
        </Section>

        <Section title="Шаг 4. Смета для клиента" badge="Экспорт">
          <p>
            Настройте, что показывать клиенту: часы, цену за единицу, количество, единицы измерения,
            структуру групп, налог и скидку. Добавьте блок «Условия» и подпись.
          </p>
          <p>
            Экспортируйте смету в формате текста, JSON или PDF. Нажмите на название позиции
            в предпросмотре, чтобы переименовать её для клиента (не меняя внутреннее название).
          </p>
        </Section>

        <Section title="Боковая панель (Sidebar)">
          <p>
            На десктопе справа отображается сводка: итоговая стоимость, трудозатраты, ставка,
            контекстный коэффициент и разбивка по категориям. На мобильном — нажмите на нижнюю
            панель «Смета ▸» для просмотра.
          </p>
        </Section>

        <Section title="Библиотека и версии">
          <ul className="list-disc pl-5 space-y-1">
            <li>
              <strong>Библиотека</strong> — набор шаблонных элементов, которые можно быстро добавлять
              в смету. Управляется через кнопку «Библиотека» в шапке.
            </li>
            <li>
              <strong>Версии</strong> — снимки состояния проекта. Сохраняйте промежуточные версии
              и возвращайтесь к ним. Управляется через кнопку «Версии» в шапке.
            </li>
          </ul>
        </Section>

        <Section title="Полезные детали">
          <ul className="list-disc pl-5 space-y-1">
            <li>
              Все данные хранятся локально в браузере — ничего не отправляется на сервер.
            </li>
            <li>
              Значения, изменённые вручную, отмечаются жёлтым индикатором (⚡). Сбросить
              ручное значение можно через настройки элемента.
            </li>
            <li>
              Контекстный коэффициент можно зафиксировать вручную — в этом случае изменение
              параметров проекта не будет пересчитывать его автоматически.
            </li>
            <li>
              Диапазон трудоёмкости (min/max) рассчитывается по формуле PERT и применяется
              только если часы на единицу не заданы вручную.
            </li>
          </ul>
        </Section>
      </div>
    </Modal>
  )
}

function Section({
  title,
  badge,
  children,
}: {
  title: string
  badge?: string
  children: React.ReactNode
}) {
  return (
    <div>
      <div className="flex items-center gap-2 mb-2">
        <h3 className="text-base font-semibold text-gray-900">{title}</h3>
        {badge && (
          <span className="text-xs px-2 py-0.5 rounded-full bg-primary-100 text-primary-600 font-medium">
            {badge}
          </span>
        )}
      </div>
      <div className="space-y-2">{children}</div>
    </div>
  )
}

function Tip({ children }: { children: React.ReactNode }) {
  return (
    <div className="text-xs bg-primary-50 text-primary-700 px-3 py-2 rounded-lg">
      <strong>Совет:</strong> {children}
    </div>
  )
}
