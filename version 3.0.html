<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö —É—Å–ª—É–≥ 2.0</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* Error notifications */
        .error-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: translateX(450px);
            transition: transform 0.3s ease;
        }

        .error-notification.show {
            transform: translateX(0);
        }

        .error-notification.error {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #dc2626;
        }

        .error-notification.warning {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            color: #d97706;
        }

        .error-notification.success {
            background: #ecfdf5;
            border: 1px solid #10b981;
            color: #047857;
        }

        .error-notification.info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            color: #0369a1;
        }

        .notification-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: inherit;
            opacity: 0.7;
        }

        .notification-close:hover {
            opacity: 1;
        }

        .notification-message {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* Development panel */
        .dev-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #1f2937;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1500;
        }

        .dev-panel h4 {
            margin-bottom: 8px;
            color: #10b981;
        }

        .dev-panel div {
            margin-bottom: 4px;
        }

        .dev-panel .state-item {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .dev-panel .state-key {
            color: #fbbf24;
        }

        .dev-panel .state-value {
            color: #60a5fa;
        }

        /* Temporary content */
        .content {
            padding: 40px;
            text-align: center;
            color: #6b7280;
        }

        .content h2 {
            margin-bottom: 20px;
            color: #1f2937;
        }

        .test-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 30px;
        }

        .test-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .test-button.primary {
            background: #4f46e5;
            color: white;
        }

        .test-button.secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .test-button.danger {
            background: #ef4444;
            color: white;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö —É—Å–ª—É–≥ 2.0</h1>
            <p>–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫</p>
        </div>
        
        <div class="content">
            <h2>Core Infrastructure Ready</h2>
            <p>StateManager, EventBus –∏ ErrorHandler –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã</p>
            
            <div class="test-buttons">
                <button class="test-button primary" onclick="testStateManager()">
                    –¢–µ—Å—Ç StateManager
                </button>
                <button class="test-button secondary" onclick="testEventBus()">
                    –¢–µ—Å—Ç EventBus
                </button>
                <button class="test-button danger" onclick="testErrorHandler()">
                    –¢–µ—Å—Ç ErrorHandler
                </button>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <!-- Dev panel -->
    <div class="dev-panel" id="devPanel">
        <h4>State Monitor</h4>
        <div id="stateDisplay"></div>
    </div>

    <script>
        /**
         * State Manager - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
         * –†–µ–∞–ª–∏–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω Redux/Flux —Å immutable state
         */
        class StateManager {
            constructor() {
                this.state = this.getInitialState();
                this.listeners = new Set();
                this.middleware = [];
                this.history = [];
                this.maxHistorySize = 50;
                
                console.log('üèóÔ∏è StateManager initialized');
            }

            getInitialState() {
                return {
                    // Pricing settings
                    pricing: {
                        method: 'hourly', // 'hourly' | 'fixed'
                        hourlyRate: 220,
                        detailLevel: 'quick' // 'quick' | 'detailed'
                    },

                    // Complexity factors
                    complexity: {
                        // Quick mode
                        projectComplexity: 1.3,
                        
                        // Detailed mode
                        methodistRole: 1.0,
                        domainKnowledge: 1.0,
                        projectType: 1.0,
                        contentComplexity: 1.2,
                        urgency: 1.0,
                        qualityLevel: 1.0
                    },

                    // Financial settings
                    financial: {
                        discountRate: 0,
                        taxRate: 13,
                        enableVolumeDiscounts: true,
                        showTaxSeparately: true,
                        clientType: 20
                    },

                    // Presets
                    presets: {
                        textLesson: { count: 0, duration: 30 },
                        videoLesson: { count: 0, duration: 60 },
                        webinar: { count: 0, duration: 90 },
                        workshop: { count: 0, duration: 60 },
                        caseStudy: { count: 0, duration: 45 },
                        masterClass: { count: 0, duration: 60 }
                    },

                    // Components
                    components: {},

                    // Services
                    services: {},

                    // Custom services
                    customServices: [],

                    // Results
                    results: {
                        totalCost: 0,
                        totalHours: 0,
                        breakdown: {},
                        composition: []
                    },

                    // UI state
                    ui: {
                        loading: false,
                        errors: [],
                        notifications: [],
                        activeTab: 'presets'
                    },

                    // Meta
                    meta: {
                        version: '2.0.0',
                        lastUpdated: Date.now(),
                        calculationId: this.generateId()
                    }
                };
            }

            /**
             * –î–æ–±–∞–≤–ª—è–µ—Ç middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ actions
             */
            use(middlewareFn) {
                this.middleware.push(middlewareFn);
                return this;
            }

            /**
             * Dispatch action –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
             */
            dispatch(action) {
                try {
                    console.log('üì¶ Dispatching action:', action.type, action.payload);

                    // –ü—Ä–∏–º–µ–Ω—è–µ–º middleware
                    let processedAction = action;
                    for (const middleware of this.middleware) {
                        processedAction = middleware(processedAction, this.state) || processedAction;
                    }

                    const prevState = this.state;
                    this.state = this.reducer(this.state, processedAction);

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                    this.addToHistory(processedAction, prevState);

                    // –û–±–Ω–æ–≤–ª—è–µ–º meta
                    this.state = {
                        ...this.state,
                        meta: {
                            ...this.state.meta,
                            lastUpdated: Date.now()
                        }
                    };

                    // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
                    this.notifyListeners(processedAction);

                    EventBus.emit('state:changed', {
                        action: processedAction,
                        prevState,
                        newState: this.state
                    });

                } catch (error) {
                    ErrorHandler.handleError(error, {
                        context: 'StateManager.dispatch',
                        action: action
                    });
                }
            }

            /**
             * Reducer –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ actions
             */
            reducer(state, action) {
                switch (action.type) {
                    case 'PRICING_UPDATE':
                        return {
                            ...state,
                            pricing: { ...state.pricing, ...action.payload }
                        };

                    case 'COMPLEXITY_UPDATE':
                        return {
                            ...state,
                            complexity: { ...state.complexity, ...action.payload }
                        };

                    case 'FINANCIAL_UPDATE':
                        return {
                            ...state,
                            financial: { ...state.financial, ...action.payload }
                        };

                    case 'PRESET_UPDATE':
                        return {
                            ...state,
                            presets: {
                                ...state.presets,
                                [action.payload.presetType]: {
                                    ...state.presets[action.payload.presetType],
                                    ...action.payload.data
                                }
                            }
                        };

                    case 'COMPONENT_TOGGLE':
                        const { componentId, enabled, config } = action.payload;
                        return {
                            ...state,
                            components: enabled 
                                ? { ...state.components, [componentId]: config || {} }
                                : Object.fromEntries(
                                    Object.entries(state.components).filter(([id]) => id !== componentId)
                                )
                        };

                    case 'SERVICE_TOGGLE':
                        const { serviceId, enabled: serviceEnabled, config: serviceConfig } = action.payload;
                        return {
                            ...state,
                            services: serviceEnabled 
                                ? { ...state.services, [serviceId]: serviceConfig || {} }
                                : Object.fromEntries(
                                    Object.entries(state.services).filter(([id]) => id !== serviceId)
                                )
                        };

                    case 'CUSTOM_SERVICE_ADD':
                        return {
                            ...state,
                            customServices: [...state.customServices, action.payload]
                        };

                    case 'CUSTOM_SERVICE_REMOVE':
                        return {
                            ...state,
                            customServices: state.customServices.filter(s => s.id !== action.payload.id)
                        };

                    case 'RESULTS_UPDATE':
                        return {
                            ...state,
                            results: { ...state.results, ...action.payload }
                        };

                    case 'UI_UPDATE':
                        return {
                            ...state,
                            ui: { ...state.ui, ...action.payload }
                        };

                    case 'STATE_RESET':
                        return this.getInitialState();

                    case 'STATE_LOAD':
                        return { ...action.payload, meta: { ...state.meta, lastUpdated: Date.now() } };

                    default:
                        console.warn('Unknown action type:', action.type);
                        return state;
                }
            }

            /**
             * –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
             */
            subscribe(listener) {
                this.listeners.add(listener);
                return () => this.listeners.delete(listener);
            }

            /**
             * –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
             */
            getState() {
                return { ...this.state }; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–ø–∏—é –¥–ª—è immutability
            }

            /**
             * –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
             */
            notifyListeners(action) {
                this.listeners.forEach(listener => {
                    try {
                        listener(this.state, action);
                    } catch (error) {
                        ErrorHandler.handleError(error, {
                            context: 'StateManager.notifyListeners',
                            listener: listener.name
                        });
                    }
                });
            }

            /**
             * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è undo/redo
             */
            addToHistory(action, prevState) {
                this.history.push({
                    action,
                    state: prevState,
                    timestamp: Date.now()
                });

                if (this.history.length > this.maxHistorySize) {
                    this.history.shift();
                }
            }

            /**
             * Undo –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
             */
            undo() {
                if (this.history.length === 0) return;

                const lastEntry = this.history.pop();
                this.state = lastEntry.state;
                this.notifyListeners({ type: 'UNDO', payload: lastEntry.action });

                EventBus.emit('state:undo', lastEntry);
            }

            /**
             * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID
             */
            generateId() {
                return Math.random().toString(36).substr(2, 9);
            }

            /**
             * –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
             */
            validateState(state = this.state) {
                const errors = [];

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ pricing
                if (!state.pricing || typeof state.pricing.hourlyRate !== 'number' || state.pricing.hourlyRate <= 0) {
                    errors.push('Invalid hourly rate');
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ complexity
                if (!state.complexity) {
                    errors.push('Missing complexity settings');
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ financial
                if (!state.financial) {
                    errors.push('Missing financial settings');
                }

                return {
                    isValid: errors.length === 0,
                    errors
                };
            }
        }

        /**
         * Event Bus - –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Å–≤—è–∑–∏ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏
         */
        class EventBusClass {
            constructor() {
                this.listeners = new Map();
                this.onceListeners = new Map();
                this.globalListeners = new Set();
                
                console.log('üì° EventBus initialized');
            }

            /**
             * –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ
             */
            on(event, callback, context = null) {
                if (!this.listeners.has(event)) {
                    this.listeners.set(event, new Set());
                }

                const wrappedCallback = context ? callback.bind(context) : callback;
                this.listeners.get(event).add(wrappedCallback);

                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø–∏—Å–∫–∏
                return () => this.off(event, wrappedCallback);
            }

            /**
             * –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ
             */
            once(event, callback, context = null) {
                const wrappedCallback = (...args) => {
                    this.off(event, wrappedCallback);
                    const fn = context ? callback.bind(context) : callback;
                    return fn(...args);
                };

                return this.on(event, wrappedCallback);
            }

            /**
             * –û—Ç–ø–∏—Å–∫–∞ –æ—Ç —Å–æ–±—ã—Ç–∏—è
             */
            off(event, callback) {
                if (this.listeners.has(event)) {
                    this.listeners.get(event).delete(callback);
                    
                    if (this.listeners.get(event).size === 0) {
                        this.listeners.delete(event);
                    }
                }
            }

            /**
             * –ò—Å–ø—É—Å–∫–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
             */
            emit(event, data = null) {
                try {
                    console.log(`üì° Emitting event: ${event}`, data);

                    // –£–≤–µ–¥–æ–º–ª—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
                    if (this.listeners.has(event)) {
                        this.listeners.get(event).forEach(callback => {
                            try {
                                callback(data, event);
                            } catch (error) {
                                ErrorHandler.handleError(error, {
                                    context: 'EventBus.emit',
                                    event,
                                    callback: callback.name
                                });
                            }
                        });
                    }

                    // –£–≤–µ–¥–æ–º–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
                    this.globalListeners.forEach(callback => {
                        try {
                            callback(event, data);
                        } catch (error) {
                            ErrorHandler.handleError(error, {
                                context: 'EventBus.emit.global',
                                event,
                                callback: callback.name
                            });
                        }
                    });

                } catch (error) {
                    ErrorHandler.handleError(error, {
                        context: 'EventBus.emit',
                        event
                    });
                }
            }

            /**
             * –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
             */
            onAll(callback) {
                this.globalListeners.add(callback);
                return () => this.globalListeners.delete(callback);
            }

            /**
             * –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫
             */
            clear() {
                this.listeners.clear();
                this.onceListeners.clear();
                this.globalListeners.clear();
            }

            /**
             * –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–ø–∏—Å–∫–∞—Ö
             */
            getStats() {
                return {
                    events: Array.from(this.listeners.keys()),
                    totalListeners: Array.from(this.listeners.values())
                        .reduce((sum, set) => sum + set.size, 0),
                    globalListeners: this.globalListeners.size
                };
            }
        }

        /**
         * Error Handler - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
         */
        class ErrorHandlerClass {
            constructor() {
                this.errors = [];
                this.maxErrors = 100;
                this.notificationContainer = null;
                this.currentNotifications = new Map();
                
                this.init();
                console.log('üö® ErrorHandler initialized');
            }

            init() {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
                window.addEventListener('error', (event) => {
                    this.handleError(event.error, {
                        context: 'Global error',
                        filename: event.filename,
                        lineno: event.lineno,
                        colno: event.colno
                    });
                });

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –ø—Ä–æ–º–∏—Å–æ–≤
                window.addEventListener('unhandledrejection', (event) => {
                    this.handleError(event.reason, {
                        context: 'Unhandled promise rejection'
                    });
                });

                // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                this.createNotificationContainer();
            }

            /**
             * –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
             */
            handleError(error, context = {}) {
                const errorInfo = {
                    id: this.generateId(),
                    message: error?.message || String(error),
                    stack: error?.stack,
                    context,
                    timestamp: Date.now(),
                    severity: this.determineSeverity(error, context)
                };

                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ª–æ–≥
                this.addError(errorInfo);

                // –õ–æ–≥–∏—Ä—É–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å
                console.error('üí• Error handled:', errorInfo);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                this.showNotification(errorInfo);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ
                EventBus.emit('error:occurred', errorInfo);

                return errorInfo;
            }

            /**
             * –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
             */
            showNotification(errorInfo) {
                const notification = this.createNotificationElement(errorInfo);
                this.notificationContainer.appendChild(notification);
                this.currentNotifications.set(errorInfo.id, notification);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                setTimeout(() => notification.classList.add('show'), 10);

                // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ –¥–ª—è –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫
                if (errorInfo.severity !== 'critical') {
                    setTimeout(() => {
                        this.hideNotification(errorInfo.id);
                    }, 5000);
                }
            }

            /**
             * –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
             */
            createNotificationElement(errorInfo) {
                const notification = document.createElement('div');
                notification.className = `error-notification ${this.getNotificationClass(errorInfo.severity)}`;
                
                const icon = this.getNotificationIcon(errorInfo.severity);
                const title = this.getNotificationTitle(errorInfo.severity);
                
                notification.innerHTML = `
                    <div class="notification-header">
                        <div class="notification-title">
                            ${icon} ${title}
                        </div>
                        <button class="notification-close" onclick="ErrorHandler.hideNotification('${errorInfo.id}')">&times;</button>
                    </div>
                    <div class="notification-message">${this.formatErrorMessage(errorInfo)}</div>
                `;

                return notification;
            }

            /**
             * –°–∫—Ä—ã—Ç–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
             */
            hideNotification(errorId) {
                const notification = this.currentNotifications.get(errorId);
                if (notification) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                        this.currentNotifications.delete(errorId);
                    }, 300);
                }
            }

            /**
             * –ü–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
             */
            showInfo(message, title = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è') {
                this.showCustomNotification({
                    severity: 'info',
                    message,
                    title
                });
            }

            /**
             * –ü–æ–∫–∞–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
             */
            showWarning(message, title = '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ') {
                this.showCustomNotification({
                    severity: 'warning',
                    message,
                    title
                });
            }

            /**
             * –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ
             */
            showSuccess(message, title = '–£—Å–ø–µ—à–Ω–æ') {
                this.showCustomNotification({
                    severity: 'success',
                    message,
                    title
                });
            }

            /**
             * –ü–æ–∫–∞–∑ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
             */
            showCustomNotification({ severity, message, title, duration = 5000 }) {
                const notification = {
                    id: this.generateId(),
                    message,
                    title,
                    severity,
                    timestamp: Date.now()
                };

                const element = this.createCustomNotificationElement(notification, title);
                this.notificationContainer.appendChild(element);
                this.currentNotifications.set(notification.id, element);

                setTimeout(() => element.classList.add('show'), 10);

                if (duration > 0) {
                    setTimeout(() => {
                        this.hideNotification(notification.id);
                    }, duration);
                }
            }

            /**
             * –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
             */
            createCustomNotificationElement(notification, customTitle) {
                const element = document.createElement('div');
                element.className = `error-notification ${this.getNotificationClass(notification.severity)}`;
                
                const icon = this.getNotificationIcon(notification.severity);
                
                element.innerHTML = `
                    <div class="notification-header">
                        <div class="notification-title">
                            ${icon} ${customTitle}
                        </div>
                        <button class="notification-close" onclick="ErrorHandler.hideNotification('${notification.id}')">&times;</button>
                    </div>
                    <div class="notification-message">${notification.message}</div>
                `;

                return element;
            }

            /**
             * –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
             */
            createNotificationContainer() {
                this.notificationContainer = document.createElement('div');
                this.notificationContainer.id = 'notificationContainer';
                this.notificationContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 1000;
                    pointer-events: none;
                `;
                document.body.appendChild(this.notificationContainer);

                // –í–∫–ª—é—á–∞–µ–º pointer-events –¥–ª—è –¥–æ—á–µ—Ä–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                const style = document.createElement('style');
                style.textContent = `
                    #notificationContainer > * {
                        pointer-events: auto;
                        margin-bottom: 10px;
                    }
                `;
                document.head.appendChild(style);
            }

            /**
             * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥
             */
            addError(errorInfo) {
                this.errors.unshift(errorInfo);
                
                if (this.errors.length > this.maxErrors) {
                    this.errors = this.errors.slice(0, this.maxErrors);
                }
            }

            /**
             * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ –æ—à–∏–±–∫–∏
             */
            determineSeverity(error, context) {
                // –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
                if (error?.name === 'TypeError' || 
                    error?.name === 'ReferenceError' ||
                    context.context?.includes('StateManager')) {
                    return 'critical';
                }

                // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
                if (context.context?.includes('validation') ||
                    context.context?.includes('input')) {
                    return 'warning';
                }

                return 'error';
            }

            /**
             * –ü–æ–ª—É—á–µ–Ω–∏–µ CSS –∫–ª–∞—Å—Å–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
             */
            getNotificationClass(severity) {
                const classes = {
                    critical: 'error',
                    error: 'error',
                    warning: 'warning',
                    info: 'info',
                    success: 'success'
                };
                return classes[severity] || 'error';
            }

            /**
             * –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
             */
            getNotificationIcon(severity) {
                const icons = {
                    critical: 'üö®',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è',
                    success: '‚úÖ'
                };
                return icons[severity] || '‚ùå';
            }

            /**
             * –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
             */
            getNotificationTitle(severity) {
                const titles = {
                    critical: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞',
                    error: '–û—à–∏–±–∫–∞',
                    warning: '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ',
                    info: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
                    success: '–£—Å–ø–µ—à–Ω–æ'
                };
                return titles[severity] || '–û—à–∏–±–∫–∞';
            }

            /**
             * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
             */
            formatErrorMessage(errorInfo) {
                let message = errorInfo.message;

                // –î–µ–ª–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (message.includes('Cannot read property')) {
                    message = '–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.';
                }
                
                if (message.includes('fetch')) {
                    message = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.';
                }

                if (errorInfo.context.context) {
                    message += ` (${errorInfo.context.context})`;
                }

                return message;
            }

            /**
             * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID
             */
            generateId() {
                return Math.random().toString(36).substr(2, 9);
            }

            /**
             * –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫
             */
            getErrors() {
                return [...this.errors];
            }

            /**
             * –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–∞ –æ—à–∏–±–æ–∫
             */
            clearErrors() {
                this.errors = [];
                EventBus.emit('errors:cleared');
            }

            /**
             * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—à–∏–±–æ–∫
             */
            getStats() {
                const now = Date.now();
                const oneHour = 60 * 60 * 1000;
                const oneDay = 24 * oneHour;

                return {
                    total: this.errors.length,
                    lastHour: this.errors.filter(e => now - e.timestamp < oneHour).length,
                    lastDay: this.errors.filter(e => now - e.timestamp < oneDay).length,
                    bySeverity: this.errors.reduce((acc, error) => {
                        acc[error.severity] = (acc[error.severity] || 0) + 1;
                        return acc;
                    }, {})
                };
            }
        }

        /**
         * Utilities - –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
         */
        class Utils {
            static formatNumber(number, decimals = 0) {
                if (typeof number !== 'number' || isNaN(number)) {
                    return '0';
                }
                return number.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            }

            static formatCurrency(amount, currency = '‚ÇΩ') {
                return `${this.formatNumber(amount)} ${currency}`;
            }

            static debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            static throttle(func, limit) {
                let lastFunc;
                let lastRan;
                return function(...args) {
                    if (!lastRan) {
                        func.apply(this, args);
                        lastRan = Date.now();
                    } else {
                        clearTimeout(lastFunc);
                        lastFunc = setTimeout(() => {
                            if ((Date.now() - lastRan) >= limit) {
                                func.apply(this, args);
                                lastRan = Date.now();
                            }
                        }, limit - (Date.now() - lastRan));
                    }
                }
            }

            static deepClone(obj) {
                if (obj === null || typeof obj !== 'object') return obj;
                if (obj instanceof Date) return new Date(obj.getTime());
                if (obj instanceof Array) return obj.map(item => this.deepClone(item));
                if (typeof obj === 'object') {
                    const clonedObj = {};
                    for (let key in obj) {
                        if (obj.hasOwnProperty(key)) {
                            clonedObj[key] = this.deepClone(obj[key]);
                        }
                    }
                    return clonedObj;
                }
            }

            static validateNumber(value, min = 0, max = Infinity) {
                const num = parseFloat(value);
                if (isNaN(num)) return { valid: false, error: '–ù–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º' };
                if (num < min) return { valid: false, error: `–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${min}` };
                if (num > max) return { valid: false, error: `–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${max}` };
                return { valid: true, value: num };
            }

            static getElementById(id) {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`Element with id "${id}" not found`);
                }
                return element;
            }

            static safeGetValue(elementOrId, defaultValue = 0) {
                try {
                    const element = typeof elementOrId === 'string' 
                        ? this.getElementById(elementOrId) 
                        : elementOrId;
                    
                    if (!element) return defaultValue;
                    
                    const value = parseFloat(element.value);
                    return isNaN(value) ? defaultValue : value;
                } catch (error) {
                    ErrorHandler.handleError(error, { context: 'Utils.safeGetValue', elementOrId });
                    return defaultValue;
                }
            }
        }

        /**
         * Loading Manager - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –∑–∞–≥—Ä—É–∑–∫–∏
         */
        class LoadingManager {
            constructor() {
                this.loadingStates = new Map();
                this.overlay = null;
                this.init();
            }

            init() {
                this.overlay = document.getElementById('loadingOverlay');
                if (!this.overlay) {
                    console.warn('Loading overlay not found');
                }
            }

            show(message = '–ó–∞–≥—Ä—É–∑–∫–∞...', id = 'default') {
                this.loadingStates.set(id, { message, startTime: Date.now() });
                this.updateOverlay();
                EventBus.emit('loading:start', { id, message });
            }

            hide(id = 'default') {
                if (this.loadingStates.has(id)) {
                    const state = this.loadingStates.get(id);
                    const duration = Date.now() - state.startTime;
                    this.loadingStates.delete(id);
                    this.updateOverlay();
                    EventBus.emit('loading:end', { id, duration });
                }
            }

            updateOverlay() {
                if (!this.overlay) return;

                const hasActiveLoading = this.loadingStates.size > 0;
                
                if (hasActiveLoading) {
                    const currentState = Array.from(this.loadingStates.values())[0];
                    const textElement = document.getElementById('loadingText');
                    if (textElement) {
                        textElement.textContent = currentState.message;
                    }
                    this.overlay.classList.add('show');
                } else {
                    this.overlay.classList.remove('show');
                }
            }

            isLoading(id = 'default') {
                return this.loadingStates.has(id);
            }

            getActiveLoadings() {
                return Array.from(this.loadingStates.keys());
            }
        }

        // –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã
        const StateManager = new StateManager();
        const EventBus = new EventBusClass();
        const ErrorHandler = new ErrorHandlerClass();
        const LoadingManager = new LoadingManager();

        // Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        StateManager.use((action, state) => {
            console.log('üîÑ State change:', action.type, 'Current state size:', JSON.stringify(state).length);
            return action;
        });

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
        StateManager.subscribe((state, action) => {
            updateDevPanel(state);
        });

        // Event listeners –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        EventBus.onAll((event, data) => {
            if (!event.startsWith('state:')) {
                console.log(`üì° Event: ${event}`, data);
            }
        });

        /**
         * Development Panel - –ü–∞–Ω–µ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
         */
        function updateDevPanel(state) {
            const panel = document.getElementById('devPanel');
            const display = document.getElementById('stateDisplay');
            
            if (!panel || !display) return;

            const importantFields = {
                '–ú–µ—Ç–æ–¥': state.pricing?.method,
                '–°—Ç–∞–≤–∫–∞': state.pricing?.hourlyRate,
                '–°–ª–æ–∂–Ω–æ—Å—Ç—å': state.complexity?.projectComplexity,
                '–°–∫–∏–¥–∫–∞': state.financial?.discountRate,
                '–ò—Ç–æ–≥–æ': state.results?.totalCost,
                '–û—à–∏–±–∫–∏': ErrorHandler.getErrors().length
            };

            display.innerHTML = Object.entries(importantFields)
                .map(([key, value]) => `
                    <div class="state-item">
                        <span class="state-key">${key}:</span>
                        <span class="state-value">${value}</span>
                    </div>
                `).join('');
        }

        /**
         * Test functions - –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
         */
        function testStateManager() {
            try {
                LoadingManager.show('–¢–µ—Å—Ç–∏—Ä—É–µ–º StateManager...');
                
                // –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è pricing
                StateManager.dispatch({
                    type: 'PRICING_UPDATE',
                    payload: { hourlyRate: 300, method: 'fixed' }
                });

                // –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è complexity
                StateManager.dispatch({
                    type: 'COMPLEXITY_UPDATE',
                    payload: { projectComplexity: 1.5 }
                });

                // –¢–µ—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–π —É—Å–ª—É–≥–∏
                StateManager.dispatch({
                    type: 'CUSTOM_SERVICE_ADD',
                    payload: {
                        id: 'test-service',
                        name: '–¢–µ—Å—Ç–æ–≤–∞—è —É—Å–ª—É–≥–∞',
                        hours: 5,
                        pricePerUnit: 1000
                    }
                });

                setTimeout(() => {
                    LoadingManager.hide();
                    ErrorHandler.showSuccess('StateManager —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    console.log('Current state:', StateManager.getState());
                }, 1000);

            } catch (error) {
                LoadingManager.hide();
                ErrorHandler.handleError(error, { context: 'testStateManager' });
            }
        }

        function testEventBus() {
            try {
                LoadingManager.show('–¢–µ—Å—Ç–∏—Ä—É–µ–º EventBus...');

                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
                const unsubscribe = EventBus.on('test:event', (data) => {
                    ErrorHandler.showInfo(`–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ: ${data.message}`);
                });

                // –ò—Å–ø—É—Å–∫–∞–µ–º —Å–æ–±—ã—Ç–∏–µ
                setTimeout(() => {
                    EventBus.emit('test:event', { message: 'EventBus —Ä–∞–±–æ—Ç–∞–µ—Ç!' });
                }, 500);

                setTimeout(() => {
                    LoadingManager.hide();
                    unsubscribe(); // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è
                    ErrorHandler.showSuccess('EventBus —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!');
                    
                    console.log('EventBus stats:', EventBus.getStats());
                }, 1500);

            } catch (error) {
                LoadingManager.hide();
                ErrorHandler.handleError(error, { context: 'testEventBus' });
            }
        }

        function testErrorHandler() {
            try {
                LoadingManager.show('–¢–µ—Å—Ç–∏—Ä—É–µ–º ErrorHandler...');

                setTimeout(() => {
                    // –¢–µ—Å—Ç —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                    ErrorHandler.showInfo('–≠—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                }, 500);

                setTimeout(() => {
                    ErrorHandler.showWarning('–≠—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ');
                }, 1000);

                setTimeout(() => {
                    ErrorHandler.showSuccess('–≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ');
                }, 1500);

                setTimeout(() => {
                    // –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–∫–∏
                    try {
                        throw new Error('–¢–µ—Å—Ç–æ–≤–∞—è –æ—à–∏–±–∫–∞');
                    } catch (error) {
                        ErrorHandler.handleError(error, { context: 'testErrorHandler' });
                    }
                }, 2000);

                setTimeout(() => {
                    LoadingManager.hide();
                    console.log('Error stats:', ErrorHandler.getStats());
                }, 2500);

            } catch (error) {
                LoadingManager.hide();
                ErrorHandler.handleError(error, { context: 'testErrorHandler' });
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function initializeApp() {
            console.log('üöÄ Calculator 2.0 Core Infrastructure Ready');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML
            window.StateManager = StateManager;
            window.EventBus = EventBus;
            window.ErrorHandler = ErrorHandler;
            window.LoadingManager = LoadingManager;
            window.Utils = Utils;

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º dev panel
            updateDevPanel(StateManager.getState());

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            ErrorHandler.showSuccess('Core Infrastructure –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');

            // –≠–º–∏—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
            EventBus.emit('app:initialized');
        }

        // –ó–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        /**
 * PricingEngine.js - –ú–æ–¥—É–ª—å —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
 * –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –ª–æ–≥–∏–∫—É —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
 */

class PricingEngine {
    constructor(stateManager, eventBus, errorHandler) {
        this.state = stateManager;
        this.events = eventBus;
        this.errors = errorHandler;
        
        this.presetConfigs = this.initializePresetConfigs();
        this.componentConfigs = this.initializeComponentConfigs();
        this.serviceConfigs = this.initializeServiceConfigs();
        this.fixedPriceConfigs = this.initializeFixedPrices();
        
        this.influenceWeights = {
            domain: 0.6,
            project: 0.8,
            complexity: 1.0,
            urgency: 0.5
        };
        
        this.normalizedWeights = this.normalizeWeights();
        
        this.init();
        console.log('üí∞ PricingEngine initialized');
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è
     */
    init() {
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
        this.state.subscribe((state, action) => {
            if (this.shouldRecalculate(action.type)) {
                this.calculateAndUpdate();
            }
        });

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
        this.events.on('pricing:calculate', () => this.calculateAndUpdate());
        this.events.on('pricing:reset', () => this.resetCalculation());
        this.events.on('presets:changed', () => this.updatePresetPrices());
        this.events.on('components:changed', () => this.updateComponentPrices());

        console.log('PricingEngine event listeners attached');
    }

    /**
     * –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    initializePresetConfigs() {
        return {
            textLesson: {
                name: '–¢–µ–∫—Å—Ç–æ–≤—ã–µ —É—Ä–æ–∫–∏',
                components: ['longread', 'exercises', 'illustrations', 'quizzes'],
                baseHours: 5.5,
                defaultDuration: 30
            },
            videoLesson: {
                name: '–í–∏–¥–µ–æ —É—Ä–æ–∫–∏',
                components: ['script', 'presentation', 'illustrations'],
                baseHours: 8,
                defaultDuration: 60
            },
            webinar: {
                name: '–í–µ–±–∏–Ω–∞—Ä—ã',
                components: ['presentation', 'illustrations', 'engagementMechanics'],
                baseHours: 7,
                defaultDuration: 90
            },
            workshop: {
                name: '–ü—Ä–∞–∫—Ç–∏–∫—É–º—ã',
                components: ['instructions', 'templates', 'exercises', 'examples'],
                baseHours: 9,
                defaultDuration: 60
            },
            caseStudy: {
                name: '–ö–µ–π—Å-—Å—Ç–∞–¥–∏',
                components: ['caseDescription', 'caseQuestions', 'caseSolution'],
                baseHours: 5,
                defaultDuration: 45
            },
            masterClass: {
                name: '–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã',
                components: ['caseDescription', 'caseQuestions', 'caseSolution'],
                baseHours: 7,
                defaultDuration: 60
            }
        };
    }

    /**
     * –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
     */
    initializeComponentConfigs() {
        return {
            longread: { 
                defaultHours: 2.5, 
                name: '–õ–æ–Ω–≥—Ä–∏–¥',
                hasVolumeMultiplier: true,
                volumeField: 'pages'
            },
            script: { 
                defaultHours: 4, 
                name: '–°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏'
            },
            presentation: { 
                defaultHours: 6, 
                name: '–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è'
            },
            exercises: { 
                defaultHours: 1, 
                name: '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è'
            },
            illustrations: { 
                defaultHours: 0.5, 
                name: '–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏'
            },
            quizzes: { 
                defaultHours: 1.5, 
                name: '–ö–≤–∏–∑—ã',
                hasVolumeMultiplier: true,
                volumeField: 'questions',
                volumeBase: 7
            },
            instructions: { 
                defaultHours: 3, 
                name: '–ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏'
            },
            templates: {
                defaultHours: 2, 
                name: '–®–∞–±–ª–æ–Ω—ã/–ö–∞–Ω–≤–∞—Å—ã'
            },
            examples: { 
                defaultHours: 2, 
                name: '–†–∞–∑–±–æ—Ä –ø—Ä–∏–º–µ—Ä–∞'
            },
            caseDescription: { 
                defaultHours: 3, 
                name: '–†–∞–∑–±–æ—Ä –∫–µ–π—Å–∞'
            },
            caseQuestions: { 
                defaultHours: 1, 
                name: '–í–æ–ø—Ä–æ—Å—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞'
            },
            caseSolution: { 
                defaultHours: 1, 
                name: '–†–∞–∑–±–æ—Ä —Ä–µ—à–µ–Ω–∏—è'
            },
            engagementMechanics: { 
                defaultHours: 2, 
                name: '–ú–µ—Ö–∞–Ω–∏–∫–∏ –≤–æ–≤–ª–µ—á–µ–Ω–∏—è'
            }
        };
    }

    /**
     * –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ª—É–≥
     */
    initializeServiceConfigs() {
        return {
            // –ü—Ä–æ–≤–µ—Ä–∫–∏ –∑–Ω–∞–Ω–∏–π
            assessments: {
                currentTests: { defaultHours: 2, name: '–¢–µ–∫—É—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞' },
                moduleProjects: { defaultHours: 4, name: '–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞' },
                finalAssessment: { defaultHours: 6, name: '–ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞' }
            },
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
            additional: {
                research: { defaultHours: 6, name: '–ö–∞–±–∏–Ω–µ—Ç–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ' },
                audit: { defaultHours: 6, name: '–ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–π –∞—É–¥–∏—Ç' },
                methodology: { defaultHours: 5, name: '–ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã' },
                speakerPrep: { defaultHours: 4, name: '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–ø–∏–∫–µ—Ä–∞ –∫ –∑–∞–ø–∏—Å–∏ —É—Ä–æ–∫–∞' }
            }
        };
    }

    /**
     * –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ü–µ–Ω
     */
    initializeFixedPrices() {
        return {
            textLesson: { default: 1200, current: 1200, baseDuration: 30 },
            videoLesson: { default: 1800, current: 1800, baseDuration: 60 },
            webinar: { default: 1500, current: 1500, baseDuration: 90 },
            workshop: { default: 2000, current: 2000, baseDuration: 60 },
            caseStudy: { default: 1100, current: 1100, baseDuration: 45 },
            masterClass: { default: 1540, current: 1540, baseDuration: 60 }
        };
    }

    /**
     * –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ—Å–æ–≤ –≤–ª–∏—è–Ω–∏—è —Ñ–∞–∫—Ç–æ—Ä–æ–≤
     */
    normalizeWeights() {
        const totalInfluence = Object.values(this.influenceWeights).reduce((sum, weight) => sum + weight, 0);
        const normalized = {};
        Object.keys(this.influenceWeights).forEach(key => {
            normalized[key] = this.influenceWeights[key] / totalInfluence;
        });
        return normalized;
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–∞
     */
    shouldRecalculate(actionType) {
        const recalculateActions = [
            'PRICING_UPDATE',
            'COMPLEXITY_UPDATE', 
            'FINANCIAL_UPDATE',
            'PRESET_UPDATE',
            'COMPONENT_TOGGLE',
            'SERVICE_TOGGLE',
            'CUSTOM_SERVICE_ADD',
            'CUSTOM_SERVICE_REMOVE'
        ];
        return recalculateActions.includes(actionType);
    }

    /**
     * –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ —Ä–∞—Å—á–µ—Ç–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
     */
    async calculateAndUpdate() {
        try {
            this.events.emit('calculation:start');
            
            const currentState = this.state.getState();
            const calculation = await this.performCalculation(currentState);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
            this.state.dispatch({
                type: 'RESULTS_UPDATE',
                payload: calculation.results
            });

            // –≠–º–∏—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è
            this.events.emit('calculation:complete', calculation);
            this.events.emit('pricing:updated', calculation.results);

        } catch (error) {
            this.errors.handleError(error, { context: 'PricingEngine.calculateAndUpdate' });
            this.events.emit('calculation:error', error);
        }
    }

    /**
     * –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞
     */
    async performCalculation(state) {
        const startTime = Date.now();
        
        // –ü–æ–ª—É—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        const { pricing, complexity, financial, presets, components, services, customServices } = state;
        
        // –†–∞—Å—á–µ—Ç –ø—Ä–µ—Å–µ—Ç–æ–≤
        const presetCalculation = this.calculatePresets(presets, pricing, complexity, financial);
        
        // –†–∞—Å—á–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        const componentCalculation = this.calculateComponents(components, pricing, complexity, financial);
        
        // –†–∞—Å—á–µ—Ç —É—Å–ª—É–≥
        const serviceCalculation = this.calculateServices(services, pricing, complexity, financial);
        
        // –†–∞—Å—á–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —É—Å–ª—É–≥
        const customCalculation = this.calculateCustomServices(customServices, financial);
        
        // –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
        const subtotalCalculation = this.combineCalculations([
            presetCalculation,
            componentCalculation, 
            serviceCalculation,
            customCalculation
        ]);

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
        const finalCalculation = this.applyFinancialSettings(subtotalCalculation, financial);

        // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        const calculation = {
            results: {
                totalCost: finalCalculation.totalCost,
                totalHours: finalCalculation.totalHours,
                breakdown: finalCalculation.breakdown,
                composition: this.generateComposition(presetCalculation, componentCalculation, serviceCalculation, customCalculation)
            },
            details: {
                presets: presetCalculation,
                components: componentCalculation,
                services: serviceCalculation,
                custom: customCalculation,
                financial: finalCalculation.financial
            },
            meta: {
                calculationTime: Date.now() - startTime,
                timestamp: Date.now(),
                method: pricing.method,
                detailLevel: pricing.detailLevel
            }
        };

        return calculation;
    }

    /**
     * –†–∞—Å—á–µ—Ç –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    calculatePresets(presets, pricing, complexity, financial) {
        const items = [];
        let totalCost = 0;
        let totalHours = 0;

        Object.entries(presets).forEach(([presetType, presetData]) => {
            if (!presetData.count || presetData.count <= 0) return;

            const config = this.presetConfigs[presetType];
            if (!config) return;

            const calculation = this.calculatePresetItem(presetType, presetData, config, pricing, complexity, financial);
            
            items.push(calculation);
            totalCost += calculation.totalCost;
            totalHours += calculation.totalHours;
        });

        return { items, totalCost, totalHours, type: 'presets' };
    }

    /**
     * –†–∞—Å—á–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø—Ä–µ—Å–µ—Ç–∞
     */
    calculatePresetItem(presetType, presetData, config, pricing, complexity, financial) {
        const { count, duration } = presetData;
        const durationFactor = duration / config.defaultDuration;
        
        let pricePerUnit, hoursPerUnit;

        if (pricing.method === 'fixed') {
            // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã
            const fixedConfig = this.fixedPriceConfigs[presetType];
            const basePrice = fixedConfig.current;
            pricePerUnit = basePrice * durationFactor;
            hoursPerUnit = pricePerUnit / pricing.hourlyRate; // –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è
        } else {
            // –ü–æ—á–∞—Å–æ–≤–æ–π —Ä–∞—Å—á–µ—Ç
            const complexityMultiplier = this.calculateComplexityMultiplier(complexity, pricing.detailLevel, pricing.method);
            hoursPerUnit = config.baseHours * durationFactor * complexityMultiplier;
            pricePerUnit = hoursPerUnit * pricing.hourlyRate;
        }

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫–∏ –∑–∞ –æ–±—ä–µ–º
        const volumeDiscount = this.calculateVolumeDiscount(count, financial.enableVolumeDiscounts);
        const adjustedPricePerUnit = pricePerUnit * volumeDiscount;
        const adjustedHoursPerUnit = hoursPerUnit * volumeDiscount;

        return {
            id: presetType,
            name: config.name,
            count,
            duration,
            pricePerUnit: adjustedPricePerUnit,
            hoursPerUnit: adjustedHoursPerUnit,
            totalCost: adjustedPricePerUnit * count,
            totalHours: adjustedHoursPerUnit * count,
            volumeDiscount,
            durationFactor,
            source: 'preset'
        };
    }

    /**
     * –†–∞—Å—á–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
     */
    calculateComponents(components, pricing, complexity, financial) {
        const items = [];
        let totalCost = 0;
        let totalHours = 0;

        Object.entries(components).forEach(([componentId, componentData]) => {
            const config = this.componentConfigs[componentId];
            if (!config) return;

            const calculation = this.calculateComponentItem(componentId, componentData, config, pricing, complexity, financial);
            
            items.push(calculation);
            totalCost += calculation.totalCost;
            totalHours += calculation.totalHours;
        });

        return { items, totalCost, totalHours, type: 'components' };
    }

    /**
     * –†–∞—Å—á–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
     */
    calculateComponentItem(componentId, componentData, config, pricing, complexity, financial) {
        const count = componentData.count || 1;
        const hours = componentData.hours || config.defaultHours;
        
        // –†–∞—Å—á–µ—Ç –æ–±—ä–µ–º–Ω–æ–≥–æ –º–Ω–æ–∂–∏—Ç–µ–ª—è
        let volumeMultiplier = 1.0;
        if (config.hasVolumeMultiplier) {
            if (config.volumeField === 'pages') {
                volumeMultiplier = componentData.pages || 1;
            } else if (config.volumeField === 'questions') {
                const questions = componentData.questions || config.volumeBase;
                volumeMultiplier = questions / config.volumeBase;
            }
        }

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        const complexityMultiplier = this.calculateComplexityMultiplier(complexity, pricing.detailLevel, pricing.method);
        
        // –°–∫–∏–¥–∫–∞ –∑–∞ –æ–±—ä–µ–º
        const volumeDiscount = this.calculateVolumeDiscount(count, financial.enableVolumeDiscounts);
        
        // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç
        const adjustedHours = hours * volumeMultiplier * complexityMultiplier * volumeDiscount;
        const pricePerUnit = adjustedHours * pricing.hourlyRate;

        return {
            id: componentId,
            name: config.name,
            count,
            hours,
            volumeMultiplier,
            complexityMultiplier,
            volumeDiscount,
            pricePerUnit,
            totalCost: pricePerUnit * count,
            totalHours: adjustedHours * count,
            source: 'component'
        };
    }

    /**
     * –†–∞—Å—á–µ—Ç —É—Å–ª—É–≥
     */
    calculateServices(services, pricing, complexity, financial) {
        const items = [];
        let totalCost = 0;
        let totalHours = 0;

        // –ü—Ä–æ–≤–µ—Ä–∫–∏ –∑–Ω–∞–Ω–∏–π
        Object.entries(services).forEach(([serviceId, serviceData]) => {
            const assessmentConfig = this.serviceConfigs.assessments[serviceId];
            const additionalConfig = this.serviceConfigs.additional[serviceId];
            
            const config = assessmentConfig || additionalConfig;
            if (!config) return;

            const isAssessment = !!assessmentConfig;
            const calculation = this.calculateServiceItem(serviceId, serviceData, config, isAssessment, pricing, complexity, financial);
            
            items.push(calculation);
            totalCost += calculation.totalCost;
            totalHours += calculation.totalHours;
        });

        return { items, totalCost, totalHours, type: 'services' };
    }

    /**
     * –†–∞—Å—á–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–π —É—Å–ª—É–≥–∏
     */
    calculateServiceItem(serviceId, serviceData, config, isAssessment, pricing, complexity, financial) {
        const count = serviceData.count || 1;
        const hours = serviceData.hours || config.defaultHours;
        
        // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ –ø—Ä–æ–≤–µ—Ä–∫–∞–º –∑–Ω–∞–Ω–∏–π
        let complexityMultiplier = 1.0;
        if (isAssessment) {
            complexityMultiplier = this.calculateComplexityMultiplier(complexity, pricing.detailLevel, pricing.method);
        }
        
        const adjustedHours = hours * complexityMultiplier;
        const pricePerUnit = adjustedHours * pricing.hourlyRate;

        return {
            id: serviceId,
            name: config.name,
            count,
            hours,
            complexityMultiplier,
            pricePerUnit,
            totalCost: pricePerUnit * count,
            totalHours: adjustedHours * count,
            source: isAssessment ? 'assessment' : 'additional'
        };
    }

    /**
     * –†–∞—Å—á–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —É—Å–ª—É–≥
     */
    calculateCustomServices(customServices, financial) {
        const items = customServices.map(service => ({
            ...service,
            totalCost: service.pricePerUnit * service.count,
            totalHours: service.hours * service.count,
            source: 'custom'
        }));

        const totalCost = items.reduce((sum, item) => sum + item.totalCost, 0);
        const totalHours = items.reduce((sum, item) => sum + item.totalHours, 0);

        return { items, totalCost, totalHours, type: 'custom' };
    }

    /**
     * –†–∞—Å—á–µ—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
     */
    calculateComplexityMultiplier(complexity, detailLevel, pricingMethod) {
        if (detailLevel === 'quick') {
            // –ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
            let multiplier = complexity.projectComplexity * (complexity.methodistRole || 1.0);
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ü–µ–Ω
            if (pricingMethod === 'fixed') {
                multiplier = Math.min(multiplier, 1.5);
            }
            
            return multiplier;
        } else {
            // –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
            const { methodistRole, domainKnowledge, projectType, contentComplexity, urgency, qualityLevel } = complexity;
            
            const weightedSum = 1.0 + 
                (domainKnowledge - 1) * this.normalizedWeights.domain +
                (projectType - 1) * this.normalizedWeights.project +
                (contentComplexity - 1) * this.normalizedWeights.complexity +
                (urgency - 1) * this.normalizedWeights.urgency;
            
            let result = weightedSum * methodistRole * (qualityLevel || 1.0);
            
            if (pricingMethod === 'fixed') {
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ü–µ–Ω
                result = Math.min(result, 1.5);
            } else {
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –ø–æ—á–∞—Å–æ–≤–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
                if (result > 3.0) {
                    result = 3.0 + (result - 3.0) * 0.3;
                }
                if (result > 4.0) {
                    result = 4.0;
                }
            }
            
            return result;
        }
    }

    /**
     * –†–∞—Å—á–µ—Ç —Å–∫–∏–¥–∫–∏ –∑–∞ –æ–±—ä–µ–º
     */
    calculateVolumeDiscount(quantity, enableVolumeDiscounts) {
        if (!enableVolumeDiscounts) return 1.0;
        
        if (quantity <= 5) return 1.0;
        if (quantity <= 15) return 0.9;
        if (quantity <= 30) return 0.8;
        return 0.7;
    }

    /**
     * –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–æ–≤
     */
    combineCalculations(calculations) {
        const combined = {
            totalCost: 0,
            totalHours: 0,
            details: {}
        };

        calculations.forEach(calc => {
            combined.totalCost += calc.totalCost;
            combined.totalHours += calc.totalHours;
            combined.details[calc.type] = calc;
        });

        return combined;
    }

    /**
     * –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
     */
    applyFinancialSettings(calculation, financial) {
        const { discountRate, taxRate, showTaxSeparately, clientType } = financial;
        
        // –†–∞—Å—á–µ—Ç –ø—Ä–∞–≤–æ–∫ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∑–Ω–∞–Ω–∏–π)
        const contentCost = (calculation.details.presets?.totalCost || 0) + 
                           (calculation.details.components?.totalCost || 0);
        const assessmentCost = calculation.details.services?.items
            ?.filter(item => item.source === 'assessment')
            ?.reduce((sum, item) => sum + item.totalCost, 0) || 0;
        
        const revisionCost = (contentCost + assessmentCost) * (clientType / 100);
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∞–≤–∫–∏ –∫ –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏
        const afterRevisions = calculation.totalCost + revisionCost;
        
        // –ù–∞–¥–±–∞–≤–∫–∞ –∑–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ü–µ–Ω
        let complexityBonus = 0;
        // –≠—Ç–æ—Ç —Ä–∞—Å—á–µ—Ç –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
        
        const subtotal = afterRevisions + complexityBonus;
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É/–Ω–∞—Ü–µ–Ω–∫—É
        const discountAmount = subtotal * (discountRate / 100);
        const afterDiscount = subtotal + discountAmount;
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞–ª–æ–≥
        const taxAmount = afterDiscount * (taxRate / 100);
        const finalTotal = afterDiscount + taxAmount;

        return {
            totalCost: finalTotal,
            totalHours: calculation.totalHours,
            breakdown: this.generateBreakdown(calculation, revisionCost, complexityBonus, subtotal, discountAmount, afterDiscount, taxAmount, financial),
            financial: {
                subtotal,
                revisionCost,
                complexityBonus,
                discountAmount,
                taxAmount,
                afterDiscount,
                finalTotal
            }
        };
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
     */
    generateBreakdown(calculation, revisionCost, complexityBonus, subtotal, discountAmount, afterDiscount, taxAmount, financial) {
        const breakdown = {
            sections: [],
            totals: {
                subtotal,
                discountAmount,
                taxAmount,
                finalTotal: afterDiscount + taxAmount
            }
        };

        // –°–µ–∫—Ü–∏–∏ –ø–æ —Ç–∏–ø–∞–º
        Object.entries(calculation.details).forEach(([type, details]) => {
            if (details.items && details.items.length > 0) {
                breakdown.sections.push({
                    type,
                    name: this.getSectionName(type),
                    items: details.items.map(item => ({
                        name: item.name,
                        count: item.count,
                        pricePerUnit: item.pricePerUnit,
                        totalCost: item.totalCost
                    })),
                    totalCost: details.totalCost
                });
            }
        });

        // –°–µ–∫—Ü–∏—è –ø—Ä–∞–≤–æ–∫
        if (revisionCost > 0) {
            breakdown.sections.push({
                type: 'revisions',
                name: '–ü—Ä–∞–≤–∫–∏',
                items: [{
                    name: `–ü—Ä–∞–≤–∫–∏ (${financial.clientType}%)`,
                    totalCost: revisionCost
                }],
                totalCost: revisionCost
            });
        }

        // –°–µ–∫—Ü–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
        if (discountAmount !== 0 || (taxAmount > 0 && financial.showTaxSeparately)) {
            const financialItems = [];
            
            if (discountAmount !== 0) {
                financialItems.push({
                    name: discountAmount > 0 ? `–ù–∞—Ü–µ–Ω–∫–∞ (+${financial.discountRate}%)` : `–°–∫–∏–¥–∫–∞ (${financial.discountRate}%)`,
                    totalCost: discountAmount
                });
            }
            
            if (taxAmount > 0 && financial.showTaxSeparately) {
                financialItems.push({
                    name: `–ù–∞–ª–æ–≥ (${financial.taxRate}%)`,
                    totalCost: taxAmount
                });
            }

            breakdown.sections.push({
                type: 'financial',
                name: '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞—Å—á–µ—Ç—ã',
                items: financialItems,
                totalCost: discountAmount + (financial.showTaxSeparately ? taxAmount : 0)
            });
        }

        return breakdown;
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Å–µ–∫—Ü–∏–∏
     */
    getSectionName(type) {
        const names = {
            presets: '–ü—Ä–µ—Å–µ—Ç—ã',
            components: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã',
            services: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏',
            custom: '–ö–∞—Å—Ç–æ–º–Ω—ã–µ —É—Å–ª—É–≥–∏'
        };
        return names[type] || type;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ—Å—Ç–∞–≤–∞ –ø—Ä–æ–µ–∫—Ç–∞
     */
    generateComposition(...calculations) {
        const composition = [];
        
        calculations.forEach(calc => {
            if (calc.items && calc.items.length > 0) {
                calc.items.forEach(item => {
                    composition.push({
                        name: item.name,
                        count: item.count,
                        type: calc.type,
                        source: item.source
                    });
                });
            }
        });

        return composition;
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    updatePresetPrices() {
        try {
            const state = this.state.getState();
            const updatedPrices = {};

            Object.keys(this.presetConfigs).forEach(presetType => {
                const presetData = state.presets[presetType];
                if (presetData && presetData.count > 0) {
                    const calculation = this.calculatePresetItem(
                        presetType,
                        presetData,
                        this.presetConfigs[presetType],
                        state.pricing,
                        state.complexity,
                        state.financial
                    );
                    updatedPrices[presetType] = calculation.pricePerUnit;
                }
            });

            this.events.emit('pricing:presets-updated', updatedPrices);

        } catch (error) {
            this.errors.handleError(error, { context: 'PricingEngine.updatePresetPrices' });
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
     */
    updateComponentPrices() {
        try {
            const state = this.state.getState();
            const updatedPrices = {};

            Object.keys(state.components).forEach(componentId => {
                const componentData = state.components[componentId];
                const config = this.componentConfigs[componentId];
                
                if (config) {
                    const calculation = this.calculateComponentItem(
                        componentId,
                        componentData,
                        config,
                        state.pricing,
                        state.complexity,
                        state.financial
                    );
                    updatedPrices[componentId] = calculation.pricePerUnit;
                }
            });

            this.events.emit('pricing:components-updated', updatedPrices);

        } catch (error) {
            this.errors.handleError(error, { context: 'PricingEngine.updateComponentPrices' });
        }
    }

    /**
     * –°–±—Ä–æ—Å —Ä–∞—Å—á–µ—Ç–∞
     */
    resetCalculation() {
        this.state.dispatch({
            type: 'RESULTS_UPDATE',
            payload: {
                totalCost: 0,
                totalHours: 0,
                breakdown: {},
                composition: []
            }
        });

        this.events.emit('pricing:reset-complete');
    }

    /**
     * –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞
     */
    validateCalculation(state) {
        const errors = [];
        const warnings = [];

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        if (!state.pricing.hourlyRate || state.pricing.hourlyRate <= 0) {
            errors.push('–ù–µ —É–∫–∞–∑–∞–Ω–∞ —á–∞—Å–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞');
        }

        if (state.pricing.hourlyRate < 100) {
            warnings.push('–ù–∏–∑–∫–∞—è —á–∞—Å–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ (–º–µ–Ω–µ–µ 100‚ÇΩ/—á–∞—Å)');
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const hasActiveElements = Object.keys(state.presets).some(key => state.presets[key].count > 0) ||
                                 Object.keys(state.components).length > 0 ||
                                 Object.keys(state.services).length > 0 ||
                                 state.customServices.length > 0;

        if (!hasActiveElements) {
            warnings.push('–ù–µ –≤—ã–±—Ä–∞–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞');
        }

        return { errors, warnings };
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞—Å—á–µ—Ç–µ
     */
    getCalculationInfo() {
        const state = this.state.getState();
        return {
            method: state.pricing.method,
            detailLevel: state.pricing.detailLevel,
            hourlyRate: state.pricing.hourlyRate,
            hasComplexityFactors: state.pricing.detailLevel === 'detailed',
            hasVolumeDiscounts: state.financial.enableVolumeDiscounts,
            taxRate: state.financial.taxRate,
            clientType: state.financial.clientType
        };
    }

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
     */
    exportConfig() {
        return {
            presets: this.presetConfigs,
            components: this.componentConfigs,
            services: this.serviceConfigs,
            fixedPrices: this.fixedPriceConfigs,
            weights: this.influenceWeights
        };
    }

    /**
     * –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
     */
    importConfig(config) {
        try {
            if (config.presets) this.presetConfigs = { ...this.presetConfigs, ...config.presets };
            if (config.components) this.componentConfigs = { ...this.componentConfigs, ...config.components };
            if (config.services) this.serviceConfigs = { ...this.serviceConfigs, ...config.services };
            if (config.fixedPrices) this.fixedPriceConfigs = { ...this.fixedPriceConfigs, ...config.fixedPrices };
            if (config.weights) {
                this.influenceWeights = { ...this.influenceWeights, ...config.weights };
                this.normalizedWeights = this.normalizeWeights();
            }

            this.events.emit('pricing:config-imported', config);
            this.calculateAndUpdate();

        } catch (error) {
            this.errors.handleError(error, { context: 'PricingEngine.importConfig' });
        }
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
     */
    getUsageStats() {
        const state = this.state.getState();
        
        const activePresets = Object.entries(state.presets)
            .filter(([_, data]) => data.count > 0)
            .map(([type, data]) => ({ type, count: data.count }));

        const activeComponents = Object.keys(state.components).length;
        const activeServices = Object.keys(state.services).length;
        const customServices = state.customServices.length;

        return {
            activePresets,
            activeComponents,
            activeServices,
            customServices,
            totalItems: activePresets.reduce((sum, p) => sum + p.count, 0) + 
                       activeComponents + activeServices + customServices,
            complexity: state.complexity,
            estimatedHours: state.results.totalHours,
            estimatedCost: state.results.totalCost
        };
    }

    /**
     * –†–∞—Å—á–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–π —Ü–µ–Ω—ã
     */
    calculateRecommendedPrice(parameters = {}) {
        try {
            const baseRate = parameters.hourlyRate || 220;
            const experience = parameters.experience || 'middle'; // junior, middle, senior
            const market = parameters.market || 'moscow'; // moscow, regions, international
            const specialization = parameters.specialization || 'general'; // technical, business, creative, general

            const multipliers = {
                experience: { junior: 0.7, middle: 1.0, senior: 1.4 },
                market: { regions: 0.8, moscow: 1.0, international: 1.3 },
                specialization: { technical: 1.2, business: 1.0, creative: 1.1, general: 1.0 }
            };

            const recommendedRate = baseRate * 
                multipliers.experience[experience] * 
                multipliers.market[market] * 
                multipliers.specialization[specialization];

            return {
                recommendedRate: Math.round(recommendedRate),
                factors: {
                    base: baseRate,
                    experience: multipliers.experience[experience],
                    market: multipliers.market[market],
                    specialization: multipliers.specialization[specialization]
                },
                suggestion: this.getPricingSuggestion(recommendedRate, baseRate)
            };

        } catch (error) {
            this.errors.handleError(error, { context: 'PricingEngine.calculateRecommendedPrice' });
            return { recommendedRate: 220, error: '–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏' };
        }
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—é
     */
    getPricingSuggestion(recommended, current) {
        const difference = recommended - current;
        const percentDiff = (difference / current) * 100;

        if (Math.abs(percentDiff) < 10) {
            return '–í–∞—à–∞ —Å—Ç–∞–≤–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä—ã–Ω–æ—á–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º';
        } else if (percentDiff > 10) {
            return `–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —É–≤–µ–ª–∏—á–∏—Ç—å —Å—Ç–∞–≤–∫—É –Ω–∞ ${Math.round(percentDiff)}% –¥–æ ${Math.round(recommended)} ‚ÇΩ/—á–∞—Å`;
        } else {
            return `–í–∞—à–∞ —Å—Ç–∞–≤–∫–∞ –≤—ã—à–µ —Ä—ã–Ω–æ—á–Ω–æ–π –Ω–∞ ${Math.round(Math.abs(percentDiff))}%`;
        }
    }

    /**
     * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞
     */
    optimizeCalculation() {
        try {
            const state = this.state.getState();
            const suggestions = [];

            // –ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–º–æ–≤ –¥–ª—è —Å–∫–∏–¥–æ–∫
            Object.entries(state.presets).forEach(([type, data]) => {
                if (data.count > 0 && data.count < 6) {
                    suggestions.push({
                        type: 'volume',
                        message: `–£–≤–µ–ª–∏—á—å—Ç–µ ${this.presetConfigs[type].name} –¥–æ 6+ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏ 10%`,
                        action: 'increase_quantity',
                        target: type,
                        currentValue: data.count,
                        recommendedValue: 6
                    });
                }
            });

            // –ê–Ω–∞–ª–∏–∑ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            if (state.pricing.detailLevel === 'quick' && state.complexity.projectComplexity === 1.0) {
                suggestions.push({
                    type: 'complexity',
                    message: '–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –æ—Ü–µ–Ω–∫–∏',
                    action: 'adjust_complexity'
                });
            }

            // –ê–Ω–∞–ª–∏–∑ –º–µ—Ç–æ–¥–∞ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
            const hasMany = Object.values(state.presets).some(p => p.count > 10);
            if (hasMany && state.pricing.method === 'hourly') {
                suggestions.push({
                    type: 'method',
                    message: '–î–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã',
                    action: 'switch_to_fixed'
                });
            }

            this.events.emit('pricing:optimization-complete', suggestions);
            return suggestions;

        } catch (error) {
            this.errors.handleError(error, { context: 'PricingEngine.optimizeCalculation' });
            return [];
        }
    }

    /**
     * –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ —Ä–∞—Å—á–µ—Ç–∞–º–∏
     */
    compareWithPrevious(previousState) {
        try {
            const currentCalc = this.performCalculation(this.state.getState());
            const previousCalc = this.performCalculation(previousState);

            const comparison = {
                costDifference: currentCalc.results.totalCost - previousCalc.results.totalCost,
                hoursDifference: currentCalc.results.totalHours - previousCalc.results.totalHours,
                percentageChange: ((currentCalc.results.totalCost - previousCalc.results.totalCost) / previousCalc.results.totalCost) * 100,
                changedItems: this.findChangedItems(currentCalc, previousCalc)
            };

            return comparison;

        } catch (error) {
            this.errors.handleError(error, { context: 'PricingEngine.compareWithPrevious' });
            return null;
        }
    }

    /**
     * –ü–æ–∏—Å–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
     */
    findChangedItems(current, previous) {
        const changes = [];
        
        // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–æ–≤
        Object.keys({ ...current.details.presets?.items || {}, ...previous.details.presets?.items || {} }).forEach(type => {
            const currentItem = current.details.presets?.items?.find(i => i.id === type);
            const previousItem = previous.details.presets?.items?.find(i => i.id === type);
            
            if (!currentItem && previousItem) {
                changes.push({ type: 'removed', category: 'preset', name: previousItem.name });
            } else if (currentItem && !previousItem) {
                changes.push({ type: 'added', category: 'preset', name: currentItem.name });
            } else if (currentItem && previousItem && currentItem.count !== previousItem.count) {
                changes.push({ 
                    type: 'modified', 
                    category: 'preset', 
                    name: currentItem.name,
                    change: `${previousItem.count} ‚Üí ${currentItem.count}`
                });
            }
        });

        return changes;
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞—Å—á–µ—Ç–µ
     */
    getCalculationDetails() {
        const state = this.state.getState();
        return {
            timestamp: Date.now(),
            state: state,
            configuration: this.exportConfig(),
            validation: this.validateCalculation(state),
            stats: this.getUsageStats(),
            info: this.getCalculationInfo()
        };
    }

    /**
     * –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –º–æ–¥—É–ª—è
     */
    destroy() {
        // –û—Ç–ø–∏—Å–∫–∞ –æ—Ç —Å–æ–±—ã—Ç–∏–π
        this.events.off('pricing:calculate');
        this.events.off('pricing:reset');
        this.events.off('presets:changed');
        this.events.off('components:changed');
        
        console.log('üí∞ PricingEngine destroyed');
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
if (typeof module !== 'undefined' && module.exports) {
    module.exports = PricingEngine;
} else if (typeof window !== 'undefined') {
    window.PricingEngine = PricingEngine;
}

        /**
 * PresetManager.js - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–∞–º–∏
 * –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã —Å –≥–æ—Ç–æ–≤—ã–º–∏ –ø–∞–∫–µ—Ç–∞–º–∏ —É—Å–ª—É–≥
 */

class PresetManager {
    constructor(stateManager, eventBus, errorHandler) {
        this.state = stateManager;
        this.events = eventBus;
        this.errors = errorHandler;
        
        this.presetDefinitions = this.initializePresetDefinitions();
        this.presetTemplates = this.initializePresetTemplates();
        this.autoActivationRules = this.initializeAutoActivationRules();
        
        this.init();
        console.log('üì¶ PresetManager initialized');
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è
     */
    init() {
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
        this.state.subscribe((state, action) => {
            if (this.shouldHandleAction(action.type)) {
                this.handleStateChange(state, action);
            }
        });

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
        this.events.on('presets:activate', (data) => this.activatePreset(data.presetType, data.count, data.duration));
        this.events.on('presets:deactivate', (data) => this.deactivatePreset(data.presetType));
        this.events.on('presets:update-quantity', (data) => this.updatePresetQuantity(data.presetType, data.count));
        this.events.on('presets:update-duration', (data) => this.updatePresetDuration(data.presetType, data.duration));
        this.events.on('presets:apply-template', (data) => this.applyTemplate(data.templateName));
        this.events.on('presets:reset-all', () => this.resetAllPresets());
        this.events.on('presets:auto-suggest', () => this.generateAutoSuggestions());

        console.log('PresetManager event listeners attached');
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    initializePresetDefinitions() {
        return {
            textLesson: {
                id: 'textLesson',
                name: '–¢–µ–∫—Å—Ç–æ–≤—ã–π —É—Ä–æ–∫',
                icon: 'üìù',
                description: '–°—Ç–∞—Ç—å—è –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è —Ç–µ–æ—Ä–∏–∏ –∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–π (20-40 –º–∏–Ω —á—Ç–µ–Ω–∏—è)',
                defaultDuration: 30,
                minDuration: 10,
                maxDuration: 120,
                baseCost: 1210,
                category: 'content',
                difficulty: 'easy',
                timeToCreate: 5.5,
                includes: [
                    '–õ–æ–Ω–≥—Ä–∏–¥',
                    '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è', 
                    '–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏',
                    '–ö–≤–∏–∑—ã'
                ],
                linkedComponents: ['longread', 'exercises', 'illustrations', 'quizzes'],
                compatibleWith: ['workshop', 'caseStudy'],
                tags: ['—Ç–µ–∫—Å—Ç', '—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ', '—Ç–µ–æ—Ä–∏—è']
            },
            videoLesson: {
                id: 'videoLesson',
                name: '–í–∏–¥–µ–æ —É—Ä–æ–∫',
                icon: 'üé•',
                description: '–í–∏–¥–µ–æ—É—Ä–æ–∫ —Å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–µ–π –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ (30-90 –º–∏–Ω)',
                defaultDuration: 60,
                minDuration: 15,
                maxDuration: 120,
                baseCost: 1760,
                category: 'content',
                difficulty: 'medium',
                timeToCreate: 8,
                includes: [
                    '–°–∫—Ä–∏–ø—Ç',
                    '–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è',
                    '–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏'
                ],
                linkedComponents: ['script', 'presentation', 'illustrations'],
                compatibleWith: ['webinar', 'masterClass'],
                autoActivates: ['speakerPrep'],
                tags: ['–≤–∏–¥–µ–æ', '–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è', '–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è']
            },
            webinar: {
                id: 'webinar',
                name: '–í–µ–±–∏–Ω–∞—Ä',
                icon: 'üåê',
                description: '–ñ–∏–≤–æ–µ –æ–Ω–ª–∞–π–Ω-–æ–±—É—á–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º —Å –∞—É–¥–∏—Ç–æ—Ä–∏–µ–π (60-120 –º–∏–Ω)',
                defaultDuration: 90,
                minDuration: 30,
                maxDuration: 180,
                baseCost: 1540,
                category: 'interactive',
                difficulty: 'medium',
                timeToCreate: 7,
                includes: [
                    '–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è',
                    '–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏',
                    '–ú–µ—Ö–∞–Ω–∏–∫–∏ –≤–æ–≤–ª–µ—á–µ–Ω–∏—è'
                ],
                linkedComponents: ['presentation', 'illustrations', 'engagementMechanics'],
                compatibleWith: ['videoLesson', 'workshop'],
                tags: ['–æ–Ω–ª–∞–π–Ω', '–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤', '–∂–∏–≤–æ–µ –æ–±—â–µ–Ω–∏–µ']
            },
            workshop: {
                id: 'workshop',
                name: '–ü—Ä–∞–∫—Ç–∏–∫—É–º',
                icon: 'üõ†Ô∏è',
                description: '–í–æ—Ä–∫—à–æ–ø –¥–ª—è –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–≤—ã–∫–æ–≤ —Å –ø–æ—à–∞–≥–æ–≤—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ (60-180 –º–∏–Ω)',
                defaultDuration: 60,
                minDuration: 30,
                maxDuration: 240,
                baseCost: 1980,
                category: 'practical',
                difficulty: 'hard',
                timeToCreate: 9,
                includes: [
                    '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏',
                    '–®–∞–±–ª–æ–Ω—ã',
                    '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è',
                    '–ü—Ä–∏–º–µ—Ä—ã'
                ],
                linkedComponents: ['instructions', 'templates', 'exercises', 'examples'],
                compatibleWith: ['textLesson', 'caseStudy'],
                tags: ['–ø—Ä–∞–∫—Ç–∏–∫–∞', '–Ω–∞–≤—ã–∫–∏', '–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏']
            },
            caseStudy: {
                id: 'caseStudy',
                name: '–ö–µ–π—Å-—Å—Ç–∞–¥–∏',
                icon: 'üìã',
                description: '–†–∞–∑–±–æ—Ä —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Ä–µ—à–µ–Ω–∏–π (30-60 –º–∏–Ω)',
                defaultDuration: 45,
                minDuration: 20,
                maxDuration: 90,
                baseCost: 1100,
                category: 'analytical',
                difficulty: 'medium',
                timeToCreate: 5,
                includes: [
                    '–û–ø–∏—Å–∞–Ω–∏–µ –∫–µ–π—Å–∞',
                    '–í–æ–ø—Ä–æ—Å—ã',
                    '–†–∞–∑–±–æ—Ä —Ä–µ—à–µ–Ω–∏—è'
                ],
                linkedComponents: ['caseDescription', 'caseQuestions', 'caseSolution'],
                compatibleWith: ['masterClass', 'workshop'],
                tags: ['–∞–Ω–∞–ª–∏–∑', '–∫–µ–π—Å', '—Ä–µ—à–µ–Ω–∏—è']
            },
            masterClass: {
                id: 'masterClass',
                name: '–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å',
                icon: 'üë®‚Äçüè´',
                description: '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –ø—Ä–∏–º–µ—Ä–µ (45-90 –º–∏–Ω)',
                defaultDuration: 60,
                minDuration: 30,
                maxDuration: 120,
                baseCost: 1540,
                category: 'expert',
                difficulty: 'hard',
                timeToCreate: 7,
                includes: [
                    '–†–∞–∑–±–æ—Ä –∫–µ–π—Å–∞',
                    '–í–æ–ø—Ä–æ—Å—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞',
                    '–†–∞–∑–±–æ—Ä —Ä–µ—à–µ–Ω–∏—è'
                ],
                linkedComponents: ['caseDescription', 'caseQuestions', 'caseSolution'],
                compatibleWith: ['caseStudy', 'videoLesson'],
                tags: ['—ç–∫—Å–ø–µ—Ä—Ç', '–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è', '–ø—Ä–∏–º–µ—Ä']
            }
        };
    }

    /**
     * –®–∞–±–ª–æ–Ω—ã –ø—Ä–µ—Å–µ—Ç–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
     */
    initializePresetTemplates() {
        return {
            basicCourse: {
                name: '–ë–∞–∑–æ–≤—ã–π –∫—É—Ä—Å',
                description: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ–Ω–ª–∞–π–Ω –∫—É—Ä—Å —Å –≤–∏–¥–µ–æ –∏ –ø—Ä–∞–∫—Ç–∏–∫–æ–π',
                icon: 'üéì',
                presets: [
                    { type: 'videoLesson', count: 8, duration: 45 },
                    { type: 'textLesson', count: 4, duration: 25 },
                    { type: 'workshop', count: 2, duration: 90 }
                ],
                estimatedHours: 95,
                estimatedCost: 18500,
                targetAudience: '–ù–∞—á–∏–Ω–∞—é—â–∏–µ',
                tags: ['–∫—É—Ä—Å', '–±–∞–∑–æ–≤—ã–π', '—Å–º–µ—à–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç']
            },
            intensiveCourse: {
                name: '–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–π –∫—É—Ä—Å',
                description: '–ù–∞—Å—ã—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø—Ä–∞–∫—Ç–∏–∫–∏',
                icon: 'üöÄ',
                presets: [
                    { type: 'videoLesson', count: 12, duration: 60 },
                    { type: 'workshop', count: 6, duration: 120 },
                    { type: 'caseStudy', count: 4, duration: 45 },
                    { type: 'masterClass', count: 2, duration: 90 }
                ],
                estimatedHours: 165,
                estimatedCost: 32000,
                targetAudience: '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ',
                tags: ['–∏–Ω—Ç–µ–Ω—Å–∏–≤', '–ø—Ä–∞–∫—Ç–∏–∫–∞', '–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π']
            },
            webinarSeries: {
                name: '–°–µ—Ä–∏—è –≤–µ–±–∏–Ω–∞—Ä–æ–≤',
                description: '–¶–∏–∫–ª –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–Ω–ª–∞–π–Ω-—Å–µ—Å—Å–∏–π',
                icon: 'üì∫',
                presets: [
                    { type: 'webinar', count: 6, duration: 90 },
                    { type: 'textLesson', count: 6, duration: 20 }
                ],
                estimatedHours: 57,
                estimatedCost: 11500,
                targetAudience: '–õ—é–±–æ–π —É—Ä–æ–≤–µ–Ω—å',
                tags: ['–≤–µ–±–∏–Ω–∞—Ä—ã', '–æ–Ω–ª–∞–π–Ω', '–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤']
            },
            practicalIntensive: {
                name: '–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ–Ω—Å–∏–≤',
                description: '–ú–∞–∫—Å–∏–º—É–º –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–≤—ã–∫–æ–≤',
                icon: '‚ö°',
                presets: [
                    { type: 'workshop', count: 8, duration: 180 },
                    { type: 'caseStudy', count: 6, duration: 60 },
                    { type: 'textLesson', count: 2, duration: 30 }
                ],
                estimatedHours: 113,
                estimatedCost: 21800,
                targetAudience: '–ü—Ä–∞–∫—Ç–∏–∫–∏',
                tags: ['–ø—Ä–∞–∫—Ç–∏–∫–∞', '–≤–æ—Ä–∫—à–æ–ø—ã', '–∫–µ–π—Å—ã']
            },
            expertProgram: {
                name: '–≠–∫—Å–ø–µ—Ä—Ç–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞',
                description: '–ì–ª—É–±–æ–∫–æ–µ –ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ —Å –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–∞–º–∏',
                icon: 'üéØ',
                presets: [
                    { type: 'masterClass', count: 4, duration: 90 },
                    { type: 'videoLesson', count: 6, duration: 75 },
                    { type: 'caseStudy', count: 8, duration: 45 },
                    { type: 'workshop', count: 3, duration: 120 }
                ],
                estimatedHours: 125,
                estimatedCost: 24500,
                targetAudience: '–≠–∫—Å–ø–µ—Ä—Ç—ã',
                tags: ['—ç–∫—Å–ø–µ—Ä—Ç', '–º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å', '–≥–ª—É–±–∏–Ω–∞']
            },
            compactCourse: {
                name: '–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∫—É—Ä—Å',
                description: '–ö—Ä–∞—Ç–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏',
                icon: 'üì±',
                presets: [
                    { type: 'videoLesson', count: 4, duration: 30 },
                    { type: 'textLesson', count: 3, duration: 20 },
                    { type: 'caseStudy', count: 2, duration: 30 }
                ],
                estimatedHours: 35,
                estimatedCost: 7200,
                targetAudience: '–ó–∞–Ω—è—Ç—ã–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—ã',
                tags: ['–∫–æ–º–ø–∞–∫—Ç–Ω—ã–π', '–±—ã—Å—Ç—Ä—ã–π', '–æ—Å–Ω–æ–≤—ã']
            }
        };
    }

    /**
     * –ü—Ä–∞–≤–∏–ª–∞ –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥
     */
    initializeAutoActivationRules() {
        return {
            videoLesson: {
                services: ['speakerPrep'],
                condition: (count) => count > 0,
                message: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–ø–∏–∫–µ—Ä–∞ –¥–ª—è –≤–∏–¥–µ–æ—É—Ä–æ–∫–æ–≤'
            },
            domainExpertise: {
                services: ['research', 'methodology'],
                condition: (state) => state.complexity.projectType === 1.0, // –ù–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
                message: '–î–æ–±–∞–≤–ª–µ–Ω—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∏ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–ª—è –Ω–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã'
            },
            existingProgram: {
                services: ['audit'],
                condition: (state) => state.complexity.projectType > 1.0, // –î–æ—Ä–∞–±–æ—Ç–∫–∞ –∏–ª–∏ —á—É–∂–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
                message: '–î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–π –∞—É–¥–∏—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏'
            }
        };
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
     */
    shouldHandleAction(actionType) {
        const handledActions = [
            'PRESET_UPDATE',
            'COMPLEXITY_UPDATE',
            'PRICING_UPDATE'
        ];
        return handledActions.includes(actionType);
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è
     */
    handleStateChange(state, action) {
        try {
            switch (action.type) {
                case 'PRESET_UPDATE':
                    this.handlePresetUpdate(action.payload);
                    break;
                case 'COMPLEXITY_UPDATE':
                    this.handleComplexityChange(state);
                    break;
                case 'PRICING_UPDATE':
                    this.updatePresetPricing(state);
                    break;
            }
        } catch (error) {
            this.errors.handleError(error, { 
                context: 'PresetManager.handleStateChange',
                action: action.type 
            });
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ—Å–µ—Ç–∞
     */
    handlePresetUpdate(payload) {
        const { presetType, data } = payload;
        const definition = this.presetDefinitions[presetType];
        
        if (!definition) {
            this.errors.showWarning(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ø—Ä–µ—Å–µ—Ç–∞: ${presetType}`);
            return;
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        const validation = this.validatePresetData(presetType, data);
        if (!validation.isValid) {
            this.errors.showWarning(`–û—à–∏–±–∫–∞ –≤ –ø—Ä–µ—Å–µ—Ç–µ ${definition.name}: ${validation.error}`);
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
        this.checkAutoActivation(presetType, data);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        this.checkCompatibility(presetType, data);

        // –≠–º–∏—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ
        this.events.emit('presets:updated', {
            presetType,
            data,
            definition
        });
    }

    /**
     * –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–µ—Å–µ—Ç–∞
     */
    activatePreset(presetType, count = 1, duration = null) {
        try {
            const definition = this.presetDefinitions[presetType];
            if (!definition) {
                throw new Error(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ø—Ä–µ—Å–µ—Ç–∞: ${presetType}`);
            }

            const finalDuration = duration || definition.defaultDuration;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            const validation = this.validatePresetData(presetType, { count, duration: finalDuration });
            if (!validation.isValid) {
                this.errors.showWarning(validation.error);
                return false;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            this.state.dispatch({
                type: 'PRESET_UPDATE',
                payload: {
                    presetType,
                    data: { count, duration: finalDuration }
                }
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            this.errors.showSuccess(`–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ø—Ä–µ—Å–µ—Ç: ${definition.name} (${count} —à—Ç.)`);

            return true;

        } catch (error) {
            this.errors.handleError(error, { context: 'PresetManager.activatePreset', presetType });
            return false;
        }
    }

    /**
     * –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–µ—Å–µ—Ç–∞
     */
    deactivatePreset(presetType) {
        try {
            const definition = this.presetDefinitions[presetType];
            if (!definition) {
                throw new Error(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ø—Ä–µ—Å–µ—Ç–∞: ${presetType}`);
            }

            this.state.dispatch({
                type: 'PRESET_UPDATE',
                payload: {
                    presetType,
                    data: { count: 0, duration: definition.defaultDuration }
                }
            });

            this.errors.showInfo(`–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ø—Ä–µ—Å–µ—Ç: ${definition.name}`);
            return true;

        } catch (error) {
            this.errors.handleError(error, { context: 'PresetManager.deactivatePreset', presetType });
            return false;
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–µ—Å–µ—Ç–∞
     */
    updatePresetQuantity(presetType, count) {
        try {
            const state = this.state.getState();
            const currentPreset = state.presets[presetType];
            
            if (!currentPreset) {
                return this.activatePreset(presetType, count);
            }

            if (count <= 0) {
                return this.deactivatePreset(presetType);
            }

            this.state.dispatch({
                type: 'PRESET_UPDATE',
                payload: {
                    presetType,
                    data: { ...currentPreset, count }
                }
            });

            return true;

        } catch (error) {
            this.errors.handleError(error, { context: 'PresetManager.updatePresetQuantity', presetType });
            return false;
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–µ—Å–µ—Ç–∞
     */
    updatePresetDuration(presetType, duration) {
        try {
            const state = this.state.getState();
            const currentPreset = state.presets[presetType];
            
            if (!currentPreset) {
                this.errors.showWarning('–°–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø—Ä–µ—Å–µ—Ç');
                return false;
            }

            const validation = this.validatePresetData(presetType, { ...currentPreset, duration });
            if (!validation.isValid) {
                this.errors.showWarning(validation.error);
                return false;
            }

            this.state.dispatch({
                type: 'PRESET_UPDATE',
                payload: {
                    presetType,
                    data: { ...currentPreset, duration }
                }
            });

            return true;

        } catch (error) {
            this.errors.handleError(error, { context: 'PresetManager.updatePresetDuration', presetType });
            return false;
        }
    }

    /**
     * –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
     */
    applyTemplate(templateName) {
        try {
            const template = this.presetTemplates[templateName];
            if (!template) {
                throw new Error(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —à–∞–±–ª–æ–Ω: ${templateName}`);
            }

            // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –ø—Ä–µ—Å–µ—Ç—ã
            this.resetAllPresets();

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–µ—Å–µ—Ç—ã –∏–∑ —à–∞–±–ª–æ–Ω–∞
            let appliedCount = 0;
            template.presets.forEach(presetData => {
                const success = this.activatePreset(presetData.type, presetData.count, presetData.duration);
                if (success) appliedCount++;
            });

            if (appliedCount === template.presets.length) {
                this.errors.showSuccess(`–ü—Ä–∏–º–µ–Ω–µ–Ω —à–∞–±–ª–æ–Ω: ${template.name}`);
                this.events.emit('presets:template-applied', { templateName, template });
            } else {
                this.errors.showWarning(`–®–∞–±–ª–æ–Ω –ø—Ä–∏–º–µ–Ω–µ–Ω —á–∞—Å—Ç–∏—á–Ω–æ (${appliedCount}/${template.presets.length})`);
            }

            return appliedCount === template.presets.length;

        } catch (error) {
            this.errors.handleError(error, { context: 'PresetManager.applyTemplate', templateName });
            return false;
        }
    }

    /**
     * –°–±—Ä–æ—Å –≤—Å–µ—Ö –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    resetAllPresets() {
        try {
            Object.keys(this.presetDefinitions).forEach(presetType => {
                this.deactivatePreset(presetType);
            });

            this.events.emit('presets:all-reset');
            this.errors.showInfo('–í—Å–µ –ø—Ä–µ—Å–µ—Ç—ã —Å–±—Ä–æ—à–µ–Ω—ã');

        } catch (error) {
            this.errors.handleError(error, { context: 'PresetManager.resetAllPresets' });
        }
    }

    /**
     * –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ—Å–µ—Ç–∞
     */
    validatePresetData(presetType, data) {
        const definition = this.presetDefinitions[presetType];
        if (!definition) {
            return { isValid: false, error: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ø—Ä–µ—Å–µ—Ç–∞' };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        if (data.count !== undefined) {
            if (!Number.isInteger(data.count) || data.count < 0) {
                return { isValid: false, error: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º' };
            }
            if (data.count > 100) {
                return { isValid: false, error: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: 100' };
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        if (data.duration !== undefined) {
            if (!Number.isFinite(data.duration) || data.duration <= 0) {
                return { isValid: false, error: '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º' };
            }
            if (data.duration < definition.minDuration) {
                return { isValid: false, error: `–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${definition.minDuration} –º–∏–Ω` };
            }
            if (data.duration > definition.maxDuration) {
                return { isValid: false, error: `–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${definition.maxDuration} –º–∏–Ω` };
            }
        }

        return { isValid: true };
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥
     */
    checkAutoActivation(presetType, data) {
        try {
            const definition = this.presetDefinitions[presetType];
            
            // –ê–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —É—Å–ª—É–≥ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–µ—Å–µ—Ç–∞
            if (definition.autoActivates && data.count > 0) {
                definition.autoActivates.forEach(serviceId => {
                    this.events.emit('services:auto-activate', {
                        serviceId,
                        reason: `–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ø—Ä–µ—Å–µ—Ç: ${definition.name}`,
                        source: presetType
                    });
                });
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—â–∏—Ö –ø—Ä–∞–≤–∏–ª –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
            const state = this.state.getState();
            Object.entries(this.autoActivationRules).forEach(([ruleName, rule]) => {
                if (rule.condition(state) || (typeof rule.condition === 'function' && rule.condition(data.count))) {
                    rule.services.forEach(serviceId => {
                        this.events.emit('services:auto-activate', {
                            serviceId,
                            reason: rule.message,
                            source: ruleName
                        });
                    });
                }
            });

        } catch (error) {
            this.errors.handleError(error, { context: 'PresetManager.checkAutoActivation' });
        }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    checkCompatibility(presetType, data) {
        try {
            if (data.count === 0) return;

            const state = this.state.getState();
            const definition = this.presetDefinitions[presetType];
            const activePresets = Object.entries(state.presets)
                .filter(([_, presetData]) => presetData.count > 0)
                .map(([type, _]) => type);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –ø—Ä–µ—Å–µ—Ç–∞–º–∏
            const incompatiblePresets = activePresets.filter(activeType => {
                if (activeType === presetType) return false;
                const activeDef = this.presetDefinitions[activeType];
                return activeDef && 
                       (!definition.compatibleWith?.includes(activeType)) &&
                       (!activeDef.compatibleWith?.includes(presetType));
            });

            if (incompatiblePresets.length > 0) {
                const incompatibleNames = incompatiblePresets
                    .map(type => this.presetDefinitions[type].name)
                    .join(', ');
                
                this.errors.showWarning(
                    `–ü—Ä–µ—Å–µ—Ç "${definition.name}" –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º —Å: ${incompatibleNames}`
                );
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
            this.checkLogicalConflicts(state);

        } catch (error) {
            this.errors.handleError(error, { context: 'PresetManager.checkCompatibility' });
        }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
     */
    checkLogicalConflicts(state) {
        const activePresets = Object.entries(state.presets)
            .filter(([_, data]) => data.count > 0);

        // –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        if (activePresets.length > 4) {
            this.errors.showWarning('–ú–Ω–æ–≥–æ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –º–æ–∂–µ—Ç —É—Å–ª–æ–∂–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç');
        }

        // –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ –æ–±—ä–µ–º–∞
        const totalItems = activePresets.reduce((sum, [_, data]) => sum + data.count, 0);
        const complexity = state.complexity.projectComplexity || 1.0;
        
        if (totalItems > 20 && complexity < 1.5) {
            this.errors.showWarning('–ë–æ–ª—å—à–æ–π –æ–±—ä–µ–º —Ä–∞–±–æ—Ç —Ç—Ä–µ–±—É–µ—Ç —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏');
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        const avgDuration = activePresets.reduce((sum, [_, data]) => sum + data.duration, 0) / activePresets.length;
        if (avgDuration > 90) {
            this.errors.showInfo('–°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Ä–æ–∫–æ–≤ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 90 –º–∏–Ω—É—Ç');
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
     */
    handleComplexityChange(state) {
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏—é —É—Å–ª—É–≥
        this.recheckAutoActivation(state);
    }

    /**
     * –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
     */
    recheckAutoActivation(state) {
        Object.entries(this.autoActivationRules).forEach(([ruleName, rule]) => {
            if (ruleName === 'domainExpertise' || ruleName === 'existingProgram') {
                const shouldActivate = rule.condition(state);
                this.events.emit('services:conditional-activate', {
                    ruleId: ruleName,
                    shouldActivate,
                    services: rule.services,
                    message: rule.message
                });
            }
        });
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    updatePresetPricing(state) {
        this.events.emit('presets:pricing-update-needed', state.pricing);
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
     */
    generateAutoSuggestions() {
        try {
            const state = this.state.getState();
            const suggestions = [];

            // –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            const activePresets = Object.entries(state.presets)
                .filter(([_, data]) => data.count > 0);

            if (activePresets.length === 0) {
                // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —à–∞–±–ª–æ–Ω—ã –¥–ª—è –Ω–∞—á–∞–ª–∞
                suggestions.push({
                    type: 'template',
                    priority: 'high',
                    title: '–ù–∞—á–Ω–∏—Ç–µ —Å –≥–æ—Ç–æ–≤–æ–≥–æ —à–∞–±–ª–æ–Ω–∞',
                    description: '–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞',
                    action: 'show_templates',
                    templates: ['basicCourse', 'webinarSeries', 'compactCourse']
                });
            } else {
                // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–µ—Å–µ—Ç—ã
                this.analyzeExistingPresets(activePresets, suggestions, state);
            }

            // –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            this.generateOptimizationSuggestions(activePresets, suggestions, state);

            this.events.emit('presets:suggestions-generated', suggestions);
            return suggestions;

        } catch (error) {
            this.errors.handleError(error, { context: 'PresetManager.generateAutoSuggestions' });
            return [];
        }
    }

    /**
     * –ê–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    analyzeExistingPresets(activePresets, suggestions, state) {
        const presetTypes = activePresets.map(([type, _]) => type);
        const totalItems = activePresets.reduce((sum, [_, data]) => sum + data.count, 0);

        // –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—é
        if (presetTypes.includes('videoLesson') && !presetTypes.includes('textLesson')) {
            suggestions.push({
                type: 'complement',
                priority: 'medium',
                title: '–î–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã',
                description: '–ö –≤–∏–¥–µ–æ—É—Ä–æ–∫–∞–º —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è',
                action: 'add_preset',
                presetType: 'textLesson',
                recommendedCount: Math.ceil(activePresets.find(([type]) => type === 'videoLesson')[1].count / 2)
            });
        }

        if (presetTypes.includes('textLesson') && !presetTypes.includes('workshop') && totalItems > 5) {
            suggestions.push({
                type: 'complement',
                priority: 'medium',
                title: '–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–Ω—è—Ç–∏—è',
                description: '–î–ª—è –ª—É—á—à–µ–≥–æ —É—Å–≤–æ–µ–Ω–∏—è —Ç–µ–æ—Ä–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç—Å—è –ø—Ä–∞–∫—Ç–∏–∫—É–º—ã',
                action: 'add_preset',
                presetType: 'workshop',
                recommendedCount: Math.ceil(totalItems / 4)
            });
        }

        // –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –æ–±—ä–µ–º—É
        activePresets.forEach(([type, data]) => {
            if (data.count < 6 && data.count > 2) {
                suggestions.push({
                    type: 'volume',
                    priority: 'low',
                    title: `–£–≤–µ–ª–∏—á—å—Ç–µ ${this.presetDefinitions[type].name} –¥–ª—è —Å–∫–∏–¥–∫–∏`,
                    description: `–ü—Ä–∏ –∑–∞–∫–∞–∑–µ –æ—Ç 6 –µ–¥–∏–Ω–∏—Ü –¥–µ–π—Å—Ç–≤—É–µ—Ç —Å–∫–∏–¥–∫–∞ 10%`,
                    action: 'increase_quantity',
                    presetType: type,
                    currentCount: data.count,
                    recommendedCount: 6
                });
            }
        });
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
     */
    generateOptimizationSuggestions(activePresets, suggestions, state) {
        const totalCost = state.results.totalCost || 0;
        const totalHours = state.results.totalHours || 0;

        // –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –º–µ—Ç–æ–¥—É —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
        if (state.pricing.method === 'hourly' && activePresets.length > 3) {
            suggestions.push({
                type: 'pricing',
                priority: 'low',
                title: '–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã',
                description: '–î–ª—è –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –º–æ–≥—É—Ç –±—ã—Ç—å –≤—ã–≥–æ–¥–Ω–µ–µ',
                action: 'switch_pricing_method',
                currentMethod: 'hourly',
                recommendedMethod: 'fixed'
            });
        }

        // –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        if (totalHours > 100 && state.complexity.projectComplexity === 1.0) {
            suggestions.push({
                type: 'complexity',
                priority: 'medium',
                title: '–ü–µ—Ä–µ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞',
                description: '–ë–æ–ª—å—à–æ–π –æ–±—ä–µ–º —Ä–∞–±–æ—Ç –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏',
                action: 'adjust_complexity',
                currentComplexity: state.complexity.projectComplexity,
                recommendedComplexity: 1.3
            });
        }

        // –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        const avgDuration = activePresets.reduce((sum, [_, data]) => sum + data.duration, 0) / activePresets.length;
        if (avgDuration < 30) {
            suggestions.push({
                type: 'duration',
                priority: 'low',
                title: '–ö–æ—Ä–æ—Ç–∫–∏–µ —É—Ä–æ–∫–∏',
                description: '–°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Ä–æ–∫–æ–≤ –º–µ–Ω–µ–µ 30 –º–∏–Ω—É—Ç. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤',
                action: 'optimize_duration'
            });
        }
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ —à–∞–±–ª–æ–Ω–∞–º
     */
    getTemplateRecommendations(criteria = {}) {
        const { budget, timeframe, audience, complexity } = criteria;
        const recommendations = [];

        Object.entries(this.presetTemplates).forEach(([templateName, template]) => {
            let score = 0;
            let reasons = [];

            // –û—Ü–µ–Ω–∫–∞ –ø–æ –±—é–¥–∂–µ—Ç—É
            if (budget) {
                if (template.estimatedCost <= budget) {
                    score += 2;
                    reasons.push('–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –±—é–¥–∂–µ—Ç—É');
                } else if (template.estimatedCost <= budget * 1.2) {
                    score += 1;
                    reasons.push('–ë–ª–∏–∑–∫–æ –∫ –±—é–¥–∂–µ—Ç—É');
                }
            }

            // –û—Ü–µ–Ω–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
            if (timeframe) {
                if (template.estimatedHours <= timeframe) {
                    score += 2;
                    reasons.push('–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–º —Ä–∞–º–∫–∞–º');
                }
            }

            // –û—Ü–µ–Ω–∫–∞ –ø–æ –∞—É–¥–∏—Ç–æ—Ä–∏–∏
            if (audience && template.targetAudience) {
                if (template.targetAudience.toLowerCase().includes(audience.toLowerCase()) || 
                    template.targetAudience === '–õ—é–±–æ–π —É—Ä–æ–≤–µ–Ω—å') {
                    score += 1;
                    reasons.push('–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏');
                }
            }

            // –û—Ü–µ–Ω–∫–∞ –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            if (complexity) {
                const templateComplexity = this.calculateTemplateComplexity(template);
                if (Math.abs(templateComplexity - complexity) < 0.3) {
                    score += 1;
                    reasons.push('–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞');
                }
            }

            if (score > 0) {
                recommendations.push({
                    templateName,
                    template,
                    score,
                    reasons,
                    recommendation: score >= 3 ? 'highly_recommended' : 
                                  score >= 2 ? 'recommended' : 'consider'
                });
            }
        });

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –æ—Ü–µ–Ω–∫–∏
        recommendations.sort((a, b) => b.score - a.score);
        
        return recommendations;
    }

    /**
     * –†–∞—Å—á–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —à–∞–±–ª–æ–Ω–∞
     */
    calculateTemplateComplexity(template) {
        let complexity = 0;
        template.presets.forEach(preset => {
            const definition = this.presetDefinitions[preset.type];
            if (definition) {
                const difficultyScore = {
                    'easy': 1,
                    'medium': 2,
                    'hard': 3
                }[definition.difficulty] || 2;
                complexity += difficultyScore * preset.count;
            }
        });
        return complexity / template.presets.reduce((sum, p) => sum + p.count, 0);
    }

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    exportPresetConfig() {
        return {
            definitions: this.presetDefinitions,
            templates: this.presetTemplates,
            autoActivationRules: this.autoActivationRules,
            currentState: this.state.getState().presets
        };
    }

    /**
     * –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    importPresetConfig(config) {
        try {
            if (config.definitions) {
                this.presetDefinitions = { ...this.presetDefinitions, ...config.definitions };
            }
            if (config.templates) {
                this.presetTemplates = { ...this.presetTemplates, ...config.templates };
            }
            if (config.autoActivationRules) {
                this.autoActivationRules = { ...this.autoActivationRules, ...config.autoActivationRules };
            }

            this.events.emit('presets:config-imported', config);
            this.errors.showSuccess('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–µ—Å–µ—Ç–æ–≤ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞');

        } catch (error) {
            this.errors.handleError(error, { context: 'PresetManager.importPresetConfig' });
        }
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    getUsageStatistics() {
        const state = this.state.getState();
        const activePresets = Object.entries(state.presets)
            .filter(([_, data]) => data.count > 0);

        const stats = {
            totalActivePresets: activePresets.length,
            totalItems: activePresets.reduce((sum, [_, data]) => sum + data.count, 0),
            averageDuration: activePresets.length > 0 ? 
                activePresets.reduce((sum, [_, data]) => sum + data.duration, 0) / activePresets.length : 0,
            categoryDistribution: {},
            difficultyDistribution: {},
            mostUsedPresets: activePresets.map(([type, data]) => ({
                type,
                name: this.presetDefinitions[type].name,
                count: data.count,
                duration: data.duration
            })).sort((a, b) => b.count - a.count)
        };

        // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        activePresets.forEach(([type, data]) => {
            const definition = this.presetDefinitions[type];
            if (definition) {
                stats.categoryDistribution[definition.category] = 
                    (stats.categoryDistribution[definition.category] || 0) + data.count;
                stats.difficultyDistribution[definition.difficulty] = 
                    (stats.difficultyDistribution[definition.difficulty] || 0) + data.count;
            }
        });

        return stats;
    }

    /**
     * –ü–æ–∏—Å–∫ –ø—Ä–µ—Å–µ—Ç–æ–≤ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º
     */
    searchPresets(criteria) {
        const { category, difficulty, tags, minDuration, maxDuration, searchText } = criteria;
        
        return Object.values(this.presetDefinitions).filter(preset => {
            // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if (category && preset.category !== category) return false;
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            if (difficulty && preset.difficulty !== difficulty) return false;
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º
            if (tags && tags.length > 0) {
                const hasMatchingTag = tags.some(tag => 
                    preset.tags.some(presetTag => 
                        presetTag.toLowerCase().includes(tag.toLowerCase())
                    )
                );
                if (!hasMatchingTag) return false;
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            if (minDuration && preset.defaultDuration < minDuration) return false;
            if (maxDuration && preset.defaultDuration > maxDuration) return false;
            
            // –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É
            if (searchText) {
                const text = searchText.toLowerCase();
                const matchesText = preset.name.toLowerCase().includes(text) ||
                                  preset.description.toLowerCase().includes(text) ||
                                  preset.tags.some(tag => tag.toLowerCase().includes(text));
                if (!matchesText) return false;
            }
            
            return true;
        });
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–µ—Å–µ—Ç–µ
     */
    getPresetDetails(presetType) {
        const definition = this.presetDefinitions[presetType];
        if (!definition) return null;

        const state = this.state.getState();
        const currentData = state.presets[presetType] || { count: 0, duration: definition.defaultDuration };

        return {
            definition,
            currentData,
            isActive: currentData.count > 0,
            estimatedCost: this.calculatePresetCost(presetType, currentData),
            estimatedHours: this.calculatePresetHours(presetType, currentData),
            compatiblePresets: definition.compatibleWith?.map(type => this.presetDefinitions[type]) || [],
            linkedComponents: definition.linkedComponents || [],
            autoActivatedServices: definition.autoActivates || []
        };
    }

    /**
     * –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–µ—Å–µ—Ç–∞
     */
    calculatePresetCost(presetType, data) {
        const definition = this.presetDefinitions[presetType];
        if (!definition || data.count === 0) return 0;

        const durationFactor = data.duration / definition.defaultDuration;
        return Math.round(definition.baseCost * durationFactor * data.count);
    }

    /**
     * –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–µ—Å–µ—Ç–∞
     */
    calculatePresetHours(presetType, data) {
        const definition = this.presetDefinitions[presetType];
        if (!definition || data.count === 0) return 0;

        const durationFactor = data.duration / definition.defaultDuration;
        return Math.round(definition.timeToCreate * durationFactor * data.count * 10) / 10;
    }

    /**
     * –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –º–æ–¥—É–ª—è
     */
    destroy() {
        // –û—Ç–ø–∏—Å–∫–∞ –æ—Ç —Å–æ–±—ã—Ç–∏–π
        this.events.off('presets:activate');
        this.events.off('presets:deactivate');
        this.events.off('presets:update-quantity');
        this.events.off('presets:update-duration');
        this.events.off('presets:apply-template');
        this.events.off('presets:reset-all');
        this.events.off('presets:auto-suggest');
        
        console.log('üì¶ PresetManager destroyed');
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
if (typeof module !== 'undefined' && module.exports) {
    module.exports = PresetManager;
} else if (typeof window !== 'undefined') {
    window.PresetManager = PresetManager;
}

        /**
 * ComponentManager.js - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ –∏ —É—Å–ª—É–≥–∞–º–∏
 * –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏, —É—Å–ª—É–≥–∞–º–∏ –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
 */

class ComponentManager {
    constructor(stateManager, eventBus, errorHandler) {
        this.state = stateManager;
        this.events = eventBus;
        this.errors = errorHandler;
        
        this.componentDefinitions = this.initializeComponentDefinitions();
        this.serviceDefinitions = this.initializeServiceDefinitions();
        this.autoActivatedServices = new Set();
        this.serviceGroups = this.initializeServiceGroups();
        this.customServiceCounter = 0;
        
        this.init();
        console.log('üß© ComponentManager initialized');
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è
     */
    init() {
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
        this.state.subscribe((state, action) => {
            if (this.shouldHandleAction(action.type)) {
                this.handleStateChange(state, action);
            }
        });

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
        this.events.on('components:toggle', (data) => this.toggleComponent(data.componentId, data.enabled, data.config));
        this.events.on('components:update-config', (data) => this.updateComponentConfig(data.componentId, data.config));
        this.events.on('services:toggle', (data) => this.toggleService(data.serviceId, data.enabled, data.config));
        this.events.on('services:auto-activate', (data) => this.autoActivateService(data.serviceId, data.reason, data.source));
        this.events.on('services:conditional-activate', (data) => this.conditionalActivateServices(data));
        this.events.on('custom-services:add', (data) => this.addCustomService(data));
        this.events.on('custom-services:remove', (data) => this.removeCustomService(data.id));
        this.events.on('custom-services:update', (data) => this.updateCustomService(data.id, data.updates));

        console.log('ComponentManager event listeners attached');
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
     */
    initializeComponentDefinitions() {
        return {
            longread: {
                id: 'longread',
                name: '–õ–æ–Ω–≥—Ä–∏–¥',
                icon: 'üìÑ',
                description: '–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç—å—è —É—Ä–æ–∫–∞ –æ–±—ä–µ–º–æ–º 1500-2000 –∑–Ω–∞–∫–æ–≤ –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è',
                defaultHours: 2.5,
                category: 'content',
                difficulty: 'easy',
                volumeFields: {
                    pages: {
                        name: '–õ–∏—Å—Ç—ã –ê4',
                        default: 1,
                        min: 0.5,
                        max: 10,
                        step: 0.5,
                        multiplier: true
                    }
                },
                presetTags: ['textLesson'],
                tags: ['—Ç–µ–∫—Å—Ç', '—Å—Ç–∞—Ç—å—è', '—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ'],
                requiredSkills: ['–Ω–∞–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤', '—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'],
                deliverables: ['–ì–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ Word/Google Docs', '–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª'],
                estimatedReadingTime: '15-20 –º–∏–Ω—É—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É'
            },
            script: {
                id: 'script',
                name: '–°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏',
                icon: 'üé¨',
                description: '–ì–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å —Ä–∞–∑–º–µ—Ç–∫–æ–π –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ—É—Ä–æ–∫–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é 30-90 –º–∏–Ω—É—Ç',
                defaultHours: 4,
                category: 'content',
                difficulty: 'medium',
                volumeFields: {},
                presetTags: ['videoLesson'],
                tags: ['–≤–∏–¥–µ–æ', '—Å–∫—Ä–∏–ø—Ç', '–∑–∞–ø–∏—Å—å'],
                requiredSkills: ['–Ω–∞–ø–∏—Å–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤', '–ø–æ–Ω–∏–º–∞–Ω–∏–µ –≤–∏–¥–µ–æ–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞'],
                deliverables: ['–°–∫—Ä–∏–ø—Ç —Å —Ç–∞–π–º-–∫–æ–¥–∞–º–∏', '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏', '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å—ä–µ–º–∫–µ'],
                dependencies: ['presentation']
            },
             presentation: {
                id: 'presentation',
                name: '–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è',
                icon: 'üìä',
                description: '–°–ª–∞–π–¥-–¥–µ–∫–∞ –∏–∑ 15-25 —Å–ª–∞–π–¥–æ–≤ —Å —Ç–µ–∫—Å—Ç–æ–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –¥–ª—è —É—Ä–æ–∫–∞ –∏–ª–∏ –≤–µ–±–∏–Ω–∞—Ä–∞',
                defaultHours: 6,
                category: 'visual',
                difficulty: 'medium',
                volumeFields: {},
                presetTags: ['videoLesson', 'webinar'],
                tags: ['–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è', '—Å–ª–∞–π–¥—ã', '–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è'],
                requiredSkills: ['–¥–∏–∑–∞–π–Ω –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π', '—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'],
                deliverables: ['PowerPoint/Google Slides —Ñ–∞–π–ª', '–ú–∞–∫–µ—Ç—ã —Å–ª–∞–π–¥–æ–≤', '–ó–∞–º–µ—Ç–∫–∏ –¥–ª—è —Å–ø–∏–∫–µ—Ä–∞'],
                relatedComponents: ['illustrations']
            },
            exercises: {
                id: 'exercises',
                name: '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è',
                icon: '‚úèÔ∏è',
                description: '–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –æ—Ç—Ä–∞–±–æ—Ç–∫—É –Ω–∞–≤—ã–∫–æ–≤ –≤–Ω—É—Ç—Ä–∏ —É—Ä–æ–∫–∞ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏',
                defaultHours: 1,
                category: 'interactive',
                difficulty: 'easy',
                volumeFields: {},
                presetTags: ['textLesson', 'workshop'],
                tags: ['–ø—Ä–∞–∫—Ç–∏–∫–∞', '—É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è', '–∑–∞–¥–∞–Ω–∏—è'],
                requiredSkills: ['–º–µ—Ç–æ–¥–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', '—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏–π'],
                deliverables: ['–û–ø–∏—Å–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π', '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è', '–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏'],
                relatedComponents: ['instructions']
            },
            illustrations: {
                id: 'illustrations',
                name: '–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏',
                icon: 'üñºÔ∏è',
                description: '–ü–æ–¥–±–æ—Ä –∏ –∞–¥–∞–ø—Ç–∞—Ü–∏—è 5-10 –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —É—Ä–æ–∫–∞',
                defaultHours: 0.5,
                category: 'visual',
                difficulty: 'easy',
                volumeFields: {},
                presetTags: ['textLesson', 'videoLesson', 'webinar'],
                tags: ['–≤–∏–∑—É–∞–ª', '–∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏', '–ø–æ–¥–±–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π'],
                requiredSkills: ['–ø–æ–∏—Å–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π', '–±–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∏'],
                deliverables: ['–ù–∞–±–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π', '–ü–æ–¥–ø–∏—Å–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏—è', '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é'],
                legalNote: '–í—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–º–∏ –∏–ª–∏ —Å–≤–æ–±–æ–¥–Ω—ã–º–∏'
            },
            quizzes: {
                id: 'quizzes',
                name: '–ö–≤–∏–∑—ã',
                icon: '‚ùì',
                description: '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑ 5-10 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞ —É—Ä–æ–∫–∞',
                defaultHours: 1.5,
                category: 'interactive',
                difficulty: 'medium',
                volumeFields: {
                    questions: {
                        name: '–í–æ–ø—Ä–æ—Å–æ–≤',
                        default: 7,
                        min: 1,
                        max: 20,
                        step: 1,
                        multiplier: true,
                        baseValue: 7
                    }
                },
                presetTags: ['textLesson'],
                tags: ['–ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞–Ω–∏–π', '–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤', '—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ'],
                requiredSkills: ['—Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤', '–∑–Ω–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è'],
                deliverables: ['–ù–∞–±–æ—Ä –≤–æ–ø—Ä–æ—Å–æ–≤ —Å –æ—Ç–≤–µ—Ç–∞–º–∏', '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–≤–∏–∑–∞'],
                questionTypes: ['–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä', '–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä', '–¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥', '–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ']
            },
            instructions: {
                id: 'instructions',
                name: '–ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏',
                icon: 'üìã',
                description: '–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –¥–µ–π—Å—Ç–≤–∏–π —Å –ø–æ—à–∞–≥–æ–≤—ã–º —Ä–∞–∑–±–æ—Ä–æ–º –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è',
                defaultHours: 3,
                category: 'practical',
                difficulty: 'medium',
                volumeFields: {},
                presetTags: ['workshop'],
                tags: ['–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏', '–∞–ª–≥–æ—Ä–∏—Ç–º', '–ø–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å'],
                requiredSkills: ['—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤', '—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ø–∏—Å—å–º–æ'],
                deliverables: ['–ü–æ—à–∞–≥–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º', '–°–∫—Ä–∏–Ω—à–æ—Ç—ã/–∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏', '–°–æ–≤–µ—Ç—ã –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é'],
                relatedComponents: ['templates', 'examples']
            },
            templates: {
                id: 'templates',
                name: '–®–∞–±–ª–æ–Ω—ã/–ö–∞–Ω–≤–∞—Å—ã',
                icon: 'üìã',
                description: '–ì–æ—Ç–æ–≤—ã–µ –±–ª–∞–Ω–∫–∏ –∏ —Ñ–æ—Ä–º—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –≤–æ –≤—Ä–µ–º—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–Ω—è—Ç–∏–π',
                defaultHours: 2,
                category: 'practical',
                difficulty: 'medium',
                volumeFields: {},
                presetTags: ['workshop'],
                tags: ['—à–∞–±–ª–æ–Ω—ã', '—Ñ–æ—Ä–º—ã', '–±–ª–∞–Ω–∫–∏'],
                requiredSkills: ['–¥–∏–∑–∞–π–Ω —Ñ–æ—Ä–º', '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç'],
                deliverables: ['–ì–æ—Ç–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã', '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é', '–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è'],
                formats: ['PDF', 'Word', 'Excel', 'Google Forms']
            },
            examples: {
                id: 'examples',
                name: '–†–∞–∑–±–æ—Ä –ø—Ä–∏–º–µ—Ä–∞',
                icon: 'üí°',
                description: '–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏–ª–∏ —É—á–µ–±–Ω–æ–≥–æ –∫–µ–π—Å–∞ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º —Ä–µ—à–µ–Ω–∏–π –∏ –≤—ã–≤–æ–¥–æ–≤',
                defaultHours: 2,
                category: 'analytical',
                difficulty: 'medium',
                volumeFields: {},
                presetTags: ['workshop'],
                tags: ['–ø—Ä–∏–º–µ—Ä—ã', '—Ä–∞–∑–±–æ—Ä', '–∞–Ω–∞–ª–∏–∑'],
                requiredSkills: ['–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ', '–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –∫–æ–Ω—Ü–µ–ø—Ü–∏–π'],
                deliverables: ['–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–∞', '–ü–æ—à–∞–≥–æ–≤—ã–π —Ä–∞–∑–±–æ—Ä', '–í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏'],
                relatedComponents: ['caseDescription']
            },
            caseDescription: {
                id: 'caseDescription',
                name: '–†–∞–∑–±–æ—Ä –∫–µ–π—Å–∞',
                icon: 'üìÅ',
                description: '–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏',
                defaultHours: 3,
                category: 'analytical',
                difficulty: 'hard',
                volumeFields: {},
                presetTags: ['caseStudy', 'masterClass'],
                tags: ['–∫–µ–π—Å', '—Å–∏—Ç—É–∞—Ü–∏—è', '–∫–æ–Ω—Ç–µ–∫—Å—Ç'],
                requiredSkills: ['case-study —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞', '—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'],
                deliverables: ['–û–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏', '–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', '–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'],
                relatedComponents: ['caseQuestions', 'caseSolution']
            },
            caseQuestions: {
                id: 'caseQuestions',
                name: '–í–æ–ø—Ä–æ—Å—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞',
                icon: 'ü§î',
                description: '–ù–∞–±–æ—Ä –∏–∑ 5-8 –Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞ –∫–µ–π—Å–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏',
                defaultHours: 1,
                category: 'analytical',
                difficulty: 'medium',
                volumeFields: {},
                presetTags: ['caseStudy', 'masterClass'],
                tags: ['–≤–æ–ø—Ä–æ—Å—ã', '–∞–Ω–∞–ª–∏–∑', '–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º—ã—Å–ª–∏'],
                requiredSkills: ['—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤', '–ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ'],
                deliverables: ['–°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤', '–ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è', '–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∞–Ω–∞–ª–∏–∑–∞'],
                dependencies: ['caseDescription']
            },
            caseSolution: {
                id: 'caseSolution',
                name: '–†–∞–∑–±–æ—Ä —Ä–µ—à–µ–Ω–∏—è',
                icon: '‚úÖ',
                description: '–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –∫–µ–π—Å–∞ –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤',
                defaultHours: 1,
                category: 'analytical',
                difficulty: 'hard',
                volumeFields: {},
                presetTags: ['caseStudy', 'masterClass'],
                tags: ['—Ä–µ—à–µ–Ω–∏–µ', '—ç–∫—Å–ø–µ—Ä—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞', '–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã'],
                requiredSkills: ['—ç–∫—Å–ø–µ—Ä—Ç–Ω–æ—Å—Ç—å –≤ –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏', '–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ'],
                deliverables: ['–†–∞–∑–±–æ—Ä —Ä–µ—à–µ–Ω–∏—è', '–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã', '–£—Ä–æ–∫–∏ –∏ –≤—ã–≤–æ–¥—ã'],
                dependencies: ['caseDescription', 'caseQuestions']
            },
            engagementMechanics: {
                id: 'engagementMechanics',
                name: '–ú–µ—Ö–∞–Ω–∏–∫–∏ –≤–æ–≤–ª–µ—á–µ–Ω–∏—è',
                icon: 'üéÆ',
                description: '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —É–¥–µ—Ä–∂–∞–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è: –æ–ø—Ä–æ—Å—ã, —á–∞—Ç—ã, –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è, –º–∏–Ω–∏-–∏–≥—Ä—ã',
                defaultHours: 2,
                category: 'interactive',
                difficulty: 'hard',
                volumeFields: {},
                presetTags: ['webinar'],
                tags: ['–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤', '–≤–æ–≤–ª–µ—á–µ–Ω–∏–µ', '–≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è'],
                requiredSkills: ['–≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è', '–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω', '–º–æ–¥–µ—Ä–∞—Ü–∏—è'],
                deliverables: ['–°—Ü–µ–Ω–∞—Ä–∏–π –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–æ–≤', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤', '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞'],
                tools: ['Mentimeter', 'Kahoot', 'Zoom Polls', 'Miro']
            }
        };
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Å–ª—É–≥
     */
    initializeServiceDefinitions() {
        return {
            // –ü—Ä–æ–≤–µ—Ä–∫–∏ –∑–Ω–∞–Ω–∏–π
            currentTests: {
                id: 'currentTests',
                name: '–¢–µ–∫—É—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞',
                icon: 'üìù',
                description: '–¢–µ—Å—Ç—ã –∏ –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ 10-15 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–∫–∞',
                defaultHours: 2,
                category: 'assessment',
                group: 'knowledge_check',
                difficulty: 'medium',
                hasCount: true,
                tags: ['—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', '–ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞–Ω–∏–π', '–¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è'],
                deliverables: ['–¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è', '–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏', '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è'],
                relatedTo: ['presets']
            },
            moduleProjects: {
                id: 'moduleProjects',
                name: '–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞',
                icon: 'üìä',
                description: '–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–µ–∫—Ç—ã –∏ –∫–µ–π—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–≤—ã–∫–æ–≤ –≤ –∫–æ–Ω—Ü–µ –º–æ–¥—É–ª—è –∏–ª–∏ –±–ª–æ–∫–∞ —É—Ä–æ–∫–æ–≤',
                defaultHours: 4,
                category: 'assessment',
                group: 'knowledge_check',
                difficulty: 'hard',
                hasCount: true,
                tags: ['–ø—Ä–æ–µ–∫—Ç—ã', '–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞', '–º–æ–¥—É–ª—å–Ω–∞—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è'],
                deliverables: ['–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞', '–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏', '–ü—Ä–∏–º–µ—Ä—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è'],
                relatedTo: ['presets']
            },
            finalAssessment: {
                id: 'finalAssessment',
                name: '–ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞',
                icon: 'üéì',
                description: '–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è –∑–Ω–∞–Ω–∏–π –∏ –Ω–∞–≤—ã–∫–æ–≤ –≤ –∫–æ–Ω—Ü–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –æ–±—É—á–µ–Ω–∏—è —Å –æ—Ü–µ–Ω–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤',
                defaultHours: 6,
                category: 'assessment',
                group: 'knowledge_check',
                difficulty: 'hard',
                hasCount: true,
                tags: ['–∏—Ç–æ–≥–æ–≤–∞—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è', '–∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞', '—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è'],
                deliverables: ['–ò—Ç–æ–≥–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ', '–°–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–∫–∏', '–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç/–¥–∏–ø–ª–æ–º'],
                relatedTo: ['program']
            },

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
            research: {
                id: 'research',
                name: '–ö–∞–±–∏–Ω–µ—Ç–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ',
                icon: 'üîç',
                description: '–ò–∑—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏, –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏ –ª—É—á—à–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞',
                defaultHours: 6,
                category: 'research',
                group: 'additional',
                difficulty: 'medium',
                hasCount: false,
                autoActivation: {
                    condition: 'new_program',
                    reason: '–ù–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—Ä–µ–±—É–µ—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏'
                },
                tags: ['–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ', '–∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞', 'best practices'],
                deliverables: ['–û—Ç—á–µ—Ç –æ–± –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏', '–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑', '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É'],
                methods: ['Desk research', '–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤', '–ò–∑—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤', '–ò–Ω—Ç–µ—Ä–≤—å—é —Å —ç–∫—Å–ø–µ—Ä—Ç–∞–º–∏']
            },
            audit: {
                id: 'audit',
                name: '–ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–π –∞—É–¥–∏—Ç',
                icon: 'üîé',
                description: '–≠–∫—Å–ø–µ—Ä—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –∫–∞—á–µ—Å—Ç–≤–∞',
                defaultHours: 6,
                category: 'audit',
                group: 'additional',
                difficulty: 'hard',
                hasCount: false,
                autoActivation: {
                    condition: 'existing_program',
                    reason: '–†–∞–±–æ—Ç–∞ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ —Ç—Ä–µ–±—É–µ—Ç –∞—É–¥–∏—Ç–∞'
                },
                tags: ['–∞—É–¥–∏—Ç', '—ç–∫—Å–ø–µ—Ä—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞', '—É–ª—É—á—à–µ–Ω–∏—è'],
                deliverables: ['–û—Ç—á–µ—Ç –æ–± –∞—É–¥–∏—Ç–µ', '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é', '–ü–ª–∞–Ω –¥–æ—Ä–∞–±–æ—Ç–∫–∏'],
                criteria: ['–ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å', '–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è', '–ö–∞—á–µ—Å—Ç–≤–æ –ø–æ–¥–∞—á–∏', '–õ–æ–≥–∏–∫–∞ –∏–∑–ª–æ–∂–µ–Ω–∏—è']
            },
            methodology: {
                id: 'methodology',
                name: '–ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã',
                icon: 'üìê',
                description: '–ö–∞—Ä—Ç–∞ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω –ø—Ä–æ–≥—Ä–∞–º–º—ã –æ–±—É—á–µ–Ω–∏—è',
                defaultHours: 5,
                category: 'methodology',
                group: 'additional',
                difficulty: 'hard',
                hasCount: false,
                autoActivation: {
                    condition: 'new_program',
                    reason: '–ù–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—Ä–µ–±—É–µ—Ç –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤'
                },
                tags: ['–º–µ—Ç–æ–¥–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', '–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã', '—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã'],
                deliverables: ['–ö–∞—Ä—Ç–∞ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π', '–¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω', '–ú–∞—Ç—Ä–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤'],
                includes: ['Learning outcomes mapping', 'Curriculum design', 'Assessment strategy']
            },
            speakerPrep: {
                id: 'speakerPrep',
                name: '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–ø–∏–∫–µ—Ä–∞ –∫ –∑–∞–ø–∏—Å–∏ —É—Ä–æ–∫–∞',
                icon: 'üé§',
                description: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–æ–¥–∞—á–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞, —Ä–∞–±–æ—Ç–∞ —Å —Ä–µ—á—å—é –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞',
                defaultHours: 4,
                category: 'coaching',
                group: 'additional',
                difficulty: 'medium',
                hasCount: false,
                autoActivation: {
                    condition: 'video_content',
                    reason: '–í–∏–¥–µ–æ–∫–æ–Ω—Ç–µ–Ω—Ç —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Å–ø–∏–∫–µ—Ä–∞'
                },
                tags: ['–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–ø–∏–∫–µ—Ä–∞', '–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ –Ω–∞–≤—ã–∫–∏', '–≤–∏–¥–µ–æ–∑–∞–ø–∏—Å—å'],
                deliverables: ['–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è', '–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–∞—è –∑–∞–ø–∏—Å—å', '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é'],
                includes: ['–†–∞–±–æ—Ç–∞ —Å –≥–æ–ª–æ—Å–æ–º', '–Ø–∑—ã–∫ —Ç–µ–ª–∞', '–¢–µ—Ö–Ω–∏–∫–∞ —Ä–µ—á–∏', '–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –∫–∞–º–µ—Ä–æ–π']
            }
        };
    }

    /**
     * –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —É—Å–ª—É–≥ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
     */
    initializeServiceGroups() {
        return {
            knowledge_check: {
                name: '–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–Ω–∞–Ω–∏–π',
                description: '–¢–µ—Å—Ç—ã, –ø—Ä–æ–µ–∫—Ç—ã –∏ –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –æ–±—É—á–µ–Ω–∏—è',
                icon: 'üìã',
                services: ['currentTests', 'moduleProjects', 'finalAssessment']
            },
            additional: {
                name: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏',
                description: '–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –∞—É–¥–∏—Ç—ã –∏ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞',
                icon: '‚öôÔ∏è',
                services: ['research', 'audit', 'methodology', 'speakerPrep']
            }
        };
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
     */
    shouldHandleAction(actionType) {
        const handledActions = [
            'COMPONENT_TOGGLE',
            'SERVICE_TOGGLE',
            'CUSTOM_SERVICE_ADD',
            'CUSTOM_SERVICE_REMOVE',
            'PRESET_UPDATE',
            'COMPLEXITY_UPDATE'
        ];
        return handledActions.includes(actionType);
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è
     */
    handleStateChange(state, action) {
        try {
            switch (action.type) {
                case 'COMPONENT_TOGGLE':
                    this.handleComponentToggle(action.payload);
                    break;
                case 'SERVICE_TOGGLE':
                    this.handleServiceToggle(action.payload);
                    break;
                case 'PRESET_UPDATE':
                    this.checkServiceAutoActivation(state);
                    break;
                case 'COMPLEXITY_UPDATE':
                    this.recheckAutoActivation(state);
                    break;
            }
        } catch (error) {
            this.errors.handleError(error, { 
                context: 'ComponentManager.handleStateChange',
                action: action.type 
            });
        }
    }

    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
     */
    toggleComponent(componentId, enabled, config = {}) {
        try {
            const definition = this.componentDefinitions[componentId];
            if (!definition) {
                throw new Error(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç: ${componentId}`);
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            const validation = this.validateComponentConfig(componentId, config);
            if (!validation.isValid) {
                this.errors.showWarning(validation.error);
                return false;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            this.state.dispatch({
                type: 'COMPONENT_TOGGLE',
                payload: { componentId, enabled, config }
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            if (enabled) {
                this.checkComponentDependencies(componentId);
                this.errors.showSuccess(`–î–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç: ${definition.name}`);
            } else {
                this.errors.showInfo(`–£–¥–∞–ª–µ–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç: ${definition.name}`);
            }

            // –≠–º–∏—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ
            this.events.emit('components:toggled', {
                componentId,
                enabled,
                config,
                definition
            });

            return true;

        } catch (error) {
            this.errors.handleError(error, { context: 'ComponentManager.toggleComponent', componentId });
            return false;
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
     */
    updateComponentConfig(componentId, config) {
        try {
            const state = this.state.getState();
            if (!state.components[componentId]) {
                this.errors.showWarning('–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω');
                return false;
            }

            const validation = this.validateComponentConfig(componentId, config);
            if (!validation.isValid) {
                this.errors.showWarning(validation.error);
                return false;
            }

            this.state.dispatch({
                type: 'COMPONENT_TOGGLE',
                payload: { 
                    componentId, 
                    enabled: true, 
                    config: { ...state.components[componentId], ...config } 
                }
            });

            this.events.emit('components:config-updated', { componentId, config });
            return true;

        } catch (error) {
            this.errors.handleError(error, { context: 'ComponentManager.updateComponentConfig', componentId });
            return false;
        }
    }

    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ª—É–≥–∏
     */
    toggleService(serviceId, enabled, config = {}) {
        try {
            const definition = this.serviceDefinitions[serviceId];
            if (!definition) {
                throw new Error(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —É—Å–ª—É–≥–∞: ${serviceId}`);
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            const validation = this.validateServiceConfig(serviceId, config);
            if (!validation.isValid) {
                this.errors.showWarning(validation.error);
                return false;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            this.state.dispatch({
                type: 'SERVICE_TOGGLE',
                payload: { serviceId, enabled, config }
            });

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π
            if (enabled) {
                this.autoActivatedServices.delete(serviceId); // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª –≤—Ä—É—á–Ω—É—é
                this.errors.showSuccess(`–î–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å–ª—É–≥–∞: ${definition.name}`);
            } else {
                this.autoActivatedServices.delete(serviceId);
                this.errors.showInfo(`–£–¥–∞–ª–µ–Ω–∞ —É—Å–ª—É–≥–∞: ${definition.name}`);
            }

            // –≠–º–∏—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ
            this.events.emit('services:toggled', {
                serviceId,
                enabled,
                config,
                definition,
                isAutoActivated: this.autoActivatedServices.has(serviceId)
            });

            return true;

        } catch (error) {
            this.errors.handleError(error, { context: 'ComponentManager.toggleService', serviceId });
            return false;
        }
    }

    /**
     * –ê–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —É—Å–ª—É–≥–∏
     */
    autoActivateService(serviceId, reason, source) {
        try {
            const definition = this.serviceDefinitions[serviceId];
            if (!definition) {
                console.warn(`Unknown service for auto-activation: ${serviceId}`);
                return false;
            }

            const state = this.state.getState();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ —É–∂–µ —É—Å–ª—É–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
            if (state.services[serviceId]) {
                return false; // –£–∂–µ –∞–∫—Ç–∏–≤–Ω–∞
            }

            // –ê–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏—è
            this.autoActivatedServices.add(serviceId);
            
            this.state.dispatch({
                type: 'SERVICE_TOGGLE',
                payload: { 
                    serviceId, 
                    enabled: true, 
                    config: { 
                        hours: definition.defaultHours,
                        count: definition.hasCount ? 1 : undefined,
                        autoActivated: true,
                        reason,
                        source
                    }
                }
            });

            this.events.emit('services:auto-activated', {
                serviceId,
                reason,
                source,
                definition
            });

            return true;

        } catch (error) {
            this.errors.handleError(error, { context: 'ComponentManager.autoActivateService', serviceId });
            return false;
        }
    }

    /**
     * –£—Å–ª–æ–≤–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è —É—Å–ª—É–≥
     */
    conditionalActivateServices(data) {
        const { ruleId, shouldActivate, services, message } = data;
        
        services.forEach(serviceId => {
            const state = this.state.getState();
            const isCurrentlyAutoActivated = this.autoActivatedServices.has(serviceId);
            const isManuallyActivated = state.services[serviceId] && !isCurrentlyAutoActivated;

            if (shouldActivate && !isManuallyActivated && !isCurrentlyAutoActivated) {
                this.autoActivateService(serviceId, message, ruleId);
            } else if (!shouldActivate && isCurrentlyAutoActivated) {
                this.deactivateAutoService(serviceId);
            }
        });
    }

    /**
     * –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —É—Å–ª—É–≥–∏
     */
    deactivateAutoService(serviceId) {
        if (!this.autoActivatedServices.has(serviceId)) return false;

        this.autoActivatedServices.delete(serviceId);
        
        this.state.dispatch({
            type: 'SERVICE_TOGGLE',
            payload: { serviceId, enabled: false, config: {} }
        });

        this.events.emit('services:auto-deactivated', { serviceId });
        return true;
    }

    /**
     * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–π —É—Å–ª—É–≥–∏
     */
    addCustomService(serviceData) {
        try {
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
            const validation = this.validateCustomServiceData(serviceData);
            if (!validation.isValid) {
                this.errors.showWarning(validation.error);
                return false;
            }

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID
            this.customServiceCounter++;
            const customService = {
                id: `custom_${this.customServiceCounter}`,
                name: serviceData.name,
                description: serviceData.description || '',
                hours: serviceData.hours,
                count: serviceData.count,
                pricePerUnit: serviceData.pricePerUnit,
                category: 'custom',
                createdAt: Date.now()
            };

            this.state.dispatch({
                type: 'CUSTOM_SERVICE_ADD',
                payload: customService
            });

            this.errors.showSuccess(`–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–∞—Å—Ç–æ–º–Ω–∞—è —É—Å–ª—É–≥–∞: ${customService.name}`);
            this.events.emit('custom-services:added', customService);

            return customService;

        } catch (error) {
            this.errors.handleError(error, { context: 'ComponentManager.addCustomService' });
            return false;
        }
    }

    /**
     * –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–π —É—Å–ª—É–≥–∏
     */
    removeCustomService(serviceId) {
        try {
            const state = this.state.getState();
            const service = state.customServices.find(s => s.id === serviceId);
            
            if (!service) {
                this.errors.showWarning('–ö–∞—Å—Ç–æ–º–Ω–∞—è —É—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return false;
            }

            this.state.dispatch({
                type: 'CUSTOM_SERVICE_REMOVE',
                payload: { id: serviceId }
            });

            this.errors.showInfo(`–£–¥–∞–ª–µ–Ω–∞ –∫–∞—Å—Ç–æ–º–Ω–∞—è —É—Å–ª—É–≥–∞: ${service.name}`);
            this.events.emit('custom-services:removed', { id: serviceId, service });

            return true;

        } catch (error) {
            this.errors.handleError(error, { context: 'ComponentManager.removeCustomService', serviceId });
            return false;
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–π —É—Å–ª—É–≥–∏
     */
    updateCustomService(serviceId, updates) {
        try {
            const state = this.state.getState();
            const serviceIndex = state.customServices.findIndex(s => s.id === serviceId);
            
            if (serviceIndex === -1) {
                this.errors.showWarning('–ö–∞—Å—Ç–æ–º–Ω–∞—è —É—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return false;
            }

            const updatedService = { ...state.customServices[serviceIndex], ...updates };
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            const validation = this.validateCustomServiceData(updatedService);
            if (!validation.isValid) {
                this.errors.showWarning(validation.error);
                return false;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–∑ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π
            this.state.dispatch({
                type: 'CUSTOM_SERVICE_REMOVE',
                payload: { id: serviceId }
            });

            this.state.dispatch({
                type: 'CUSTOM_SERVICE_ADD',
                payload: updatedService
            });

            this.events.emit('custom-services:updated', { id: serviceId, service: updatedService });
            return true;

        } catch (error) {
            this.errors.handleError(error, { context: 'ComponentManager.updateCustomService', serviceId });
            return false;
        }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —É—Å–ª—É–≥ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    checkServiceAutoActivation(state) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–µ–æ—É—Ä–æ–∫–∏ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Å–ø–∏–∫–µ—Ä–∞
        const videoLessonCount = state.presets.videoLesson?.count || 0;
        if (videoLessonCount > 0) {
            this.autoActivateService('speakerPrep', '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã –≤–∏–¥–µ–æ—É—Ä–æ–∫–∏', 'preset_videoLesson');
        } else if (this.autoActivatedServices.has('speakerPrep')) {
            this.deactivateAutoService('speakerPrep');
        }
    }

    /**
     * –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
     */
    recheckAutoActivation(state) {
        const projectType = state.complexity.projectType || 1.0;
        
        // –ù–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ - –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∏ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
        if (projectType === 1.0) {
            this.autoActivateService('research', '–ù–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—Ä–µ–±—É–µ—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è', 'complexity_new_program');
            this.autoActivateService('methodology', '–ù–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—Ä–µ–±—É–µ—Ç –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤', 'complexity_new_program');
            
            // –£–±–∏—Ä–∞–µ–º –∞—É–¥–∏—Ç –µ—Å–ª–∏ –±—ã–ª –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
            if (this.autoActivatedServices.has('audit')) {
                this.deactivateAutoService('audit');
            }
        } else {
            // –î–æ—Ä–∞–±–æ—Ç–∫–∞ –∏–ª–∏ —á—É–∂–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ - –∞—É–¥–∏—Ç
            this.autoActivateService('audit', '–†–∞–±–æ—Ç–∞ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏', 'complexity_existing_program');
            
            // –£–±–∏—Ä–∞–µ–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∏ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –µ—Å–ª–∏ –±—ã–ª–∏ –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã
            if (this.autoActivatedServices.has('research')) {
                this.deactivateAutoService('research');
            }
            if (this.autoActivatedServices.has('methodology')) {
                this.deactivateAutoService('methodology');
            }
        }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
     */
    checkComponentDependencies(componentId) {
        const definition = this.componentDefinitions[componentId];
        if (!definition.dependencies) return;

        const state = this.state.getState();
        const missingDependencies = definition.dependencies.filter(depId => !state.components[depId]);

        if (missingDependencies.length > 0) {
            const depNames = missingDependencies.map(id => this.componentDefinitions[id]?.name || id);
            this.errors.showWarning(
                `–ö–æ–º–ø–æ–Ω–µ–Ω—Ç "${definition.name}" —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–º–µ—Å—Ç–µ —Å: ${depNames.join(', ')}`
            );
        }
    }

    /**
     * –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
     */
    validateComponentConfig(componentId, config) {
        const definition = this.componentDefinitions[componentId];
        if (!definition) {
            return { isValid: false, error: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç' };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø–æ–ª–µ–π
        if (config.hours !== undefined) {
            if (!Number.isFinite(config.hours) || config.hours <= 0) {
                return { isValid: false, error: '–í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º' };
            }
            if (config.hours > 100) {
                return { isValid: false, error: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è: 100 —á–∞—Å–æ–≤' };
            }
        }

        if (config.count !== undefined) {
            if (!Number.isInteger(config.count) || config.count <= 0) {
                return { isValid: false, error: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º' };
            }
            if (config.count > 100) {
                return { isValid: false, error: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: 100' };
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—ä–µ–º–Ω—ã—Ö –ø–æ–ª–µ–π
        if (definition.volumeFields) {
            Object.entries(definition.volumeFields).forEach(([fieldName, fieldDef]) => {
                const value = config[fieldName];
                if (value !== undefined) {
                    if (!Number.isFinite(value) || value < fieldDef.min || value > fieldDef.max) {
                        return { 
                            isValid: false, 
                            error: `${fieldDef.name}: –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç ${fieldDef.min} –¥–æ ${fieldDef.max}` 
                        };
                    }
                }
            });
        }

        return { isValid: true };
    }

    /**
     * –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É—Å–ª—É–≥–∏
     */
    validateServiceConfig(serviceId, config) {
        const definition = this.serviceDefinitions[serviceId];
        if (!definition) {
            return { isValid: false, error: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —É—Å–ª—É–≥–∞' };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
        if (config.hours !== undefined) {
            if (!Number.isFinite(config.hours) || config.hours <= 0) {
                return { isValid: false, error: '–í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º' };
            }
            if (config.hours > 100) {
                return { isValid: false, error: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è: 100 —á–∞—Å–æ–≤' };
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è —É—Å–ª—É–≥, –∫–æ—Ç–æ—Ä—ã–µ –µ–≥–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç
        if (definition.hasCount && config.count !== undefined) {
            if (!Number.isInteger(config.count) || config.count <= 0) {
                return { isValid: false, error: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º' };
            }
            if (config.count > 50) {
                return { isValid: false, error: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: 50' };
            }
        }

        return { isValid: true };
    }

    /**
     * –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–∞—Å—Ç–æ–º–Ω–æ–π —É—Å–ª—É–≥–∏
     */
    validateCustomServiceData(data) {
        if (!data.name || data.name.trim().length === 0) {
            return { isValid: false, error: '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏' };
        }

        if (data.name.length > 100) {
            return { isValid: false, error: '–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 100 —Å–∏–º–≤–æ–ª–æ–≤)' };
        }

        if (!Number.isFinite(data.hours) || data.hours <= 0) {
            return { isValid: false, error: '–í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º' };
        }

        if (data.hours > 500) {
            return { isValid: false, error: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è: 500 —á–∞—Å–æ–≤' };
        }

        if (!Number.isInteger(data.count) || data.count <= 0) {
            return { isValid: false, error: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º' };
        }

        if (data.count > 1000) {
            return { isValid: false, error: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: 1000' };
        }

        if (!Number.isFinite(data.pricePerUnit) || data.pricePerUnit <= 0) {
            return { isValid: false, error: '–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º' };
        }

        if (data.pricePerUnit > 1000000) {
            return { isValid: false, error: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞: 1,000,000 ‚ÇΩ' };
        }

        return { isValid: true };
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
     */
    handleComponentToggle(payload) {
        const { componentId, enabled } = payload;
        const definition = this.componentDefinitions[componentId];

        if (enabled && definition.relatedComponents) {
            // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            const state = this.state.getState();
            const notActiveRelated = definition.relatedComponents.filter(relId => !state.components[relId]);
            
            if (notActiveRelated.length > 0) {
                const relatedNames = notActiveRelated.map(id => this.componentDefinitions[id]?.name).join(', ');
                this.errors.showInfo(`–í–æ–∑–º–æ–∂–Ω–æ, –≤–∞–º —Ç–∞–∫–∂–µ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è: ${relatedNames}`);
            }
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —É—Å–ª—É–≥–∏
     */
    handleServiceToggle(payload) {
        const { serviceId, enabled } = payload;
        const definition = this.serviceDefinitions[serviceId];

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
        if (enabled && definition.relatedTo) {
            // –ú–æ–∂–µ–º –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —Å–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
        }
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º
     */
    getComponentRecommendations() {
        try {
            const state = this.state.getState();
            const recommendations = [];

            // –ê–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ—Å–µ—Ç–æ–≤
            const activePresets = Object.entries(state.presets)
                .filter(([_, data]) => data.count > 0)
                .map(([type, _]) => type);

            // –ê–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            const activeComponents = Object.keys(state.components);

            // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ—Å–µ—Ç–æ–≤
            activePresets.forEach(presetType => {
                const definition = this.componentDefinitions[presetType];
                if (definition && definition.linkedComponents) {
                    const missingComponents = definition.linkedComponents.filter(compId => !activeComponents.includes(compId));
                    
                    missingComponents.forEach(compId => {
                        const compDef = this.componentDefinitions[compId];
                        if (compDef) {
                            recommendations.push({
                                type: 'preset_complement',
                                priority: 'medium',
                                title: `–î–æ–±–∞–≤—å—Ç–µ ${compDef.name}`,
                                description: `–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–µ—Å–µ—Ç–∞ "${this.presetDefinitions?.[presetType]?.name || presetType}"`,
                                componentId: compId,
                                reason: `preset_${presetType}`
                            });
                        }
                    });
                }
            });

            // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            activeComponents.forEach(compId => {
                const definition = this.componentDefinitions[compId];
                if (definition && definition.dependencies) {
                    const missingDeps = definition.dependencies.filter(depId => !activeComponents.includes(depId));
                    
                    missingDeps.forEach(depId => {
                        const depDef = this.componentDefinitions[depId];
                        if (depDef) {
                            recommendations.push({
                                type: 'dependency',
                                priority: 'high',
                                title: `–î–æ–±–∞–≤—å—Ç–µ ${depDef.name}`,
                                description: `–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ "${definition.name}"`,
                                componentId: depId,
                                reason: `dependency_${compId}`
                            });
                        }
                    });
                }
            });

            // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
            const uniqueRecommendations = recommendations.filter((rec, index, self) => 
                index === self.findIndex(r => r.componentId === rec.componentId)
            );

            this.events.emit('components:recommendations-generated', uniqueRecommendations);
            return uniqueRecommendations;

        } catch (error) {
            this.errors.handleError(error, { context: 'ComponentManager.getComponentRecommendations' });
            return [];
        }
    }

    /**
     * –ü–æ–∏—Å–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏ —É—Å–ª—É–≥
     */
    search(query, type = 'all') {
        const searchText = query.toLowerCase();
        const results = { components: [], services: [] };

        if (type === 'all' || type === 'components') {
            results.components = Object.values(this.componentDefinitions).filter(comp => {
                return comp.name.toLowerCase().includes(searchText) ||
                       comp.description.toLowerCase().includes(searchText) ||
                       comp.tags.some(tag => tag.toLowerCase().includes(searchText));
            });
        }

        if (type === 'all' || type === 'services') {
            results.services = Object.values(this.serviceDefinitions).filter(service => {
                return service.name.toLowerCase().includes(searchText) ||
                       service.description.toLowerCase().includes(searchText) ||
                       service.tags.some(tag => tag.toLowerCase().includes(searchText));
            });
        }

        return results;
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
     */
    getComponentsByCategory(category = null) {
        if (!category) {
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            const grouped = {};
            Object.values(this.componentDefinitions).forEach(comp => {
                if (!grouped[comp.category]) {
                    grouped[comp.category] = [];
                }
                grouped[comp.category].push(comp);
            });
            return grouped;
        }

        return Object.values(this.componentDefinitions).filter(comp => comp.category === category);
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —É—Å–ª—É–≥ –ø–æ –≥—Ä—É–ø–ø–∞–º
     */
    getServicesByGroup(groupId = null) {
        if (!groupId) {
            return this.serviceGroups;
        }

        const group = this.serviceGroups[groupId];
        if (!group) return null;

        return {
            ...group,
            services: group.services.map(serviceId => this.serviceDefinitions[serviceId]).filter(Boolean)
        };
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
     */
    getUsageStatistics() {
        const state = this.state.getState();

        const componentStats = {
            total: Object.keys(this.componentDefinitions).length,
            active: Object.keys(state.components).length,
            byCategory: {}
        };

        const serviceStats = {
            total: Object.keys(this.serviceDefinitions).length,
            active: Object.keys(state.services).length,
            autoActivated: this.autoActivatedServices.size,
            byGroup: {}
        };

        const customStats = {
            total: state.customServices.length,
            totalCost: state.customServices.reduce((sum, service) => sum + (service.pricePerUnit * service.count), 0),
            totalHours: state.customServices.reduce((sum, service) => sum + (service.hours * service.count), 0)
        };

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        Object.values(this.componentDefinitions).forEach(comp => {
            componentStats.byCategory[comp.category] = (componentStats.byCategory[comp.category] || 0) + 1;
        });

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥—Ä—É–ø–ø–∞–º —É—Å–ª—É–≥
        Object.entries(this.serviceGroups).forEach(([groupId, group]) => {
            const activeInGroup = group.services.filter(serviceId => state.services[serviceId]).length;
            serviceStats.byGroup[groupId] = {
                total: group.services.length,
                active: activeInGroup,
                name: group.name
            };
        });

        return {
            components: componentStats,
            services: serviceStats,
            custom: customStats,
            autoActivatedList: Array.from(this.autoActivatedServices)
        };
    }

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
     */
    exportConfiguration() {
        return {
            components: this.componentDefinitions,
            services: this.serviceDefinitions,
            serviceGroups: this.serviceGroups,
            currentState: {
                components: this.state.getState().components,
                services: this.state.getState().services,
                customServices: this.state.getState().customServices
            },
            autoActivatedServices: Array.from(this.autoActivatedServices)
        };
    }

    /**
     * –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
     */
    importConfiguration(config) {
        try {
            if (config.components) {
                this.componentDefinitions = { ...this.componentDefinitions, ...config.components };
            }

            if (config.services) {
                this.serviceDefinitions = { ...this.serviceDefinitions, ...config.services };
            }

            if (config.serviceGroups) {
                this.serviceGroups = { ...this.serviceGroups, ...config.serviceGroups };
            }

            if (config.autoActivatedServices) {
                this.autoActivatedServices = new Set(config.autoActivatedServices);
            }

            this.events.emit('components:config-imported', config);
            this.errors.showSuccess('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏ —É—Å–ª—É–≥ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞');

        } catch (error) {
            this.errors.handleError(error, { context: 'ComponentManager.importConfiguration' });
        }
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
     */
    getComponentDetails(componentId) {
        const definition = this.componentDefinitions[componentId];
        if (!definition) return null;

        const state = this.state.getState();
        const isActive = !!state.components[componentId];
        const config = state.components[componentId] || {};

        return {
            definition,
            isActive,
            config,
            dependencies: definition.dependencies?.map(id => this.componentDefinitions[id]) || [],
            relatedComponents: definition.relatedComponents?.map(id => this.componentDefinitions[id]) || [],
            presetUsage: definition.presetTags || []
        };
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å–ª—É–≥–µ
     */
    getServiceDetails(serviceId) {
        const definition = this.serviceDefinitions[serviceId];
        if (!definition) return null;

        const state = this.state.getState();
        const isActive = !!state.services[serviceId];
        const isAutoActivated = this.autoActivatedServices.has(serviceId);
        const config = state.services[serviceId] || {};

        return {
            definition,
            isActive,
            isAutoActivated,
            config,
            group: Object.entries(this.serviceGroups).find(([_, group]) => 
                group.services.includes(serviceId)
            )?.[0] || null
        };
    }

    /**
     * –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
     */
    validateConfiguration() {
        const errors = [];
        const warnings = [];
        const state = this.state.getState();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        Object.entries(state.components).forEach(([componentId, config]) => {
            const validation = this.validateComponentConfig(componentId, config);
            if (!validation.isValid) {
                errors.push(`–ö–æ–º–ø–æ–Ω–µ–Ω—Ç ${componentId}: ${validation.error}`);
            }
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª—É–≥
        Object.entries(state.services).forEach(([serviceId, config]) => {
            const validation = this.validateServiceConfig(serviceId, config);
            if (!validation.isValid) {
                errors.push(`–£—Å–ª—É–≥–∞ ${serviceId}: ${validation.error}`);
            }
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —É—Å–ª—É–≥
        state.customServices.forEach(service => {
            const validation = this.validateCustomServiceData(service);
            if (!validation.isValid) {
                errors.push(`–ö–∞—Å—Ç–æ–º–Ω–∞—è —É—Å–ª—É–≥–∞ ${service.name}: ${validation.error}`);
            }
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        Object.keys(state.components).forEach(componentId => {
            const definition = this.componentDefinitions[componentId];
            if (definition && definition.dependencies) {
                const missingDeps = definition.dependencies.filter(depId => !state.components[depId]);
                if (missingDeps.length > 0) {
                    warnings.push(`–ö–æ–º–ø–æ–Ω–µ–Ω—Ç ${definition.name} —Ç—Ä–µ–±—É–µ—Ç: ${missingDeps.join(', ')}`);
                }
            }
        });

        return { errors, warnings };
    }

    /**
     * –°–±—Ä–æ—Å –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏ —É—Å–ª—É–≥
     */
    resetAll() {
        try {
            const state = this.state.getState();

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            Object.keys(state.components).forEach(componentId => {
                this.state.dispatch({
                    type: 'COMPONENT_TOGGLE',
                    payload: { componentId, enabled: false, config: {} }
                });
            });

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —É—Å–ª—É–≥–∏
            Object.keys(state.services).forEach(serviceId => {
                this.state.dispatch({
                    type: 'SERVICE_TOGGLE',
                    payload: { serviceId, enabled: false, config: {} }
                });
            });

            // –û—á–∏—â–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ —É—Å–ª—É–≥–∏
            state.customServices.forEach(service => {
                this.state.dispatch({
                    type: 'CUSTOM_SERVICE_REMOVE',
                    payload: { id: service.id }
                });
            });

            // –û—á–∏—â–∞–µ–º –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏—é
            this.autoActivatedServices.clear();

            this.events.emit('components:all-reset');
            this.errors.showInfo('–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ —É—Å–ª—É–≥–∏ —Å–±—Ä–æ—à–µ–Ω—ã');

        } catch (error) {
            this.errors.handleError(error, { context: 'ComponentManager.resetAll' });
        }
    }

    /**
     * –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –º–æ–¥—É–ª—è
     */
    destroy() {
        // –û—Ç–ø–∏—Å–∫–∞ –æ—Ç —Å–æ–±—ã—Ç–∏–π
        this.events.off('components:toggle');
        this.events.off('components:update-config');
        this.events.off('services:toggle');
        this.events.off('services:auto-activate');
        this.events.off('services:conditional-activate');
        this.events.off('custom-services:add');
        this.events.off('custom-services:remove');
        this.events.off('custom-services:update');

        // –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        this.autoActivatedServices.clear();
        
        console.log('üß© ComponentManager destroyed');
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
if (typeof module !== 'undefined' && module.exports) {
    module.exports = ComponentManager;
} else if (typeof window !== 'undefined') {
    window.ComponentManager = ComponentManager;
}

        /**
 * UIManager.js - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
 * –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
 */

class UIManager {
    constructor(stateManager, eventBus, errorHandler, pricingEngine, presetManager, componentManager) {
        this.state = stateManager;
        this.events = eventBus;
        this.errors = errorHandler;
        this.pricing = pricingEngine;
        this.presets = presetManager;
        this.components = componentManager;
        
        this.sections = {};
        this.templates = {};
        this.animationQueue = [];
        this.updateThrottlers = new Map();
        this.currentTheme = 'light';
        this.isMobile = this.detectMobile();
        
        this.init();
        console.log('üé® UIManager initialized');
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è
     */
    init() {
        // –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        this.initializeSections();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω—ã
        this.initializeTemplates();
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        this.setupEventListeners();
        
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
        this.state.subscribe((state, action) => {
            this.handleStateChange(state, action);
        });

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π
        this.setupModuleEvents();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        this.renderInitialInterface();
        
        console.log('UIManager setup complete');
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ–∫—Ü–∏–π
     */
    initializeSections() {
        this.sections = {
            header: {
                element: null,
                visible: true,
                components: ['title', 'description', 'status']
            },
            sidebar: {
                element: null,
                visible: !this.isMobile,
                components: ['navigation', 'quick-actions', 'templates']
            },
            mainContent: {
                element: null,
                visible: true,
                components: ['pricing-settings', 'presets', 'components', 'services']
            },
            resultsPanel: {
                element: null,
                visible: true,
                components: ['summary', 'breakdown', 'composition', 'export']
            },
            footer: {
                element: null,
                visible: true,
                components: ['validation', 'actions', 'dev-info']
            }
        };
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤
     */
    initializeTemplates() {
        this.templates = {
            // –®–∞–±–ª–æ–Ω –¥–ª—è –ø—Ä–µ—Å–µ—Ç–∞
            presetCard: `
                <div class="preset-item" data-preset="{{presetType}}" data-active="{{isActive}}">
                    <div class="preset-header">
                        <div class="preset-icon">{{icon}}</div>
                        <div class="preset-title">{{name}}</div>
                        <div class="preset-price" id="{{presetType}}Price">{{price}}</div>
                    </div>
                    <div class="preset-description">{{description}}</div>
                    <div class="preset-includes">
                        <div class="preset-includes-title">–ë–∞–∑–æ–≤–æ –≤–∫–ª—é—á–∞–µ—Ç:</div>
                        <div class="preset-includes-list">{{includes}}</div>
                    </div>
                    <div class="preset-controls">
                        <div class="preset-quantity">
                            <label class="preset-quantity-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                            <input type="number" class="preset-quantity-input" 
                                   id="{{presetType}}Preset" value="{{count}}" 
                                   min="0" max="100" data-preset="{{presetType}}">
                        </div>
                        <div class="preset-quantity">
                            <label class="preset-quantity-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω):</label>
                            <input type="number" class="preset-quantity-input" 
                                   id="{{presetType}}Duration" value="{{duration}}" 
                                   min="{{minDuration}}" max="{{maxDuration}}" 
                                   data-preset="{{presetType}}">
                        </div>
                    </div>
                    {{#if tags}}
                    <div class="preset-tags">
                        {{#each tags}}
                        <span class="preset-tag {{../presetType}}">{{this}}</span>
                        {{/each}}
                    </div>
                    {{/if}}
                </div>
            `,

            // –®–∞–±–ª–æ–Ω –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
            componentCard: `
                <div class="component-item" data-component="{{componentId}}" data-active="{{isActive}}">
                    <div class="component-header">
                        <input type="checkbox" id="{{componentId}}" {{#if isActive}}checked{{/if}}>
                        <div class="component-icon">{{icon}}</div>
                        <div class="component-title">{{name}}</div>
                        <div class="component-price" id="{{componentId}}Price">{{price}}</div>
                    </div>
                    <div class="component-description">{{description}}</div>
                    {{#if presetTags}}
                    <div class="preset-tags">
                        {{#each presetTags}}
                        <span class="preset-tag {{this}}">{{../name}}</span>
                        {{/each}}
                    </div>
                    {{/if}}
                    <div class="component-controls {{#unless isActive}}hidden{{/unless}}">
                        <div class="component-quantity">
                            <label>–í—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (—á):</label>
                            <input type="number" id="{{componentId}}Hours" value="{{hours}}" 
                                   min="0.1" max="100" step="0.1" data-component="{{componentId}}">
                        </div>
                        <div class="component-quantity">
                            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                            <input type="number" id="{{componentId}}Count" value="{{count}}" 
                                   min="1" max="100" data-component="{{componentId}}">
                        </div>
                        {{#if volumeFields}}
                        {{#each volumeFields}}
                        <div class="component-quantity">
                            <label>{{name}}:</label>
                            <input type="number" id="{{../componentId}}{{@key}}" value="{{default}}" 
                                   min="{{min}}" max="{{max}}" step="{{step}}" 
                                   data-component="{{../componentId}}" data-field="{{@key}}">
                        </div>
                        {{/each}}
                        {{/if}}
                    </div>
                </div>
            `,

            // –®–∞–±–ª–æ–Ω –¥–ª—è —É—Å–ª—É–≥–∏
            serviceCard: `
                <div class="service-item" data-service="{{serviceId}}" data-active="{{isActive}}" 
                     data-auto="{{isAutoActivated}}">
                    <div class="service-header">
                        <input type="checkbox" id="{{serviceId}}" {{#if isActive}}checked{{/if}}>
                        <div class="service-icon">{{icon}}</div>
                        <div class="service-title">
                            {{name}}
                            {{#if isAutoActivated}}
                            <span class="auto-selected-label">–ê–í–¢–û</span>
                            {{/if}}
                        </div>
                        <div class="service-hours" id="{{serviceId}}HoursDisplay">{{hours}}—á{{#if hasCount}}/—à—Ç{{/if}}</div>
                    </div>
                    <div class="service-description">{{description}}</div>
                    <div class="service-controls {{#unless isActive}}hidden{{/unless}}">
                        <div class="quantity-input-group">
                            <label>–í—Ä–µ–º—è (—á):</label>
                            <input type="number" id="{{serviceId}}Hours" value="{{hours}}" 
                                   min="0.1" max="100" step="0.1" data-service="{{serviceId}}">
                        </div>
                        {{#if hasCount}}
                        <div class="quantity-input-group">
                            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                            <input type="number" id="{{serviceId}}Count" value="{{count}}" 
                                   min="1" max="50" data-service="{{serviceId}}">
                        </div>
                        {{/if}}
                    </div>
                </div>
            `,

            // –®–∞–±–ª–æ–Ω –∫–∞—Å—Ç–æ–º–Ω–æ–π —É—Å–ª—É–≥–∏
            customServiceCard: `
                <div class="service-item custom-service" data-custom-id="{{id}}">
                    <div class="service-header">
                        <div class="service-icon">‚öôÔ∏è</div>
                        <div class="service-title">{{name}}</div>
                        <div class="service-cost">{{totalCost}} ‚ÇΩ</div>
                    </div>
                    <div class="service-description">{{description}}</div>
                    <div class="service-details">
                        <span>{{hours}}—á √ó {{count}}—à—Ç = {{pricePerUnit}} ‚ÇΩ/—à—Ç</span>
                        <button class="remove-custom-service" data-id="{{id}}">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `,

            // –®–∞–±–ª–æ–Ω —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            notification: `
                <div class="notification {{type}}" data-id="{{id}}">
                    <div class="notification-header">
                        <div class="notification-icon">{{icon}}</div>
                        <div class="notification-title">{{title}}</div>
                        <button class="notification-close" data-id="{{id}}">&times;</button>
                    </div>
                    {{#if message}}
                    <div class="notification-message">{{message}}</div>
                    {{/if}}
                    {{#if actions}}
                    <div class="notification-actions">
                        {{#each actions}}
                        <button class="notification-action {{type}}" data-action="{{action}}" 
                                data-notification="{{../id}}">{{label}}</button>
                        {{/each}}
                    </div>
                    {{/if}}
                </div>
            `,

            // –®–∞–±–ª–æ–Ω –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
            quickAction: `
                <div class="quick-action" data-action="{{action}}">
                    <div class="quick-action-icon">{{icon}}</div>
                    <div class="quick-action-label">{{label}}</div>
                    {{#if badge}}
                    <div class="quick-action-badge">{{badge}}</div>
                    {{/if}}
                </div>
            `
        };
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑–æ–≤—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
     */
    setupEventListeners() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        document.addEventListener('change', (e) => this.handleInputChange(e));
        document.addEventListener('click', (e) => this.handleClick(e));
        document.addEventListener('input', (e) => this.handleInputUpdate(e));
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        document.addEventListener('keydown', (e) => this.handleKeyboardShortcuts(e));
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', this.throttle(() => this.handleResize(), 250));
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ touch —Å–æ–±—ã—Ç–∏–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        if (this.isMobile) {
            document.addEventListener('touchstart', (e) => this.handleTouch(e), { passive: true });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('visibilitychange', () => this.handleVisibilityChange());
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–±—ã—Ç–∏–π –æ—Ç –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π
     */
    setupModuleEvents() {
        // –°–æ–±—ã—Ç–∏—è –æ—Ç PricingEngine
        this.events.on('pricing:updated', (data) => this.updatePricingDisplay(data));
        this.events.on('pricing:presets-updated', (prices) => this.updatePresetPrices(prices));
        this.events.on('pricing:components-updated', (prices) => this.updateComponentPrices(prices));
        
        // –°–æ–±—ã—Ç–∏—è –æ—Ç PresetManager
        this.events.on('presets:updated', (data) => this.updatePresetCard(data));
        this.events.on('presets:template-applied', (data) => this.showTemplateAppliedFeedback(data));
        this.events.on('presets:suggestions-generated', (suggestions) => this.showSuggestions(suggestions));
        
        // –°–æ–±—ã—Ç–∏—è –æ—Ç ComponentManager
        this.events.on('components:toggled', (data) => this.updateComponentCard(data));
        this.events.on('services:toggled', (data) => this.updateServiceCard(data));
        this.events.on('services:auto-activated', (data) => this.showAutoActivationFeedback(data));
        this.events.on('custom-services:added', (service) => this.addCustomServiceCard(service));
        this.events.on('custom-services:removed', (data) => this.removeCustomServiceCard(data.id));
        
        // –°–æ–±—ã—Ç–∏—è –æ—Ç ErrorHandler
        this.events.on('error:occurred', (error) => this.showErrorNotification(error));
        
        // –°–æ–±—ã—Ç–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        this.events.on('loading:start', (data) => this.showLoadingState(data));
        this.events.on('loading:end', (data) => this.hideLoadingState(data));
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
     */
    renderInitialInterface() {
        try {
            // –†–µ–Ω–¥–µ—Ä–∏–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–µ–∫—Ü–∏–∏
            this.renderPricingSettings();
            this.renderPresets();
            this.renderComponents();
            this.renderServices();
            this.renderCustomServices();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å
            this.updateResponsiveLayout();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            this.initializeInteractiveElements();
            
            this.events.emit('ui:initial-render-complete');
            
        } catch (error) {
            this.errors.handleError(error, { context: 'UIManager.renderInitialInterface' });
        }
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
     */
    renderPricingSettings() {
        const state = this.state.getState();
        const container = document.getElementById('pricingSettingsContainer');
        
        if (!container) {
            console.warn('Pricing settings container not found');
            return;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏ –º–µ—Ç–æ–¥–∞ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
        const methodRadios = container.querySelectorAll('input[name="pricingMethod"]');
        methodRadios.forEach(radio => {
            radio.checked = radio.value === state.pricing.method;
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
        const detailRadios = container.querySelectorAll('input[name="detailLevel"]');
        detailRadios.forEach(radio => {
            radio.checked = radio.value === state.pricing.detailLevel;
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —á–∞—Å–æ–≤—É—é —Å—Ç–∞–≤–∫—É
        const hourlyRateInput = document.getElementById('hourlyRate');
        if (hourlyRateInput) {
            hourlyRateInput.value = state.pricing.hourlyRate;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
        this.updatePricingVisibility(state.pricing);
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    renderPresets() {
        const state = this.state.getState();
        const container = document.getElementById('presetsContainer');
        
        if (!container) {
            console.warn('Presets container not found');
            return;
        }

        container.innerHTML = '';
        
        Object.entries(this.presets.presetDefinitions).forEach(([presetType, definition]) => {
            const presetData = state.presets[presetType] || { count: 0, duration: definition.defaultDuration };
            const isActive = presetData.count > 0;
            
            const cardHtml = this.renderTemplate('presetCard', {
                presetType,
                ...definition,
                ...presetData,
                isActive,
                price: this.formatPrice(this.calculatePresetPrice(presetType, presetData)),
                includes: definition.includes.join(' + '),
                minDuration: definition.minDuration,
                maxDuration: definition.maxDuration
            });
            
            container.insertAdjacentHTML('beforeend', cardHtml);
        });

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–µ—Å–µ—Ç–æ–≤
        this.setupPresetInteractivity(container);
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
     */
    renderComponents() {
        const state = this.state.getState();
        const container = document.getElementById('componentsContainer');
        
        if (!container) {
            console.warn('Components container not found');
            return;
        }

        container.innerHTML = '';
        
        Object.entries(this.components.componentDefinitions).forEach(([componentId, definition]) => {
            const componentData = state.components[componentId];
            const isActive = !!componentData;
            
            const cardHtml = this.renderTemplate('componentCard', {
                componentId,
                ...definition,
                isActive,
                hours: componentData?.hours || definition.defaultHours,
                count: componentData?.count || 1,
                price: this.formatPrice(this.calculateComponentPrice(componentId, componentData)),
                ...componentData
            });
            
            container.insertAdjacentHTML('beforeend', cardHtml);
        });

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        this.setupComponentInteractivity(container);
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —É—Å–ª—É–≥
     */
    renderServices() {
        const state = this.state.getState();
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –ø–æ –≥—Ä—É–ø–ø–∞–º
        Object.entries(this.components.serviceGroups).forEach(([groupId, group]) => {
            const container = document.getElementById(`${groupId}Container`);
            if (!container) return;
            
            container.innerHTML = '';
            
            group.services.forEach(serviceId => {
                const definition = this.components.serviceDefinitions[serviceId];
                if (!definition) return;
                
                const serviceData = state.services[serviceId];
                const isActive = !!serviceData;
                const isAutoActivated = this.components.autoActivatedServices.has(serviceId);
                
                const cardHtml = this.renderTemplate('serviceCard', {
                    serviceId,
                    ...definition,
                    isActive,
                    isAutoActivated,
                    hours: serviceData?.hours || definition.defaultHours,
                    count: serviceData?.count || 1,
                    ...serviceData
                });
                
                container.insertAdjacentHTML('beforeend', cardHtml);
            });
        });

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É—Å–ª—É–≥
        this.setupServiceInteractivity();
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —É—Å–ª—É–≥
     */
    renderCustomServices() {
        const state = this.state.getState();
        const container = document.getElementById('customServicesContainer');
        
        if (!container) {
            console.warn('Custom services container not found');
            return;
        }

        const listContainer = container.querySelector('#customServicesList');
        if (!listContainer) return;
        
        listContainer.innerHTML = '';
        
        state.customServices.forEach(service => {
            const cardHtml = this.renderTemplate('customServiceCard', {
                ...service,
                totalCost: this.formatNumber(service.pricePerUnit * service.count),
                pricePerUnit: this.formatNumber(service.pricePerUnit)
            });
            
            listContainer.insertAdjacentHTML('beforeend', cardHtml);
        });

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —É—Å–ª—É–≥
        this.setupCustomServiceInteractivity(listContainer);
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    setupPresetInteractivity(container) {
        // –ö–ª–∏–∫–∏ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–∞–º –ø—Ä–µ—Å–µ—Ç–æ–≤
        container.querySelectorAll('.preset-item').forEach(card => {
            const presetType = card.dataset.preset;
            
            card.addEventListener('click', (e) => {
                if (e.target.tagName === 'INPUT') return; // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ input –ø–æ–ª—è–º
                
                const countInput = card.querySelector(`#${presetType}Preset`);
                if (countInput) {
                    const currentCount = parseInt(countInput.value) || 0;
                    const newCount = currentCount === 0 ? 1 : 0;
                    
                    this.updatePresetQuantity(presetType, newCount);
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ input –ø–æ–ª—è—Ö
            card.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', (e) => {
                    e.stopPropagation();
                    this.handlePresetInputChange(presetType, input);
                });
            });
        });
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
     */
    setupComponentInteractivity(container) {
        container.querySelectorAll('.component-item').forEach(card => {
            const componentId = card.dataset.component;
            
            card.addEventListener('click', (e) => {
                if (e.target.tagName === 'INPUT') return;
                
                const checkbox = card.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    this.toggleComponent(componentId, !checkbox.checked);
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–±–æ–∫—Å–∞
            const checkbox = card.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    this.toggleComponent(componentId, checkbox.checked);
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö input –ø–æ–ª–µ–π
            card.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    e.stopPropagation();
                    this.handleComponentInputChange(componentId, input);
                });
            });
        });
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —É—Å–ª—É–≥
     */
    setupServiceInteractivity() {
        document.querySelectorAll('.service-item').forEach(card => {
            const serviceId = card.dataset.service;
            if (!serviceId) return;
            
            card.addEventListener('click', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
                
                const checkbox = card.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    this.toggleService(serviceId, !checkbox.checked);
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–±–æ–∫—Å–∞
            const checkbox = card.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    this.toggleService(serviceId, checkbox.checked);
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ input –ø–æ–ª–µ–π
            card.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    e.stopPropagation();
                    this.handleServiceInputChange(serviceId, input);
                });
            });
        });
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —É—Å–ª—É–≥
     */
    setupCustomServiceInteractivity(container) {
        // –ö–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
        container.querySelectorAll('.remove-custom-service').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const serviceId = button.dataset.id;
                this.events.emit('custom-services:remove', { id: serviceId });
            });
        });
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è
     */
    handleStateChange(state, action) {
        try {
            // –¢—Ä–æ—Ç—Ç–ª–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            const updateKey = action.type;
            
            if (this.updateThrottlers.has(updateKey)) {
                clearTimeout(this.updateThrottlers.get(updateKey));
            }
            
            this.updateThrottlers.set(updateKey, setTimeout(() => {
                this.performStateUpdate(state, action);
                this.updateThrottlers.delete(updateKey);
            }, 50));
            
        } catch (error) {
            this.errors.handleError(error, { context: 'UIManager.handleStateChange', action: action.type });
        }
    }

    /**
     * –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
     */
    performStateUpdate(state, action) {
        switch (action.type) {
            case 'PRICING_UPDATE':
                this.updatePricingSettings(state.pricing);
                break;
            case 'PRESET_UPDATE':
                this.updatePresetDisplay(action.payload.presetType, state.presets[action.payload.presetType]);
                break;
            case 'COMPONENT_TOGGLE':
                this.updateComponentDisplay(action.payload.componentId, action.payload.enabled, action.payload.config);
                break;
            case 'SERVICE_TOGGLE':
                this.updateServiceDisplay(action.payload.serviceId, action.payload.enabled, action.payload.config);
                break;
            case 'RESULTS_UPDATE':
                this.updateResultsDisplay(state.results);
                break;
            case 'UI_UPDATE':
                this.updateUIState(state.ui);
                break;
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π input –ø–æ–ª–µ–π
     */
    handleInputChange(e) {
        const { target } = e;
        
        try {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫
            if (target.type === 'radio') {
                if (target.name === 'pricingMethod') {
                    this.events.emit('pricing:method-changed', target.value);
                } else if (target.name === 'detailLevel') {
                    this.events.emit('pricing:detail-level-changed', target.value);
                }
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–±–æ–∫—Å–æ–≤
            if (target.type === 'checkbox') {
                this.handleCheckboxChange(target);
            }
            
        } catch (error) {
            this.errors.handleError(error, { context: 'UIManager.handleInputChange' });
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤
     */
    handleClick(e) {
        const { target } = e;
        
        try {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
            if (target.matches('[data-action]')) {
                const action = target.dataset.action;
                this.handleActionClick(action, target);
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            if (target.matches('.notification-close')) {
                const notificationId = target.dataset.id;
                this.hideNotification(notificationId);
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
            if (target.matches('.quick-action')) {
                const action = target.dataset.action;
                this.handleQuickAction(action);
            }
            
        } catch (error) {
            this.errors.handleError(error, { context: 'UIManager.handleClick' });
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω—ã—Ö —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π
     */
    handleKeyboardShortcuts(e) {
        // Ctrl/Cmd + S - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            this.events.emit('storage:save-current');
        }
        
        // Ctrl/Cmd + Z - –æ—Ç–º–µ–Ω–∞
        if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
            e.preventDefault();
            this.state.undo();
        }
        
        // Escape - –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        if (e.key === 'Escape') {
            this.closeModals();
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
     */
    handleResize() {
        this.isMobile = this.detectMobile();
        this.updateResponsiveLayout();
        this.events.emit('ui:resize', { isMobile: this.isMobile });
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –º–∞–∫–µ—Ç–∞
     */
    updateResponsiveLayout() {
        document.body.classList.toggle('mobile', this.isMobile);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Å–∞–π–¥–±–∞—Ä–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
        if (this.sections.sidebar.element) {
            this.sections.sidebar.visible = !this.isMobile;
            this.sections.sidebar.element.style.display = this.sections.sidebar.visible ? 'block' : 'none';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ç–∫—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        const contentGrid = document.querySelector('.content');
        if (contentGrid) {
            contentGrid.style.gridTemplateColumns = this.isMobile ? '1fr' : '1fr 400px';
        }
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
     */
    detectMobile() {
        return window.innerWidth <= 768 || 
               /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —à–∞–±–ª–æ–Ω–∞
     */
    renderTemplate(templateName, data) {
        let template = this.templates[templateName];
        if (!template) {
            console.warn(`Template ${templateName} not found`);
            return '';
        }

        // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π template engine)
        return template.replace(/\{\{(\w+)\}\}/g, (match, key) => {
            return data[key] !== undefined ? data[key] : '';
        }).replace(/\{\{#if (\w+)\}\}(.*?)\{\{\/if\}\}/gs, (match, condition, content) => {
            return data[condition] ? content : '';
        }).replace(/\{\{#unless (\w+)\}\}(.*?)\{\{\/unless\}\}/gs, (match, condition, content) => {
            return !data[condition] ? content : '';
        }).replace(/\{\{#each (\w+)\}\}(.*?)\{\{\/each\}\}/gs, (match, arrayName, itemTemplate) => {
            const array = data[arrayName];
            if (!Array.isArray(array)) return '';
            
            return array.map(item => {
                return itemTemplate.replace(/\{\{this\}\}/g, item)
                                 .replace(/\{\{(\w+)\}\}/g, (m, key) => item[key] || '');
            }).join('');
        });
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–µ—Å–µ—Ç–∞
     */
    updatePresetDisplay(presetType, presetData) {
        const card = document.querySelector(`[data-preset="${presetType}"]`);
        if (!card) return;

        const countInput = card.querySelector(`#${presetType}Preset`);
        const durationInput = card.querySelector(`#${presetType}Duration`);
        const priceDisplay = card.querySelector(`#${presetType}Price`);

        if (countInput) countInput.value = presetData.count;
        if (durationInput) durationInput.value = presetData.duration;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        card.dataset.active = presetData.count > 0;
        card.classList.toggle('active', presetData.count > 0);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É
        if (priceDisplay) {
            const price = this.calculatePresetPrice(presetType, presetData);
            priceDisplay.textContent = this.formatPrice(price);
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è
        this.animateCardUpdate(card);
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
     */
    updateComponentDisplay(componentId, enabled, config) {
        const card = document.querySelector(`[data-component="${componentId}"]`);
        if (!card) return;

        const checkbox = card.querySelector('input[type="checkbox"]');
        const controls = card.querySelector('.component-controls');
        const priceDisplay = card.querySelector(`#${componentId}Price`);

        if (checkbox) checkbox.checked = enabled;
        if (controls) {
            controls.classList.toggle('hidden', !enabled);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ controls
            if (enabled && config) {
                Object.entries(config).forEach(([key, value]) => {
                    const input = controls.querySelector(`#${componentId}${key.charAt(0).toUpperCase() + key.slice(1)}`);
                    if (input) input.value = value;
                });
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É
        if (priceDisplay) {
            const price = enabled ? this.calculateComponentPrice(componentId, config) : 0;
            priceDisplay.textContent = this.formatPrice(price);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        card.dataset.active = enabled;
        card.classList.toggle('selected', enabled);

        // –ê–Ω–∏–º–∞—Ü–∏—è
        this.animateCardUpdate(card);
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—Å–ª—É–≥–∏
     */
    updateServiceDisplay(serviceId, enabled, config) {
        const card = document.querySelector(`[data-service="${serviceId}"]`);
        if (!card) return;

        const checkbox = card.querySelector('input[type="checkbox"]');
        const controls = card.querySelector('.service-controls');
        const hoursDisplay = card.querySelector(`#${serviceId}HoursDisplay`);

        if (checkbox) checkbox.checked = enabled;
        if (controls) {
            controls.classList.toggle('hidden', !enabled);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ controls
            if (enabled && config) {
                Object.entries(config).forEach(([key, value]) => {
                    const input = controls.querySelector(`#${serviceId}${key.charAt(0).toUpperCase() + key.slice(1)}`);
                    if (input) input.value = value;
                });
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–∞—Å–æ–≤
        if (hoursDisplay && config) {
            const hasCount = this.components.serviceDefinitions[serviceId]?.hasCount;
            const suffix = hasCount ? '—á/—à—Ç' : '—á';
            hoursDisplay.textContent = `${config.hours || 0}${suffix}`;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        card.dataset.active = enabled;
        card.classList.toggle('selected', enabled && !config.autoActivated);
        card.classList.toggle('auto-selected', enabled && config.autoActivated);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤—Ç–æ–º–µ—Ç–∫—É
        const autoLabel = card.querySelector('.auto-selected-label');
        if (config.autoActivated && !autoLabel) {
            const title = card.querySelector('.service-title');
            if (title) {
                title.insertAdjacentHTML('beforeend', '<span class="auto-selected-label">–ê–í–¢–û</span>');
            }
        } else if (!config.autoActivated && autoLabel) {
            autoLabel.remove();
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è
        this.animateCardUpdate(card);
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
     */
    updatePricingSettings(pricing) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –±–ª–æ–∫–æ–≤
        this.updatePricingVisibility(pricing);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π
        const hourlyRateInput = document.getElementById('hourlyRate');
        if (hourlyRateInput) {
            hourlyRateInput.value = pricing.hourlyRate;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('input[name="pricingMethod"]').forEach(radio => {
            radio.checked = radio.value === pricing.method;
        });

        document.querySelectorAll('input[name="detailLevel"]').forEach(radio => {
            radio.checked = radio.value === pricing.detailLevel;
        });
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –±–ª–æ–∫–æ–≤ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
     */
    updatePricingVisibility(pricing) {
        // –ë–ª–æ–∫–∏ –º–µ—Ç–æ–¥–æ–≤ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
        const hourlyBlock = document.getElementById('hourlyRateBlock');
        const fixedBlock = document.getElementById('fixedPricesBlock');

        if (hourlyBlock) {
            hourlyBlock.style.display = pricing.method === 'hourly' ? 'block' : 'none';
        }
        if (fixedBlock) {
            fixedBlock.style.display = pricing.method === 'fixed' ? 'block' : 'none';
        }

        // –ë–ª–æ–∫–∏ —É—Ä–æ–≤–Ω—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
        const quickBlock = document.getElementById('quickComplexityGroup');
        const detailedBlock = document.getElementById('detailedComplexityGroup');

        if (quickBlock) {
            quickBlock.style.display = pricing.detailLevel === 'quick' ? 'block' : 'none';
        }
        if (detailedBlock) {
            detailedBlock.style.display = pricing.detailLevel === 'detailed' ? 'block' : 'none';
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø—Ä–µ—Å–µ—Ç–∞—Ö
     */
    handlePresetInputChange(presetType, input) {
        const value = parseFloat(input.value) || 0;
        
        if (input.id.includes('Preset')) {
            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            this.updatePresetQuantity(presetType, value);
        } else if (input.id.includes('Duration')) {
            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            this.updatePresetDuration(presetType, value);
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
     */
    handleComponentInputChange(componentId, input) {
        const state = this.state.getState();
        const currentConfig = state.components[componentId] || {};
        
        let updateKey;
        let value = parseFloat(input.value) || 0;
        
        if (input.id.includes('Hours')) {
            updateKey = 'hours';
        } else if (input.id.includes('Count')) {
            updateKey = 'count';
            value = parseInt(input.value) || 1;
        } else {
            // –û–±—ä–µ–º–Ω—ã–µ –ø–æ–ª—è
            const fieldName = input.dataset.field;
            if (fieldName) {
                updateKey = fieldName;
            }
        }
        
        if (updateKey) {
            const newConfig = { ...currentConfig, [updateKey]: value };
            this.events.emit('components:update-config', { componentId, config: newConfig });
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —É—Å–ª—É–≥–∞—Ö
     */
    handleServiceInputChange(serviceId, input) {
        const state = this.state.getState();
        const currentConfig = state.services[serviceId] || {};
        
        let updateKey;
        let value = parseFloat(input.value) || 0;
        
        if (input.id.includes('Hours')) {
            updateKey = 'hours';
        } else if (input.id.includes('Count')) {
            updateKey = 'count';
            value = parseInt(input.value) || 1;
        }
        
        if (updateKey) {
            const newConfig = { ...currentConfig, [updateKey]: value };
            this.events.emit('services:update-config', { serviceId, config: newConfig });
        }
    }

    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–∞
     */
    updatePresetQuantity(presetType, count) {
        this.events.emit('presets:update-quantity', { presetType, count });
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–µ—Å–µ—Ç–∞
     */
    updatePresetDuration(presetType, duration) {
        this.events.emit('presets:update-duration', { presetType, duration });
    }

    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
     */
    toggleComponent(componentId, enabled) {
        const config = enabled ? {
            hours: this.components.componentDefinitions[componentId]?.defaultHours || 1,
            count: 1
        } : {};
        
        this.events.emit('components:toggle', { componentId, enabled, config });
    }

    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ª—É–≥–∏
     */
    toggleService(serviceId, enabled) {
        const definition = this.components.serviceDefinitions[serviceId];
        const config = enabled ? {
            hours: definition?.defaultHours || 1,
            count: definition?.hasCount ? 1 : undefined
        } : {};
        
        this.events.emit('services:toggle', { serviceId, enabled, config });
    }

    /**
     * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–π —É—Å–ª—É–≥–∏
     */
    addCustomServiceCard(service) {
        const container = document.getElementById('customServicesList');
        if (!container) return;

        const cardHtml = this.renderTemplate('customServiceCard', {
            ...service,
            totalCost: this.formatNumber(service.pricePerUnit * service.count),
            pricePerUnit: this.formatNumber(service.pricePerUnit)
        });

        container.insertAdjacentHTML('beforeend', cardHtml);
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –Ω–æ–≤–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
        const newCard = container.lastElementChild;
        this.setupCustomServiceInteractivity(newCard);
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
        this.animateCardAppear(newCard);
    }

    /**
     * –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–π —É—Å–ª—É–≥–∏
     */
    removeCustomServiceCard(serviceId) {
        const card = document.querySelector(`[data-custom-id="${serviceId}"]`);
        if (card) {
            this.animateCardDisappear(card, () => {
                card.remove();
            });
        }
    }

    /**
     * –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
     */
    showAutoActivationFeedback(data) {
        this.showNotification({
            type: 'info',
            title: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å–ª—É–≥–∞',
            message: `${data.definition.name}: ${data.reason}`,
            duration: 4000
        });
    }

    /**
     * –ü–æ–∫–∞–∑ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —à–∞–±–ª–æ–Ω–∞
     */
    showTemplateAppliedFeedback(data) {
        this.showNotification({
            type: 'success',
            title: '–®–∞–±–ª–æ–Ω –ø—Ä–∏–º–µ–Ω–µ–Ω',
            message: `–£—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω —à–∞–±–ª–æ–Ω: ${data.template.name}`,
            duration: 3000
        });
    }

    /**
     * –ü–æ–∫–∞–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
     */
    showSuggestions(suggestions) {
        if (suggestions.length === 0) return;

        const highPriority = suggestions.filter(s => s.priority === 'high');
        
        if (highPriority.length > 0) {
            this.showNotification({
                type: 'info',
                title: '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏',
                message: highPriority[0].description,
                actions: [{
                    label: '–ü—Ä–∏–º–µ–Ω–∏—Ç—å',
                    type: 'primary',
                    action: 'apply_suggestion'
                }],
                duration: 8000
            });
        }
    }

    /**
     * –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
     */
    showNotification(notification) {
        const id = 'notif_' + Date.now();
        const notificationData = {
            id,
            icon: this.getNotificationIcon(notification.type),
            title: notification.title || '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ',
            message: notification.message,
            type: notification.type || 'info',
            actions: notification.actions || []
        };

        const container = document.getElementById('notificationContainer');
        if (!container) return;

        const notificationHtml = this.renderTemplate('notification', notificationData);
        container.insertAdjacentHTML('beforeend', notificationHtml);

        const element = container.lastElementChild;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        setTimeout(() => element.classList.add('show'), 10);

        // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ
        if (notification.duration) {
            setTimeout(() => {
                this.hideNotification(id);
            }, notification.duration);
        }

        return id;
    }

    /**
     * –°–∫—Ä—ã—Ç–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
     */
    hideNotification(notificationId) {
        const notification = document.querySelector(`[data-id="${notificationId}"]`);
        if (notification) {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
     */
    getNotificationIcon(type) {
        const icons = {
            success: '‚úÖ',
            error: '‚ùå',
            warning: '‚ö†Ô∏è',
            info: '‚ÑπÔ∏è'
        };
        return icons[type] || '‚ÑπÔ∏è';
    }

    /**
     * –ê–Ω–∏–º–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
     */
    animateCardUpdate(card) {
        card.classList.add('updating');
        setTimeout(() => {
            card.classList.remove('updating');
        }, 200);
    }

    /**
     * –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
     */
    animateCardAppear(card) {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.3s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 10);
    }

    /**
     * –ê–Ω–∏–º–∞—Ü–∏—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
     */
    animateCardDisappear(card, callback) {
        card.style.transition = 'all 0.3s ease';
        card.style.opacity = '0';
        card.style.transform = 'translateY(-20px)';
        
        setTimeout(() => {
            if (callback) callback();
        }, 300);
    }

    /**
     * –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã –ø—Ä–µ—Å–µ—Ç–∞ (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π)
     */
    calculatePresetPrice(presetType, presetData) {
        if (!presetData || presetData.count === 0) return 0;
        
        // –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Ç–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç –≤ PricingEngine
        const definition = this.presets.presetDefinitions[presetType];
        if (!definition) return 0;
        
        const durationFactor = presetData.duration / definition.defaultDuration;
        return Math.round(definition.baseCost * durationFactor * presetData.count);
    }

    /**
     * –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π)
     */
    calculateComponentPrice(componentId, componentData) {
        if (!componentData) return 0;
        
        const state = this.state.getState();
        const definition = this.components.componentDefinitions[componentId];
        if (!definition) return 0;
        
        const hours = componentData.hours || definition.defaultHours;
        const count = componentData.count || 1;
        const hourlyRate = state.pricing.hourlyRate;
        
        return Math.round(hours * count * hourlyRate);
    }

    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã
     */
    formatPrice(price) {
        if (price === 0) return '0 ‚ÇΩ';
        return this.formatNumber(price) + ' ‚ÇΩ';
    }

    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞
     */
    formatNumber(number) {
        if (typeof number !== 'number' || isNaN(number)) return '0';
        return Math.round(number).toLocaleString('ru-RU');
    }

    /**
     * Throttle —Ñ—É–Ω–∫—Ü–∏—è
     */
    throttle(func, limit) {
        let inThrottle;
        return function() {
            const args = arguments;
            const context = this;
            if (!inThrottle) {
                func.apply(context, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        }
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
     */
    initializeInteractiveElements() {
        // Tooltips
        this.initializeTooltips();
        
        // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        this.initializeModals();
        
        // Drag & Drop
        if (!this.isMobile) {
            this.initializeDragAndDrop();
        }
        
        // Keyboard navigation
        this.initializeKeyboardNavigation();
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫
     */
    initializeTooltips() {
        document.querySelectorAll('[data-tooltip]').forEach(element => {
            element.addEventListener('mouseenter', (e) => this.showTooltip(e));
            element.addEventListener('mouseleave', (e) => this.hideTooltip(e));
        });
    }

    /**
     * –ü–æ–∫–∞–∑ –ø–æ–¥—Å–∫–∞–∑–∫–∏
     */
    showTooltip(e) {
        const text = e.target.dataset.tooltip;
        if (!text) return;

        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip-popup';
        tooltip.textContent = text;
        document.body.appendChild(tooltip);

        const rect = e.target.getBoundingClientRect();
        tooltip.style.left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
        tooltip.style.top = rect.top - tooltip.offsetHeight - 10 + 'px';

        e.target._tooltip = tooltip;
    }

    /**
     * –°–∫—Ä—ã—Ç–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
     */
    hideTooltip(e) {
        if (e.target._tooltip) {
            e.target._tooltip.remove();
            delete e.target._tooltip;
        }
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
     */
    getUIState() {
        return {
            theme: this.currentTheme,
            isMobile: this.isMobile,
            sections: this.sections,
            activeNotifications: document.querySelectorAll('.notification').length
        };
    }

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
     */
    exportUISettings() {
        return {
            theme: this.currentTheme,
            layout: this.sections,
            preferences: {
                autoSave: true,
                showTooltips: true,
                animationsEnabled: true
            }
        };
    }

    /**
     * –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –º–æ–¥—É–ª—è
     */
    destroy() {
        // –û—á–∏—â–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.removeEventListener('change', this.handleInputChange);
        document.removeEventListener('click', this.handleClick);
        document.removeEventListener('input', this.handleInputUpdate);
        document.removeEventListener('keydown', this.handleKeyboardShortcuts);
        window.removeEventListener('resize', this.handleResize);

        // –û—Ç–ø–∏—Å–∫–∞ –æ—Ç —Å–æ–±—ã—Ç–∏–π –º–æ–¥—É–ª–µ–π
        this.events.off('pricing:updated');
        this.events.off('presets:updated');
        this.events.off('components:toggled');
        this.events.off('services:toggled');

        // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä—ã
        this.updateThrottlers.forEach(timer => clearTimeout(timer));
        this.updateThrottlers.clear();

        // –û—á–∏—â–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏
        document.querySelectorAll('.tooltip-popup').forEach(tooltip => tooltip.remove());

        console.log('üé® UIManager destroyed');
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
if (typeof module !== 'undefined' && module.exports) {
    module.exports = UIManager;
} else if (typeof window !== 'undefined') {
    window.UIManager = UIManager;
}

   /**
 * FinancialControls.js - –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
 * –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∞–º–∏, –Ω–∞–ª–æ–≥–∞–º–∏, –ø—Ä–∞–≤–∫–∞–º–∏ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ —Ä–∞—Å—á–µ—Ç–∞–º–∏
 */

class FinancialControls {
    constructor(stateManager, eventBus, errorHandler) {
        this.state = stateManager;
        this.events = eventBus;
        this.errors = errorHandler;
        
        this.sliders = new Map();
        this.tooltips = new Map();
        this.validationRules = this.initializeValidationRules();
        this.presets = this.initializeFinancialPresets();
        this.calculators = this.initializeCalculators();
        
        this.init();
        console.log('üí≥ FinancialControls initialized');
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è
     */
    init() {
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
        this.state.subscribe((state, action) => {
            if (this.shouldHandleAction(action.type)) {
                this.handleStateChange(state, action);
            }
        });

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
        this.events.on('financial:update-discount', (data) => this.updateDiscount(data.rate));
        this.events.on('financial:update-tax', (data) => this.updateTaxRate(data.rate));
        this.events.on('financial:toggle-volume-discounts', (data) => this.toggleVolumeDiscounts(data.enabled));
        this.events.on('financial:apply-preset', (data) => this.applyFinancialPreset(data.presetName));
        this.events.on('financial:calculate-recommendation', () => this.calculateRecommendations());

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        this.initializeControls();
        
        console.log('FinancialControls setup complete');
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª –≤–∞–ª–∏–¥–∞—Ü–∏–∏
     */
    initializeValidationRules() {
        return {
            discountRate: {
                min: -50,
                max: 50,
                step: 5,
                warning: {
                    below: -30,
                    above: 30
                }
            },
            taxRate: {
                min: 0,
                max: 30,
                step: 1,
                presets: {
                    selfEmployed: 0,
                    selfEmployedTax: 4,
                    simplified: 6,
                    personal: 13,
                    simplifiedProfit: 15,
                    corporate: 20
                }
            },
            clientType: {
                values: [0, 10, 20],
                descriptions: {
                    0: '–ë–µ–∑ –ø—Ä–∞–≤–æ–∫',
                    10: '–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∑–∞–∫–∞–∑—á–∏–∫',
                    20: '–ù–æ–≤—ã–π –∑–∞–∫–∞–∑—á–∏–∫'
                }
            }
        };
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    initializeFinancialPresets() {
        return {
            selfEmployed: {
                name: '–°–∞–º–æ–∑–∞–Ω—è—Ç—ã–π',
                description: '–ù–∞–ª–æ–≥ –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥',
                settings: {
                    taxRate: 4,
                    discountRate: 0,
                    enableVolumeDiscounts: true,
                    showTaxSeparately: false,
                    clientType: 10
                },
                icon: 'üë§',
                advantages: ['–ù–∏–∑–∫–∏–π –Ω–∞–ª–æ–≥', '–ü—Ä–æ—Å—Ç–∞—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å', '–ë—ã—Å—Ç—Ä—ã–µ —Ä–∞—Å—á–µ—Ç—ã']
            },
            individual: {
                name: '–ò–ü (–£–°–ù)',
                description: '–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è',
                settings: {
                    taxRate: 6,
                    discountRate: 0,
                    enableVolumeDiscounts: true,
                    showTaxSeparately: true,
                    clientType: 15
                },
                icon: 'üè¢',
                advantages: ['–ì–∏–±–∫–∞—è –Ω–∞–ª–æ–≥–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞', '–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–∞–π–º–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤', '–ë–æ–ª—å—à–µ –¥–æ–≤–µ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤']
            },
            corporate: {
                name: '–û–û–û',
                description: '–ü–æ–ª–Ω–æ–µ –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏–µ —Å –ù–î–°',
                settings: {
                    taxRate: 20,
                    discountRate: 5,
                    enableVolumeDiscounts: true,
                    showTaxSeparately: true,
                    clientType: 10
                },
                icon: 'üèõÔ∏è',
                advantages: ['–†–∞–±–æ—Ç–∞ —Å –∫—Ä—É–ø–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏', '–ù–î–° –∫ –∑–∞—á–µ—Ç—É', '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –¥–æ–≤–µ—Ä–∏–µ']
            },
            freelancer: {
                name: '–§—Ä–∏–ª–∞–Ω—Å–µ—Ä',
                description: '–§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ —Å –ù–î–§–õ',
                settings: {
                    taxRate: 13,
                    discountRate: -5,
                    enableVolumeDiscounts: false,
                    showTaxSeparately: false,
                    clientType: 20
                },
                icon: 'üíª',
                advantages: ['–ü—Ä–æ—Å—Ç–æ—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è', '–ì–∏–±–∫–æ—Å—Ç—å –≤ —Ä–∞–±–æ—Ç–µ', '–ú–∏–Ω–∏–º—É–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–∞']
            }
        };
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–≤
     */
    initializeCalculators() {
        return {
            volumeDiscount: this.createVolumeDiscountCalculator(),
            taxOptimization: this.createTaxOptimizationCalculator(),
            profitMargin: this.createProfitMarginCalculator(),
            competitiveAnalysis: this.createCompetitiveAnalysisCalculator()
        };
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
     */
    shouldHandleAction(actionType) {
        const handledActions = [
            'FINANCIAL_UPDATE',
            'RESULTS_UPDATE',
            'PRICING_UPDATE'
        ];
        return handledActions.includes(actionType);
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è
     */
    handleStateChange(state, action) {
        try {
            switch (action.type) {
                case 'FINANCIAL_UPDATE':
                    this.updateFinancialDisplay(state.financial);
                    break;
                case 'RESULTS_UPDATE':
                    this.updateFinancialImpact(state.results, state.financial);
                    break;
                case 'PRICING_UPDATE':
                    this.recalculateFinancialImpact(state);
                    break;
            }
        } catch (error) {
            this.errors.handleError(error, { 
                context: 'FinancialControls.handleStateChange',
                action: action.type 
            });
        }
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
     */
    initializeControls() {
        this.initializeDiscountSlider();
        this.initializeTaxSlider();
        this.initializeClientTypeSelector();
        this.initializeVolumeDiscountToggle();
        this.initializeFinancialPresetButtons();
        this.initializeCalculatorButtons();
    }

     /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–∞–π–¥–µ—Ä–∞ —Å–∫–∏–¥–æ–∫
     */
    initializeDiscountSlider() {
        const slider = document.getElementById('discountRate');
        const valueDisplay = document.getElementById('discountRateValue');
        const tooltip = document.getElementById('discountTooltipContent');

        if (!slider) return;

        this.sliders.set('discount', {
            element: slider,
            valueDisplay,
            tooltip,
            currentValue: 0
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        slider.addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            this.updateDiscountDisplay(value);
            this.state.dispatch({
                type: 'FINANCIAL_UPDATE',
                payload: { discountRate: value }
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫
        slider.addEventListener('mouseenter', () => this.showSliderTooltip('discount'));
        slider.addEventListener('mouseleave', () => this.hideSliderTooltip('discount'));
        slider.addEventListener('focus', () => this.showSliderTooltip('discount'));
        slider.addEventListener('blur', () => this.hideSliderTooltip('discount'));

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        this.updateDiscountDisplay(0);
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–∞–π–¥–µ—Ä–∞ –Ω–∞–ª–æ–≥–æ–≤
     */
    initializeTaxSlider() {
        const slider = document.getElementById('taxRate');
        const valueDisplay = document.getElementById('taxRateValue');
        const tooltip = document.getElementById('taxTooltipContent');

        if (!slider) return;

        this.sliders.set('tax', {
            element: slider,
            valueDisplay,
            tooltip,
            currentValue: 13
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        slider.addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            this.updateTaxDisplay(value);
            this.state.dispatch({
                type: 'FINANCIAL_UPDATE',
                payload: { taxRate: value }
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫
        slider.addEventListener('mouseenter', () => this.showSliderTooltip('tax'));
        slider.addEventListener('mouseleave', () => this.hideSliderTooltip('tax'));
        slider.addEventListener('focus', () => this.showSliderTooltip('tax'));
        slider.addEventListener('blur', () => this.hideSliderTooltip('tax'));

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        this.updateTaxDisplay(13);
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ —Ç–∏–ø–∞ –∫–ª–∏–µ–Ω—Ç–∞
     */
    initializeClientTypeSelector() {
        const selector = document.getElementById('clientType');
        if (!selector) return;

        selector.addEventListener('change', (e) => {
            const value = parseInt(e.target.value);
            this.state.dispatch({
                type: 'FINANCIAL_UPDATE',
                payload: { clientType: value }
            });
            
            this.showClientTypeInfo(value);
        });
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –æ–±—ä–µ–º–Ω—ã—Ö —Å–∫–∏–¥–æ–∫
     */
    initializeVolumeDiscountToggle() {
        const toggle = document.getElementById('enableVolumeDiscounts');
        if (!toggle) return;

        toggle.addEventListener('change', (e) => {
            const enabled = e.target.checked;
            this.state.dispatch({
                type: 'FINANCIAL_UPDATE',
                payload: { enableVolumeDiscounts: enabled }
            });
            
            this.updateVolumeDiscountInfo(enabled);
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        this.updateVolumeDiscountInfo(true);
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    initializeFinancialPresetButtons() {
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–µ—Å–µ—Ç–æ–≤ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        let container = document.getElementById('financialPresetsContainer');
        if (!container) {
            container = this.createFinancialPresetsContainer();
        }

        this.renderFinancialPresets(container);
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    createFinancialPresetsContainer() {
        const financialCard = document.querySelector('.financial-settings-card');
        if (!financialCard) return null;

        const container = document.createElement('div');
        container.id = 'financialPresetsContainer';
        container.className = 'financial-presets-container';
        container.innerHTML = `
            <div class="financial-presets-header">
                <h4>üöÄ –ë—ã—Å—Ç—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Å—Ç–∞—Ç—É—Å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</p>
            </div>
            <div class="financial-presets-grid" id="financialPresetsGrid"></div>
        `;

        financialCard.appendChild(container);
        return container;
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø—Ä–µ—Å–µ—Ç–æ–≤
     */
    renderFinancialPresets(container) {
        const grid = container.querySelector('#financialPresetsGrid');
        if (!grid) return;

        grid.innerHTML = '';

        Object.entries(this.presets).forEach(([presetId, preset]) => {
            const presetElement = document.createElement('div');
            presetElement.className = 'financial-preset-card';
            presetElement.dataset.preset = presetId;
            
            presetElement.innerHTML = `
                <div class="preset-icon">${preset.icon}</div>
                <div class="preset-content">
                    <div class="preset-name">${preset.name}</div>
                    <div class="preset-description">${preset.description}</div>
                    <div class="preset-advantages">
                        ${preset.advantages.map(adv => `<span class="advantage-tag">${adv}</span>`).join('')}
                    </div>
                </div>
                <div class="preset-tax-rate">${preset.settings.taxRate}%</div>
            `;

            presetElement.addEventListener('click', () => {
                this.applyFinancialPreset(presetId);
            });

            grid.appendChild(presetElement);
        });
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–≤
     */
    initializeCalculatorButtons() {
        const calculatorContainer = this.createCalculatorContainer();
        if (calculatorContainer) {
            this.renderCalculatorButtons(calculatorContainer);
        }
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–≤
     */
    createCalculatorContainer() {
        const resultPanel = document.querySelector('.result-section');
        if (!resultPanel) return null;

        const container = document.createElement('div');
        container.className = 'result-card calculator-container';
        container.innerHTML = `
            <div class="result-title">üßÆ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ã</div>
            <div class="calculator-buttons" id="calculatorButtons"></div>
        `;

        resultPanel.appendChild(container);
        return container;
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–Ω–æ–ø–æ–∫ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–≤
     */
    renderCalculatorButtons(container) {
        const buttonsContainer = container.querySelector('#calculatorButtons');
        if (!buttonsContainer) return;

        const calculators = [
            {
                id: 'volumeDiscount',
                name: '–û–±—ä–µ–º–Ω—ã–µ —Å–∫–∏–¥–∫–∏',
                icon: 'üìä',
                description: '–†–∞—Å—á–µ—Ç —ç–∫–æ–Ω–æ–º–∏–∏ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –∑–∞–∫–∞–∑–∞—Ö'
            },
            {
                id: 'taxOptimization',
                name: '–ù–∞–ª–æ–≥–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è',
                icon: 'üí∞',
                description: '–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞–ª–æ–≥–æ–≤—ã—Ö —Ä–µ–∂–∏–º–æ–≤'
            },
            {
                id: 'profitMargin',
                name: '–ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å',
                icon: 'üìà',
                description: '–ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞'
            }
        ];

        calculators.forEach(calc => {
            const button = document.createElement('div');
            button.className = 'calculator-button';
            button.dataset.calculator = calc.id;
            
            button.innerHTML = `
                <div class="calculator-icon">${calc.icon}</div>
                <div class="calculator-info">
                    <div class="calculator-name">${calc.name}</div>
                    <div class="calculator-description">${calc.description}</div>
                </div>
            `;

            button.addEventListener('click', () => {
                this.openCalculator(calc.id);
            });

            buttonsContainer.appendChild(button);
        });
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏
     */
    updateDiscountDisplay(value) {
        const sliderData = this.sliders.get('discount');
        if (!sliderData) return;

        sliderData.currentValue = value;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        if (sliderData.valueDisplay) {
            if (value === 0) {
                sliderData.valueDisplay.textContent = '0% (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)';
            } else if (value > 0) {
                sliderData.valueDisplay.textContent = `+${value}% (–Ω–∞—Ü–µ–Ω–∫–∞)`;
            } else {
                sliderData.valueDisplay.textContent = `${value}% (—Å–∫–∏–¥–∫–∞)`;
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
        if (sliderData.tooltip) {
            sliderData.tooltip.textContent = this.getDiscountTooltipText(value);
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        this.checkDiscountWarnings(value);
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–ª–æ–≥–∞
     */
    updateTaxDisplay(value) {
        const sliderData = this.sliders.get('tax');
        if (!sliderData) return;

        sliderData.currentValue = value;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        if (sliderData.valueDisplay) {
            if (value === 0) {
                sliderData.valueDisplay.textContent = '0% (–±–µ–∑ –Ω–∞–ª–æ–≥–æ–≤)';
            } else {
                sliderData.valueDisplay.textContent = `${value}%`;
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
        if (sliderData.tooltip) {
            sliderData.tooltip.textContent = this.getTaxTooltipText(value);
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        this.showTaxRecommendations(value);
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —Å–∫–∏–¥–∫–∏
     */
    getDiscountTooltipText(value) {
        if (value === 0) return '–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π';
        if (value === -10) return '–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç';
        if (value === -15) return '–•–æ—Ä–æ—à–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä—ã';
        if (value === -20) return '–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–æ–µ–∫—Ç';
        if (value > 0) return '–ù–∞—Ü–µ–Ω–∫–∞ –∑–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏';
        return '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞';
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –Ω–∞–ª–æ–≥–∞
     */
    getTaxTooltipText(value) {
        const presets = this.validationRules.taxRate.presets;
        
        if (value === presets.selfEmployed) return '–°–∞–º–æ–∑–∞–Ω—è—Ç—ã–π –±–µ–∑ –Ω–∞–ª–æ–≥–æ–≤';
        if (value === presets.selfEmployedTax) return '–°–∞–º–æ–∑–∞–Ω—è—Ç—ã–π —Å –Ω–∞–ª–æ–≥–æ–º';
        if (value === presets.simplified) return '–£–°–ù –¥–æ—Ö–æ–¥—ã';
        if (value === presets.personal) return '–ù–î–§–õ –¥–ª—è —Ñ–∏–∑–ª–∏—Ü';
        if (value === presets.simplifiedProfit) return '–£–°–ù –¥–æ—Ö–æ–¥—ã-—Ä–∞—Å—Ö–æ–¥—ã';
        if (value === presets.corporate) return '–ù–î–° + –Ω–∞–ª–æ–≥ –Ω–∞ –ø—Ä–∏–±—ã–ª—å';
        
        return '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞';
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –¥–ª—è —Å–∫–∏–¥–æ–∫
     */
    checkDiscountWarnings(value) {
        const rules = this.validationRules.discountRate;
        
        if (value < rules.warning.below) {
            this.errors.showWarning(`–ë–æ–ª—å—à–∞—è —Å–∫–∏–¥–∫–∞ (${value}%) –º–æ–∂–µ—Ç –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å`);
        } else if (value > rules.warning.above) {
            this.errors.showWarning(`–í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ (${value}%) –º–æ–∂–µ—Ç —Å–Ω–∏–∑–∏—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å`);
        }
    }

    /**
     * –ü–æ–∫–∞–∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –Ω–∞–ª–æ–≥–∞–º
     */
    showTaxRecommendations(value) {
        const state = this.state.getState();
        const totalCost = state.results.totalCost || 0;
        
        // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±–æ—Ä–æ—Ç–∞
        if (totalCost > 100000 && value === 4) {
            this.errors.showInfo('–ü—Ä–∏ –±–æ–ª—å—à–∏—Ö –æ–±–æ—Ä–æ—Ç–∞—Ö —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –£–°–ù (6%)');
        } else if (totalCost > 500000 && value < 15) {
            this.errors.showInfo('–î–ª—è –∫—Ä—É–ø–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–≥–æ–¥–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –û–û–û');
        }
    }

    /**
     * –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫ —Å–ª–∞–π–¥–µ—Ä–æ–≤
     */
    showSliderTooltip(sliderId) {
        const sliderData = this.sliders.get(sliderId);
        if (!sliderData || !sliderData.tooltip) return;

        const tooltip = sliderData.tooltip.parentElement;
        if (tooltip) {
            tooltip.classList.add('show');
        }
    }

    hideSliderTooltip(sliderId) {
        const sliderData = this.sliders.get(sliderId);
        if (!sliderData || !sliderData.tooltip) return;

        const tooltip = sliderData.tooltip.parentElement;
        if (tooltip) {
            tooltip.classList.remove('show');
        }
    }

    /**
     * –ü–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–∏–ø–µ –∫–ª–∏–µ–Ω—Ç–∞
     */
    showClientTypeInfo(value) {
        const descriptions = this.validationRules.clientType.descriptions;
        const description = descriptions[value] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø';
        
        this.errors.showInfo(`–¢–∏–ø –∫–ª–∏–µ–Ω—Ç–∞: ${description}`);
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ–±—ä–µ–º–Ω—ã—Ö —Å–∫–∏–¥–∫–∞—Ö
     */
    updateVolumeDiscountInfo(enabled) {
        const infoElement = document.getElementById('volumeDiscountInfo');
        if (infoElement) {
            infoElement.style.display = enabled ? 'block' : 'none';
        }

        if (enabled) {
            this.events.emit('pricing:calculate'); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å —É—á–µ—Ç–æ–º —Å–∫–∏–¥–æ–∫
        }
    }

    /**
     * –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –ø—Ä–µ—Å–µ—Ç–∞
     */
    applyFinancialPreset(presetId) {
        const preset = this.presets[presetId];
        if (!preset) {
            this.errors.showError(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–µ—Å–µ—Ç: ${presetId}`);
            return;
        }

        try {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–µ—Å–µ—Ç–∞
            this.state.dispatch({
                type: 'FINANCIAL_UPDATE',
                payload: preset.settings
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            this.updateAllFinancialDisplays(preset.settings);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            this.errors.showSuccess(`–ü—Ä–∏–º–µ–Ω–µ–Ω –ø—Ä–µ—Å–µ—Ç: ${preset.name}`);

            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–µ—Å–µ—Ç
            this.highlightSelectedPreset(presetId);

            this.events.emit('financial:preset-applied', { presetId, preset });

        } catch (error) {
            this.errors.handleError(error, { context: 'FinancialControls.applyFinancialPreset', presetId });
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–π
     */
    updateAllFinancialDisplays(settings) {
        if (settings.discountRate !== undefined) {
            this.updateDiscountDisplay(settings.discountRate);
            const slider = this.sliders.get('discount');
            if (slider && slider.element) {
                slider.element.value = settings.discountRate;
            }
        }

        if (settings.taxRate !== undefined) {
            this.updateTaxDisplay(settings.taxRate);
            const slider = this.sliders.get('tax');
            if (slider && slider.element) {
                slider.element.value = settings.taxRate;
            }
        }

        if (settings.enableVolumeDiscounts !== undefined) {
            const toggle = document.getElementById('enableVolumeDiscounts');
            if (toggle) {
                toggle.checked = settings.enableVolumeDiscounts;
                this.updateVolumeDiscountInfo(settings.enableVolumeDiscounts);
            }
        }

        if (settings.showTaxSeparately !== undefined) {
            const toggle = document.getElementById('showTaxSeparately');
            if (toggle) {
                toggle.checked = settings.showTaxSeparately;
            }
        }

        if (settings.clientType !== undefined) {
            const selector = document.getElementById('clientType');
            if (selector) {
                selector.value = settings.clientType;
            }
        }
    }

    /**
     * –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ—Å–µ—Ç–∞
     */
    highlightSelectedPreset(presetId) {
        // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –ø—Ä–µ—Å–µ—Ç–æ–≤
        document.querySelectorAll('.financial-preset-card').forEach(card => {
            card.classList.remove('selected');
        });

        // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–µ—Å–µ—Ç
        const selectedCard = document.querySelector(`[data-preset="${presetId}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }
    }

    /**
     * –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
     */
    openCalculator(calculatorId) {
        const calculator = this.calculators[calculatorId];
        if (!calculator) {
            this.errors.showError(`–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä ${calculatorId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
            return;
        }

        try {
            const result = calculator();
            this.showCalculatorResult(calculatorId, result);
        } catch (error) {
            this.errors.handleError(error, { context: 'FinancialControls.openCalculator', calculatorId });
        }
    }

    /**
     * –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
     */
    showCalculatorResult(calculatorId, result) {
        const modal = this.createCalculatorModal(calculatorId, result);
        document.body.appendChild(modal);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        setTimeout(() => modal.classList.add('show'), 10);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è
        modal.addEventListener('click', (e) => {
            if (e.target === modal || e.target.classList.contains('modal-close')) {
                this.closeCalculatorModal(modal);
            }
        });
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
     */
    createCalculatorModal(calculatorId, result) {
        const modal = document.createElement('div');
        modal.className = 'calculator-modal';
        
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>${result.title}</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    ${result.content}
                </div>
                <div class="modal-footer">
                    ${result.actions || '<button class="modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>'}
                </div>
            </div>
        `;

        return modal;
    }

    /**
     * –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
     */
    closeCalculatorModal(modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            if (modal.parentNode) {
                modal.parentNode.removeChild(modal);
            }
        }, 300);
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –æ–±—ä–µ–º–Ω—ã—Ö —Å–∫–∏–¥–æ–∫
     */
    createVolumeDiscountCalculator() {
        return () => {
            const state = this.state.getState();
            const presets = Object.entries(state.presets).filter(([_, data]) => data.count > 0);
            
            let analysis = '<div class="volume-analysis">';
            analysis += '<h4>–ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–º–Ω—ã—Ö —Å–∫–∏–¥–æ–∫</h4>';
            
            presets.forEach(([presetType, data]) => {
                const currentDiscount = this.getVolumeDiscountRate(data.count);
                const nextThreshold = this.getNextVolumeThreshold(data.count);
                
                analysis += `
                    <div class="preset-volume-analysis">
                        <div class="preset-name">${presetType}</div>
                        <div class="current-volume">${data.count} —à—Ç. (—Å–∫–∏–¥–∫–∞: ${(1 - currentDiscount) * 100}%)</div>
                        ${nextThreshold ? `<div class="next-threshold">–î–æ —Å–∫–∏–¥–∫–∏ ${(1 - nextThreshold.discount) * 100}%: +${nextThreshold.needed} —à—Ç.</div>` : ''}
                    </div>
                `;
            });
            
            analysis += '</div>';

            return {
                title: 'üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–±—ä–µ–º–Ω—ã—Ö —Å–∫–∏–¥–æ–∫',
                content: analysis
            };
        };
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –Ω–∞–ª–æ–≥–æ–≤–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
     */
    createTaxOptimizationCalculator() {
        return () => {
            const state = this.state.getState();
            const totalCost = state.results.totalCost || 0;
            
            let comparison = '<div class="tax-comparison">';
            comparison += '<h4>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞–ª–æ–≥–æ–≤—ã—Ö —Ä–µ–∂–∏–º–æ–≤</h4>';
            comparison += '<table class="tax-table">';
            comparison += '<tr><th>–†–µ–∂–∏–º</th><th>–°—Ç–∞–≤–∫–∞</th><th>–ö –¥–æ–ø–ª–∞—Ç–µ</th><th>–û—Å—Ç–∞–µ—Ç—Å—è</th></tr>';
            
            Object.entries(this.validationRules.taxRate.presets).forEach(([regime, rate]) => {
                const tax = totalCost * (rate / 100);
                const afterTax = totalCost - tax;
                
                comparison += `
                    <tr>
                        <td>${this.getTaxRegimeName(regime)}</td>
                        <td>${rate}%</td>
                        <td>${this.formatCurrency(tax)}</td>
                        <td>${this.formatCurrency(afterTax)}</td>
                    </tr>
                `;
            });
            
            comparison += '</table>';
            comparison += this.getTaxRecommendation(totalCost);
            comparison += '</div>';

            return {
                title: 'üí∞ –ù–∞–ª–æ–≥–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è',
                content: comparison
            };
        };
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏
     */
    createProfitMarginCalculator() {
        return () => {
            const state = this.state.getState();
            const totalCost = state.results.totalCost || 0;
            const totalHours = state.results.totalHours || 0;
            const hourlyRate = state.pricing.hourlyRate;
            
            // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤
            const expenses = this.calculateExpenses(totalHours, hourlyRate);
            const profit = totalCost - expenses.total;
            const margin = totalCost > 0 ? (profit / totalCost) * 100 : 0;
            
            let analysis = '<div class="profit-analysis">';
            analysis += '<h4>–ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞</h4>';
            analysis += `
                <div class="profit-summary">
                    <div class="profit-item">
                        <label>–í—ã—Ä—É—á–∫–∞:</label>
                        <span>${this.formatCurrency(totalCost)}</span>
                    </div>
                    <div class="profit-item">
                        <label>–†–∞—Å—Ö–æ–¥—ã:</label>
                        <span>${this.formatCurrency(expenses.total)}</span>
                    </div>
                    <div class="profit-item profit-result">
                        <label>–ü—Ä–∏–±—ã–ª—å:</label>
                        <span>${this.formatCurrency(profit)}</span>
                    </div>
                    <div class="profit-item margin-result">
                        <label>–ú–∞—Ä–∂–∞:</label>
                        <span>${margin.toFixed(1)}%</span>
                    </div>
                </div>
                <div class="expenses-breakdown">
                    <h5>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤:</h5>
                    ${expenses.breakdown}
                </div>
                ${this.getProfitRecommendation(margin)}
            `;
            
            return {
                title: 'üìà –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏',
                content: analysis
            };
        };
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
     */
    createCompetitiveAnalysisCalculator() {
        return () => {
            const state = this.state.getState();
            const hourlyRate = state.pricing.hourlyRate;
            
            const marketRates = {
                junior: { min: 150, max: 300, avg: 225 },
                middle: { min: 250, max: 500, avg: 375 },
                senior: { min: 400, max: 800, avg: 600 }
            };
            
            let position = 'middle';
            if (hourlyRate < marketRates.middle.min) position = 'junior';
            else if (hourlyRate > marketRates.middle.max) position = 'senior';
            
            let analysis = '<div class="competitive-analysis">';
            analysis += '<h4>–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å—Ç–∞–≤–∫–∏</h4>';
            analysis += `<div class="current-rate">–í–∞—à–∞ —Å—Ç–∞–≤–∫–∞: ${hourlyRate} ‚ÇΩ/—á–∞—Å</div>`;
            analysis += '<div class="market-comparison">';
            
            Object.entries(marketRates).forEach(([level, rates]) => {
                const isCurrentLevel = level === position;
                analysis += `
                    <div class="market-level ${isCurrentLevel ? 'current' : ''}">
                        <div class="level-name">${this.getLevelName(level)}</div>
                        <div class="level-range">${rates.min} - ${rates.max} ‚ÇΩ/—á–∞—Å</div>
                        <div class="level-avg">–°—Ä–µ–¥–Ω—è—è: ${rates.avg} ‚ÇΩ/—á–∞—Å</div>
                        ${isCurrentLevel ? '<div class="level-indicator">–í–∞—à —É—Ä–æ–≤–µ–Ω—å</div>' : ''}
                    </div>
                `;
            });
            
            analysis += '</div>';
            analysis += this.getCompetitiveRecommendation(hourlyRate, position, marketRates);
            analysis += '</div>';

            return {
                title: 'üéØ –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑',
                content: analysis
            };
        };
    }

    /**
     * –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–≤
     */
    getVolumeDiscountRate(count) {
        if (count <= 5) return 1.0;
        if (count <= 15) return 0.9;
        if (count <= 30) return 0.8;
        return 0.7;
    }

    getNextVolumeThreshold(count) {
        if (count < 6) return { threshold: 6, discount: 0.9, needed: 6 - count };
        if (count < 16) return { threshold: 16, discount: 0.8, needed: 16 - count };
        if (count < 31) return { threshold: 31, discount: 0.7, needed: 31 - count };
        return null;
    }

    getTaxRegimeName(regime) {
        const names = {
            selfEmployed: '–°–∞–º–æ–∑–∞–Ω—è—Ç—ã–π',
            selfEmployedTax: '–°–∞–º–æ–∑–∞–Ω—è—Ç—ã–π (—Å –Ω–∞–ª–æ–≥–æ–º)',
            simplified: '–£–°–ù –¥–æ—Ö–æ–¥—ã',
            personal: '–ù–î–§–õ',
            simplifiedProfit: '–£–°–ù –¥–æ—Ö–æ–¥—ã-—Ä–∞—Å—Ö–æ–¥—ã',
            corporate: '–û–û–û —Å –ù–î–°'
        };
        return names[regime] || regime;
    }

    getTaxRecommendation(totalCost) {
        if (totalCost < 50000) {
            return '<div class="recommendation">üí° –î–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –æ–ø—Ç–∏–º–∞–ª–µ–Ω —Ä–µ–∂–∏–º —Å–∞–º–æ–∑–∞–Ω—è—Ç–æ–≥–æ</div>';
        } else if (totalCost < 200000) {
            return '<div class="recommendation">üí° –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –£–°–ù –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±–æ—Ä–æ—Ç–æ–≤</div>';
        } else {
            return '<div class="recommendation">üí° –ü—Ä–∏ –±–æ–ª—å—à–∏—Ö –æ–±–æ—Ä–æ—Ç–∞—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–≥–æ–¥–Ω–æ –û–û–û</div>';
        }
    }

    calculateExpenses(hours, hourlyRate) {
        const timeExpenses = hours * 50; // –ü—Ä–∏–º–µ—Ä–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –≤—Ä–µ–º–µ–Ω–∏
        const toolsExpenses = hourlyRate * 0.1 * hours; // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –ü–û
        const marketingExpenses = hourlyRate * 0.05 * hours; // –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥
        const otherExpenses = hourlyRate * 0.05 * hours; // –ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã
        
        const total = timeExpenses + toolsExpenses + marketingExpenses + otherExpenses;
        
        return {
            total,
            breakdown: `
                <div class="expense-item">–í—Ä–µ–º—è –∏ —Ä–µ—Å—É—Ä—Å—ã: ${this.formatCurrency(timeExpenses)}</div>
                <div class="expense-item">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –ü–û: ${this.formatCurrency(toolsExpenses)}</div>
                <div class="expense-item">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥: ${this.formatCurrency(marketingExpenses)}</div>
                <div class="expense-item">–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã: ${this.formatCurrency(otherExpenses)}</div>
            `
        };
    }

    getProfitRecommendation(margin) {
        if (margin < 20) {
            return '<div class="recommendation warning">‚ö†Ô∏è –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ü–µ–Ω—ã –∏–ª–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é —Ä–∞—Å—Ö–æ–¥–æ–≤</div>';
        } else if (margin < 40) {
            return '<div class="recommendation good">‚úÖ –ü—Ä–∏–µ–º–ª–µ–º–∞—è –º–∞—Ä–∂–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è</div>';
        } else {
            return '<div class="recommendation excellent">üöÄ –û—Ç–ª–∏—á–Ω–∞—è –º–∞—Ä–∂–∞! –ú–æ–∂–Ω–æ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —Ä–∞–∑–≤–∏—Ç–∏–µ</div>';
        }
    }

    getLevelName(level) {
        const names = {
            junior: 'Junior (1-2 –≥–æ–¥–∞)',
            middle: 'Middle (3-5 –ª–µ—Ç)',
            senior: 'Senior (5+ –ª–µ—Ç)'
        };
        return names[level] || level;
    }

    getCompetitiveRecommendation(hourlyRate, position, marketRates) {
        const currentLevel = marketRates[position];
        let recommendation = '<div class="competitive-recommendation">';
        
        if (hourlyRate < currentLevel.avg * 0.8) {
            recommendation += 'üí° –í–∞—à–∞ —Å—Ç–∞–≤–∫–∞ –Ω–∏–∂–µ —Ä—ã–Ω–æ—á–Ω–æ–π. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ü–µ–Ω—ã.';
        } else if (hourlyRate > currentLevel.avg * 1.2) {
            recommendation += '‚ö†Ô∏è –í–∞—à–∞ —Å—Ç–∞–≤–∫–∞ –≤—ã—à–µ —Ä—ã–Ω–æ—á–Ω–æ–π. –û–±–æ—Å–Ω—É–π—Ç–µ –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥.';
        } else {
            recommendation += '‚úÖ –í–∞—à–∞ —Å—Ç–∞–≤–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä—ã–Ω–æ—á–Ω–æ–º—É —É—Ä–æ–≤–Ω—é.';
        }
        
        recommendation += '</div>';
        return recommendation;
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è
     */
    updateFinancialImpact(results, financial) {
        this.updateFinancialSummary(results, financial);
        this.updateSavingsIndicators(results, financial);
        this.updateTaxImpact(results, financial);
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–≤–æ–¥–∫–∏
     */
    updateFinancialSummary(results, financial) {
        const summaryContainer = document.getElementById('financialSummary');
        if (!summaryContainer) return;

        const { totalCost } = results;
        const taxAmount = totalCost * (financial.taxRate / 100);
        const discountAmount = totalCost * (financial.discountRate / 100);
        const netAmount = totalCost + discountAmount - taxAmount;

        summaryContainer.innerHTML = `
            <div class="financial-summary-grid">
                <div class="summary-item">
                    <div class="summary-label">–í–∞–ª–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
                    <div class="summary-value">${this.formatCurrency(totalCost)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">–°–∫–∏–¥–∫–∞/–ù–∞—Ü–µ–Ω–∫–∞</div>
                    <div class="summary-value ${discountAmount >= 0 ? 'positive' : 'negative'}">
                        ${discountAmount >= 0 ? '+' : ''}${this.formatCurrency(discountAmount)}
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">–ù–∞–ª–æ–≥</div>
                    <div class="summary-value negative">-${this.formatCurrency(taxAmount)}</div>
                </div>
                <div class="summary-item total">
                    <div class="summary-label">–ö –ø–æ–ª—É—á–µ–Ω–∏—é</div>
                    <div class="summary-value">${this.formatCurrency(netAmount)}</div>
                </div>
            </div>
        `;
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —ç–∫–æ–Ω–æ–º–∏–∏
     */
    updateSavingsIndicators(results, financial) {
        if (!financial.enableVolumeDiscounts) return;

        const state = this.state.getState();
        const presets = Object.entries(state.presets).filter(([_, data]) => data.count > 0);
        
        presets.forEach(([presetType, data]) => {
            const savingsIndicator = document.getElementById(`${presetType}Savings`);
            if (!savingsIndicator) return;

            const discountRate = this.getVolumeDiscountRate(data.count);
            const savings = (1 - discountRate) * 100;

            if (savings > 0) {
                savingsIndicator.innerHTML = `üí∞ –°–∫–∏–¥–∫–∞ ${savings}%`;
                savingsIndicator.style.display = 'inline';
            } else {
                savingsIndicator.style.display = 'none';
            }
        });
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è –Ω–∞–ª–æ–≥–æ–≤
     */
    updateTaxImpact(results, financial) {
        const taxImpactContainer = document.getElementById('taxImpact');
        if (!taxImpactContainer) return;

        const { totalCost } = results;
        const taxAmount = totalCost * (financial.taxRate / 100);
        const effectiveRate = totalCost > 0 ? (taxAmount / totalCost) * 100 : 0;

        taxImpactContainer.innerHTML = `
            <div class="tax-impact-summary">
                <div class="tax-impact-item">
                    <span class="tax-label">–ù–∞–ª–æ–≥–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞:</span>
                    <span class="tax-value">${effectiveRate.toFixed(1)}%</span>
                </div>
                <div class="tax-impact-item">
                    <span class="tax-label">–°—É–º–º–∞ –Ω–∞–ª–æ–≥–∞:</span>
                    <span class="tax-value">${this.formatCurrency(taxAmount)}</span>
                </div>
                <div class="tax-impact-item">
                    <span class="tax-label">–†–µ–∂–∏–º –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è:</span>
                    <span class="tax-value">${this.getTaxRegimeDescription(financial.taxRate)}</span>
                </div>
            </div>
        `;
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞
     */
    getTaxRegimeDescription(taxRate) {
        const regimes = {
            0: '–°–∞–º–æ–∑–∞–Ω—è—Ç—ã–π (–±–µ–∑ –Ω–∞–ª–æ–≥–æ–≤)',
            4: '–°–∞–º–æ–∑–∞–Ω—è—Ç—ã–π (–ù–ü–î)',
            6: '–£–°–ù –î–æ—Ö–æ–¥—ã',
            13: '–ù–î–§–õ (—Ñ–∏–∑–ª–∏—Ü–æ)',
            15: '–£–°–ù –î–æ—Ö–æ–¥—ã-–†–∞—Å—Ö–æ–¥—ã',
            20: '–û–û–û (–ø–æ–ª–Ω–æ–µ –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏–µ)'
        };
        
        return regimes[taxRate] || `–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ (${taxRate}%)`;
    }

    /**
     * –ü–µ—Ä–µ—Å—á–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è
     */
    recalculateFinancialImpact(state) {
        this.updateFinancialImpact(state.results, state.financial);
        this.events.emit('financial:impact-updated', {
            results: state.results,
            financial: state.financial
        });
    }

    /**
     * –†–∞—Å—á–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
     */
    calculateRecommendations() {
        const state = this.state.getState();
        const recommendations = [];

        // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –Ω–∞–ª–æ–≥–∞–º
        const taxRecommendations = this.calculateTaxRecommendations(state);
        recommendations.push(...taxRecommendations);

        // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–∫–∏–¥–∫–∞–º
        const discountRecommendations = this.calculateDiscountRecommendations(state);
        recommendations.push(...discountRecommendations);

        // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–±—ä–µ–º–∞–º
        const volumeRecommendations = this.calculateVolumeRecommendations(state);
        recommendations.push(...volumeRecommendations);

        this.events.emit('financial:recommendations-generated', recommendations);
        return recommendations;
    }

    /**
     * –†–∞—Å—á–µ—Ç –Ω–∞–ª–æ–≥–æ–≤—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
     */
    calculateTaxRecommendations(state) {
        const recommendations = [];
        const { totalCost } = state.results;
        const { taxRate } = state.financial;

        // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —Å–º–µ–Ω–µ –Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞
        if (totalCost > 100000 && taxRate === 4) {
            recommendations.push({
                type: 'tax',
                priority: 'medium',
                title: '–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –£–°–ù',
                description: '–ü—Ä–∏ –±–æ–ª—å—à–∏—Ö –æ–±–æ—Ä–æ—Ç–∞—Ö –£–°–ù –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–≥–æ–¥–Ω–µ–µ —Å–∞–º–æ–∑–∞–Ω—è—Ç–æ—Å—Ç–∏',
                action: 'change_tax_regime',
                newValue: 6
            });
        }

        // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
        if (taxRate > 15 && totalCost < 500000) {
            recommendations.push({
                type: 'tax',
                priority: 'low',
                title: '–í—ã—Å–æ–∫–∞—è –Ω–∞–ª–æ–≥–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞',
                description: '–ò–∑—É—á–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è',
                action: 'tax_optimization'
            });
        }

        return recommendations;
    }

    /**
     * –†–∞—Å—á–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ —Å–∫–∏–¥–∫–∞–º
     */
    calculateDiscountRecommendations(state) {
        const recommendations = [];
        const { discountRate } = state.financial;

        if (discountRate < -25) {
            recommendations.push({
                type: 'discount',
                priority: 'high',
                title: '–ë–æ–ª—å—à–∞—è —Å–∫–∏–¥–∫–∞',
                description: '–°–∫–∏–¥–∫–∞ –±–æ–ª–µ–µ 25% –º–æ–∂–µ—Ç –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å',
                action: 'reduce_discount'
            });
        }

        if (discountRate > 30) {
            recommendations.push({
                type: 'discount',
                priority: 'medium',
                title: '–í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞',
                description: '–ù–∞—Ü–µ–Ω–∫–∞ –±–æ–ª–µ–µ 30% –º–æ–∂–µ—Ç —Å–Ω–∏–∑–∏—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å',
                action: 'reduce_markup'
            });
        }

        return recommendations;
    }

    /**
     * –†–∞—Å—á–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –æ–±—ä–µ–º–∞–º
     */
    calculateVolumeRecommendations(state) {
        const recommendations = [];
        const presets = Object.entries(state.presets).filter(([_, data]) => data.count > 0);

        presets.forEach(([presetType, data]) => {
            const nextThreshold = this.getNextVolumeThreshold(data.count);
            if (nextThreshold && nextThreshold.needed <= 3) {
                recommendations.push({
                    type: 'volume',
                    priority: 'low',
                    title: `–£–≤–µ–ª–∏—á—å—Ç–µ ${presetType}`,
                    description: `–î–æ —Å–∫–∏–¥–∫–∏ ${(1 - nextThreshold.discount) * 100}% –Ω—É–∂–Ω–æ –≤—Å–µ–≥–æ +${nextThreshold.needed} —à—Ç.`,
                    action: 'increase_volume',
                    presetType,
                    targetCount: nextThreshold.threshold
                });
            }
        });

        return recommendations;
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏
     */
    updateDiscount(rate) {
        this.updateDiscountDisplay(rate);
        this.state.dispatch({
            type: 'FINANCIAL_UPDATE',
            payload: { discountRate: rate }
        });
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–ª–æ–≥–æ–≤–æ–π —Å—Ç–∞–≤–∫–∏
     */
    updateTaxRate(rate) {
        this.updateTaxDisplay(rate);
        this.state.dispatch({
            type: 'FINANCIAL_UPDATE',
            payload: { taxRate: rate }
        });
    }

    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–±—ä–µ–º–Ω—ã—Ö —Å–∫–∏–¥–æ–∫
     */
    toggleVolumeDiscounts(enabled) {
        this.updateVolumeDiscountInfo(enabled);
        this.state.dispatch({
            type: 'FINANCIAL_UPDATE',
            payload: { enableVolumeDiscounts: enabled }
        });
    }

    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª—é—Ç—ã
     */
    formatCurrency(amount) {
        if (typeof amount !== 'number' || isNaN(amount)) return '0 ‚ÇΩ';
        return Math.round(amount).toLocaleString('ru-RU') + ' ‚ÇΩ';
    }

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
     */
    exportFinancialSettings() {
        const state = this.state.getState();
        return {
            financial: state.financial,
            presets: this.presets,
            validationRules: this.validationRules,
            currentCalculations: {
                totalCost: state.results.totalCost,
                taxAmount: state.results.totalCost * (state.financial.taxRate / 100),
                discountAmount: state.results.totalCost * (state.financial.discountRate / 100)
            }
        };
    }

    /**
     * –ò–º–ø–æ—Ä—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
     */
    importFinancialSettings(settings) {
        try {
            if (settings.financial) {
                this.state.dispatch({
                    type: 'FINANCIAL_UPDATE',
                    payload: settings.financial
                });
                this.updateAllFinancialDisplays(settings.financial);
            }

            if (settings.presets) {
                this.presets = { ...this.presets, ...settings.presets };
                this.renderFinancialPresets(document.getElementById('financialPresetsContainer'));
            }

            this.events.emit('financial:settings-imported', settings);
            this.errors.showSuccess('–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');

        } catch (error) {
            this.errors.handleError(error, { context: 'FinancialControls.importFinancialSettings' });
        }
    }

    /**
     * –°–±—Ä–æ—Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
     */
    resetFinancialSettings() {
        const defaultSettings = {
            discountRate: 0,
            taxRate: 13,
            enableVolumeDiscounts: true,
            showTaxSeparately: true,
            clientType: 20
        };

        this.state.dispatch({
            type: 'FINANCIAL_UPDATE',
            payload: defaultSettings
        });

        this.updateAllFinancialDisplays(defaultSettings);
        this.highlightSelectedPreset(null); // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–æ–≤

        this.errors.showInfo('–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
     */
    getCurrentFinancialSettings() {
        return this.state.getState().financial;
    }

    /**
     * –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
     */
    validateFinancialSettings(settings = null) {
        const financial = settings || this.state.getState().financial;
        const errors = [];
        const warnings = [];

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–∫–∏–¥–∫–∏
        if (financial.discountRate < this.validationRules.discountRate.min ||
            financial.discountRate > this.validationRules.discountRate.max) {
            errors.push(`–°–∫–∏–¥–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç ${this.validationRules.discountRate.min}% –¥–æ ${this.validationRules.discountRate.max}%`);
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞–ª–æ–≥–∞
        if (financial.taxRate < this.validationRules.taxRate.min ||
            financial.taxRate > this.validationRules.taxRate.max) {
            errors.push(`–ù–∞–ª–æ–≥–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç ${this.validationRules.taxRate.min}% –¥–æ ${this.validationRules.taxRate.max}%`);
        }

        // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        if (financial.discountRate < this.validationRules.discountRate.warning.below) {
            warnings.push('–û—á–µ–Ω—å –±–æ–ª—å—à–∞—è —Å–∫–∏–¥–∫–∞ –º–æ–∂–µ—Ç –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å');
        }

        if (financial.discountRate > this.validationRules.discountRate.warning.above) {
            warnings.push('–í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –º–æ–∂–µ—Ç —Å–Ω–∏–∑–∏—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å');
        }

        return { errors, warnings, isValid: errors.length === 0 };
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
     */
    getFinancialStatistics() {
        const state = this.state.getState();
        const { financial, results } = state;

        const taxAmount = results.totalCost * (financial.taxRate / 100);
        const discountAmount = results.totalCost * (financial.discountRate / 100);
        const netAmount = results.totalCost + discountAmount - taxAmount;

        return {
            gross: results.totalCost,
            tax: taxAmount,
            discount: discountAmount,
            net: netAmount,
            effectiveTaxRate: results.totalCost > 0 ? (taxAmount / results.totalCost) * 100 : 0,
            margin: results.totalCost > 0 ? (netAmount / results.totalCost) * 100 : 0,
            settings: financial
        };
    }

    /**
     * –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –º–æ–¥—É–ª—è
     */
    destroy() {
        // –û—Ç–ø–∏—Å–∫–∞ –æ—Ç —Å–æ–±—ã—Ç–∏–π
        this.events.off('financial:update-discount');
        this.events.off('financial:update-tax');
        this.events.off('financial:toggle-volume-discounts');
        this.events.off('financial:apply-preset');
        this.events.off('financial:calculate-recommendation');

        // –û—á–∏—Å—Ç–∫–∞ —Å–ª–∞–π–¥–µ—Ä–æ–≤
        this.sliders.clear();
        this.tooltips.clear();

        // –£–¥–∞–ª–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        document.querySelectorAll('.calculator-modal').forEach(modal => modal.remove());

        console.log('üí≥ FinancialControls destroyed');
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
if (typeof module !== 'undefined' && module.exports) {
    module.exports = FinancialControls;
} else if (typeof window !== 'undefined') {
    window.FinancialControls = FinancialControls;
}

        /**
 * ResultsPanel.js - –ü–∞–Ω–µ–ª—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
 * –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤ —Ä–∞—Å—á–µ—Ç–∞, –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
 */

class ResultsPanel {
    constructor(stateManager, eventBus, errorHandler) {
        this.state = stateManager;
        this.events = eventBus;
        this.errors = errorHandler;
        
        this.panels = {};
        this.exportFormats = this.initializeExportFormats();
        this.templates = this.initializeTemplates();
        this.animations = {
            counters: new Map(),
            charts: new Map()
        };
        this.updateQueue = [];
        
        this.init();
        console.log('üìä ResultsPanel initialized');
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è
     */
    init() {
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
        this.state.subscribe((state, action) => {
            if (this.shouldHandleAction(action.type)) {
                this.handleStateChange(state, action);
            }
        });

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
        this.events.on('results:export', (data) => this.exportResults(data.format, data.options));
        this.events.on('results:copy', () => this.copyToClipboard());
        this.events.on('results:print', () => this.printResults());
        this.events.on('results:share', (data) => this.shareResults(data.method));
        this.events.on('results:compare', (data) => this.compareResults(data.previousState));
        this.events.on('results:save-template', (data) => this.saveAsTemplate(data.name));

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª–∏
        this.initializePanels();
        
        console.log('ResultsPanel setup complete');
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤ —ç–∫—Å–ø–æ—Ä—Ç–∞
     */
    initializeExportFormats() {
        return {
            pdf: {
                name: 'PDF –¥–æ–∫—É–º–µ–Ω—Ç',
                icon: 'üìÑ',
                description: '–ì–æ—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç—É',
                generator: this.generatePDF.bind(this),
                options: {
                    includeDetails: true,
                    includeBreakdown: true,
                    includeComposition: true,
                    includeBranding: false,
                    watermark: false
                }
            },
            excel: {
                name: 'Excel —Ç–∞–±–ª–∏—Ü–∞',
                icon: 'üìä',
                description: '–î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è',
                generator: this.generateExcel.bind(this),
                options: {
                    includeFormulas: true,
                    includeCharts: true,
                    multipleSheets: true,
                    protectStructure: false
                }
            },
            word: {
                name: 'Word –¥–æ–∫—É–º–µ–Ω—Ç',
                icon: 'üìù',
                description: '–¢–µ–∫—Å—Ç–æ–≤–æ–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ',
                generator: this.generateWord.bind(this),
                options: {
                    includeHeader: true,
                    includeFooter: true,
                    template: 'commercial',
                    formatting: 'professional'
                }
            },
            json: {
                name: 'JSON –¥–∞–Ω–Ω—ã–µ',
                icon: 'üîß',
                description: '–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏',
                generator: this.generateJSON.bind(this),
                options: {
                    includeMetadata: true,
                    minify: false,
                    includeCalculationSteps: true
                }
            },
            email: {
                name: '–®–∞–±–ª–æ–Ω –ø–∏—Å—å–º–∞',
                icon: 'üìß',
                description: '–ì–æ—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç—É',
                generator: this.generateEmail.bind(this),
                options: {
                    subject: '–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö —É—Å–ª—É–≥',
                    greeting: 'formal',
                    signature: true,
                    attachments: ['pdf']
                }
            }
        };
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤
     */
    initializeTemplates() {
        return {
            // –®–∞–±–ª–æ–Ω –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            mainPanel: `
                <div class="results-main-panel">
                    <div class="results-summary">
                        <div class="summary-item total-cost">
                            <div class="summary-icon">üí∞</div>
                            <div class="summary-content">
                                <div class="summary-label">–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
                                <div class="summary-value" id="totalCostDisplay">{{totalCost}}</div>
                                <div class="summary-subtitle">{{costSubtitle}}</div>
                            </div>
                        </div>
                        <div class="summary-item total-hours">
                            <div class="summary-icon">‚è±Ô∏è</div>
                            <div class="summary-content">
                                <div class="summary-label">–û–±—â–µ–µ –≤—Ä–µ–º—è</div>
                                <div class="summary-value" id="totalHoursDisplay">{{totalHours}}</div>
                                <div class="summary-subtitle">–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã</div>
                            </div>
                        </div>
                        <div class="summary-item hourly-rate">
                            <div class="summary-icon">‚ö°</div>
                            <div class="summary-content">
                                <div class="summary-label">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Å—Ç–∞–≤–∫–∞</div>
                                <div class="summary-value" id="effectiveRateDisplay">{{effectiveRate}}</div>
                                <div class="summary-subtitle">‚ÇΩ/—á–∞—Å —Ñ–∞–∫—Ç</div>
                            </div>
                        </div>
                    </div>
                    <div class="results-actions">
                        <button class="action-button primary" data-action="copy">
                            <span class="button-icon">üìã</span>
                            <span class="button-text">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                        <button class="action-button secondary" data-action="export">
                            <span class="button-icon">üì§</span>
                            <span class="button-text">–≠–∫—Å–ø–æ—Ä—Ç</span>
                        </button>
                        <button class="action-button secondary" data-action="share">
                            <span class="button-icon">üì§</span>
                            <span class="button-text">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
                        </button>
                    </div>
                </div>
            `,

            // –®–∞–±–ª–æ–Ω –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
            breakdownPanel: `
                <div class="breakdown-panel">
                    <div class="breakdown-header">
                        <h3>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞</h3>
                        <div class="breakdown-controls">
                            <button class="toggle-button" data-toggle="collapse-all">–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
                            <button class="toggle-button" data-toggle="expand-all">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
                        </div>
                    </div>
                    <div class="breakdown-content" id="breakdownContent">
                        {{breakdownSections}}
                    </div>
                </div>
            `,

            // –®–∞–±–ª–æ–Ω —Å–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
            breakdownSection: `
                <div class="breakdown-section {{sectionClass}}" data-section="{{sectionId}}">
                    <div class="section-header" data-toggle="section">
                        <div class="section-info">
                            <span class="section-icon">{{icon}}</span>
                            <span class="section-title">{{title}}</span>
                            <span class="section-count">({{count}} –ø–æ–∑.)</span>
                        </div>
                        <div class="section-total">{{total}}</div>
                        <div class="section-toggle">‚ñº</div>
                    </div>
                    <div class="section-content {{#unless expanded}}collapsed{{/unless}}">
                        {{#each items}}
                        <div class="breakdown-item">
                            <div class="item-info">
                                <span class="item-name">{{name}}</span>
                                {{#if description}}
                                <span class="item-description">{{description}}</span>
                                {{/if}}
                            </div>
                            <div class="item-details">
                                {{#if quantity}}
                                <span class="item-quantity">{{quantity}} —à—Ç.</span>
                                {{/if}}
                                {{#if unitPrice}}
                                <span class="item-unit-price">{{unitPrice}}/—à—Ç</span>
                                {{/if}}
                                <span class="item-total">{{itemTotal}}</span>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                </div>
            `,

            // –®–∞–±–ª–æ–Ω —Å–æ—Å—Ç–∞–≤–∞ –ø—Ä–æ–µ–∫—Ç–∞
            compositionPanel: `
                <div class="composition-panel">
                    <div class="composition-header">
                        <h3>–°–æ—Å—Ç–∞–≤ –ø—Ä–æ–µ–∫—Ç–∞</h3>
                        <div class="composition-stats">
                            <span class="stat-item">{{totalItems}} —ç–ª–µ–º–µ–Ω—Ç–æ–≤</span>
                            <span class="stat-item">{{categories}} –∫–∞—Ç–µ–≥–æ—Ä–∏–π</span>
                        </div>
                    </div>
                    <div class="composition-content">
                        {{#each categories}}
                        <div class="composition-category">
                            <div class="category-header">
                                <span class="category-icon">{{icon}}</span>
                                <span class="category-name">{{name}}</span>
                                <span class="category-count">{{count}} —à—Ç.</span>
                            </div>
                            <div class="category-items">
                                {{#each items}}
                                <div class="composition-item">
                                    <span class="item-name">{{name}}</span>
                                    <span class="item-quantity">{{quantity}}</span>
                                </div>
                                {{/each}}
                            </div>
                        </div>
                        {{/each}}
                    </div>
                </div>
            `,

            // –®–∞–±–ª–æ–Ω —ç–∫—Å–ø–æ—Ä—Ç–∞
                       exportModal: `
                <div class="export-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h3>
                            <button class="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="export-formats">
                                {{#each formats}}
                                <div class="export-format" data-format="{{id}}">
                                    <div class="format-icon">{{icon}}</div>
                                    <div class="format-info">
                                        <div class="format-name">{{name}}</div>
                                        <div class="format-description">{{description}}</div>
                                    </div>
                                    <div class="format-select">
                                        <input type="radio" name="exportFormat" value="{{id}}" {{#if default}}checked{{/if}}>
                                    </div>
                                </div>
                                {{/each}}
                            </div>
                            <div class="export-options" id="exportOptions">
                                <!-- –û–ø—Ü–∏–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="button secondary" data-action="cancel">–û—Ç–º–µ–Ω–∞</button>
                            <button class="button primary" data-action="export">–≠–∫—Å–ø–æ—Ä—Ç</button>
                        </div>
                    </div>
                </div>
            `
        };
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
     */
    shouldHandleAction(actionType) {
        const handledActions = [
            'RESULTS_UPDATE',
            'FINANCIAL_UPDATE',
            'PRICING_UPDATE'
        ];
        return handledActions.includes(actionType);
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è
     */
    handleStateChange(state, action) {
        try {
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–æ–∫
            this.updateQueue.push({ state, action });
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            setTimeout(() => this.processUpdateQueue(), 10);
            
        } catch (error) {
            this.errors.handleError(error, { 
                context: 'ResultsPanel.handleStateChange',
                action: action.type 
            });
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
     */
    processUpdateQueue() {
        if (this.updateQueue.length === 0) return;
        
        // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
        const { state, action } = this.updateQueue[this.updateQueue.length - 1];
        this.updateQueue = [];
        
        this.performUpdate(state, action);
    }

    /**
     * –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
     */
    performUpdate(state, action) {
        switch (action.type) {
            case 'RESULTS_UPDATE':
                this.updateAllPanels(state);
                break;
            case 'FINANCIAL_UPDATE':
                this.updateFinancialDisplay(state);
                break;
            case 'PRICING_UPDATE':
                this.updatePricingDisplay(state);
                break;
        }
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–Ω–µ–ª–µ–π
     */
    initializePanels() {
        this.panels = {
            main: {
                element: document.getElementById('resultsMainPanel'),
                visible: true,
                updateMethod: this.updateMainPanel.bind(this)
            },
            breakdown: {
                element: document.getElementById('resultsBreakdownPanel'),
                visible: true,
                updateMethod: this.updateBreakdownPanel.bind(this)
            },
            composition: {
                element: document.getElementById('resultsCompositionPanel'),
                visible: true,
                updateMethod: this.updateCompositionPanel.bind(this)
            },
            financial: {
                element: document.getElementById('resultsFinancialPanel'),
                visible: true,
                updateMethod: this.updateFinancialPanel.bind(this)
            }
        };

        // –°–æ–∑–¥–∞–µ–º –ø–∞–Ω–µ–ª–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        this.createMissingPanels();
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        this.setupPanelEventListeners();
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–∞–Ω–µ–ª–µ–π
     */
    createMissingPanels() {
        const resultSection = document.querySelector('.result-section');
        if (!resultSection) {
            console.warn('Result section not found');
            return;
        }

        Object.entries(this.panels).forEach(([panelId, panel]) => {
            if (!panel.element) {
                panel.element = this.createPanel(panelId);
                resultSection.appendChild(panel.element);
            }
        });
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–∏
     */
    createPanel(panelId) {
        const panel = document.createElement('div');
        panel.id = `results${panelId.charAt(0).toUpperCase() + panelId.slice(1)}Panel`;
        panel.className = `result-card ${panelId}-panel`;
        
        switch (panelId) {
            case 'main':
                panel.innerHTML = this.renderTemplate('mainPanel', this.getMainPanelData());
                break;
            case 'breakdown':
                panel.innerHTML = this.renderTemplate('breakdownPanel', {});
                break;
            case 'composition':
                panel.innerHTML = this.renderTemplate('compositionPanel', {});
                break;
            default:
                panel.innerHTML = `<div class="panel-placeholder">–ü–∞–Ω–µ–ª—å ${panelId}</div>`;
        }
        
        return panel;
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –ø–∞–Ω–µ–ª–µ–π
     */
    setupPanelEventListeners() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
        document.addEventListener('click', (e) => {
            if (e.target.matches('[data-action="copy"]')) {
                this.copyToClipboard();
            } else if (e.target.matches('[data-action="export"]')) {
                this.showExportModal();
            } else if (e.target.matches('[data-action="share"]')) {
                this.showShareOptions();
            } else if (e.target.matches('[data-toggle="section"]')) {
                this.toggleSection(e.target.closest('.breakdown-section'));
            } else if (e.target.matches('[data-toggle="collapse-all"]')) {
                this.toggleAllSections(false);
            } else if (e.target.matches('[data-toggle="expand-all"]')) {
                this.toggleAllSections(true);
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏
        window.addEventListener('resize', () => {
            this.updatePanelLayout();
        });
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–∞–Ω–µ–ª–µ–π
     */
    updateAllPanels(state) {
        Object.entries(this.panels).forEach(([panelId, panel]) => {
            if (panel.visible && panel.updateMethod) {
                try {
                    panel.updateMethod(state);
                } catch (error) {
                    this.errors.handleError(error, { 
                        context: `ResultsPanel.update${panelId}Panel` 
                    });
                }
            }
        });
        
        this.events.emit('results:panels-updated', state.results);
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏
     */
    updateMainPanel(state) {
        const panel = this.panels.main.element;
        if (!panel) return;

        const { results, pricing } = state;
        const effectiveRate = results.totalHours > 0 ? results.totalCost / results.totalHours : 0;

        // –û–±–Ω–æ–≤–ª—è–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        this.animateCounter('totalCostDisplay', results.totalCost, '‚ÇΩ');
        this.animateCounter('totalHoursDisplay', results.totalHours, '—á');
        this.animateCounter('effectiveRateDisplay', effectiveRate, '‚ÇΩ/—á');

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏
        const costSubtitle = panel.querySelector('.total-cost .summary-subtitle');
        if (costSubtitle) {
            costSubtitle.textContent = this.getCostSubtitle(state);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è
        this.updateStatusIndicators(panel, state);
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
     */
    updateBreakdownPanel(state) {
        const panel = this.panels.breakdown.element;
        if (!panel) return;

        const content = panel.querySelector('#breakdownContent');
        if (!content) return;

        const { results } = state;
        if (!results.breakdown || !results.breakdown.sections) {
            content.innerHTML = '<div class="empty-breakdown">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏</div>';
            return;
        }

        let sectionsHtml = '';
        results.breakdown.sections.forEach((section, index) => {
            const sectionData = {
                sectionId: section.type,
                sectionClass: `section-${section.type}`,
                icon: this.getSectionIcon(section.type),
                title: section.name,
                count: section.items.length,
                total: this.formatCurrency(section.totalCost),
                items: section.items.map(item => ({
                    name: item.name,
                    description: item.description || null,
                    quantity: item.count || null,
                    unitPrice: item.pricePerUnit ? this.formatCurrency(item.pricePerUnit) : null,
                    itemTotal: this.formatCurrency(item.totalCost)
                })),
                expanded: index === 0 // –ü–µ—Ä–≤–∞—è —Å–µ–∫—Ü–∏—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            };
            
            sectionsHtml += this.renderTemplate('breakdownSection', sectionData);
        });

        content.innerHTML = sectionsHtml;
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–µ–∫—Ü–∏–π
        this.setupSectionInteractivity(content);
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ —Å–æ—Å—Ç–∞–≤–∞
     */
    updateCompositionPanel(state) {
        const panel = this.panels.composition.element;
        if (!panel) return;

        const { results } = state;
        if (!results.composition || results.composition.length === 0) {
            panel.innerHTML = '<div class="empty-composition">–ü—Ä–æ–µ–∫—Ç –ø—É—Å—Ç</div>';
            return;
        }

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ —Ç–∏–ø–∞–º
        const categorized = this.categorizeComposition(results.composition);
        
        const compositionData = {
            totalItems: results.composition.length,
            categories: Object.keys(categorized).length,
            categories: Object.entries(categorized).map(([categoryId, items]) => ({
                id: categoryId,
                name: this.getCategoryName(categoryId),
                icon: this.getCategoryIcon(categoryId),
                count: items.length,
                items: items.map(item => ({
                    name: item.name,
                    quantity: item.count
                }))
            }))
        };

        panel.innerHTML = this.renderTemplate('compositionPanel', compositionData);
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
     */
    updateFinancialPanel(state) {
        const panel = this.panels.financial.element;
        if (!panel) return;

        const { results, financial } = state;
        
        const taxAmount = results.totalCost * (financial.taxRate / 100);
        const discountAmount = results.totalCost * (financial.discountRate / 100);
        const netAmount = results.totalCost + discountAmount - taxAmount;

        let financialHtml = `
            <div class="financial-summary">
                <h3>–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞</h3>
                <div class="financial-grid">
                    <div class="financial-item">
                        <span class="financial-label">–í–∞–ª–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                        <span class="financial-value">${this.formatCurrency(results.totalCost)}</span>
                    </div>
        `;

        if (discountAmount !== 0) {
            financialHtml += `
                <div class="financial-item">
                    <span class="financial-label">${discountAmount > 0 ? '–ù–∞—Ü–µ–Ω–∫–∞' : '–°–∫–∏–¥–∫–∞'}:</span>
                    <span class="financial-value ${discountAmount > 0 ? 'positive' : 'negative'}">
                        ${discountAmount > 0 ? '+' : ''}${this.formatCurrency(discountAmount)}
                    </span>
                </div>
            `;
        }

        if (financial.showTaxSeparately && taxAmount > 0) {
            financialHtml += `
                <div class="financial-item">
                    <span class="financial-label">–ù–∞–ª–æ–≥ (${financial.taxRate}%):</span>
                    <span class="financial-value negative">-${this.formatCurrency(taxAmount)}</span>
                </div>
            `;
        }

        financialHtml += `
                <div class="financial-item total">
                    <span class="financial-label">–ö –ø–æ–ª—É—á–µ–Ω–∏—é:</span>
                    <span class="financial-value">${this.formatCurrency(netAmount)}</span>
                </div>
            </div>
        </div>
        `;

        panel.innerHTML = financialHtml;
    }

    /**
     * –ê–Ω–∏–º–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞
     */
    animateCounter(elementId, targetValue, suffix = '') {
        const element = document.getElementById(elementId);
        if (!element) return;

        const currentAnimation = this.animations.counters.get(elementId);
        if (currentAnimation) {
            cancelAnimationFrame(currentAnimation.id);
        }

        const startValue = parseFloat(element.textContent.replace(/[^\d.-]/g, '')) || 0;
        const duration = 1000; // 1 —Å–µ–∫—É–Ω–¥–∞
        const startTime = Date.now();

        const animate = () => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Easing —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
            const easeOutCubic = 1 - Math.pow(1 - progress, 3);
            const currentValue = startValue + (targetValue - startValue) * easeOutCubic;
            
            if (suffix === '‚ÇΩ') {
                element.textContent = this.formatCurrency(currentValue);
            } else if (suffix === '—á') {
                element.textContent = this.formatHours(currentValue);
            } else if (suffix === '‚ÇΩ/—á') {
                element.textContent = this.formatCurrency(currentValue).replace('‚ÇΩ', '') + ' ‚ÇΩ/—á';
            } else {
                element.textContent = Math.round(currentValue).toLocaleString('ru-RU') + suffix;
            }

            if (progress < 1) {
                const animationId = requestAnimationFrame(animate);
                this.animations.counters.set(elementId, { id: animationId });
            } else {
                this.animations.counters.delete(elementId);
            }
        };

        animate();
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏
     */
    getMainPanelData() {
        const state = this.state.getState();
        const { results, pricing } = state;
        const effectiveRate = results.totalHours > 0 ? results.totalCost / results.totalHours : 0;

        return {
            totalCost: this.formatCurrency(results.totalCost),
            totalHours: this.formatHours(results.totalHours),
            effectiveRate: this.formatCurrency(effectiveRate).replace('‚ÇΩ', '') + ' ‚ÇΩ/—á',
            costSubtitle: this.getCostSubtitle(state)
        };
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
     */
    getCostSubtitle(state) {
        const { pricing, financial } = state;
        
        if (financial.showTaxSeparately && financial.taxRate > 0) {
            return '—Å —É—á–µ—Ç–æ–º –Ω–∞–ª–æ–≥–æ–≤';
        } else if (financial.taxRate > 0) {
            return '–≤–∫–ª—é—á–∞—è –Ω–∞–ª–æ–≥–∏';
        }
        
        return '–∑–∞ –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç';
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è
     */
    updateStatusIndicators(panel, state) {
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–∞—Å—á–µ—Ç–∞
        let statusHtml = '<div class="status-indicators">';
        
        const { results, financial, pricing } = state;
        
        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –º–µ—Ç–æ–¥–∞ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
        statusHtml += `<span class="status-indicator method-${pricing.method}">${pricing.method === 'fixed' ? '–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã' : '–ü–æ—á–∞—Å–æ–≤–æ–π —Ä–∞—Å—á–µ—Ç'}</span>`;
        
        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±—ä–µ–º–Ω—ã—Ö —Å–∫–∏–¥–æ–∫
        if (financial.enableVolumeDiscounts) {
            statusHtml += '<span class="status-indicator volume-discounts">–û–±—ä–µ–º–Ω—ã–µ —Å–∫–∏–¥–∫–∏</span>';
        }
        
        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        if (pricing.detailLevel === 'detailed') {
            statusHtml += '<span class="status-indicator detailed-calc">–î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç</span>';
        }
        
        statusHtml += '</div>';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
        let statusContainer = panel.querySelector('.status-indicators');
        if (statusContainer) {
            statusContainer.outerHTML = statusHtml;
        } else {
            const summaryElement = panel.querySelector('.results-summary');
            if (summaryElement) {
                summaryElement.insertAdjacentHTML('afterend', statusHtml);
            }
        }
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–µ–∫—Ü–∏–π
     */
    setupSectionInteractivity(container) {
        container.querySelectorAll('.section-header').forEach(header => {
            header.addEventListener('click', () => {
                const section = header.closest('.breakdown-section');
                this.toggleSection(section);
            });
        });
    }

    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–∏
     */
    toggleSection(section) {
        if (!section) return;
        
        const content = section.querySelector('.section-content');
        const toggle = section.querySelector('.section-toggle');
        
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            toggle.textContent = '‚ñº';
            section.classList.add('expanded');
        } else {
            content.classList.add('collapsed');
            toggle.textContent = '‚ñ∂';
            section.classList.remove('expanded');
        }
    }

    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–µ–∫—Ü–∏–π
     */
    toggleAllSections(expand) {
        const sections = document.querySelectorAll('.breakdown-section');
        sections.forEach(section => {
            const content = section.querySelector('.section-content');
            const toggle = section.querySelector('.section-toggle');
            
            if (expand) {
                content.classList.remove('collapsed');
                toggle.textContent = '‚ñº';
                section.classList.add('expanded');
            } else {
                content.classList.add('collapsed');
                toggle.textContent = '‚ñ∂';
                section.classList.remove('expanded');
            }
        });
    }

    /**
     * –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–∞–≤–∞
     */
    categorizeComposition(composition) {
        const categories = {};
        
        composition.forEach(item => {
            const category = item.type || 'other';
            if (!categories[category]) {
                categories[category] = [];
            }
            categories[category].push(item);
        });
        
        return categories;
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ —Å–µ–∫—Ü–∏–∏
     */
    getSectionIcon(sectionType) {
        const icons = {
            presets: 'üì¶',
            components: 'üß©',
            services: '‚öôÔ∏è',
            custom: 'üîß',
            revisions: '‚úèÔ∏è',
            financial: 'üí∞'
        };
        return icons[sectionType] || 'üìÑ';
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
     */
    getCategoryName(categoryId) {
        const names = {
            presets: '–ü—Ä–µ—Å–µ—Ç—ã',
            components: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã', 
            services: '–£—Å–ª—É–≥–∏',
            custom: '–ö–∞—Å—Ç–æ–º–Ω—ã–µ —É—Å–ª—É–≥–∏'
        };
        return names[categoryId] || categoryId;
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
     */
    getCategoryIcon(categoryId) {
        const icons = {
            presets: 'üì¶',
            components: 'üß©',
            services: '‚öôÔ∏è',
            custom: 'üîß'
        };
        return icons[categoryId] || 'üìÑ';
    }

    /**
     * –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
     */
    async copyToClipboard() {
        try {
            const text = this.generateTextExport();
            
            if (navigator.clipboard) {
                await navigator.clipboard.writeText(text);
            } else {
                // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            }
            
            this.errors.showSuccess('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
            this.events.emit('results:copied');
            
        } catch (error) {
            this.errors.handleError(error, { context: 'ResultsPanel.copyToClipboard' });
        }
    }

    /**
     * –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
     */
    showExportModal() {
        const formatsData = Object.entries(this.exportFormats).map(([id, format]) => ({
            id,
            ...format,
            default: id === 'pdf'
        }));

        const modalHtml = this.renderTemplate('exportModal', { formats: formatsData });
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = modalHtml;
        
        document.body.appendChild(modal);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        setTimeout(() => modal.classList.add('show'), 10);
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        this.setupExportModalHandlers(modal);
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
     */
    setupExportModalHandlers(modal) {
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        modal.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay') || 
                e.target.classList.contains('modal-close') ||
                e.target.matches('[data-action="cancel"]')) {
                this.closeModal(modal);
            }
        });

        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
        modal.addEventListener('change', (e) => {
            if (e.target.name === 'exportFormat') {
                this.updateExportOptions(modal, e.target.value);
            }
        });

        // –≠–∫—Å–ø–æ—Ä—Ç
        modal.addEventListener('click', (e) => {
            if (e.target.matches('[data-action="export"]')) {
                this.performExport(modal);
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
        const selectedFormat = modal.querySelector('input[name="exportFormat"]:checked');
        if (selectedFormat) {
            this.updateExportOptions(modal, selectedFormat.value);
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø—Ü–∏–π —ç–∫—Å–ø–æ—Ä—Ç–∞
     */
    updateExportOptions(modal, formatId) {
        const optionsContainer = modal.querySelector('#exportOptions');
        if (!optionsContainer) return;

        const format = this.exportFormats[formatId];
        if (!format || !format.options) {
            optionsContainer.innerHTML = '';
            return;
        }

        let optionsHtml = '<div class="export-options-content"><h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞</h4>';
        
        Object.entries(format.options).forEach(([optionId, optionValue]) => {
            const optionName = this.getOptionName(optionId);
            
            if (typeof optionValue === 'boolean') {
                optionsHtml += `
                    <label class="option-checkbox">
                        <input type="checkbox" name="${optionId}" ${optionValue ? 'checked' : ''}>
                        <span>${optionName}</span>
                    </label>
                `;
            } else if (typeof optionValue === 'string') {
                optionsHtml += `
                    <label class="option-input">
                        <span>${optionName}:</span>
                        <input type="text" name="${optionId}" value="${optionValue}">
                    </label>
                `;
            }
        });
        
        optionsHtml += '</div>';
        optionsContainer.innerHTML = optionsHtml;
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —á–µ–ª–æ–≤–µ–∫–æ-—á–∏—Ç–∞–µ–º–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è –æ–ø—Ü–∏–∏
     */
    getOptionName(optionId) {
        const names = {
            includeDetails: '–í–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é',
            includeBreakdown: '–í–∫–ª—é—á–∏—Ç—å —Ä–∞–∑–±–∏–≤–∫—É –ø–æ —Å—Ç–∞—Ç—å—è–º',
            includeComposition: '–í–∫–ª—é—á–∏—Ç—å —Å–æ—Å—Ç–∞–≤ –ø—Ä–æ–µ–∫—Ç–∞',
            includeBranding: '–î–æ–±–∞–≤–∏—Ç—å –±—Ä–µ–Ω–¥–∏–Ω–≥',
            watermark: '–î–æ–±–∞–≤–∏—Ç—å –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫',
            includeFormulas: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ä–º—É–ª—ã',
            includeCharts: '–í–∫–ª—é—á–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—ã',
            multipleSheets: '–ù–µ—Å–∫–æ–ª—å–∫–æ –ª–∏—Å—Ç–æ–≤',
            protectStructure: '–ó–∞—â–∏—Ç–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É',
            includeHeader: '–í–∫–ª—é—á–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫',
            includeFooter: '–í–∫–ª—é—á–∏—Ç—å –ø–æ–¥–≤–∞–ª',
            template: '–®–∞–±–ª–æ–Ω',
            formatting: '–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ',
            includeMetadata: '–í–∫–ª—é—á–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ',
            minify: '–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å',
            includeCalculationSteps: '–í–∫–ª—é—á–∏—Ç—å —à–∞–≥–∏ —Ä–∞—Å—á–µ—Ç–∞',
            subject: '–¢–µ–º–∞ –ø–∏—Å—å–º–∞',
            greeting: '–¢–∏–ø –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è',
            signature: '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å',
            attachments: '–í–ª–æ–∂–µ–Ω–∏—è'
        };
        return names[optionId] || optionId;
    }

    /**
     * –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —ç–∫—Å–ø–æ—Ä—Ç–∞
     */
    async performExport(modal) {
        try {
            const selectedFormat = modal.querySelector('input[name="exportFormat"]:checked');
            if (!selectedFormat) {
                this.errors.showWarning('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }

            const formatId = selectedFormat.value;
            const format = this.exportFormats[formatId];

            // –°–æ–±–∏—Ä–∞–µ–º –æ–ø—Ü–∏–∏
            const options = {};
            modal.querySelectorAll('#exportOptions input').forEach(input => {
                if (input.type === 'checkbox') {
                    options[input.name] = input.checked;
                } else {
                    options[input.name] = input.value;
                }
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            this.showExportProgress(modal);

            // –í—ã–ø–æ–ª–Ω—è–µ–º —ç–∫—Å–ø–æ—Ä—Ç
            const result = await format.generator(options);
            
            if (result.success) {
                this.errors.showSuccess(`–§–∞–π–ª ${formatId.toUpperCase()} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω`);
                this.downloadFile(result.data, result.filename);
            } else {
                this.errors.showError(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞: ${result.error}`);
            }

            this.closeModal(modal);
            
        } catch (error) {
            this.errors.handleError(error, { context: 'ResultsPanel.performExport' });
        }
    }

    /**
     * –ü–æ–∫–∞–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
     */
    showExportProgress(modal) {
        const exportButton = modal.querySelector('[data-action="export"]');
        if (exportButton) {
            exportButton.disabled = true;
            exportButton.textContent = '–≠–∫—Å–ø–æ—Ä—Ç...';
        }
    }

    /**
     * –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
     */
    closeModal(modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            if (modal.parentNode) {
                modal.parentNode.removeChild(modal);
            }
        }, 300);
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF
     */
    async generatePDF(options) {
        // –ò–º–∏—Ç–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ç–∏–ø–∞ jsPDF
        return new Promise((resolve) => {
            setTimeout(() => {
                const data = this.generateTextExport();
                resolve({
                    success: true,
                    data: new Blob([data], { type: 'application/pdf' }),
                    filename: `–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä_${Date.now()}.pdf`
                });
            }, 1000);
        });
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Excel
     */
    async generateExcel(options) {
        return new Promise((resolve) => {
            setTimeout(() => {
                const data = this.generateTextExport();
                resolve({
                    success: true,
                    data: new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }),
                    filename: `–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä_${Date.now()}.xlsx`
                });
            }, 1000);
        });
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Word
     */
    async generateWord(options) {
        return new Promise((resolve) => {
            setTimeout(() => {
                const data = this.generateTextExport();
                resolve({
                    success: true,
                    data: new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' }),
                    filename: `–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä_${Date.now()}.docx`
                });
            }, 1000);
        });
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JSON
     */
    async generateJSON(options) {
        const state = this.state.getState();
        const data = JSON.stringify(state, null, options.minify ? 0 : 2);
        
        return {
            success: true,
            data: new Blob([data], { type: 'application/json' }),
            filename: `–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä_${Date.now()}.json`
        };
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Email
     */
    async generateEmail(options) {
        const emailTemplate = this.generateEmailTemplate(options);
        
        return {
            success: true,
            data: new Blob([emailTemplate], { type: 'text/html' }),
            filename: `–ø–∏—Å—å–º–æ_–∫–ª–∏–µ–Ω—Ç—É_${Date.now()}.html`
        };
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–∞ –ø–∏—Å—å–º–∞
     */
    generateEmailTemplate(options) {
        const state = this.state.getState();
        const { results } = state;

        let template = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${options.subject}</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .email-container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { border-bottom: 2px solid #4f46e5; padding-bottom: 20px; margin-bottom: 20px; }
        .results-summary { background: #f8fafc; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .cost-highlight { font-size: 24px; font-weight: bold; color: #4f46e5; }
        .footer { border-top: 1px solid #e5e7eb; padding-top: 20px; margin-top: 30px; font-size: 14px; color: #6b7280; }
    </style>
</head>
<body>
    <div class="email-container">
        <div class="header">
            <h1>–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö —É—Å–ª—É–≥</h1>
            <p>–î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}</p>
        </div>
        
        ${options.greeting === 'formal' ? 
            '<p>–£–≤–∞–∂–∞–µ–º—ã–π –∫–ª–∏–µ–Ω—Ç!</p>' : 
            '<p>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!</p>'}
        
        <p>–ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª –¥–ª—è –í–∞—Å —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö —É—Å–ª—É–≥ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –∑–∞–¥–∞–Ω–∏—é.</p>
        
        <div class="results-summary">
            <h2>–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</h2>
            <div class="cost-highlight">${this.formatCurrency(results.totalCost)}</div>
            <p>–û–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${this.formatHours(results.totalHours)}</p>
        </div>
        
        ${this.generateEmailBreakdown(state)}
        
        <p>–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏.</p>
        <p>–ì–æ—Ç–æ–≤ –æ–±—Å—É–¥–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∏ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã.</p>
        
        ${options.signature ? this.generateEmailSignature() : ''}
    </div>
</body>
</html>
        `;
        
        return template;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø–∏—Å—å–º–∞
     */
    generateEmailBreakdown(state) {
        const { results } = state;
        
        if (!results.breakdown || !results.breakdown.sections) {
            return '';
        }

        let breakdown = '<h3>–°–æ—Å—Ç–∞–≤ –ø—Ä–æ–µ–∫—Ç–∞:</h3><ul>';
        
        results.composition.forEach(item => {
            breakdown += `<li>${item.name} (${item.count} —à—Ç.)</li>`;
        });
        
        breakdown += '</ul>';
        
        return breakdown;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –ø–∏—Å—å–º–∞
     */
    generateEmailSignature() {
        return `
        <div class="footer">
            <p>–° —É–≤–∞–∂–µ–Ω–∏–µ–º,<br>
            [–í–∞—à–µ –∏–º—è]<br>
            –ú–µ—Ç–æ–¥–∏—Å—Ç-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫<br>
            –¢–µ–ª: [–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω]<br>
            Email: [–í–∞—à email]</p>
        </div>
        `;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞
     */
    generateTextExport() {
        const state = this.state.getState();
        const { results, pricing, financial } = state;

        let text = `–†–ê–°–ß–ï–¢ –°–¢–û–ò–ú–û–°–¢–ò –ú–ï–¢–û–î–ò–ß–ï–°–ö–ò–• –£–°–õ–£–ì\n`;
        text += `–î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}\n\n`;

        // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
        text += `–ò–¢–û–ì–û–í–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò:\n`;
        text += `‚Ä¢ –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${this.formatCurrency(results.totalCost)}\n`;
        text += `‚Ä¢ –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${this.formatHours(results.totalHours)}\n`;
        
        const effectiveRate = results.totalHours > 0 ? results.totalCost / results.totalHours : 0;
        text += `‚Ä¢ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Å—Ç–∞–≤–∫–∞: ${this.formatCurrency(effectiveRate).replace('‚ÇΩ', '')} ‚ÇΩ/—á–∞—Å\n\n`;

        // –°–æ—Å—Ç–∞–≤ –ø—Ä–æ–µ–∫—Ç–∞
        if (results.composition && results.composition.length > 0) {
            text += `–°–û–°–¢–ê–í –ü–†–û–ï–ö–¢–ê:\n`;
            results.composition.forEach(item => {
                text += `‚Ä¢ ${item.name} (${item.count} —à—Ç.)\n`;
            });
            text += `\n`;
        }

        // –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è
        if (results.breakdown && results.breakdown.sections) {
            text += `–î–ï–¢–ê–õ–¨–ù–ê–Ø –°–ú–ï–¢–ê:\n\n`;
            
            results.breakdown.sections.forEach(section => {
                text += `${section.name.toUpperCase()}:\n`;
                section.items.forEach(item => {
                    const unitPrice = item.pricePerUnit ? ` (${this.formatCurrency(item.pricePerUnit)}/—à—Ç)` : '';
                    const quantity = item.count ? ` √ó ${item.count}` : '';
                    text += `  ${item.name}${quantity}${unitPrice} ‚Äî ${this.formatCurrency(item.totalCost)}\n`;
                });
                text += `\n`;
            });
        }

        // –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–µ—Ç–∞–ª–∏
        text += `–§–ò–ù–ê–ù–°–û–í–´–ï –£–°–õ–û–í–ò–Ø:\n`;
        text += `‚Ä¢ –ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞: ${pricing.hourlyRate} ‚ÇΩ/—á–∞—Å\n`;
        text += `‚Ä¢ –ú–µ—Ç–æ–¥ —Ä–∞—Å—á–µ—Ç–∞: ${pricing.method === 'fixed' ? '–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã' : '–ü–æ—á–∞—Å–æ–≤–æ–π'}\n`;
        
        if (financial.discountRate !== 0) {
            text += `‚Ä¢ ${financial.discountRate > 0 ? '–ù–∞—Ü–µ–Ω–∫–∞' : '–°–∫–∏–¥–∫–∞'}: ${Math.abs(financial.discountRate)}%\n`;
        }
        
        if (financial.taxRate > 0) {
            text += `‚Ä¢ –ù–∞–ª–æ–≥: ${financial.taxRate}%\n`;
        }
        
        text += `‚Ä¢ –ü—Ä–∞–≤–∫–∏: ${financial.clientType}% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞\n\n`;

        // –£—Å–ª–æ–≤–∏—è
        text += `–û–ë–©–ò–ï –£–°–õ–û–í–ò–Ø:\n`;
        text += `‚Ä¢ –û–ø–ª–∞—Ç–∞ –ø–æ—ç—Ç–∞–ø–Ω–æ –ø–æ —Ñ–∞–∫—Ç—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç\n`;
        text += `‚Ä¢ –°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–±—Å—É–∂–¥–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ\n`;
        text += `‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ 30 –¥–Ω–µ–π\n`;
        text += `‚Ä¢ –í–æ–∑–º–æ–∂–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ—Å–ª–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –¢–ó\n\n`;

        text += `–†–∞—Å—á–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –ø–æ–º–æ—â—å—é –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö —É—Å–ª—É–≥ v2.0`;

        return text;
    }

    /**
     * –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
     */
    downloadFile(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    /**
     * –ü–æ–∫–∞–∑ –æ–ø—Ü–∏–π –ø–æ–¥–µ–ª–∏—Ç—å—Å—è
     */
    showShareOptions() {
        const options = [
            { id: 'email', name: 'Email', icon: 'üìß' },
            { id: 'telegram', name: 'Telegram', icon: 'üì±' },
            { id: 'whatsapp', name: 'WhatsApp', icon: 'üí¨' },
            { id: 'link', name: '–°—Å—ã–ª–∫–∞', icon: 'üîó' }
        ];

        let optionsHtml = '<div class="share-options">';
        options.forEach(option => {
            optionsHtml += `
                <button class="share-option" data-method="${option.id}">
                    <span class="share-icon">${option.icon}</span>
                    <span class="share-name">${option.name}</span>
                </button>
            `;
        });
        optionsHtml += '</div>';

        this.errors.showInfo('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏', {
            html: optionsHtml,
            duration: 0,
            actions: options.map(opt => ({
                label: opt.name,
                action: `share_${opt.id}`
            }))
        });
    }

    /**
     * –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
     */
    shareResults(method) {
        const text = this.generateTextExport();
        const url = window.location.href;

        switch (method) {
            case 'email':
                const emailSubject = encodeURIComponent('–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö —É—Å–ª—É–≥');
                const emailBody = encodeURIComponent(text);
                window.open(`mailto:?subject=${emailSubject}&body=${emailBody}`);
                break;
                
            case 'telegram':
                const telegramText = encodeURIComponent(text.substring(0, 2000) + '...');
                window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${telegramText}`);
                break;
                
            case 'whatsapp':
                const whatsappText = encodeURIComponent(text.substring(0, 1000) + '...');
                window.open(`https://wa.me/?text=${whatsappText}`);
                break;
                
            case 'link':
                navigator.clipboard.writeText(url).then(() => {
                    this.errors.showSuccess('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
                });
                break;
        }
    }

    /**
     * –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
     */
    compareResults(previousState) {
        if (!previousState) {
            this.errors.showWarning('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è');
            return;
        }

        const currentState = this.state.getState();
        const comparison = this.calculateComparison(currentState, previousState);
        
        this.showComparisonModal(comparison);
    }

    /**
     * –†–∞—Å—á–µ—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
     */
    calculateComparison(current, previous) {
        const currentResults = current.results;
        const previousResults = previous.results;

        const costDiff = currentResults.totalCost - previousResults.totalCost;
        const hoursDiff = currentResults.totalHours - previousResults.totalHours;
        const costPercent = previousResults.totalCost > 0 ? 
            (costDiff / previousResults.totalCost) * 100 : 0;

        return {
            cost: {
                current: currentResults.totalCost,
                previous: previousResults.totalCost,
                difference: costDiff,
                percentage: costPercent
            },
            hours: {
                current: currentResults.totalHours,
                previous: previousResults.totalHours,
                difference: hoursDiff
            },
            changes: this.findChanges(current, previous)
        };
    }

    /**
     * –ü–æ–∏—Å–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π
     */
    findChanges(current, previous) {
        const changes = [];

        // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–æ–≤
        Object.keys({...current.presets, ...previous.presets}).forEach(presetType => {
            const currentCount = current.presets[presetType]?.count || 0;
            const previousCount = previous.presets[presetType]?.count || 0;
            
            if (currentCount !== previousCount) {
                changes.push({
                    type: 'preset',
                    item: presetType,
                    change: `${previousCount} ‚Üí ${currentCount}`,
                    impact: currentCount > previousCount ? 'increase' : 'decrease'
                });
            }
        });

        // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        if (current.pricing.hourlyRate !== previous.pricing.hourlyRate) {
            changes.push({
                type: 'pricing',
                item: '–ß–∞—Å–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞',
                change: `${previous.pricing.hourlyRate} ‚Üí ${current.pricing.hourlyRate} ‚ÇΩ/—á`,
                impact: current.pricing.hourlyRate > previous.pricing.hourlyRate ? 'increase' : 'decrease'
            });
        }

        return changes;
    }

    /**
     * –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
     */
    showComparisonModal(comparison) {
        let modalHtml = `
            <div class="comparison-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="comparison-summary">
                            <div class="comparison-item">
                                <label>–°—Ç–æ–∏–º–æ—Å—Ç—å:</label>
                                <span class="comparison-value ${comparison.cost.difference >= 0 ? 'increase' : 'decrease'}">
                                    ${this.formatCurrency(comparison.cost.current)}
                                    (${comparison.cost.difference >= 0 ? '+' : ''}${this.formatCurrency(comparison.cost.difference)})
                                </span>
                            </div>
                            <div class="comparison-item">
                                <label>–í—Ä–µ–º—è:</label>
                                <span class="comparison-value ${comparison.hours.difference >= 0 ? 'increase' : 'decrease'}">
                                    ${this.formatHours(comparison.hours.current)}
                                    (${comparison.hours.difference >= 0 ? '+' : ''}${this.formatHours(comparison.hours.difference)})
                                </span>
                            </div>
                        </div>
        `;

        if (comparison.changes.length > 0) {
            modalHtml += '<div class="changes-list"><h4>–ò–∑–º–µ–Ω–µ–Ω–∏—è:</h4>';
            comparison.changes.forEach(change => {
                modalHtml += `
                    <div class="change-item ${change.impact}">
                        <span class="change-type">${change.type}</span>
                        <span class="change-description">${change.item}: ${change.change}</span>
                    </div>
                `;
            });
            modalHtml += '</div>';
        }

        modalHtml += `
                    </div>
                    <div class="modal-footer">
                        <button class="button secondary modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            </div>
        `;

        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = modalHtml;
        document.body.appendChild(modal);

        setTimeout(() => modal.classList.add('show'), 10);

        modal.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay') || 
                e.target.classList.contains('modal-close')) {
                this.closeModal(modal);
            }
        });
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∫ —à–∞–±–ª–æ–Ω
     */
    saveAsTemplate(name) {
        const state = this.state.getState();
        const template = {
            name,
            description: `–®–∞–±–ª–æ–Ω —Å–æ–∑–¥–∞–Ω ${new Date().toLocaleDateString('ru-RU')}`,
            settings: {
                pricing: state.pricing,
                financial: state.financial,
                presets: state.presets,
                components: state.components,
                services: state.services
            },
            results: {
                totalCost: state.results.totalCost,
                totalHours: state.results.totalHours
            },
            createdAt: Date.now()
        };

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ - –Ω–∞ —Å–µ—Ä–≤–µ—Ä)
        const templates = JSON.parse(localStorage.getItem('calculatorTemplates') || '[]');
        templates.push(template);
        localStorage.setItem('calculatorTemplates', JSON.stringify(templates));

        this.errors.showSuccess(`–®–∞–±–ª–æ–Ω "${name}" —Å–æ—Ö—Ä–∞–Ω–µ–Ω`);
        this.events.emit('template:saved', template);
    }

    /**
     * –ü–µ—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
     */
    printResults() {
        const printContent = this.generatePrintContent();
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.print();
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏
     */
    generatePrintContent() {
        const state = this.state.getState();
        
        return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö —É—Å–ª—É–≥</title>
    <style>
        body { font-family: Arial, sans-serif; font-size: 12px; line-height: 1.4; }
        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .summary { background: #f5f5f5; padding: 15px; margin: 15px 0; }
        .breakdown { margin: 20px 0; }
        .section { margin-bottom: 15px; }
        .section-title { font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        .item { display: flex; justify-content: space-between; padding: 2px 0; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        td, th { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #f0f0f0; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö —É—Å–ª—É–≥</h1>
        <p>–î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}</p>
    </div>
    
    <div class="summary">
        <h2>–ò—Ç–æ–≥–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
        <p><strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong> ${this.formatCurrency(state.results.totalCost)}</p>
        <p><strong>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</strong> ${this.formatHours(state.results.totalHours)}</p>
    </div>
    
    ${this.generatePrintBreakdown(state)}
    
    <div class="footer" style="margin-top: 30px; border-top: 1px solid #ccc; padding-top: 10px; font-size: 10px;">
        <p>–†–∞—Å—á–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –ø–æ–º–æ—â—å—é –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö —É—Å–ª—É–≥ v2.0</p>
    </div>
</body>
</html>
        `;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø–µ—á–∞—Ç–∏
     */
    generatePrintBreakdown(state) {
        const { results } = state;
        
        if (!results.breakdown || !results.breakdown.sections) {
            return '';
        }

        let html = '<div class="breakdown"><h3>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è</h3>';
        
        results.breakdown.sections.forEach(section => {
            html += `
                <div class="section">
                    <div class="section-title">${section.name}</div>
            `;
            
            section.items.forEach(item => {
                const quantity = item.count ? ` (${item.count} —à—Ç.)` : '';
                html += `
                    <div class="item">
                        <span>${item.name}${quantity}</span>
                        <span>${this.formatCurrency(item.totalCost)}</span>
                    </div>
                `;
            });
            
            html += '</div>';
        });
        
        html += '</div>';
        return html;
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞–∫–µ—Ç–∞ –ø–∞–Ω–µ–ª–µ–π
     */
    updatePanelLayout() {
        const isMobile = window.innerWidth <= 768;
        
        Object.values(this.panels).forEach(panel => {
            if (panel.element) {
                panel.element.classList.toggle('mobile', isMobile);
            }
        });
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —à–∞–±–ª–æ–Ω–∞ (–ø—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
     */
    renderTemplate(templateName, data) {
        let template = this.templates[templateName];
        if (!template) {
            console.warn(`Template ${templateName} not found`);
            return '';
        }

        // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        return template.replace(/\{\{(\w+)\}\}/g, (match, key) => {
            return data[key] !== undefined ? data[key] : '';
        }).replace(/\{\{#if (\w+)\}\}(.*?)\{\{\/if\}\}/gs, (match, condition, content) => {
            return data[condition] ? content : '';
        }).replace(/\{\{#unless (\w+)\}\}(.*?)\{\{\/unless\}\}/gs, (match, condition, content) => {
            return !data[condition] ? content : '';
        }).replace(/\{\{#each (\w+)\}\}(.*?)\{\{\/each\}\}/gs, (match, arrayName, itemTemplate) => {
            const array = data[arrayName];
            if (!Array.isArray(array)) return '';
            
            return array.map(item => {
                return itemTemplate.replace(/\{\{(\w+)\}\}/g, (m, key) => item[key] || '');
            }).join('');
        });
    }

    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª—é—Ç—ã
     */
    formatCurrency(amount) {
        if (typeof amount !== 'number' || isNaN(amount)) return '0 ‚ÇΩ';
        return Math.round(amount).toLocaleString('ru-RU') + ' ‚ÇΩ';
    }

    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å–æ–≤
     */
    formatHours(hours) {
        if (typeof hours !== 'number' || isNaN(hours)) return '0 —á';
        return (Math.round(hours * 10) / 10) + ' —á';
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–∞–Ω–µ–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
     */
    getStatistics() {
        const state = this.state.getState();
        
        return {
            panels: Object.keys(this.panels).length,
            visiblePanels: Object.values(this.panels).filter(p => p.visible).length,
            exportFormats: Object.keys(this.exportFormats).length,
            lastUpdate: Date.now(),
            state: {
                totalCost: state.results.totalCost,
                totalHours: state.results.totalHours,
                itemsCount: state.results.composition?.length || 0
            }
        };
    }

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–∞–Ω–µ–ª–∏
     */
    exportSettings() {
        return {
            panels: Object.fromEntries(
                Object.entries(this.panels).map(([id, panel]) => [id, {
                    visible: panel.visible
                }])
            ),
            exportFormats: this.exportFormats,
            templates: this.templates
        };
    }

    /**
     * –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –º–æ–¥—É–ª—è
     */
    destroy() {
        // –û—Ç–ø–∏—Å–∫–∞ –æ—Ç —Å–æ–±—ã—Ç–∏–π
        this.events.off('results:export');
        this.events.off('results:copy');
        this.events.off('results:print');
        this.events.off('results:share');
        this.events.off('results:compare');
        this.events.off('results:save-template');

        // –û—á–∏—Å—Ç–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–π
        this.animations.counters.forEach(animation => {
            if (animation.id) {
                cancelAnimationFrame(animation.id);
            }
        });
        this.animations.counters.clear();
        this.animations.charts.clear();

        // –û—á–∏—Å—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        this.updateQueue = [];

        // –£–¥–∞–ª–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        document.querySelectorAll('.modal-overlay').forEach(modal => modal.remove());

        console.log('üìä ResultsPanel destroyed');
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
if (typeof module !== 'undefined' && module.exports) {
    module.exports = ResultsPanel;
} else if (typeof window !== 'undefined') {
    window.ResultsPanel = ResultsPanel;
}

        /**
 * StorageManager.js - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ –∏ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
 * –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è, –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
 */

class StorageManager {
    constructor(stateManager, eventBus, errorHandler) {
        this.state = stateManager;
        this.events = eventBus;
        this.errors = errorHandler;
        
        this.storageKey = 'methodCalculator_v2';
        this.autoSaveInterval = 30000; // 30 —Å–µ–∫—É–Ω–¥
        this.maxHistoryEntries = 50;
        this.maxAutoSaves = 10;
        
        this.autoSaveTimer = null;
        this.lastSaveTimestamp = 0;
        this.saveQueue = [];
        this.isOnline = navigator.onLine;
        
        this.storageTypes = this.initializeStorageTypes();
        this.compressionEnabled = true;
        this.encryptionEnabled = false; // –î–ª—è –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏–π
        
        this.init();
        console.log('üíæ StorageManager initialized');
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è
     */
    init() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å localStorage
        this.checkStorageAvailability();
        
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
        this.state.subscribe((state, action) => {
            this.handleStateChange(state, action);
        });

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
        this.events.on('storage:save', () => this.saveCurrentState());
        this.events.on('storage:load', (data) => this.loadState(data.stateId));
        this.events.on('storage:auto-save', () => this.performAutoSave());
        this.events.on('storage:clear', () => this.clearAllData());
        this.events.on('storage:export-all', () => this.exportAllData());
        this.events.on('storage:import-all', (data) => this.importAllData(data.data));
        this.events.on('storage:get-history', () => this.getHistory());
        this.events.on('storage:restore-backup', (data) => this.restoreFromBackup(data.backupId));

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
        window.addEventListener('beforeunload', () => this.handleBeforeUnload());
        window.addEventListener('online', () => this.handleOnlineStatus(true));
        window.addEventListener('offline', () => this.handleOnlineStatus(false));
        window.addEventListener('storage', (e) => this.handleStorageChange(e));
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        this.startAutoSave();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        this.loadLastState();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        this.initializeBackupSystem();
        
        console.log('StorageManager setup complete');
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∏–ø–æ–≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
     */
    initializeStorageTypes() {
        return {
            localStorage: {
                available: this.testLocalStorage(),
                priority: 1,
                save: this.saveToLocalStorage.bind(this),
                load: this.loadFromLocalStorage.bind(this),
                remove: this.removeFromLocalStorage.bind(this),
                getSize: this.getLocalStorageSize.bind(this)
            },
            indexedDB: {
                available: this.testIndexedDB(),
                priority: 2,
                save: this.saveToIndexedDB.bind(this),
                load: this.loadFromIndexedDB.bind(this),
                remove: this.removeFromIndexedDB.bind(this),
                getSize: this.getIndexedDBSize.bind(this)
            },
            memory: {
                available: true,
                priority: 3,
                data: new Map(),
                save: this.saveToMemory.bind(this),
                load: this.loadFromMemory.bind(this),
                remove: this.removeFromMemory.bind(this),
                getSize: this.getMemorySize.bind(this)
            }
        };
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
     */
    checkStorageAvailability() {
        const available = [];
        const unavailable = [];

        Object.entries(this.storageTypes).forEach(([type, storage]) => {
            if (storage.available) {
                available.push(type);
            } else {
                unavailable.push(type);
            }
        });

        console.log('Available storage types:', available);
        if (unavailable.length > 0) {
            console.warn('Unavailable storage types:', unavailable);
        }

        if (available.length === 0) {
            this.errors.showError('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–Ω–Ω—ã—Ö');
        }
    }

    /**
     * –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ localStorage
     */
    testLocalStorage() {
        try {
            const testKey = '__storage_test__';
            localStorage.setItem(testKey, 'test');
            localStorage.removeItem(testKey);
            return true;
        } catch (error) {
            return false;
        }
    }

    /**
     * –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ IndexedDB
     */
    testIndexedDB() {
        return typeof indexedDB !== 'undefined';
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è
     */
    handleStateChange(state, action) {
        try {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —ç—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
            if (this.shouldTriggerSave(action.type)) {
                this.scheduleAutoSave();
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π
            this.addToChangeHistory(state, action);

        } catch (error) {
            this.errors.handleError(error, { 
                context: 'StorageManager.handleStateChange',
                action: action.type 
            });
        }
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
     */
    shouldTriggerSave(actionType) {
        const saveTriggerActions = [
            'PRESET_UPDATE',
            'COMPONENT_TOGGLE', 
            'SERVICE_TOGGLE',
            'FINANCIAL_UPDATE',
            'PRICING_UPDATE',
            'CUSTOM_SERVICE_ADD',
            'CUSTOM_SERVICE_REMOVE'
        ];
        
        return saveTriggerActions.includes(actionType);
    }

    /**
     * –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
     */
    scheduleAutoSave() {
        // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
        if (this.autoSaveTimer) {
            clearTimeout(this.autoSaveTimer);
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä
        this.autoSaveTimer = setTimeout(() => {
            this.performAutoSave();
        }, 2000); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    }

    /**
     * –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
     */
    async performAutoSave() {
        try {
            const state = this.state.getState();
            const saveData = this.prepareSaveData(state, 'auto');
            
            const saved = await this.saveWithFallback(saveData);
            
            if (saved) {
                this.lastSaveTimestamp = Date.now();
                this.events.emit('storage:auto-saved', { timestamp: this.lastSaveTimestamp });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–Ω–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                this.showAutoSaveIndicator();
                
                // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                this.cleanupAutoSaves();
            }

        } catch (error) {
            this.errors.handleError(error, { context: 'StorageManager.performAutoSave' });
        }
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
     */
    async saveCurrentState(name = null, description = null) {
        try {
            const state = this.state.getState();
            const saveData = this.prepareSaveData(state, 'manual', name, description);
            
            const saved = await this.saveWithFallback(saveData);
            
            if (saved) {
                this.errors.showSuccess(`–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${saveData.name}`);
                this.events.emit('storage:saved', saveData);
                return saveData.id;
            } else {
                this.errors.showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
                return null;
            }

        } catch (error) {
            this.errors.handleError(error, { context: 'StorageManager.saveCurrentState' });
            return null;
        }
    }

    /**
     * –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
     */
    prepareSaveData(state, type = 'manual', name = null, description = null) {
        const timestamp = Date.now();
        const id = this.generateId();
        
        // –°–æ–∑–¥–∞–µ–º –∏–º—è –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ
        if (!name) {
            if (type === 'auto') {
                name = `–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ${new Date(timestamp).toLocaleString('ru-RU')}`;
            } else {
                name = `–†–∞—Å—á–µ—Ç ${new Date(timestamp).toLocaleString('ru-RU')}`;
            }
        }

        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        const metadata = {
            id,
            name,
            description,
            type,
            timestamp,
            version: '2.0.0',
            checksum: this.calculateChecksum(state),
            size: JSON.stringify(state).length,
            summary: this.generateStateSummary(state)
        };

        // –°–∂–∏–º–∞–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
        const stateData = this.compressionEnabled ? 
            this.compressData(state) : state;

        return {
            ...metadata,
            state: stateData,
            compressed: this.compressionEnabled
        };
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å fallback –º–µ—Ö–∞–Ω–∏–∑–º–æ–º
     */
    async saveWithFallback(saveData) {
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
        const storageList = Object.entries(this.storageTypes)
            .filter(([_, storage]) => storage.available)
            .sort(([_, a], [__, b]) => a.priority - b.priority);

        for (const [storageType, storage] of storageList) {
            try {
                await storage.save(saveData);
                console.log(`Saved to ${storageType}:`, saveData.id);
                return true;
            } catch (error) {
                console.warn(`Failed to save to ${storageType}:`, error);
                continue;
            }
        }

        return false;
    }

    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
     */
    async loadState(stateId = null) {
        try {
            let saveData;

            if (stateId) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                saveData = await this.loadWithFallback(stateId);
            } else {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                saveData = await this.loadLastSave();
            }

            if (!saveData) {
                this.errors.showWarning('–°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                return false;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
            if (!this.validateSaveData(saveData)) {
                this.errors.showError('–î–∞–Ω–Ω—ã–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã –∏ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                return false;
            }

            // –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const state = saveData.compressed ? 
                this.decompressData(saveData.state) : saveData.state;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            this.state.dispatch({
                type: 'STATE_LOAD',
                payload: state
            });

            this.errors.showSuccess(`–°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${saveData.name}`);
            this.events.emit('storage:loaded', saveData);
            
            return true;

        } catch (error) {
            this.errors.handleError(error, { context: 'StorageManager.loadState' });
            return false;
        }
    }

    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ —Å fallback –º–µ—Ö–∞–Ω–∏–∑–º–æ–º
     */
    async loadWithFallback(stateId) {
        const storageList = Object.entries(this.storageTypes)
            .filter(([_, storage]) => storage.available)
            .sort(([_, a], [__, b]) => a.priority - b.priority);

        for (const [storageType, storage] of storageList) {
            try {
                const data = await storage.load(stateId);
                if (data) {
                    console.log(`Loaded from ${storageType}:`, stateId);
                    return data;
                }
            } catch (error) {
                console.warn(`Failed to load from ${storageType}:`, error);
                continue;
            }
        }

        return null;
    }

    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
     */
    async loadLastSave() {
        try {
            const saves = await this.getAllSaves();
            if (saves.length === 0) return null;

            // –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Ä—É—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ—Ç - –±–µ—Ä–µ–º –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            const manualSaves = saves.filter(save => save.type === 'manual');
            const lastSave = manualSaves.length > 0 ? 
                manualSaves[manualSaves.length - 1] : 
                saves[saves.length - 1];

            return await this.loadWithFallback(lastSave.id);

        } catch (error) {
            console.warn('Failed to load last save:', error);
            return null;
        }
    }

    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
     */
    async loadLastState() {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            const lastSave = await this.loadLastSave();
            
            if (lastSave) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
                this.showRestoreNotification(lastSave);
            } else {
                console.log('No saved state found, starting with default state');
            }

        } catch (error) {
            console.warn('Failed to load last state:', error);
        }
    }

    /**
     * –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
     */
    showRestoreNotification(saveData) {
        const timeDiff = Date.now() - saveData.timestamp;
        const hours = Math.floor(timeDiff / (1000 * 60 * 60));
        const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
        
        let timeText;
        if (hours > 0) {
            timeText = `${hours}—á ${minutes}–º–∏–Ω –Ω–∞–∑–∞–¥`;
        } else if (minutes > 0) {
            timeText = `${minutes}–º–∏–Ω –Ω–∞–∑–∞–¥`;
        } else {
            timeText = '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        }

        this.errors.showInfo(
            `–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${saveData.name} (${timeText})`,
            '–ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ'
        );
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
     */
    async getAllSaves() {
        try {
            const saves = [];
            
            // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑ localStorage (–æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫)
            const savedList = localStorage.getItem(`${this.storageKey}_list`);
            if (savedList) {
                const list = JSON.parse(savedList);
                for (const saveInfo of list) {
                    const saveData = await this.loadWithFallback(saveInfo.id);
                    if (saveData) {
                        saves.push(saveData);
                    }
                }
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è
            saves.sort((a, b) => a.timestamp - b.timestamp);
            
            return saves;

        } catch (error) {
            console.warn('Failed to get all saves:', error);
            return [];
        }
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
     */
    getHistory() {
        try {
            const historyKey = `${this.storageKey}_history`;
            const historyData = localStorage.getItem(historyKey);
            
            if (historyData) {
                const history = JSON.parse(historyData);
                this.events.emit('storage:history-loaded', history);
                return history;
            }
            
            return [];

        } catch (error) {
            this.errors.handleError(error, { context: 'StorageManager.getHistory' });
            return [];
        }
    }

    /**
     * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π
     */
    addToChangeHistory(state, action) {
        try {
            const historyKey = `${this.storageKey}_history`;
            let history = [];
            
            try {
                const existingHistory = localStorage.getItem(historyKey);
                if (existingHistory) {
                    history = JSON.parse(existingHistory);
                }
            } catch (error) {
                console.warn('Failed to load existing history:', error);
            }

            const historyEntry = {
                id: this.generateId(),
                timestamp: Date.now(),
                action: action.type,
                summary: this.generateActionSummary(action),
                stateSummary: this.generateStateSummary(state)
            };

            history.push(historyEntry);

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
            if (history.length > this.maxHistoryEntries) {
                history = history.slice(-this.maxHistoryEntries);
            }

            localStorage.setItem(historyKey, JSON.stringify(history));

        } catch (error) {
            console.warn('Failed to add to history:', error);
        }
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–≤–æ–¥–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è
     */
    generateActionSummary(action) {
        const summaries = {
            'PRESET_UPDATE': '–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–∞',
            'COMPONENT_TOGGLE': '–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞', 
            'SERVICE_TOGGLE': '–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ª—É–≥–∏',
            'FINANCIAL_UPDATE': '–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫',
            'PRICING_UPDATE': '–ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è',
            'CUSTOM_SERVICE_ADD': '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–π —É—Å–ª—É–≥–∏',
            'CUSTOM_SERVICE_REMOVE': '–£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–π —É—Å–ª—É–≥–∏'
        };
        
        return summaries[action.type] || action.type;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–≤–æ–¥–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
     */
    generateStateSummary(state) {
        const activePresets = Object.entries(state.presets || {})
            .filter(([_, data]) => data.count > 0).length;
        
        const activeComponents = Object.keys(state.components || {}).length;
        const activeServices = Object.keys(state.services || {}).length;
        const customServices = (state.customServices || []).length;

        return {
            totalCost: state.results?.totalCost || 0,
            totalHours: state.results?.totalHours || 0,
            activePresets,
            activeComponents,
            activeServices,
            customServices,
            totalItems: activePresets + activeComponents + activeServices + customServices
        };
    }

    /**
     * –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
     */
    async cleanupAutoSaves() {
        try {
            const saves = await this.getAllSaves();
            const autoSaves = saves
                .filter(save => save.type === 'auto')
                .sort((a, b) => b.timestamp - a.timestamp);

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ
            if (autoSaves.length > this.maxAutoSaves) {
                const toDelete = autoSaves.slice(this.maxAutoSaves);
                
                for (const save of toDelete) {
                    await this.deleteSave(save.id);
                }
            }

        } catch (error) {
            console.warn('Failed to cleanup auto saves:', error);
        }
    }

    /**
     * –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
     */
    async deleteSave(saveId) {
        try {
            // –£–¥–∞–ª—è–µ–º –∏–∑ –≤—Å–µ—Ö —Ö—Ä–∞–Ω–∏–ª–∏—â
            const storageList = Object.entries(this.storageTypes)
                .filter(([_, storage]) => storage.available);

            for (const [storageType, storage] of storageList) {
                try {
                    await storage.remove(saveId);
                } catch (error) {
                    console.warn(`Failed to remove from ${storageType}:`, error);
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
            await this.updateSavesList();
            
            this.events.emit('storage:save-deleted', { saveId });

        } catch (error) {
            this.errors.handleError(error, { context: 'StorageManager.deleteSave' });
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
     */
    async updateSavesList() {
        try {
            const saves = await this.getAllSaves();
            const savesList = saves.map(save => ({
                id: save.id,
                name: save.name,
                type: save.type,
                timestamp: save.timestamp,
                summary: save.summary
            }));

            localStorage.setItem(`${this.storageKey}_list`, JSON.stringify(savesList));

        } catch (error) {
            console.warn('Failed to update saves list:', error);
        }
    }

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
     */
    async exportAllData() {
        try {
            const saves = await this.getAllSaves();
            const history = this.getHistory();
            
            const exportData = {
                version: '2.0.0',
                exportTimestamp: Date.now(),
                saves,
                history,
                metadata: {
                    totalSaves: saves.length,
                    totalHistoryEntries: history.length,
                    storageTypes: Object.keys(this.storageTypes).filter(
                        type => this.storageTypes[type].available
                    )
                }
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                type: 'application/json'
            });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `calculator_backup_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            this.errors.showSuccess('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ');
            this.events.emit('storage:exported', exportData.metadata);

        } catch (error) {
            this.errors.handleError(error, { context: 'StorageManager.exportAllData' });
        }
    }

    /**
     * –ò–º–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
     */
    async importAllData(data) {
        try {
            if (!data || !data.saves) {
                throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞');
            }

            let importedCount = 0;
            
            for (const saveData of data.saves) {
                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
                    if (this.validateSaveData(saveData)) {
                        await this.saveWithFallback(saveData);
                        importedCount++;
                    }
                } catch (error) {
                    console.warn('Failed to import save:', saveData.id, error);
                }
            }

            // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
            if (data.history) {
                try {
                    const historyKey = `${this.storageKey}_history`;
                    localStorage.setItem(historyKey, JSON.stringify(data.history));
                } catch (error) {
                    console.warn('Failed to import history:', error);
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
            await this.updateSavesList();

            this.errors.showSuccess(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${importedCount} –∏–∑ ${data.saves.length} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π`);
            this.events.emit('storage:imported', { 
                total: data.saves.length, 
                imported: importedCount 
            });

        } catch (error) {
            this.errors.handleError(error, { context: 'StorageManager.importAllData' });
        }
    }

    /**
     * –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
     */
    async clearAllData() {
        try {
            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const confirmed = confirm(
                '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.'
            );
            
            if (!confirmed) return;

            // –û—á–∏—â–∞–µ–º –≤—Å–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
            const storageList = Object.entries(this.storageTypes)
                .filter(([_, storage]) => storage.available);

            for (const [storageType, storage] of storageList) {
                try {
                    if (storageType === 'localStorage') {
                        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–ª—é—á–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º
                        const keys = Object.keys(localStorage)
                            .filter(key => key.startsWith(this.storageKey));
                        keys.forEach(key => localStorage.removeItem(key));
                    } else if (storageType === 'memory') {
                        storage.data.clear();
                    }
                    // IndexedDB –æ—á–∏—Å—Ç–∫–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
                } catch (error) {
                    console.warn(`Failed to clear ${storageType}:`, error);
                }
            }

            this.errors.showSuccess('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
            this.events.emit('storage:cleared');

        } catch (error) {
            this.errors.handleError(error, { context: 'StorageManager.clearAllData' });
        }
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
     */
    initializeBackupSystem() {
        // –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ä–∞–∑ –≤ –¥–µ–Ω—å
        const lastBackup = localStorage.getItem(`${this.storageKey}_last_backup`);
        const now = Date.now();
        const oneDayMs = 24 * 60 * 60 * 1000;

        if (!lastBackup || (now - parseInt(lastBackup)) > oneDayMs) {
            this.createDailyBackup();
        }
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
     */
    async createDailyBackup() {
        try {
            const state = this.state.getState();
            const backupData = this.prepareSaveData(state, 'backup', '–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è');
            
            const backupKey = `${this.storageKey}_backup_${new Date().toISOString().split('T')[0]}`;
            localStorage.setItem(backupKey, JSON.stringify(backupData));
            localStorage.setItem(`${this.storageKey}_last_backup`, Date.now().toString());

            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ (—Ö—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)
            this.cleanupOldBackups();

        } catch (error) {
            console.warn('Failed to create daily backup:', error);
        }
    }

    /**
     * –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
     */
    cleanupOldBackups() {
        try {
            const backupKeys = Object.keys(localStorage)
                .filter(key => key.startsWith(`${this.storageKey}_backup_`))
                .sort()
                .reverse();

            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 7
            if (backupKeys.length > 7) {
                const toDelete = backupKeys.slice(7);
                toDelete.forEach(key => localStorage.removeItem(key));
            }

        } catch (error) {
            console.warn('Failed to cleanup old backups:', error);
        }
    }

    /**
     * –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
     */
    async restoreFromBackup(backupId) {
        try {
            const backupKey = `${this.storageKey}_backup_${backupId}`;
            const backupData = localStorage.getItem(backupKey);
            
            if (!backupData) {
                this.errors.showError('–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return false;
            }

            const saveData = JSON.parse(backupData);
            
            if (this.validateSaveData(saveData)) {
                const state = saveData.compressed ? 
                    this.decompressData(saveData.state) : saveData.state;

                this.state.dispatch({
                    type: 'STATE_LOAD',
                    payload: state
                });

                this.errors.showSuccess('–î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏');
                this.events.emit('storage:backup-restored', { backupId });
                return true;
            } else {
                this.errors.showError('–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞');
                return false;
            }

        } catch (error) {
            this.errors.handleError(error, { context: 'StorageManager.restoreFromBackup' });
            return false;
        }
    }

    /**
     * –†–µ–∞–ª–∏–∑–∞—Ü–∏—è localStorage –º–µ—Ç–æ–¥–æ–≤
     */
    async saveToLocalStorage(saveData) {
        const key = `${this.storageKey}_${saveData.id}`;
        localStorage.setItem(key, JSON.stringify(saveData));
        await this.updateSavesList();
    }

    async loadFromLocalStorage(saveId) {
        const key = `${this.storageKey}_${saveId}`;
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
    }

    async removeFromLocalStorage(saveId) {
        const key = `${this.storageKey}_${saveId}`;
        localStorage.removeItem(key);
    }

    getLocalStorageSize() {
        let total = 0;
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith(this.storageKey)) {
                total += localStorage.getItem(key).length;
            }
        });
        return total;
    }

    /**
     * –†–µ–∞–ª–∏–∑–∞—Ü–∏—è IndexedDB –º–µ—Ç–æ–¥–æ–≤ (–±–∞–∑–æ–≤–∞—è)
     */
    async saveToIndexedDB(saveData) {
        // –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('MethodCalculator', 1);
            
            request.onerror = () => reject(request.error);
            
            request.onsuccess = () => {
                const db = request.result;
                const transaction = db.transaction(['saves'], 'readwrite');
                const store = transaction.objectStore('saves');
                
                const saveRequest = store.put(saveData);
                saveRequest.onsuccess = () => resolve();
                saveRequest.onerror = () => reject(saveRequest.error);
            };
            
            request.onupgradeneeded = () => {
                const db = request.result;
                if (!db.objectStoreNames.contains('saves')) {
                    db.createObjectStore('saves', { keyPath: 'id' });
                }
            };
        });
    }

    async loadFromIndexedDB(saveId) {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('MethodCalculator', 1);
            
            request.onerror = () => reject(request.error);
            
            request.onsuccess = () => {
                const db = request.result;
                const transaction = db.transaction(['saves'], 'readonly');
                const store = transaction.objectStore('saves');
                
                const getRequest = store.get(saveId);
                getRequest.onsuccess = () => resolve(getRequest.result);
                getRequest.onerror = () => reject(getRequest.error);
            };
        });
    }

    async removeFromIndexedDB(saveId) {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('MethodCalculator', 1);
            
            request.onerror = () => reject(request.error);
            
            request.onsuccess = () => {
                const db = request.result;
                const transaction = db.transaction(['saves'], 'readwrite');
                const store = transaction.objectStore('saves');
                
                const deleteRequest = store.delete(saveId);
                deleteRequest.onsuccess = () => resolve();
                deleteRequest.onerror = () => reject(deleteRequest.error);
            };
        });
    }

    getIndexedDBSize() {
        // –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
        return 0;
    }

    /**
     * –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Memory –º–µ—Ç–æ–¥–æ–≤
     */
    async saveToMemory(saveData) {
        this.storageTypes.memory.data.set(saveData.id, saveData);
    }

    async loadFromMemory(saveId) {
        return this.storageTypes.memory.data.get(saveId) || null;
    }

    async removeFromMemory(saveId) {
        this.storageTypes.memory.data.delete(saveId);
    }

    getMemorySize() {
        let total = 0;
        this.storageTypes.memory.data.forEach(data => {
            total += JSON.stringify(data).length;
        });
        return total;
    }

    /**
     * –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
     */
    startAutoSave() {
        if (this.autoSaveTimer) {
            clearInterval(this.autoSaveTimer);
        }

        this.autoSaveTimer = setInterval(() => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∏ –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            const now = Date.now();
            if (now - this.lastSaveTimestamp > this.autoSaveInterval) {
                this.performAutoSave();
            }
        }, this.autoSaveInterval);
    }

    /**
     * –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
     */
    stopAutoSave() {
        if (this.autoSaveTimer) {
            clearInterval(this.autoSaveTimer);
            this.autoSaveTimer = null;
        }
    }

    /**
     * –ü–æ–∫–∞–∑ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
     */
    showAutoSaveIndicator() {
        // –°–æ–∑–¥–∞–µ–º —Ç–æ–Ω–∫–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        let indicator = document.getElementById('autoSaveIndicator');
        
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'autoSaveIndicator';
            indicator.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: #10b981;
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
            `;
            document.body.appendChild(indicator);
        }

        indicator.textContent = 'üíæ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ';
        indicator.style.opacity = '1';

        // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            indicator.style.opacity = '0';
        }, 2000);
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è beforeunload
     */
    handleBeforeUnload() {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
        const state = this.state.getState();
        const saveData = this.prepareSaveData(state, 'exit');
        
        try {
            // –ë—ã—Å—Ç—Ä–æ–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            localStorage.setItem(`${this.storageKey}_exit`, JSON.stringify(saveData));
        } catch (error) {
            console.warn('Failed to save on exit:', error);
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞
     */
    handleOnlineStatus(isOnline) {
        this.isOnline = isOnline;
        
        if (isOnline) {
            this.errors.showSuccess('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å –æ–±–ª–∞–∫–æ–º
        } else {
            this.errors.showWarning('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.');
        }
        
        this.events.emit('storage:online-status-changed', { isOnline });
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ storage (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏)
     */
    handleStorageChange(event) {
        if (event.key && event.key.startsWith(this.storageKey)) {
            // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –≤–Ω–µ—à–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
            this.events.emit('storage:external-change', {
                key: event.key,
                oldValue: event.oldValue,
                newValue: event.newValue
            });
        }
    }

    /**
     * –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
     */
    validateSaveData(saveData) {
        if (!saveData || typeof saveData !== 'object') {
            return false;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        const requiredFields = ['id', 'name', 'timestamp', 'version', 'state'];
        for (const field of requiredFields) {
            if (!(field in saveData)) {
                console.warn(`Missing required field: ${field}`);
                return false;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º checksum –µ—Å–ª–∏ –µ—Å—Ç—å
        if (saveData.checksum) {
            const calculatedChecksum = this.calculateChecksum(saveData.state);
            if (calculatedChecksum !== saveData.checksum) {
                console.warn('Checksum mismatch');
                return false;
            }
        }

        return true;
    }

    /**
     * –†–∞—Å—á–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã
     */
    calculateChecksum(data) {
        const str = JSON.stringify(data);
        let hash = 0;
        
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ 32-–±–∏—Ç–Ω–æ–µ —Ü–µ–ª–æ–µ
        }
        
        return hash.toString();
    }

    /**
     * –°–∂–∞—Ç–∏–µ –¥–∞–Ω–Ω—ã—Ö (–±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
     */
    compressData(data) {
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LZ-string –∏–ª–∏ –ø–æ–¥–æ–±–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É
        const jsonString = JSON.stringify(data);
        
        // –ü—Ä–æ—Å—Ç–æ–µ —Å–∂–∞—Ç–∏–µ: —É–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –∑–∞–º–µ–Ω—è–µ–º —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—â–∏–µ—Å—è —Å—Ç—Ä–æ–∫–∏
        const compressed = jsonString
            .replace(/\s+/g, ' ')
            .replace(/"pricing"/g, '"p"')
            .replace(/"results"/g, '"r"')
            .replace(/"components"/g, '"c"')
            .replace(/"services"/g, '"s"')
            .replace(/"financial"/g, '"f"');
            
        return compressed;
    }

    /**
     * –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
     */
    decompressData(compressedData) {
        // –û–±—Ä–∞—Ç–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
        const jsonString = compressedData
            .replace(/"p"/g, '"pricing"')
            .replace(/"r"/g, '"results"')
            .replace(/"c"/g, '"components"')
            .replace(/"s"/g, '"services"')
            .replace(/"f"/g, '"financial"');
            
        return JSON.parse(jsonString);
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID
     */
    generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
     */
    getStorageInfo() {
        const info = {
            available: [],
            sizes: {},
            totalSize: 0,
            quotaUsed: 0,
            isOnline: this.isOnline
        };

        Object.entries(this.storageTypes).forEach(([type, storage]) => {
            if (storage.available) {
                info.available.push(type);
                const size = storage.getSize();
                info.sizes[type] = size;
                info.totalSize += size;
            }
        });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–≤–æ—Ç—É localStorage
        try {
            const testKey = '__quota_test__';
            const testValue = 'x'.repeat(1024); // 1KB
            let used = 0;
            
            while (true) {
                try {
                    localStorage.setItem(testKey + used, testValue);
                    used++;
                } catch (e) {
                    localStorage.removeItem(testKey + (used - 1));
                    break;
                }
            }
            
            // –û—á–∏—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            for (let i = 0; i < used; i++) {
                localStorage.removeItem(testKey + i);
            }
            
            info.quotaUsed = (info.sizes.localStorage || 0) / (used * 1024);
            
        } catch (error) {
            console.warn('Failed to check storage quota:', error);
        }

        return info;
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π –¥–ª—è UI
     */
    async getSavesList() {
        try {
            const saves = await this.getAllSaves();
            
            return saves.map(save => ({
                id: save.id,
                name: save.name,
                description: save.description,
                type: save.type,
                timestamp: save.timestamp,
                summary: save.summary,
                size: save.size,
                timeAgo: this.getTimeAgo(save.timestamp)
            }));

        } catch (error) {
            this.errors.handleError(error, { context: 'StorageManager.getSavesList' });
            return [];
        }
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ "–Ω–∞–∑–∞–¥"
     */
    getTimeAgo(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        
        const minutes = Math.floor(diff / (1000 * 60));
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        
        if (days > 0) {
            return `${days} –¥–Ω. –Ω–∞–∑–∞–¥`;
        } else if (hours > 0) {
            return `${hours} —á. –Ω–∞–∑–∞–¥`;
        } else if (minutes > 0) {
            return `${minutes} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
        } else {
            return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        }
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
     */
    async createRestorePoint(name = null) {
        const state = this.state.getState();
        const restoreName = name || `–¢–æ—á–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ${new Date().toLocaleString('ru-RU')}`;
        
        return await this.saveCurrentState(restoreName, '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
     */
    getStorageStatistics() {
        const info = this.getStorageInfo();
        const stats = {
            storageInfo: info,
            autoSaveEnabled: !!this.autoSaveTimer,
            lastSaveTime: this.lastSaveTimestamp,
            compressionEnabled: this.compressionEnabled,
            encryptionEnabled: this.encryptionEnabled
        };

        return stats;
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
     */
    configureStorage(options) {
        if (options.autoSaveInterval !== undefined) {
            this.autoSaveInterval = Math.max(10000, options.autoSaveInterval); // –ú–∏–Ω–∏–º—É–º 10 —Å–µ–∫—É–Ω–¥
            this.stopAutoSave();
            this.startAutoSave();
        }

        if (options.maxHistoryEntries !== undefined) {
            this.maxHistoryEntries = Math.max(10, options.maxHistoryEntries);
        }

        if (options.maxAutoSaves !== undefined) {
            this.maxAutoSaves = Math.max(5, options.maxAutoSaves);
        }

        if (options.compressionEnabled !== undefined) {
            this.compressionEnabled = options.compressionEnabled;
        }

        this.events.emit('storage:configured', options);
    }

    /**
     * –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –º–æ–¥—É–ª—è
     */
    destroy() {
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        this.stopAutoSave();

        // –û—Ç–ø–∏—Å–∫–∞ –æ—Ç —Å–æ–±—ã—Ç–∏–π
        this.events.off('storage:save');
        this.events.off('storage:load');
        this.events.off('storage:auto-save');
        this.events.off('storage:clear');
        this.events.off('storage:export-all');
        this.events.off('storage:import-all');
        this.events.off('storage:get-history');
        this.events.off('storage:restore-backup');

        // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
        window.removeEventListener('beforeunload', this.handleBeforeUnload);
        window.removeEventListener('online', this.handleOnlineStatus);
        window.removeEventListener('offline', this.handleOnlineStatus);
        window.removeEventListener('storage', this.handleStorageChange);

        // –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        try {
            this.performAutoSave();
        } catch (error) {
            console.warn('Failed to perform final save:', error);
        }

        // –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏
        this.storageTypes.memory.data.clear();
        this.saveQueue = [];

        // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const indicator = document.getElementById('autoSaveIndicator');
        if (indicator) {
            indicator.remove();
        }

        console.log('üíæ StorageManager destroyed');
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
if (typeof module !== 'undefined' && module.exports) {
    module.exports = StorageManager;
} else if (typeof window !== 'undefined') {
    window.StorageManager = StorageManager;
}

/**
 * ExportManager.js - –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
 * –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –æ—Ç—á–µ—Ç–æ–≤ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
 */

class ExportManager {
    constructor(stateManager, eventBus, errorHandler) {
        this.state = stateManager;
        this.events = eventBus;
        this.errors = errorHandler;
        
        this.generators = this.initializeGenerators();
        this.templates = this.initializeTemplates();
        this.formatters = this.initializeFormatters();
        this.integrations = this.initializeIntegrations();
        
        this.defaultSettings = {
            includeBranding: true,
            includeTimestamp: true,
            includeWatermark: false,
            language: 'ru',
            currency: 'RUB',
            dateFormat: 'DD.MM.YYYY',
            numberFormat: 'ru-RU'
        };
        
        this.init();
        console.log('üì§ ExportManager initialized');
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è
     */
    init() {
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
        this.events.on('export:document', (data) => this.exportDocument(data));
        this.events.on('export:report', (data) => this.generateReport(data));
        this.events.on('export:integration', (data) => this.performIntegration(data));
        this.events.on('export:bulk', (data) => this.bulkExport(data));
        this.events.on('export:custom', (data) => this.customExport(data));
        this.events.on('export:email', (data) => this.prepareEmailExport(data));
        this.events.on('export:api', (data) => this.apiExport(data));

        console.log('ExportManager setup complete');
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
     */
    initializeGenerators() {
        return {
            pdf: {
                name: 'PDF Document',
                extensions: ['.pdf'],
                mimeType: 'application/pdf',
                generator: this.generatePDF.bind(this),
                options: {
                    pageSize: 'A4',
                    orientation: 'portrait',
                    margins: { top: 20, right: 20, bottom: 20, left: 20 },
                    fonts: ['Arial', 'Times New Roman', 'Helvetica'],
                    compression: true,
                    metadata: true
                }
            },
            excel: {
                name: 'Excel Spreadsheet',
                extensions: ['.xlsx', '.xls'],
                mimeType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                generator: this.generateExcel.bind(this),
                options: {
                    worksheets: ['–†–∞—Å—á–µ—Ç', '–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è', '–°–æ—Å—Ç–∞–≤'],
                    charts: true,
                    formulas: true,
                    formatting: true,
                    protection: false
                }
            },
            word: {
                name: 'Word Document',
                extensions: ['.docx', '.doc'],
                mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                generator: this.generateWord.bind(this),
                options: {
                    template: 'commercial',
                    styling: 'professional',
                    headers: true,
                    footers: true,
                    toc: false
                }
            },
            powerpoint: {
                name: 'PowerPoint Presentation',
                extensions: ['.pptx', '.ppt'],
                mimeType: 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                generator: this.generatePowerPoint.bind(this),
                options: {
                    template: 'business',
                    slides: ['title', 'summary', 'breakdown', 'details'],
                    animations: false,
                    notes: true
                }
            },
            csv: {
                name: 'CSV Data',
                extensions: ['.csv'],
                mimeType: 'text/csv',
                generator: this.generateCSV.bind(this),
                options: {
                    delimiter: ',',
                    encoding: 'UTF-8',
                    headers: true,
                    quotes: true
                }
            },
            json: {
                name: 'JSON Data',
                extensions: ['.json'],
                mimeType: 'application/json',
                generator: this.generateJSON.bind(this),
                options: {
                    pretty: true,
                    metadata: true,
                    validation: true,
                    schema: true
                }
            },
            html: {
                name: 'HTML Report',
                extensions: ['.html', '.htm'],
                mimeType: 'text/html',
                generator: this.generateHTML.bind(this),
                options: {
                    template: 'modern',
                    responsive: true,
                    printable: true,
                    interactive: false
                }
            }
        };
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤
     */
    initializeTemplates() {
        return {
            commercial: {
                name: '–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ',
                description: '–§–æ—Ä–º–∞–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç—É',
                sections: ['header', 'summary', 'breakdown', 'terms', 'contact'],
                style: 'professional'
            },
            technical: {
                name: '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ',
                description: '–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π',
                sections: ['header', 'scope', 'deliverables', 'timeline', 'specifications'],
                style: 'detailed'
            },
            invoice: {
                name: '–°—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É',
                description: '–î–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞',
                sections: ['header', 'client', 'items', 'total', 'payment'],
                style: 'formal'
            },
            presentation: {
                name: '–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞',
                description: '–°–ª–∞–π–¥—ã –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç—É',
                sections: ['title', 'overview', 'breakdown', 'timeline', 'contact'],
                style: 'visual'
            },
            report: {
                name: '–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç',
                description: '–ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–µ–∫—Ç–∞',
                sections: ['executive', 'analysis', 'recommendations', 'appendix'],
                style: 'analytical'
            }
        };
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–µ—Ä–æ–≤
     */
    initializeFormatters() {
        return {
            currency: this.formatCurrency.bind(this),
            number: this.formatNumber.bind(this),
            date: this.formatDate.bind(this),
            duration: this.formatDuration.bind(this),
            percentage: this.formatPercentage.bind(this),
            fileSize: this.formatFileSize.bind(this)
        };
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
     */
    initializeIntegrations() {
        return {
            googleSheets: {
                name: 'Google Sheets',
                enabled: false,
                apiEndpoint: 'https://sheets.googleapis.com/v4/spreadsheets',
                requiredScopes: ['https://www.googleapis.com/auth/spreadsheets'],
                export: this.exportToGoogleSheets.bind(this)
            },
            microsoftExcel: {
                name: 'Microsoft Excel Online',
                enabled: false,
                apiEndpoint: 'https://graph.microsoft.com/v1.0/me/drive/items',
                requiredScopes: ['Files.ReadWrite'],
                export: this.exportToMicrosoftExcel.bind(this)
            },
            airtable: {
                name: 'Airtable',
                enabled: false,
                apiEndpoint: 'https://api.airtable.com/v0',
                requiredScopes: ['data:write'],
                export: this.exportToAirtable.bind(this)
            },
            notion: {
                name: 'Notion',
                enabled: false,
                apiEndpoint: 'https://api.notion.com/v1',
                requiredScopes: ['read', 'write'],
                export: this.exportToNotion.bind(this)
            },
            webhook: {
                name: 'Custom Webhook',
                enabled: true,
                configurable: true,
                export: this.exportToWebhook.bind(this)
            }
        };
    }

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞
     */
    async exportDocument(data) {
        try {
            const { format, template, options = {}, filename } = data;
            
            if (!this.generators[format]) {
                throw new Error(`–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç: ${format}`);
            }

            const generator = this.generators[format];
            const exportOptions = { ...generator.options, ...options };
            
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
            const exportData = await this.prepareExportData(template, exportOptions);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
            const result = await generator.generator(exportData, exportOptions);
            
            if (result.success) {
                // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                this.downloadFile(result.blob, filename || result.filename);
                
                this.errors.showSuccess(`–î–æ–∫—É–º–µ–Ω—Ç ${format.toUpperCase()} —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ`);
                this.events.emit('export:document-completed', { format, filename: result.filename });
                
                return result;
            } else {
                throw new Error(result.error || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞');
            }

        } catch (error) {
            this.errors.handleError(error, { context: 'ExportManager.exportDocument' });
            return { success: false, error: error.message };
        }
    }

    /**
     * –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
     */
    async prepareExportData(template, options) {
        const state = this.state.getState();
        const timestamp = new Date();
        
        const exportData = {
            // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            metadata: {
                exportDate: timestamp,
                version: '2.0.0',
                template,
                calculatorSettings: {
                    pricingMethod: state.pricing.method,
                    detailLevel: state.pricing.detailLevel,
                    hourlyRate: state.pricing.hourlyRate
                }
            },
            
            // –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            results: {
                totalCost: state.results.totalCost,
                totalHours: state.results.totalHours,
                effectiveRate: state.results.totalHours > 0 ? 
                    state.results.totalCost / state.results.totalHours : 0,
                summary: this.generateResultsSummary(state)
            },
            
            // –°–æ—Å—Ç–∞–≤ –ø—Ä–æ–µ–∫—Ç–∞
            composition: this.prepareComposition(state),
            
            // –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è
            breakdown: this.prepareBreakdown(state),
            
            // –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–µ—Ç–∞–ª–∏
            financial: this.prepareFinancialData(state),
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            settings: this.prepareSettingsData(state),
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            formatted: this.prepareFormattedData(state, options)
        };

        return exportData;
    }

    /**
     * –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–æ—Å—Ç–∞–≤–∞ –ø—Ä–æ–µ–∫—Ç–∞
     */
    prepareComposition(state) {
        const composition = [];
        
        // –ü—Ä–µ—Å–µ—Ç—ã
        Object.entries(state.presets).forEach(([presetType, data]) => {
            if (data.count > 0) {
                composition.push({
                    category: 'preset',
                    type: presetType,
                    name: this.getPresetName(presetType),
                    quantity: data.count,
                    duration: data.duration,
                    unit: '—à—Ç.',
                    price: this.calculatePresetPrice(presetType, data, state)
                });
            }
        });
        
        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        Object.entries(state.components).forEach(([componentId, data]) => {
            composition.push({
                category: 'component',
                type: componentId,
                name: this.getComponentName(componentId),
                quantity: data.count || 1,
                hours: data.hours,
                unit: '—à—Ç.',
                price: this.calculateComponentPrice(componentId, data, state)
            });
        });
        
        // –£—Å–ª—É–≥–∏
        Object.entries(state.services).forEach(([serviceId, data]) => {
            composition.push({
                category: 'service',
                type: serviceId,
                name: this.getServiceName(serviceId),
                quantity: data.count || 1,
                hours: data.hours,
                unit: data.count ? '—à—Ç.' : '—É—Å–ª—É–≥–∞',
                price: this.calculateServicePrice(serviceId, data, state)
            });
        });
        
        // –ö–∞—Å—Ç–æ–º–Ω—ã–µ —É—Å–ª—É–≥–∏
        state.customServices.forEach(service => {
            composition.push({
                category: 'custom',
                type: 'custom',
                name: service.name,
                quantity: service.count,
                hours: service.hours,
                unit: '—à—Ç.',
                price: service.pricePerUnit * service.count
            });
        });
        
        return composition;
    }

     /**
     * –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
     */
    prepareBreakdown(state) {
        const breakdown = {
            sections: [],
            totals: {
                subtotal: 0,
                discounts: 0,
                taxes: 0,
                finalTotal: state.results.totalCost
            }
        };

        if (state.results.breakdown && state.results.breakdown.sections) {
            breakdown.sections = state.results.breakdown.sections.map(section => ({
                name: section.name,
                type: section.type,
                items: section.items.map(item => ({
                    name: item.name,
                    description: item.description || '',
                    quantity: item.count || 1,
                    unitPrice: item.pricePerUnit || 0,
                    totalPrice: item.totalCost || 0
                })),
                sectionTotal: section.totalCost || 0
            }));

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º subtotal
            breakdown.totals.subtotal = breakdown.sections.reduce(
                (sum, section) => sum + section.sectionTotal, 0
            );
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞—Å—á–µ—Ç—ã
        const discountAmount = breakdown.totals.subtotal * (state.financial.discountRate / 100);
        const taxAmount = (breakdown.totals.subtotal + discountAmount) * (state.financial.taxRate / 100);
        
        breakdown.totals.discounts = discountAmount;
        breakdown.totals.taxes = taxAmount;

        return breakdown;
    }

    /**
     * –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
     */
    prepareFinancialData(state) {
        return {
            settings: {
                method: state.pricing.method,
                hourlyRate: state.pricing.hourlyRate,
                discountRate: state.financial.discountRate,
                taxRate: state.financial.taxRate,
                clientType: state.financial.clientType,
                enableVolumeDiscounts: state.financial.enableVolumeDiscounts
            },
            calculations: {
                grossAmount: state.results.totalCost,
                discountAmount: state.results.totalCost * (state.financial.discountRate / 100),
                taxAmount: state.results.totalCost * (state.financial.taxRate / 100),
                netAmount: state.results.totalCost - (state.results.totalCost * (state.financial.taxRate / 100))
            }
        };
    }

    /**
     * –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
     */
    prepareSettingsData(state) {
        return {
            pricing: state.pricing,
            complexity: state.complexity,
            financial: state.financial,
            exportSettings: this.defaultSettings
        };
    }

    /**
     * –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
     */
    prepareFormattedData(state, options) {
        const locale = options.numberFormat || this.defaultSettings.numberFormat;
        
        return {
            totalCost: this.formatters.currency(state.results.totalCost, locale),
            totalHours: this.formatters.duration(state.results.totalHours),
            effectiveRate: this.formatters.currency(
                state.results.totalHours > 0 ? state.results.totalCost / state.results.totalHours : 0,
                locale
            ),
            discountRate: this.formatters.percentage(state.financial.discountRate),
            taxRate: this.formatters.percentage(state.financial.taxRate),
            exportDate: this.formatters.date(new Date(), options.dateFormat),
            exportTime: new Date().toLocaleTimeString(locale)
        };
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –¥–æ–∫—É–º–µ–Ω—Ç–∞
     */
    async generatePDF(exportData, options) {
        try {
            // –ò–º–∏—Ç–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º jsPDF –∏–ª–∏ –ø–æ–¥–æ–±–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
            const content = this.generatePDFContent(exportData, options);
            
            const blob = new Blob([content], { type: 'application/pdf' });
            const filename = this.generateFilename('pdf', exportData);
            
            return {
                success: true,
                blob,
                filename,
                size: blob.size
            };

        } catch (error) {
            return {
                success: false,
                error: error.message
            };
        }
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ PDF
     */
    generatePDFContent(exportData, options) {
        // –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è jsPDF
        let content = `%PDF-1.4\n`;
        content += `–†–ê–°–ß–ï–¢ –°–¢–û–ò–ú–û–°–¢–ò –ú–ï–¢–û–î–ò–ß–ï–°–ö–ò–• –£–°–õ–£–ì\n\n`;
        content += `–î–∞—Ç–∞: ${exportData.formatted.exportDate}\n`;
        content += `–í—Ä–µ–º—è: ${exportData.formatted.exportTime}\n\n`;
        
        content += `–ò–¢–û–ì–û–í–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò:\n`;
        content += `–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${exportData.formatted.totalCost}\n`;
        content += `–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${exportData.formatted.totalHours}\n`;
        content += `–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Å—Ç–∞–≤–∫–∞: ${exportData.formatted.effectiveRate}\n\n`;
        
        if (exportData.composition.length > 0) {
            content += `–°–û–°–¢–ê–í –ü–†–û–ï–ö–¢–ê:\n`;
            exportData.composition.forEach(item => {
                content += `‚Ä¢ ${item.name} (${item.quantity} ${item.unit}) - ${this.formatters.currency(item.price)}\n`;
            });
            content += `\n`;
        }
        
        if (exportData.breakdown.sections.length > 0) {
            content += `–î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø:\n`;
            exportData.breakdown.sections.forEach(section => {
                content += `\n${section.name}:\n`;
                section.items.forEach(item => {
                    content += `  ${item.name} - ${this.formatters.currency(item.totalPrice)}\n`;
                });
            });
        }
        
        return content;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Excel –¥–æ–∫—É–º–µ–Ω—Ç–∞
     */
    async generateExcel(exportData, options) {
        try {
            const workbook = this.createExcelWorkbook(exportData, options);
            const blob = new Blob([workbook], { 
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
            });
            const filename = this.generateFilename('xlsx', exportData);
            
            return {
                success: true,
                blob,
                filename,
                size: blob.size,
                worksheets: options.worksheets.length
            };

        } catch (error) {
            return {
                success: false,
                error: error.message
            };
        }
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ Excel workbook
     */
    createExcelWorkbook(exportData, options) {
        // –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è SheetJS –∏–ª–∏ –ø–æ–¥–æ–±–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
        let workbook = `<?xml version="1.0" encoding="UTF-8"?>\n`;
        workbook += `<workbook>\n`;
        
        // –õ–∏—Å—Ç "–†–∞—Å—á–µ—Ç"
        if (options.worksheets.includes('–†–∞—Å—á–µ—Ç')) {
            workbook += this.createSummaryWorksheet(exportData);
        }
        
        // –õ–∏—Å—Ç "–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è"
        if (options.worksheets.includes('–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è')) {
            workbook += this.createBreakdownWorksheet(exportData);
        }
        
        // –õ–∏—Å—Ç "–°–æ—Å—Ç–∞–≤"
        if (options.worksheets.includes('–°–æ—Å—Ç–∞–≤')) {
            workbook += this.createCompositionWorksheet(exportData);
        }
        
        workbook += `</workbook>`;
        return workbook;
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ —Å–≤–æ–¥–∫–∏
     */
    createSummaryWorksheet(exportData) {
        let worksheet = `<worksheet name="–†–∞—Å—á–µ—Ç">\n`;
        worksheet += `<row><cell>–ü–∞—Ä–∞–º–µ—Ç—Ä</cell><cell>–ó–Ω–∞—á–µ–Ω–∏–µ</cell></row>\n`;
        worksheet += `<row><cell>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</cell><cell>${exportData.results.totalCost}</cell></row>\n`;
        worksheet += `<row><cell>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</cell><cell>${exportData.results.totalHours}</cell></row>\n`;
        worksheet += `<row><cell>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Å—Ç–∞–≤–∫–∞</cell><cell>${exportData.results.effectiveRate}</cell></row>\n`;
        worksheet += `</worksheet>\n`;
        return worksheet;
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
     */
    createBreakdownWorksheet(exportData) {
        let worksheet = `<worksheet name="–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è">\n`;
        worksheet += `<row><cell>–°–µ–∫—Ü–∏—è</cell><cell>–≠–ª–µ–º–µ–Ω—Ç</cell><cell>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</cell><cell>–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</cell><cell>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</cell></row>\n`;
        
        exportData.breakdown.sections.forEach(section => {
            section.items.forEach(item => {
                worksheet += `<row>`;
                worksheet += `<cell>${section.name}</cell>`;
                worksheet += `<cell>${item.name}</cell>`;
                worksheet += `<cell>${item.quantity}</cell>`;
                worksheet += `<cell>${item.unitPrice}</cell>`;
                worksheet += `<cell>${item.totalPrice}</cell>`;
                worksheet += `</row>\n`;
            });
        });
        
        worksheet += `</worksheet>\n`;
        return worksheet;
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ —Å–æ—Å—Ç–∞–≤–∞
     */
    createCompositionWorksheet(exportData) {
        let worksheet = `<worksheet name="–°–æ—Å—Ç–∞–≤">\n`;
        worksheet += `<row><cell>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</cell><cell>–ù–∞–∑–≤–∞–Ω–∏–µ</cell><cell>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</cell><cell>–ï–¥–∏–Ω–∏—Ü–∞</cell><cell>–°—Ç–æ–∏–º–æ—Å—Ç—å</cell></row>\n`;
        
        exportData.composition.forEach(item => {
            worksheet += `<row>`;
            worksheet += `<cell>${item.category}</cell>`;
            worksheet += `<cell>${item.name}</cell>`;
            worksheet += `<cell>${item.quantity}</cell>`;
            worksheet += `<cell>${item.unit}</cell>`;
            worksheet += `<cell>${item.price}</cell>`;
            worksheet += `</row>\n`;
        });
        
        worksheet += `</worksheet>\n`;
        return worksheet;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Word –¥–æ–∫—É–º–µ–Ω—Ç–∞
     */
    async generateWord(exportData, options) {
        try {
            const document = this.createWordDocument(exportData, options);
            const blob = new Blob([document], { 
                type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' 
            });
            const filename = this.generateFilename('docx', exportData);
            
            return {
                success: true,
                blob,
                filename,
                size: blob.size
            };

        } catch (error) {
            return {
                success: false,
                error: error.message
            };
        }
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ Word –¥–æ–∫—É–º–µ–Ω—Ç–∞
     */
    createWordDocument(exportData, options) {
        // –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è docx –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
        let document = `<?xml version="1.0" encoding="UTF-8"?>\n`;
        document += `<document>\n`;
        
        if (options.headers) {
            document += this.createWordHeader(exportData);
        }
        
        document += this.createWordBody(exportData, options);
        
        if (options.footers) {
            document += this.createWordFooter(exportData);
        }
        
        document += `</document>`;
        return document;
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ Word –¥–æ–∫—É–º–µ–Ω—Ç–∞
     */
    createWordHeader(exportData) {
        return `
        <header>
            <h1>–†–ê–°–ß–ï–¢ –°–¢–û–ò–ú–û–°–¢–ò –ú–ï–¢–û–î–ò–ß–ï–°–ö–ò–• –£–°–õ–£–ì</h1>
            <p>–î–∞—Ç–∞: ${exportData.formatted.exportDate}</p>
        </header>
        `;
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–ª–∞ Word –¥–æ–∫—É–º–µ–Ω—Ç–∞
     */
    createWordBody(exportData, options) {
        let body = `<body>\n`;
        
        // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
        body += `
        <section>
            <h2>–ò—Ç–æ–≥–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
            <table>
                <tr><td>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</td><td>${exportData.formatted.totalCost}</td></tr>
                <tr><td>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</td><td>${exportData.formatted.totalHours}</td></tr>
                <tr><td>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Å—Ç–∞–≤–∫–∞:</td><td>${exportData.formatted.effectiveRate}</td></tr>
            </table>
        </section>
        `;
        
        // –°–æ—Å—Ç–∞–≤ –ø—Ä–æ–µ–∫—Ç–∞
        if (exportData.composition.length > 0) {
            body += `
            <section>
                <h2>–°–æ—Å—Ç–∞–≤ –ø—Ä–æ–µ–∫—Ç–∞</h2>
                <table>
                    <thead>
                        <tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th><th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th></tr>
                    </thead>
                    <tbody>
            `;
            
            exportData.composition.forEach(item => {
                body += `<tr><td>${item.name}</td><td>${item.quantity} ${item.unit}</td><td>${this.formatters.currency(item.price)}</td></tr>`;
            });
            
            body += `
                    </tbody>
                </table>
            </section>
            `;
        }
        
        body += `</body>\n`;
        return body;
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–≤–∞–ª–∞ Word –¥–æ–∫—É–º–µ–Ω—Ç–∞
     */
    createWordFooter(exportData) {
        return `
        <footer>
            <p>–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω ${exportData.formatted.exportDate} –≤ ${exportData.formatted.exportTime}</p>
            <p>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö —É—Å–ª—É–≥ v2.0</p>
        </footer>
        `;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PowerPoint –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
     */
    async generatePowerPoint(exportData, options) {
        try {
            const presentation = this.createPowerPointPresentation(exportData, options);
            const blob = new Blob([presentation], { 
                type: 'application/vnd.openxmlformats-officedocument.presentationml.presentation' 
            });
            const filename = this.generateFilename('pptx', exportData);
            
            return {
                success: true,
                blob,
                filename,
                size: blob.size,
                slides: options.slides.length
            };

        } catch (error) {
            return {
                success: false,
                error: error.message
            };
        }
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ PowerPoint –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
     */
    createPowerPointPresentation(exportData, options) {
        let presentation = `<?xml version="1.0" encoding="UTF-8"?>\n`;
        presentation += `<presentation>\n`;
        
        options.slides.forEach((slideType, index) => {
            presentation += this.createPowerPointSlide(slideType, exportData, index + 1);
        });
        
        presentation += `</presentation>`;
        return presentation;
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–∞–π–¥–∞ PowerPoint
     */
    createPowerPointSlide(slideType, exportData, slideNumber) {
        let slide = `<slide number="${slideNumber}">\n`;
        
        switch (slideType) {
            case 'title':
                slide += `
                <title>–†–ê–°–ß–ï–¢ –°–¢–û–ò–ú–û–°–¢–ò –ú–ï–¢–û–î–ò–ß–ï–°–ö–ò–• –£–°–õ–£–ì</title>
                <subtitle>${exportData.formatted.exportDate}</subtitle>
                `;
                break;
                
            case 'summary':
                slide += `
                <title>–ò—Ç–æ–≥–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</title>
                <content>
                    <item>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${exportData.formatted.totalCost}</item>
                    <item>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${exportData.formatted.totalHours}</item>
                    <item>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Å—Ç–∞–≤–∫–∞: ${exportData.formatted.effectiveRate}</item>
                </content>
                `;
                break;
                
            case 'breakdown':
                slide += `
                <title>–°–æ—Å—Ç–∞–≤ –ø—Ä–æ–µ–∫—Ç–∞</title>
                <content>
                `;
                exportData.composition.slice(0, 8).forEach(item => {
                    slide += `<item>${item.name}: ${this.formatters.currency(item.price)}</item>`;
                });
                slide += `</content>`;
                break;
                
            case 'details':
                slide += `
                <title>–î–µ—Ç–∞–ª–∏ —Ä–∞—Å—á–µ—Ç–∞</title>
                <content>
                    <item>–ú–µ—Ç–æ–¥: ${exportData.settings.pricing.method}</item>
                    <item>–ß–∞—Å–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞: ${this.formatters.currency(exportData.settings.pricing.hourlyRate)}</item>
                    <item>–°–∫–∏–¥–∫–∞: ${exportData.formatted.discountRate}</item>
                    <item>–ù–∞–ª–æ–≥: ${exportData.formatted.taxRate}</item>
                </content>
                `;
                break;
        }
        
        slide += `</slide>\n`;
        return slide;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è CSV —Ñ–∞–π–ª–∞
     */
    async generateCSV(exportData, options) {
        try {
            const csvContent = this.createCSVContent(exportData, options);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const filename = this.generateFilename('csv', exportData);
            
            return {
                success: true,
                blob,
                filename,
                size: blob.size,
                rows: csvContent.split('\n').length
            };

        } catch (error) {
            return {
                success: false,
                error: error.message
            };
        }
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ CSV –∫–æ–Ω—Ç–µ–Ω—Ç–∞
     */
    createCSVContent(exportData, options) {
        const { delimiter, encoding, headers, quotes } = options;
        const quote = quotes ? '"' : '';
        
        let csv = '';
        
        if (headers) {
            csv += `${quote}–ö–∞—Ç–µ–≥–æ—Ä–∏—è${quote}${delimiter}${quote}–ù–∞–∑–≤–∞–Ω–∏–µ${quote}${delimiter}${quote}–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ${quote}${delimiter}${quote}–ï–¥–∏–Ω–∏—Ü–∞${quote}${delimiter}${quote}–°—Ç–æ–∏–º–æ—Å—Ç—å${quote}\n`;
        }
        
        exportData.composition.forEach(item => {
            csv += `${quote}${item.category}${quote}${delimiter}`;
            csv += `${quote}${item.name}${quote}${delimiter}`;
            csv += `${quote}${item.quantity}${quote}${delimiter}`;
            csv += `${quote}${item.unit}${quote}${delimiter}`;
            csv += `${quote}${item.price}${quote}\n`;
        });
        
        return csv;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JSON —Ñ–∞–π–ª–∞
     */
    async generateJSON(exportData, options) {
        try {
            const jsonContent = this.createJSONContent(exportData, options);
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            const filename = this.generateFilename('json', exportData);
            
            return {
                success: true,
                blob,
                filename,
                size: blob.size
            };

        } catch (error) {
            return {
                success: false,
                error: error.message
            };
        }
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ JSON –∫–æ–Ω—Ç–µ–Ω—Ç–∞
     */
    createJSONContent(exportData, options) {
        const data = {
            metadata: exportData.metadata,
            results: exportData.results,
            composition: exportData.composition,
            breakdown: exportData.breakdown,
            financial: exportData.financial
        };
        
        if (options.metadata) {
            data.exportInfo = {
                generated: new Date().toISOString(),
                generator: 'MethodCalculator v2.0',
                format: 'json',
                version: '1.0'
            };
        }
        
        if (options.validation) {
            data.validation = {
                totalItems: exportData.composition.length,
                totalSections: exportData.breakdown.sections.length,
                checksums: {
                    composition: this.calculateChecksum(exportData.composition),
                    breakdown: this.calculateChecksum(exportData.breakdown)
                }
            };
        }
        
        return JSON.stringify(data, null, options.pretty ? 2 : 0);
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –æ—Ç—á–µ—Ç–∞
     */
    async generateHTML(exportData, options) {
        try {
            const htmlContent = this.createHTMLContent(exportData, options);
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
            const filename = this.generateFilename('html', exportData);
            
            return {
                success: true,
                blob,
                filename,
                size: blob.size
            };

        } catch (error) {
            return {
                success: false,
                error: error.message
            };
        }
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ HTML –∫–æ–Ω—Ç–µ–Ω—Ç–∞
     */
    createHTMLContent(exportData, options) {
        let html = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö —É—Å–ª—É–≥</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; }
        .summary { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .section { margin: 30px 0; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #f2f2f2; font-weight: bold; }
        .total { font-size: 1.2em; font-weight: bold; color: #2c5282; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 0.9em; color: #666; }
        ${options.responsive ? '@media (max-width: 768px) { body { margin: 20px; } table { font-size: 0.9em; } }' : ''}
        ${options.printable ? '@media print { .no-print { display: none; } }' : ''}
    </style>
</head>
<body>
    <div class="header">
        <h1>–†–ê–°–ß–ï–¢ –°–¢–û–ò–ú–û–°–¢–ò –ú–ï–¢–û–î–ò–ß–ï–°–ö–ò–• –£–°–õ–£–ì</h1>
        <p>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${exportData.formatted.exportDate}</p>
    </div>
    
    <div class="summary">
        <h2>–ò—Ç–æ–≥–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
        <div class="total">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${exportData.formatted.totalCost}</div>
        <p>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${exportData.formatted.totalHours}</p>
        <p>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Å—Ç–∞–≤–∫–∞: ${exportData.formatted.effectiveRate}</p>
    </div>`;

        if (exportData.composition.length > 0) {
            html += `
    <div class="section">
        <h2>–°–æ—Å—Ç–∞–≤ –ø—Ä–æ–µ–∫—Ç–∞</h2>
        <table>
            <thead>
                <tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th><th>–ï–¥–∏–Ω–∏—Ü–∞</th><th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th></tr>
            </thead>
            <tbody>`;
            
            exportData.composition.forEach(item => {
                html += `<tr>
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit}</td>
                    <td>${this.formatters.currency(item.price)}</td>
                </tr>`;
            });
            
            html += `
            </tbody>
        </table>
    </div>`;
        }

        if (exportData.breakdown.sections.length > 0) {
            html += `
    <div class="section">
        <h2>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è</h2>`;
        
            exportData.breakdown.sections.forEach(section => {
                html += `
        <h3>${section.name}</h3>
        <table>
            <thead>
                <tr><th>–≠–ª–µ–º–µ–Ω—Ç</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th><th>–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</th><th>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</th></tr>
            </thead>
            <tbody>`;
            
                section.items.forEach(item => {
                    html += `<tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${this.formatters.currency(item.unitPrice)}</td>
                        <td>${this.formatters.currency(item.totalPrice)}</td>
                    </tr>`;
                });
                
                html += `
            </tbody>
        </table>`;
            });
            
            html += `</div>`;
        }

        html += `
    <div class="footer">
        <p>–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω —Å –ø–æ–º–æ—â—å—é –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö —É—Å–ª—É–≥ v2.0</p>
        <p>–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è: ${exportData.formatted.exportTime}</p>
    </div>
</body>
</html>`;

        return html;
    }

    /**
     * –ú–∞—Å—Å–æ–≤—ã–π —ç–∫—Å–ø–æ—Ä—Ç
     */
    async bulkExport(data) {
        try {
            const { formats, template, options = {} } = data;
            const results = [];
            
            for (const format of formats) {
                try {
                    const result = await this.exportDocument({
                        format,
                        template,
                        options: options[format] || {},
                        filename: `bulk_export_${Date.now()}.${format}`
                    });
                    
                    results.push({
                        format,
                        success: result.success,
                        filename: result.filename,
                        error: result.error
                    });
                    
                } catch (error) {
                    results.push({
                        format,
                        success: false,
                        error: error.message
                    });
                }
            }
            
            const successCount = results.filter(r => r.success).length;
            this.errors.showSuccess(`–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω: ${successCount}/${formats.length} —Ñ–∞–π–ª–æ–≤`);
            
            this.events.emit('export:bulk-completed', { results, successCount, totalCount: formats.length });
            
            return results;

        } catch (error) {
            this.errors.handleError(error, { context: 'ExportManager.bulkExport' });
            return [];
        }
    }

    /**
     * –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
     */
    async performIntegration(data) {
        try {
            const { service, config, exportData } = data;
            
            if (!this.integrations[service]) {
                throw new Error(`–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Å–µ—Ä–≤–∏—Å: ${service}`);
            }
            
            const integration = this.integrations[service];
            
            if (!integration.enabled && !config.force) {
                throw new Error(`–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ${service} –æ—Ç–∫–ª—é—á–µ–Ω–∞`);
            }
            
            const result = await integration.export(exportData || await this.prepareExportData(), config);
            
            if (result.success) {
                this.errors.showSuccess(`–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ ${integration.name}`);
                this.events.emit('export:integration-completed', { service, result });
            } else {
                throw new Error(result.error || '–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏');
            }
            
            return result;

        } catch (error) {
            this.errors.handleError(error, { context: 'ExportManager.performIntegration' });
            return { success: false, error: error.message };
        }
    }

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç –≤ Google Sheets
     */
    async exportToGoogleSheets(exportData, config) {
        // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Google Sheets
        return new Promise((resolve) => {
            setTimeout(() => {
                resolve({
                    success: true,
                    url: 'https://docs.google.com/spreadsheets/d/example',
                    sheetId: 'example_sheet_id'
                });
            }, 2000);
        });
    }

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ Webhook
     */
    async exportToWebhook(exportData, config) {
        try {
            const response = await fetch(config.url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...config.headers
                },
                body: JSON.stringify({
                    data: exportData,
                    timestamp: new Date().toISOString(),
                    source: 'MethodCalculator v2.0'
                })
            });
            
            if (response.ok) {
                return {
                    success: true,
                    response: await response.json()
                };
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

        } catch (error) {
            return {
                success: false,
                error: error.message
            };
        }
    }

    /**
     * –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–ª—è email
     */
    async prepareEmailExport(data) {
        try {
            const { format = 'pdf', template = 'commercial', emailOptions = {} } = data;
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
            const exportResult = await this.exportDocument({ format, template });
            
            if (!exportResult.success) {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏');
            }
            
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º email
            const emailData = {
                subject: emailOptions.subject || '–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö —É—Å–ª—É–≥',
                body: this.generateEmailBody(template, emailOptions),
                attachments: [{
                    filename: exportResult.filename,
                    content: exportResult.blob,
                    contentType: this.generators[format].mimeType
                }]
            };
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—á—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
            this.openEmailClient(emailData);
            
            this.events.emit('export:email-prepared', emailData);
            
            return {
                success: true,
                emailData
            };

        } catch (error) {
            this.errors.handleError(error, { context: 'ExportManager.prepareEmailExport' });
            return { success: false, error: error.message };
        }
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–ª–∞ –ø–∏—Å—å–º–∞
     */
    generateEmailBody(template, options) {
        const state = this.state.getState();
        const { results } = state;
        
        let body = '';
        
        if (options.greeting === 'formal') {
            body += '–£–≤–∞–∂–∞–µ–º—ã–π –∫–ª–∏–µ–Ω—Ç!\n\n';
        } else {
            body += '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!\n\n';
        }
        
        body += '–ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª –¥–ª—è –í–∞—Å —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö —É—Å–ª—É–≥ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –∑–∞–¥–∞–Ω–∏—é.\n\n';
        
        body += `–ò–¢–û–ì–û–í–ê–Ø –°–¢–û–ò–ú–û–°–¢–¨: ${this.formatters.currency(results.totalCost)}\n`;
        body += `–û–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${this.formatters.duration(results.totalHours)}\n\n`;
        
        if (template === 'detailed') {
            body += '–°–û–°–¢–ê–í –ü–†–û–ï–ö–¢–ê:\n';
            const composition = this.prepareComposition(state);
            composition.slice(0, 10).forEach(item => {
                body += `‚Ä¢ ${item.name} (${item.quantity} ${item.unit}) ‚Äî ${this.formatters.currency(item.price)}\n`;
            });
            body += '\n';
        }
        
        body += '–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏.\n';
        body += '–ì–æ—Ç–æ–≤ –æ–±—Å—É–¥–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∏ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã.\n\n';
        
        if (options.signature) {
            body += '–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n';
            body += '[–í–∞—à–µ –∏–º—è]\n';
            body += '–ú–µ—Ç–æ–¥–∏—Å—Ç-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫\n';
            body += '–¢–µ–ª: [–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω]\n';
            body += 'Email: [–í–∞—à email]';
        }
        
        return body;
    }

    /**
     * –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—á—Ç–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
     */
    openEmailClient(emailData) {
        const { subject, body } = emailData;
        const encodedSubject = encodeURIComponent(subject);
        const encodedBody = encodeURIComponent(body);
        
        const mailtoLink = `mailto:?subject=${encodedSubject}&body=${encodedBody}`;
        window.open(mailtoLink);
    }

    /**
     * API —ç–∫—Å–ø–æ—Ä—Ç
     */
    async apiExport(data) {
        try {
            const { endpoint, method = 'POST', headers = {}, format = 'json' } = data;
            
            const exportData = await this.prepareExportData(format);
            
            const response = await fetch(endpoint, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    ...headers
                },
                body: JSON.stringify(exportData)
            });
            
            if (response.ok) {
                const result = await response.json();
                this.errors.showSuccess('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ API');
                this.events.emit('export:api-completed', { endpoint, result });
                
                return {
                    success: true,
                    response: result
                };
            } else {
                throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }

        } catch (error) {
            this.errors.handleError(error, { context: 'ExportManager.apiExport' });
            return { success: false, error: error.message };
        }
    }

    /**
     * –ö–∞—Å—Ç–æ–º–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç
     */
    async customExport(data) {
        try {
            const { generator, options = {} } = data;
            
            if (typeof generator !== 'function') {
                throw new Error('Generator –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ñ—É–Ω–∫—Ü–∏–µ–π');
            }
            
            const exportData = await this.prepareExportData('custom', options);
            const result = await generator(exportData, options);
            
            this.events.emit('export:custom-completed', result);
            
            return result;

        } catch (error) {
            this.errors.handleError(error, { context: 'ExportManager.customExport' });
            return { success: false, error: error.message };
        }
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
     */
    async generateReport(data) {
        try {
            const { reportType = 'standard', format = 'pdf', options = {} } = data;
            
            const reportData = await this.prepareReportData(reportType);
            const generator = this.generators[format];
            
            if (!generator) {
                throw new Error(`–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç—á–µ—Ç–∞: ${format}`);
            }
            
            const result = await generator.generator(reportData, {
                ...generator.options,
                ...options,
                isReport: true
            });
            
            if (result.success) {
                this.downloadFile(result.blob, result.filename);
                this.errors.showSuccess(`–û—Ç—á–µ—Ç ${format.toUpperCase()} —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ`);
                this.events.emit('export:report-completed', { reportType, format, filename: result.filename });
            }
            
            return result;

        } catch (error) {
            this.errors.handleError(error, { context: 'ExportManager.generateReport' });
            return { success: false, error: error.message };
        }
    }

    /**
     * –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞
     */
    async prepareReportData(reportType) {
        const state = this.state.getState();
        const exportData = await this.prepareExportData('report');
        
        const reportData = {
            ...exportData,
            reportType,
            analytics: this.generateAnalytics(state),
            recommendations: this.generateRecommendations(state),
            charts: this.prepareChartData(state)
        };
        
        return reportData;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
     */
    generateAnalytics(state) {
        const analytics = {
            complexity: {
                score: this.calculateComplexityScore(state),
                factors: this.analyzeComplexityFactors(state)
            },
            efficiency: {
                costPerHour: state.results.totalHours > 0 ? state.results.totalCost / state.results.totalHours : 0,
                comparison: this.compareWithMarket(state)
            },
            composition: {
                distribution: this.analyzeCompositionDistribution(state),
                recommendations: this.getCompositionRecommendations(state)
            }
        };
        
        return analytics;
    }

    /**
     * –†–∞—Å—á–µ—Ç –æ—Ü–µ–Ω–∫–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
     */
    calculateComplexityScore(state) {
        const { complexity } = state;
        
        if (state.pricing.detailLevel === 'quick') {
            return complexity.projectComplexity * 20; // –ü–µ—Ä–µ–≤–æ–¥ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
        } else {
            const factors = [
                complexity.methodistRole,
                complexity.domainKnowledge,
                complexity.projectType,
                complexity.contentComplexity,
                complexity.urgency,
                complexity.qualityLevel
            ];
            
            const average = factors.reduce((sum, factor) => sum + (factor || 1), 0) / factors.length;
            return Math.round(average * 20);
        }
    }

    /**
     * –ê–Ω–∞–ª–∏–∑ —Ñ–∞–∫—Ç–æ—Ä–æ–≤ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
     */
    analyzeComplexityFactors(state) {
        const factors = [];
        const { complexity } = state;
        
        if (complexity.domainKnowledge > 1.2) {
            factors.push('–í—ã—Å–æ–∫–∞—è —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏');
        }
        
        if (complexity.contentComplexity > 1.3) {
            factors.push('–°–ª–æ–∂–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç');
        }
        
        if (complexity.urgency > 1.2) {
            factors.push('–°–∂–∞—Ç—ã–µ —Å—Ä–æ–∫–∏');
        }
        
        if (complexity.qualityLevel > 1.2) {
            factors.push('–ü–æ–≤—ã—à–µ–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫–∞—á–µ—Å—Ç–≤—É');
        }
        
        return factors;
    }

    /**
     * –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º
     */
    compareWithMarket(state) {
        const effectiveRate = state.results.totalHours > 0 ? 
            state.results.totalCost / state.results.totalHours : 0;
        
        const marketRates = {
            junior: 225,
            middle: 375,
            senior: 600
        };
        
        let position = 'middle';
        if (effectiveRate < marketRates.middle * 0.8) position = 'junior';
        else if (effectiveRate > marketRates.middle * 1.3) position = 'senior';
        
        return {
            position,
            effectiveRate,
            marketAverage: marketRates[position],
            deviation: ((effectiveRate - marketRates[position]) / marketRates[position]) * 100
        };
    }

    /**
     * –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Å—Ç–∞–≤–∞
     */
    analyzeCompositionDistribution(state) {
        const distribution = {
            presets: 0,
            components: 0,
            services: 0,
            custom: 0
        };
        
        // –ü—Ä–µ—Å–µ—Ç—ã
        Object.values(state.presets).forEach(preset => {
            distribution.presets += preset.count || 0;
        });
        
        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        distribution.components = Object.keys(state.components).length;
        
        // –£—Å–ª—É–≥–∏
        distribution.services = Object.keys(state.services).length;
        
        // –ö–∞—Å—Ç–æ–º–Ω—ã–µ
        distribution.custom = state.customServices.length;
        
        const total = distribution.presets + distribution.components + distribution.services + distribution.custom;
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
        Object.keys(distribution).forEach(key => {
            distribution[key] = total > 0 ? Math.round((distribution[key] / total) * 100) : 0;
        });
        
        return distribution;
    }

    /**
     * –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–æ—Å—Ç–∞–≤—É
     */
    getCompositionRecommendations(state) {
        const recommendations = [];
        const distribution = this.analyzeCompositionDistribution(state);
        
        if (distribution.presets > 70) {
            recommendations.push('–í—ã—Å–æ–∫–∞—è –¥–æ–ª—è –ø—Ä–µ—Å–µ—Ç–æ–≤. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.');
        }
        
        if (distribution.components === 0 && distribution.presets > 0) {
            recommendations.push('–î–æ–±–∞–≤—å—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–µ–∫—Ç–∞.');
        }
        
        if (distribution.services === 0) {
            recommendations.push('–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–Ω–∞–Ω–∏–π.');
        }
        
        return recommendations;
    }

    /**
     * –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º
     */
    prepareChartData(state) {
        return {
            costDistribution: this.prepareCostDistributionChart(state),
            timeDistribution: this.prepareTimeDistributionChart(state),
            complexityRadar: this.prepareComplexityRadarChart(state)
        };
    }

    /**
     * –î–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏
     */
    prepareCostDistributionChart(state) {
        const data = [];
        
        // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º breakdown –µ—Å–ª–∏ –µ—Å—Ç—å
        if (state.results.breakdown && state.results.breakdown.sections) {
            state.results.breakdown.sections.forEach(section => {
                data.push({
                    label: section.name,
                    value: section.totalCost || 0,
                    percentage: state.results.totalCost > 0 ? 
                        Math.round((section.totalCost / state.results.totalCost) * 100) : 0
                });
            });
        }
        
        return {
            type: 'pie',
            title: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º',
            data
        };
    }

    /**
     * –î–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
     */
    prepareTimeDistributionChart(state) {
        const data = [];
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ç–∏–ø–∞–º
        const timeByType = {
            '–ü—Ä–µ—Å–µ—Ç—ã': 0,
            '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã': 0,
            '–£—Å–ª—É–≥–∏': 0,
            '–ö–∞—Å—Ç–æ–º–Ω—ã–µ': 0
        };
        
        // –°—á–∏—Ç–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ (–ø—Ä–∏–º–µ—Ä–Ω–æ)
        Object.values(state.presets).forEach(preset => {
            timeByType['–ü—Ä–µ—Å–µ—Ç—ã'] += (preset.count || 0) * (preset.duration || 30) / 60; // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
        });
        
        Object.values(state.components).forEach(component => {
            timeByType['–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã'] += component.hours || 0;
        });
        
        Object.values(state.services).forEach(service => {
            timeByType['–£—Å–ª—É–≥–∏'] += service.hours || 0;
        });
        
        state.customServices.forEach(service => {
            timeByType['–ö–∞—Å—Ç–æ–º–Ω—ã–µ'] += service.hours * service.count;
        });
        
        Object.entries(timeByType).forEach(([label, value]) => {
            if (value > 0) {
                data.push({
                    label,
                    value: Math.round(value * 10) / 10,
                    percentage: state.results.totalHours > 0 ? 
                        Math.round((value / state.results.totalHours) * 100) : 0
                });
            }
        });
        
        return {
            type: 'bar',
            title: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ —Ç–∏–ø–∞–º —Ä–∞–±–æ—Ç',
            data
        };
    }

    /**
     * –†–∞–¥–∞—Ä–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
     */
    prepareComplexityRadarChart(state) {
        const { complexity } = state;
        
        if (state.pricing.detailLevel === 'quick') {
            return {
                type: 'radar',
                title: '–ê–Ω–∞–ª–∏–∑ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞',
                data: [
                    { label: '–û–±—â–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å', value: (complexity.projectComplexity || 1) * 20 }
                ]
            };
        }
        
        return {
            type: 'radar',
            title: '–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏',
            data: [
                { label: '–†–æ–ª—å –º–µ—Ç–æ–¥–∏—Å—Ç–∞', value: (complexity.methodistRole || 1) * 20 },
                { label: '–ü—Ä–µ–¥–º–µ—Ç–Ω–∞—è –æ–±–ª–∞—Å—Ç—å', value: (complexity.domainKnowledge || 1) * 20 },
                { label: '–¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞', value: (complexity.projectType || 1) * 20 },
                { label: '–°–ª–æ–∂–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞', value: (complexity.contentComplexity || 1) * 20 },
                { label: '–°—Ä–æ—á–Ω–æ—Å—Ç—å', value: (complexity.urgency || 1) * 20 },
                { label: '–ö–∞—á–µ—Å—Ç–≤–æ', value: (complexity.qualityLevel || 1) * 20 }
            ]
        };
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
     */
    generateRecommendations(state) {
        const recommendations = [];
        
        // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—é
        const pricingRecs = this.generatePricingRecommendations(state);
        recommendations.push(...pricingRecs);
        
        // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–æ—Å—Ç–∞–≤—É
        const compositionRecs = this.getCompositionRecommendations(state);
        recommendations.push(...compositionRecs);
        
        // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
        const optimizationRecs = this.generateOptimizationRecommendations(state);
        recommendations.push(...optimizationRecs);
        
        return recommendations;
    }

    /**
     * –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—é
     */
    generatePricingRecommendations(state) {
        const recommendations = [];
        const effectiveRate = state.results.totalHours > 0 ? 
            state.results.totalCost / state.results.totalHours : 0;
        
        if (effectiveRate < 200) {
            recommendations.push('–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —á–∞—Å–æ–≤–æ–π —Å—Ç–∞–≤–∫–∏ –∏–ª–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏');
        }
        
        if (state.financial.discountRate < -20) {
            recommendations.push('–ë–æ–ª—å—à–∞—è —Å–∫–∏–¥–∫–∞ –º–æ–∂–µ—Ç –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å');
        }
        
        if (state.results.totalHours > 100 && state.pricing.method === 'hourly') {
            recommendations.push('–î–ª—è –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ');
        }
        
        return recommendations;
    }

    /**
     * –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
     */
    generateOptimizationRecommendations(state) {
        const recommendations = [];
        
        // –ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–º–æ–≤
        Object.entries(state.presets).forEach(([type, data]) => {
            if (data.count > 0 && data.count < 6) {
                recommendations.push(`–£–≤–µ–ª–∏—á—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ "${type}" –¥–æ 6+ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—ä–µ–º–Ω–æ–π —Å–∫–∏–¥–∫–∏`);
            }
        });
        
        // –ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        if (state.results.totalCost > 0 && state.results.totalHours > 0) {
            const efficiency = state.results.totalCost / state.results.totalHours;
            if (efficiency > 500) {
                recommendations.push('–í—ã—Å–æ–∫–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Å—Ç–∞–≤–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å—á–µ—Ç–æ–≤');
            }
        }
        
        return recommendations;
    }

    /**
     * –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π
     */
    getPresetName(presetType) {
        const names = {
            textLesson: '–¢–µ–∫—Å—Ç–æ–≤—ã–π —É—Ä–æ–∫',
            videoLesson: '–í–∏–¥–µ–æ —É—Ä–æ–∫',
            webinar: '–í–µ–±–∏–Ω–∞—Ä',
            workshop: '–ü—Ä–∞–∫—Ç–∏–∫—É–º',
            caseStudy: '–ö–µ–π—Å-—Å—Ç–∞–¥–∏',
            masterClass: '–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å'
        };
        return names[presetType] || presetType;
    }

    getComponentName(componentId) {
        // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Å—ã–ª–∫–∞ –Ω–∞ ComponentManager –∏–ª–∏ —Å–ª–æ–≤–∞—Ä—å –Ω–∞–∑–≤–∞–Ω–∏–π
        return componentId; // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
    }

    getServiceName(serviceId) {
        // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Å—ã–ª–∫–∞ –Ω–∞ ComponentManager –∏–ª–∏ —Å–ª–æ–≤–∞—Ä—å –Ω–∞–∑–≤–∞–Ω–∏–π
        return serviceId; // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
    }

    /**
     * –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ü–µ–Ω (–¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞)
     */
    calculatePresetPrice(presetType, data, state) {
        // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
        const basePrice = 1500; // –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –ø—Ä–µ—Å–µ—Ç–∞
        const durationFactor = (data.duration || 60) / 60;
        return Math.round(basePrice * durationFactor * (data.count || 1));
    }

    calculateComponentPrice(componentId, data, state) {
        // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
        const hours = data.hours || 2;
        const rate = state.pricing.hourlyRate || 220;
        return Math.round(hours * rate * (data.count || 1));
    }

    calculateServicePrice(serviceId, data, state) {
        // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
        const hours = data.hours || 3;
        const rate = state.pricing.hourlyRate || 220;
        return Math.round(hours * rate * (data.count || 1));
    }

    /**
     * –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
     */
    downloadFile(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
     */
    generateFilename(extension, exportData) {
        const timestamp = new Date().toISOString().slice(0, 10);
        const cost = Math.round(exportData.results.totalCost / 1000);
        return `calculator_${timestamp}_${cost}k.${extension}`;
    }

    /**
     * –†–∞—Å—á–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã
     */
    calculateChecksum(data) {
        const str = JSON.stringify(data);
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return hash.toString();
    }

    /**
     * –§–æ—Ä–º–∞—Ç–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö
     */
    formatCurrency(amount, locale = 'ru-RU') {
        if (typeof amount !== 'number' || isNaN(amount)) return '0 ‚ÇΩ';
        return Math.round(amount).toLocaleString(locale) + ' ‚ÇΩ';
    }

    formatNumber(number, locale = 'ru-RU') {
        if (typeof number !== 'number' || isNaN(number)) return '0';
        return number.toLocaleString(locale);
    }

    formatDate(date, format = 'DD.MM.YYYY') {
        if (!(date instanceof Date)) return '';
        
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        
        return format
            .replace('DD', day)
            .replace('MM', month)
            .replace('YYYY', year);
    }

    formatDuration(hours) {
        if (typeof hours !== 'number' || isNaN(hours)) return '0 —á';
        return (Math.round(hours * 10) / 10) + ' —á';
    }

    formatPercentage(value) {
        if (typeof value !== 'number' || isNaN(value)) return '0%';
        return value.toFixed(1) + '%';
    }

    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
     */
    getExportStatistics() {
        return {
            generators: Object.keys(this.generators).length,
            templates: Object.keys(this.templates).length,
            integrations: Object.keys(this.integrations).length,
            enabledIntegrations: Object.values(this.integrations).filter(i => i.enabled).length,
            supportedFormats: Object.keys(this.generators)
        };
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
     */
    configureExport(settings) {
        this.defaultSettings = { ...this.defaultSettings, ...settings };
        this.events.emit('export:configured', this.defaultSettings);
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
     */
    getAvailableFormats() {
        return Object.entries(this.generators).map(([id, generator]) => ({
            id,
            name: generator.name,
            extensions: generator.extensions,
            mimeType: generator.mimeType
        }));
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤
     */
    getAvailableTemplates() {
        return Object.entries(this.templates).map(([id, template]) => ({
            id,
            ...template
        }));
    }

    /**
     * –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –º–æ–¥—É–ª—è
     */
    destroy() {
        // –û—Ç–ø–∏—Å–∫–∞ –æ—Ç —Å–æ–±—ã—Ç–∏–π
        this.events.off('export:document');
        this.events.off('export:report');
        this.events.off('export:integration');
        this.events.off('export:bulk');
        this.events.off('export:custom');
        this.events.off('export:email');
        this.events.off('export:api');

        console.log('üì§ ExportManager destroyed');
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
if (typeof module !== 'undefined' && module.exports) {
    module.exports = ExportManager;
} else if (typeof window !== 'undefined') {
    window.ExportManager = ExportManager;
}

        
        
    </script>
</body>
</html>
