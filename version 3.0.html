    <!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор методических услуг 2.1</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.5;
        }

        /* Основные контейнеры */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        /* Заголовок */
        .app-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .app-title {
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .app-subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* Навигация быстрого доступа */
        .quick-nav {
            position: absolute;
            top: 15px;
            right: 30px;
            display: flex;
            gap: 10px;
        }

        .quick-nav-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Основной контент */
        .app-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 0;
            flex: 1;
            min-height: 0;
        }

        /* Форма */
        .form-section {
            padding: 40px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        /* Результаты */
        .results-section {
            background: #f8fafc;
            padding: 40px;
            border-left: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Состояния загрузки и ошибок */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #dc2626;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 1001;
        }

        .error-toast.show {
            transform: translateX(0);
        }

        .success-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #d1fae5;
            border: 1px solid #6ee7b7;
            color: #047857;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 1001;
        }

        .success-toast.show {
            transform: translateX(0);
        }

        /* Секции */
        .form-section-wrapper {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            font-size: 1.2rem;
        }

        /* Группы форм */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-input:invalid {
            border-color: #ef4444;
        }

        /* Чекбоксы и радио */
        .checkbox-group, .radio-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .checkbox-input, .radio-input {
            width: 18px;
            height: 18px;
            accent-color: #4f46e5;
        }

        .checkbox-label, .radio-label {
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            user-select: none;
        }

        /* Карточки */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #f3f4f6;
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .info-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-card-title {
            color: #0369a1;
            margin-bottom: 8px;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-card-content {
            color: #0369a1;
            font-size: 0.9rem;
            line-height: 1.4;
            margin: 0;
        }

        /* Быстрые режимы */
        .mode-selector {
            background: linear-gradient(135deg, #fef7ff 0%, #f3e8ff 100%);
            border: 2px solid #d8b4fe;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .mode-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #7c2d12;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mode-description {
            color: #92400e;
            font-size: 0.9rem;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .mode-options {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }

        /* Сетки */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        /* Пресеты */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .preset-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .preset-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .preset-item.active {
            border-color: #4f46e5;
            background: linear-gradient(135deg, #ede9fe 0%, #f3f4f6 100%);
        }

        .preset-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .preset-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .preset-price {
            font-size: 0.9rem;
            font-weight: 600;
            color: #7c3aed;
            text-align: right;
        }

        .preset-description {
            color: #6b7280;
            font-size: 0.85rem;
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .preset-includes {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .preset-includes-title {
            font-weight: 600;
            color: #374151;
            font-size: 0.8rem;
            margin-bottom: 6px;
        }

        .preset-includes-list {
            color: #6b7280;
            font-size: 0.75rem;
            line-height: 1.3;
        }

        .preset-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }

        .preset-control {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .preset-control-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #374151;
        }

        .preset-control-input {
            padding: 8px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .preset-control-input:focus {
            border-color: #4f46e5;
            outline: none;
        }

        /* Цветовое кодирование пресетов */
        .preset-item[data-type="textLesson"] {
            border-left: 4px solid #64748b;
        }

        .preset-item[data-type="textLesson"]:hover,
        .preset-item[data-type="textLesson"].active {
            border-color: #64748b;
            background: rgba(59, 130, 246, 0.08);
        }

        .preset-item[data-type="videoLesson"] {
            border-left: 4px solid #7c3aed;
        }

        .preset-item[data-type="videoLesson"]:hover,
        .preset-item[data-type="videoLesson"].active {
            border-color: #7c3aed;
            background: rgba(139, 92, 246, 0.08);
        }

        .preset-item[data-type="webinar"] {
            border-left: 4px solid #be185d;
        }

        .preset-item[data-type="webinar"]:hover,
        .preset-item[data-type="webinar"].active {
            border-color: #be185d;
            background: rgba(236, 72, 153, 0.08);
        }

        .preset-item[data-type="workshop"] {
            border-left: 4px solid #047857;
        }

        .preset-item[data-type="workshop"]:hover,
        .preset-item[data-type="workshop"].active {
            border-color: #047857;
            background: rgba(16, 185, 129, 0.08);
        }

        .preset-item[data-type="caseStudy"] {
            border-left: 4px solid #d97706;
        }

        .preset-item[data-type="caseStudy"]:hover,
        .preset-item[data-type="caseStudy"].active {
            border-color: #d97706;
            background: rgba(245, 158, 11, 0.08);
        }

        .preset-item[data-type="masterClass"] {
            border-left: 4px solid #dc2626;
        }

        .preset-item[data-type="masterClass"]:hover,
        .preset-item[data-type="masterClass"].active {
            border-color: #dc2626;
            background: rgba(239, 68, 68, 0.08);
        }

        /* Компоненты */
        .components-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .component-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .component-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
            transform: translateY(-1px);
        }

        .component-item.selected {
            background: #ede9fe;
            border-color: #7c3aed;
        }

        .component-item.auto-selected {
            background: #ecfdf5;
            border-color: #10b981;
        }

        .component-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .component-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            margin-top: 2px;
            accent-color: #7c3aed;
        }

        .component-main {
            flex: 1;
        }

        .component-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .component-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #6b7280;
        }

        .component-hours {
            font-weight: 600;
        }

        .component-price {
            font-weight: 600;
            color: #7c3aed;
        }

        .component-description {
            color: #6b7280;
            font-size: 0.85rem;
            line-height: 1.3;
            margin-bottom: 10px;
        }

        .component-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 10px;
        }

        .component-tag {
            background: rgba(79, 70, 229, 0.1);
            color: #4f46e5;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .component-controls {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }

        .component-controls.visible {
            display: grid;
        }

        .component-control {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .component-control-label {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
        }

        .component-control-input {
            padding: 6px 8px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.85rem;
            text-align: center;
        }

        .component-control-input:focus {
            border-color: #7c3aed;
            outline: none;
        }

        .auto-badge {
            background: #10b981;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Услуги и проверки */
        .service-item, .assessment-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .service-item:hover, .assessment-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
            transform: translateY(-1px);
        }

        .service-item.selected, .assessment-item.selected {
            background: #ede9fe;
            border-color: #7c3aed;
        }

        .service-item.auto-selected, .assessment-item.auto-selected {
            background: #ecfdf5;
            border-color: #10b981;
        }

        .service-header, .assessment-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .service-checkbox, .assessment-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            margin-top: 2px;
            accent-color: #7c3aed;
        }

        .service-main, .assessment-main {
            flex: 1;
        }

        .service-title, .assessment-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .service-meta, .assessment-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #6b7280;
        }

        .service-hours, .assessment-hours {
            font-weight: 600;
        }

        .service-description, .assessment-description {
            color: #6b7280;
            font-size: 0.85rem;
            line-height: 1.3;
            margin-top: 8px;
        }

        .service-controls, .assessment-controls {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }

        .service-controls.visible, .assessment-controls.visible {
            display: grid;
        }

        /* Кастомные услуги */
        .custom-service-item {
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 0.1%, #fef3c7 100%);
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .custom-service-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .custom-service-title {
            font-weight: 600;
            color: #92400e;
            font-size: 1.05rem;
        }

        .custom-service-price {
            font-weight: 600;
            color: #d97706;
            font-size: 0.9rem;
        }

        .custom-service-description {
            color: #b45309;
            font-size: 0.85rem;
            margin-bottom: 10px;
        }

        .custom-service-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #a16207;
            padding-top: 10px;
            border-top: 1px solid rgba(245, 158, 11, 0.3);
        }

        .custom-service-remove {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .custom-service-remove:hover {
            background: #dc2626;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .preset-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .components-grid {
                grid-template-columns: 1fr;
            }
            
            .preset-controls {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .component-controls {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Результаты */
        .result-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            flex-shrink: 0;
            border-left: 4px solid #4f46e5;
        }

        .result-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-value {
            font-size: 2rem;
            font-weight: 800;
            color: #4f46e5;
            margin-bottom: 5px;
        }

        .result-subtitle {
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* Кнопки */
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn-full {
            width: 100%;
            justify-content: center;
        }

        /* Мобильная адаптация */
        @media (max-width: 1024px) {
            .app-content {
                grid-template-columns: 1fr;
            }
            
            .results-section {
                border-left: none;
                border-top: 1px solid #e5e7eb;
                position: static;
                max-height: none;
            }
            
            .quick-nav {
                position: static;
                margin-top: 15px;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                margin: 10px;
                border-radius: 10px;
                min-height: calc(100vh - 20px);
            }
            
            .form-section, .results-section {
                padding: 20px;
            }
            
            .app-header {
                padding: 20px;
            }
            
            .app-title {
                font-size: 1.5rem;
            }
            
            .preset-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .mode-options {
                flex-direction: column;
                gap: 15px;
            }
        }

        /* Утилиты */
        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-xs {
            font-size: 0.75rem;
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-bold {
            font-weight: 700;
        }

        .text-gray-500 {
            color: #6b7280;
        }

        .text-gray-600 {
            color: #4b5563;
        }

        .text-blue-600 {
            color: #2563eb;
        }

        .text-green-600 {
            color: #059669;
        }

        .text-red-600 {
            color: #dc2626;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        /* Анимации для состояний */
        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus states */
        .btn:focus,
        .preset-item:focus,
        .form-input:focus,
        .form-select:focus {
            outline: 2px solid #4f46e5;
            outline-offset: 2px;
        }

        /* Dark mode support (готовность) */
        @media (prefers-color-scheme: dark) {
            /* Будет добавлено в следующих этапах */
        }
    </style>
</head>

<body>
    <!-- Overlay для загрузки -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Контейнер приложения -->
    <div class="app-container" id="appContainer">
        <!-- Заголовок -->
        <header class="app-header">
            <nav class="quick-nav">
                <button class="quick-nav-btn" id="saveBtn" title="Сохранить расчет">
                    💾 Сохранить
                </button>
                <button class="quick-nav-btn" id="loadBtn" title="Загрузить расчет">
                    📁 Загрузить
                </button>
                <button class="quick-nav-btn" id="resetBtn" title="Сбросить все">
                    🔄 Сброс
                </button>
            </nav>
            <h1 class="app-title">Калькулятор методических услуг 2.1</h1>
            <p class="app-subtitle">Современная система расчета с улучшенным UX</p>
        </header>

        <!-- Основной контент -->
        <main class="app-content">
            <!-- Форма настроек -->
            <section class="form-section" id="formSection">
                
                <!-- Режим работы -->
                <div class="form-section-wrapper">
                    <div class="mode-selector">
                        <div class="mode-title">
                            <span class="section-icon">⚙️</span>
                            Режим работы калькулятора
                        </div>
                        <div class="mode-description">
                            Выберите подходящий режим для ваших задач
                        </div>
                        
                        <div class="mode-options">
                            <label class="radio-group">
                                <input type="radio" name="calculatorMode" value="express" class="radio-input" checked>
                                <span class="radio-label">🚀 Экспресс-режим</span>
                            </label>
                            <label class="radio-group">
                                <input type="radio" name="calculatorMode" value="standard" class="radio-input">
                                <span class="radio-label">⚖️ Стандартный</span>
                            </label>
                            <label class="radio-group">
                                <input type="radio" name="calculatorMode" value="detailed" class="radio-input">
                                <span class="radio-label">🔬 Детальный</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Информационная карточка -->
                <div class="info-card" id="modeInfoCard">
                    <div class="info-card-title">
                        <span>🚀</span>
                        Экспресс-режим
                    </div>
                    <div class="info-card-content">
                        Быстрая оценка за 30 секунд. Подходит для первичных переговоров и примерных расчетов.
                    </div>
                </div>

                <!-- Система ценообразования -->
                <div class="form-section-wrapper" id="pricingSystemSection">
                    <h2 class="section-title">
                        <span class="section-icon">💰</span>
                        Система ценообразования
                    </h2>
                    
                    <div class="card">
                        <div class="form-group">
                            <label class="form-label">Метод расчета</label>
                            <div class="mode-options">
                                <label class="radio-group">
                                    <input type="radio" name="pricingMethod" value="hourly" class="radio-input" checked>
                                    <span class="radio-label">⏱️ Почасовой расчет</span>
                                </label>
                                <label class="radio-group">
                                    <input type="radio" name="pricingMethod" value="fixed" class="radio-input">
                                    <span class="radio-label">💰 Фиксированные цены</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="hourlyRate" class="form-label">Базовая ставка (₽/час)</label>
                            <input 
                                type="number" 
                                id="hourlyRate" 
                                class="form-input" 
                                value="220" 
                                min="100" 
                                max="10000" 
                                step="10"
                                data-validation="required|min:100|max:10000"
                            >
                            <div class="text-xs text-gray-500 mt-2">
                                Рекомендуемый диапазон: 150-2000 ₽/час
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Параметры сложности -->
                <div class="form-section-wrapper" id="complexitySection">
                    <h2 class="section-title">
                        <span class="section-icon">🎯</span>
                        Параметры проекта
                    </h2>
                    
                    <!-- Экспресс режим -->
                    <div class="card" id="expressComplexityCard">
                        <div class="form-group">
                            <label for="projectComplexity" class="form-label">Общая сложность проекта</label>
                            <select id="projectComplexity" class="form-select">
                                <option value="1.0">Простой (знакомый домен + своя методика)</option>
                                <option value="1.3" selected>Средний (один усложняющий фактор)</option>
                                <option value="1.6">Сложный (несколько факторов)</option>
                                <option value="1.8">Экстремальный (все факторы + срочность)</option>
                            </select>
                            <div class="text-xs text-gray-500 mt-2" id="complexityHint">
                                Средняя сложность: новый домен ИЛИ чужая методика ИЛИ сложный контент
                            </div>
                        </div>
                    </div>

                    <!-- Детальный режим -->
                    <div class="card hidden" id="detailedComplexityCard">
                        <div class="grid-2">
                            <div class="form-group">
                                <label for="methodistRole" class="form-label">Роль методиста</label>
                                <select id="methodistRole" class="form-select">
                                    <option value="1.0">Методист-автор (создаю сам)</option>
                                    <option value="0.5">Методист-редактор (проверяю)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="domainKnowledge" class="form-label">Знание области</label>
                                <select id="domainKnowledge" class="form-select">
                                    <option value="1.0">Знаю домен хорошо</option>
                                    <option value="1.3">Новый домен (изучение)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="projectType" class="form-label">Характер работы</label>
                                <select id="projectType" class="form-select">
                                    <option value="1.0">По моей методике</option>
                                    <option value="1.2">Доработка материалов</option>
                                    <option value="1.4">По чужой методике</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="urgency" class="form-label">Срочность</label>
                                <select id="urgency" class="form-select">
                                    <option value="1.0">Обычная</option>
                                    <option value="1.2">Ускоренная (+20%)</option>
                                    <option value="1.5">Срочная (+50%)</option>
                                    <option value="2.0">Экстренная (+100%)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Финансовые настройки -->
                <div class="form-section-wrapper" id="financialSection">
                    <h2 class="section-title">
                        <span class="section-icon">💳</span>
                        Финансовые настройки
                    </h2>
                    
                    <div class="card">
                        <div class="grid-3">
                            <div class="form-group">
                                <label for="discountRate" class="form-label">Скидка/Наценка (%)</label>
                                <input 
                                    type="range" 
                                    id="discountRate" 
                                    min="-50" 
                                    max="50" 
                                    step="5" 
                                    value="0"
                                    class="form-input"
                                >
                                <div class="text-xs text-gray-600 mt-2" id="discountValue">
                                    0% (без изменений)
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="taxRate" class="form-label">Налоговая ставка (%)</label>
                                <input 
                                    type="range" 
                                    id="taxRate" 
                                    min="0" 
                                    max="30" 
                                    step="1" 
                                    value="13"
                                    class="form-input"
                                >
                                <div class="text-xs text-gray-600 mt-2" id="taxValue">
                                    13% (НДФЛ)
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Дополнительно</label>
                                <div class="flex flex-col gap-2">
                                    <label class="checkbox-group">
                                        <input type="checkbox" id="enableVolumeDiscounts" class="checkbox-input" checked>
                                        <span class="checkbox-label text-sm">Объемные скидки</span>
                                    </label>
                                    <label class="checkbox-group">
                                        <input type="checkbox" id="showTaxSeparately" class="checkbox-input" checked>
                                        <span class="checkbox-label text-sm">Налог отдельно</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Пресеты -->
                <div class="form-section-wrapper" id="presetsSection">
                    <h2 class="section-title">
                        <span class="section-icon">📋</span>
                        Быстрые пресеты
                    </h2>
                    
                    <div class="info-card">
                        <div class="info-card-title">
                            <span>💡</span>
                            Как работают пресеты
                        </div>
                        <div class="info-card-content">
                            Готовые пакеты услуг с типовым составом. Выберите количество и длительность - система автоматически рассчитает стоимость и предложит дополнительные компоненты.
                        </div>
                    </div>

                    <div class="preset-grid" id="presetGrid">
                        <!-- Пресеты будут добавлены динамически -->
                    </div>
                </div>

                <!-- Дополнительные компоненты -->
                <div class="form-section-wrapper" id="componentsSection">
                    <h2 class="section-title">
                        <span class="section-icon">🧩</span>
                        Дополнительные компоненты
                    </h2>
                    
                    <div class="info-card">
                        <div class="info-card-title">
                            <span>⚡</span>
                            Умная система предложений
                        </div>
                        <div class="info-card-content">
                            Система автоматически предлагает связанные компоненты на основе выбранных пресетов. Компоненты с пометкой "АВТО" были предложены системой.
                        </div>
                    </div>

                    <div class="components-grid" id="componentsGrid">
                        <!-- Компоненты будут добавлены динамически -->
                    </div>
                </div>

                <!-- Проверки знаний -->
                <div class="form-section-wrapper" id="assessmentsSection">
                    <h2 class="section-title">
                        <span class="section-icon">🎯</span>
                        Система проверки знаний
                    </h2>
                    
                    <div class="grid-2" id="assessmentsGrid">
                        <!-- Проверки будут добавлены динамически -->
                    </div>
                </div>

                <!-- Дополнительные услуги -->
                <div class="form-section-wrapper" id="servicesSection">
                    <h2 class="section-title">
                        <span class="section-icon">🔧</span>
                        Дополнительные услуги
                    </h2>
                    
                    <div class="grid-2" id="servicesGrid">
                        <!-- Услуги будут добавлены динамически -->
                    </div>
                </div>

                <!-- Кастомные услуги -->
                <div class="form-section-wrapper" id="customServicesSection">
                    <h2 class="section-title">
                        <span class="section-icon">⚙️</span>
                        Кастомные услуги
                    </h2>
                    
                    <div class="info-card">
                        <div class="info-card-title">
                            <span>✨</span>
                            Создайте свои услуги
                        </div>
                        <div class="info-card-content">
                            Добавьте любые дополнительные работы, которых нет в стандартном списке
                        </div>
                    </div>

                    <div class="card" id="customServiceForm">
                        <div class="grid-2 mb-4">
                            <div class="form-group">
                                <label for="customServiceName" class="form-label">Название услуги</label>
                                <input type="text" id="customServiceName" class="form-input" placeholder="Например: Дизайн логотипа">
                            </div>
                            <div class="form-group">
                                <label for="customServiceDescription" class="form-label">Описание (опционально)</label>
                                <input type="text" id="customServiceDescription" class="form-input" placeholder="Краткое описание">
                            </div>
                        </div>
                        
                        <div class="flex gap-4 items-end">
                            <div class="form-group flex-1">
                                <label for="customServiceHours" class="form-label">Время (ч)</label>
                                <input type="number" id="customServiceHours" class="form-input" value="1" min="0.1" max="100" step="0.1">
                            </div>
                            <div class="form-group flex-1">
                                <label for="customServiceCount" class="form-label">Количество</label>
                                <input type="number" id="customServiceCount" class="form-input" value="1" min="1" max="100">
                            </div>
                            <div class="form-group flex-1">
                                <label for="customServicePrice" class="form-label">Цена за ед. (₽)</label>
                                <input type="number" id="customServicePrice" class="form-input" value="220" min="1" max="100000">
                            </div>
                            <button class="btn btn-success" onclick="componentsManager.addCustomService()">
                                ➕ Добавить
                            </button>
                        </div>
                    </div>

                    <div id="customServicesList" class="mt-4">
                        <!-- Кастомные услуги будут добавлены динамически -->
                    </div>
                </div>

                <!-- Правки и итерации -->
                <div class="form-section-wrapper" id="revisionsSection">
                    <h2 class="section-title">
                        <span class="section-icon">🔄</span>
                        Правки и итерации
                    </h2>
                    
                    <div class="card">
                        <div class="form-group">
                            <label for="clientType" class="form-label">Тип заказчика</label>
                            <select id="clientType" class="form-select">
                                <option value="10">Постоянный заказчик (знаю стиль) - 10%</option>
                                <option value="20" selected>Новый заказчик (притирка) - 20%</option>
                                <option value="0">Без правок - 0%</option>
                            </select>
                        </div>
                        
                        <div class="info-card mt-4">
                            <div class="info-card-title">
                                <span>⚠️</span>
                                Важно: правки касаются только контента
                            </div>
                            <div class="info-card-content">
                                Правки применяются к компонентам образовательного контента и проверкам знаний. Дополнительные услуги не подлежат правкам.
                            </div>
                        </div>
                    </div>
                </div>

            </section>

            <!-- Результаты -->
            <aside class="results-section" id="resultsSection">
                
                <!-- Основной результат -->
                <div class="result-card">
                    <div class="result-title">
                        💰 Итоговая стоимость
                    </div>
                    <div class="result-value" id="totalCost">0 ₽</div>
                    <div class="result-subtitle">За весь проект</div>
                </div>
                
                <!-- Время выполнения -->
                <div class="result-card">
                    <div class="result-title">
                        ⏱️ Общее время
                    </div>
                    <div class="result-value" id="totalHours">0 ч</div>
                    <div class="result-subtitle">Трудозатраты</div>
                </div>

                <!-- Состав проекта -->
                <div class="result-card">
                    <div class="result-title">
                        📋 Состав проекта
                    </div>
                    <div id="projectComposition">
                        <div class="text-gray-500 text-sm" style="font-style: italic;">
                            Выберите компоненты для расчета
                        </div>
                    </div>
                </div>

                <!-- Детализация -->
                <div class="result-card">
                    <div class="result-title">
                        📊 Детализация
                    </div>
                    <div id="breakdown">
                        <div class="text-gray-500 text-sm" style="font-style: italic;">
                            Расчет появится после выбора компонентов
                        </div>
                    </div>
                </div>

                <!-- Действия -->
                <div class="result-card">
                    <div class="result-title">
                        🎯 Действия
                    </div>
                    <div class="flex flex-col gap-2">
                        <button class="btn btn-primary btn-full" id="copyBtn">
                            📋 Копировать расчет
                        </button>
                        <button class="btn btn-secondary btn-full" id="exportBtn">
                            📄 Экспорт в PDF
                        </button>
                        <button class="btn btn-secondary btn-full" id="shareBtn">
                            🔗 Поделиться ссылкой
                        </button>
                    </div>
                    <div class="hidden text-green-600 text-sm mt-2" id="copyStatus">
                        ✓ Скопировано в буфер обмена
                    </div>
                </div>

            </aside>
        </main>
    </div>

    <!-- Модальные окна -->
    
    <!-- Модалка сохранения -->
    <div class="modal-overlay hidden" id="saveModal">
        <div class="modal">
            <div class="modal-header">
                <h3>💾 Сохранить расчет</h3>
                <button class="modal-close" id="closeSaveModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="saveName" class="form-label">Название расчета</label>
                    <input type="text" id="saveName" class="form-input" placeholder="Мой проект">
                </div>
                <div class="form-group">
                    <label for="saveDescription" class="form-label">Описание (опционально)</label>
                    <textarea id="saveDescription" class="form-input" rows="3" placeholder="Краткое описание проекта"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelSave">Отмена</button>
                <button class="btn btn-success" id="confirmSave">💾 Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модалка загрузки -->
    <div class="modal-overlay hidden" id="loadModal">
        <div class="modal">
            <div class="modal-header">
                <h3>📁 Загрузить расчет</h3>
                <button class="modal-close" id="closeLoadModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="savedCalculations">
                    <div class="text-gray-500 text-sm text-center">
                        Сохраненных расчетов пока нет
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelLoad">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        /**
         * Калькулятор методических услуг 2.1
         * Модульная архитектура с State Manager
         */

        // ===========================================
        // УТИЛИТЫ И КОНСТАНТЫ
        // ===========================================

        const STORAGE_KEY = 'methodical_calculator_v2';
        const CALCULATIONS_KEY = 'saved_calculations_v2';

        // Конфигурация режимов
        const MODES = {
            express: {
                name: 'Экспресс-режим',
                icon: '🚀',
                description: 'Быстрая оценка за 30 секунд. Подходит для первичных переговоров и примерных расчетов.',
                sections: ['pricingSystemSection', 'complexitySection', 'financialSection']
            },
            standard: {
                name: 'Стандартный',
                icon: '⚖️',
                description: 'Сбалансированный режим с основными настройками. Подходит для большинства проектов.',
                sections: ['pricingSystemSection', 'complexitySection', 'financialSection', 'presetsSection']
            },
            detailed: {
                name: 'Детальный',
                icon: '🔬',
                description: 'Максимально точный расчет с учетом всех факторов. Рекомендуется для крупных проектов.',
                sections: ['pricingSystemSection', 'complexitySection', 'financialSection', 'presetsSection']
            }
        };

        // Утилиты
        const Utils = {
            // Безопасное получение элемента
            safeGetElement(id) {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`Element not found: ${id}`);
                }
                return element;
            },

            // Безопасное получение значения
            safeGetValue(id, defaultValue = 0) {
                const element = this.safeGetElement(id);
                if (!element) return defaultValue;
                
                const value = parseFloat(element.value);
                return isNaN(value) ? defaultValue : value;
            },

            // Получение значения радиокнопки
            getRadioValue(name, defaultValue) {
                const checked = document.querySelector(`input[name="${name}"]:checked`);
                return checked ? checked.value : defaultValue;
            },

            // Форматирование валюты
            formatCurrency(amount) {
                return Math.round(amount).toLocaleString('ru-RU') + ' ₽';
            },

            // Форматирование времени
            formatHours(hours) {
                return (Math.round(hours * 10) / 10) + ' ч';
            },

            // Debounce функция
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            // Показать тост
            showToast(message, type = 'success') {
                const existingToast = document.querySelector('.success-toast, .error-toast');
                if (existingToast) {
                    existingToast.remove();
                }

                const toast = document.createElement('div');
                toast.className = `${type}-toast`;
                toast.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span>${type === 'success' ? '✅' : '❌'}</span>
                        <span>${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" style="margin-left: auto; background: none; border: none; font-size: 1.2rem; cursor: pointer;">&times;</button>
                    </div>
                `;
                
                document.body.appendChild(toast);
                
                // Показываем с анимацией
                setTimeout(() => toast.classList.add('show'), 100);
                
                // Убираем через 5 секунд
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.classList.remove('show');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, 5000);
            }
        };

        // ===========================================
        // МЕНЕДЖЕР СОСТОЯНИЯ
        // ===========================================

        class StateManager {
            constructor() {
                this.state = {
                    // Режим калькулятора
                    mode: 'express',
                    
                    // Ценообразование
                    pricingMethod: 'hourly',
                    hourlyRate: 220,
                    
                    // Сложность (экспресс)
                    projectComplexity: 1.3,
                    
                    // Сложность (детальная)
                    methodistRole: 1.0,
                    domainKnowledge: 1.0,
                    projectType: 1.0,
                    urgency: 1.0,
                    
                    // Финансы
                    discountRate: 0,
                    taxRate: 13,
                    enableVolumeDiscounts: true,
                    showTaxSeparately: true,
                    
                    // Результаты
                    totalCost: 0,
                    totalHours: 0,
                    breakdown: null
                };
                
                this.listeners = new Set();
                this.isCalculating = false;
            }

            // Подписка на изменения
            subscribe(callback) {
                this.listeners.add(callback);
                return () => this.listeners.delete(callback);
            }

            // Уведомление слушателей
            notify(changedFields) {
                if (this.isCalculating) return; // Предотвращаем рекурсию
                
                this.listeners.forEach(callback => {
                    try {
                        callback(this.state, changedFields);
                    } catch (error) {
                        console.error('State listener error:', error);
                    }
                });
            }

            // Обновление состояния
            update(changes) {
                const changedFields = Object.keys(changes);
                let hasChanges = false;

                changedFields.forEach(field => {
                    if (this.state[field] !== changes[field]) {
                        this.state[field] = changes[field];
                        hasChanges = true;
                    }
                });

                if (hasChanges) {
                    this.notify(changedFields);
                }
            }

            // Получение состояния
            getState() {
                return { ...this.state };
            }

            // Сброс к начальным значениям
            reset() {
                const initialState = {
                    mode: 'express',
                    pricingMethod: 'hourly',
                    hourlyRate: 220,
                    projectComplexity: 1.3,
                    methodistRole: 1.0,
                    domainKnowledge: 1.0,
                    projectType: 1.0,
                    urgency: 1.0,
                    discountRate: 0,
                    taxRate: 13,
                    enableVolumeDiscounts: true,
                    showTaxSeparately: true,
                    totalCost: 0,
                    totalHours: 0,
                    breakdown: null
                };

                Object.keys(initialState).forEach(key => {
                    this.state[key] = initialState[key];
                });

                this.notify(Object.keys(initialState));
            }

            // Валидация состояния
            validate() {
                const errors = [];

                if (this.state.hourlyRate < 100 || this.state.hourlyRate > 10000) {
                    errors.push('Ставка должна быть от 100 до 10000 ₽/час');
                }

                if (this.state.discountRate < -50 || this.state.discountRate > 50) {
                    errors.push('Скидка/наценка должна быть от -50% до +50%');
                }

                return errors;
            }
        }

        // ===========================================
        // ИНТЕРФЕЙС
        // ===========================================

        class UIManager {
            constructor(stateManager) {
                this.stateManager = stateManager;
                this.debouncedCalculate = Utils.debounce(() => {
                    calculator.calculate();
                }, 300);
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupStateSubscription();
                this.updateModeInterface();
            }

            // Подписка на изменения состояния
            setupStateSubscription() {
                this.stateManager.subscribe((state, changedFields) => {
                    // Обновляем интерфейс при изменении состояния
                    if (changedFields.includes('mode')) {
                        this.updateModeInterface();
                    }

                    if (changedFields.includes('totalCost') || changedFields.includes('totalHours')) {
                        this.updateResults(state);
                    }

                    if (changedFields.includes('discountRate')) {
                        this.updateDiscountDisplay(state.discountRate);
                    }

                    if (changedFields.includes('taxRate')) {
                        this.updateTaxDisplay(state.taxRate);
                    }
                });
            }

            // Настройка обработчиков событий
            setupEventListeners() {
                // Радиокнопки режима
                document.querySelectorAll('input[name="calculatorMode"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.stateManager.update({ mode: e.target.value });
                    });
                });

                // Метод ценообразования
                document.querySelectorAll('input[name="pricingMethod"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.stateManager.update({ pricingMethod: e.target.value });
                        this.debouncedCalculate();
                    });
                });

                // Числовые поля
                this.setupNumberInput('hourlyRate', 'hourlyRate');
                this.setupSelectInput('projectComplexity', 'projectComplexity');
                this.setupSelectInput('methodistRole', 'methodistRole');
                this.setupSelectInput('domainKnowledge', 'domainKnowledge');
                this.setupSelectInput('projectType', 'projectType');
                this.setupSelectInput('urgency', 'urgency');

                // Ползунки
                this.setupRangeInput('discountRate', 'discountRate');
                this.setupRangeInput('taxRate', 'taxRate');

                // Чекбоксы
                this.setupCheckboxInput('enableVolumeDiscounts', 'enableVolumeDiscounts');
                this.setupCheckboxInput('showTaxSeparately', 'showTaxSeparately');

                // Кнопки
                this.setupButtons();
            }

            // Настройка числового поля
            setupNumberInput(inputId, stateKey) {
                const input = Utils.safeGetElement(inputId);
                if (!input) return;

                input.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value) || 0;
                    this.stateManager.update({ [stateKey]: value });
                    this.debouncedCalculate();
                });

                input.addEventListener('blur', () => {
                    this.validateInput(input);
                });
            }

            // Настройка селекта
            setupSelectInput(inputId, stateKey) {
                const select = Utils.safeGetElement(inputId);
                if (!select) return;

                select.addEventListener('change', (e) => {
                    const value = parseFloat(e.target.value) || 0;
                    this.stateManager.update({ [stateKey]: value });
                    this.debouncedCalculate();
                });
            }

            // Настройка ползунка
            setupRangeInput(inputId, stateKey) {
                const range = Utils.safeGetElement(inputId);
                if (!range) return;

                range.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value) || 0;
                    this.stateManager.update({ [stateKey]: value });
                    this.debouncedCalculate();
                });
            }

            // Настройка чекбокса
            setupCheckboxInput(inputId, stateKey) {
                const checkbox = Utils.safeGetElement(inputId);
                if (!checkbox) return;

                checkbox.addEventListener('change', (e) => {
                    this.stateManager.update({ [stateKey]: e.target.checked });
                    this.debouncedCalculate();
                });
            }

            // Настройка кнопок
            setupButtons() {
                // Сохранение
                const saveBtn = Utils.safeGetElement('saveBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        this.showSaveModal();
                    });
                }

                // Загрузка
                const loadBtn = Utils.safeGetElement('loadBtn');
                if (loadBtn) {
                    loadBtn.addEventListener('click', () => {
                        this.showLoadModal();
                    });
                }

                // Сброс
                const resetBtn = Utils.safeGetElement('resetBtn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        if (confirm('Сбросить все настройки?')) {
                            this.stateManager.reset();
                            this.syncStateToUI();
                            Utils.showToast('Настройки сброшены');
                        }
                    });
                }

                // Копирование
                const copyBtn = Utils.safeGetElement('copyBtn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => {
                        this.copyCalculationToClipboard();
                    });
                }
            }

            // Валидация поля
            validateInput(input) {
                const validation = input.dataset.validation;
                if (!validation) return true;

                const rules = validation.split('|');
                const value = parseFloat(input.value);

                for (const rule of rules) {
                    if (rule === 'required' && !input.value) {
                        this.showFieldError(input, 'Поле обязательно для заполнения');
                        return false;
                    }

                    if (rule.startsWith('min:')) {
                        const min = parseFloat(rule.split(':')[1]);
                        if (value < min) {
                            this.showFieldError(input, `Минимальное значение: ${min}`);
                            return false;
                        }
                    }

                    if (rule.startsWith('max:')) {
                        const max = parseFloat(rule.split(':')[1]);
                        if (value > max) {
                            this.showFieldError(input, `Максимальное значение: ${max}`);
                            return false;
                        }
                    }
                }

                this.hideFieldError(input);
                return true;
            }

            // Показать ошибку поля
            showFieldError(input, message) {
                input.classList.add('shake');
                input.style.borderColor = '#ef4444';
                
                let errorDiv = input.parentNode.querySelector('.field-error');
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = 'field-error text-xs text-red-600 mt-1';
                    input.parentNode.appendChild(errorDiv);
                }
                errorDiv.textContent = message;

                setTimeout(() => input.classList.remove('shake'), 500);
            }

            // Скрыть ошибку поля
            hideFieldError(input) {
                input.style.borderColor = '';
                const errorDiv = input.parentNode.querySelector('.field-error');
                if (errorDiv) {
                    errorDiv.remove();
                }
            }

            // Обновление интерфейса режима
            updateModeInterface() {
                const state = this.stateManager.getState();
                const mode = MODES[state.mode];

                // Обновляем информационную карточку
                const infoCard = Utils.safeGetElement('modeInfoCard');
                if (infoCard) {
                    infoCard.innerHTML = `
                        <div class="info-card-title">
                            <span>${mode.icon}</span>
                            ${mode.name}
                        </div>
                        <div class="info-card-content">
                            ${mode.description}
                        </div>
                    `;
                }

                // Показываем/скрываем секции
                document.querySelectorAll('.form-section-wrapper').forEach(section => {
                    const sectionId = section.id;
                    if (mode.sections.includes(sectionId)) {
                        section.classList.remove('hidden');
                        section.classList.add('fade-in');
                    } else {
                        section.classList.add('hidden');
                    }
                });

                // Переключаем карточки сложности
                const expressCard = Utils.safeGetElement('expressComplexityCard');
                const detailedCard = Utils.safeGetElement('detailedComplexityCard');

                if (state.mode === 'detailed') {
                    expressCard?.classList.add('hidden');
                    detailedCard?.classList.remove('hidden');
                } else {
                    expressCard?.classList.remove('hidden');
                    detailedCard?.classList.add('hidden');
                }
            }

            // Обновление результатов
            updateResults(state) {
                const totalCostEl = Utils.safeGetElement('totalCost');
                const totalHoursEl = Utils.safeGetElement('totalHours');

                if (totalCostEl) {
                    totalCostEl.textContent = Utils.formatCurrency(state.totalCost);
                }

                if (totalHoursEl) {
                    totalHoursEl.textContent = Utils.formatHours(state.totalHours);
                }

                // Обновляем детализацию
                this.updateBreakdown(state);
            }

            // Обновление детализации
            updateBreakdown(state) {
                const breakdownEl = Utils.safeGetElement('breakdown');
                if (!breakdownEl || !state.breakdown) return;

                const { subtotal, discountAmount, afterDiscount, taxAmount, complexityMultiplier } = state.breakdown;

                let html = '<div class="space-y-2 text-sm">';
                
                html += `<div class="flex justify-between">
                    <span>Базовая стоимость:</span>
                    <span class="font-semibold">${Utils.formatCurrency(subtotal)}</span>
                </div>`;

                if (complexityMultiplier !== 1.0) {
                    html += `<div class="flex justify-between text-blue-600">
                        <span>Коэффициент сложности:</span>
                        <span class="font-semibold">×${complexityMultiplier.toFixed(2)}</span>
                    </div>`;
                }

                if (discountAmount !== 0) {
                    const sign = discountAmount > 0 ? '+' : '';
                    const label = discountAmount > 0 ? 'Наценка:' : 'Скидка:';
                    html += `<div class="flex justify-between ${discountAmount > 0 ? 'text-red-600' : 'text-green-600'}">
                        <span>${label}</span>
                        <span class="font-semibold">${sign}${Utils.formatCurrency(Math.abs(discountAmount))}</span>
                    </div>`;
                }

                if (state.showTaxSeparately && taxAmount > 0) {
                    html += `<div class="flex justify-between text-gray-600">
                        <span>Налог (${state.taxRate}%):</span>
                        <span class="font-semibold">+${Utils.formatCurrency(taxAmount)}</span>
                    </div>`;
                }

                html += `<div class="flex justify-between border-t pt-2 font-bold text-lg">
                    <span>Итого:</span>
                    <span class="text-blue-600">${Utils.formatCurrency(state.totalCost)}</span>
                </div>`;

                html += '</div>';
                
                breakdownEl.innerHTML = html;
            }

            // Обновление отображения скидки
            updateDiscountDisplay(value) {
                const valueEl = Utils.safeGetElement('discountValue');
                if (!valueEl) return;

                if (value === 0) {
                    valueEl.textContent = '0% (без изменений)';
                } else if (value > 0) {
                    valueEl.textContent = `+${value}% (наценка)`;
                } else {
                    valueEl.textContent = `${value}% (скидка)`;
                }
            }

            // Обновление отображения налога
            updateTaxDisplay(value) {
                const valueEl = Utils.safeGetElement('taxValue');
                if (!valueEl) return;

                const labels = {
                    0: '0% (без налогов)',
                    4: '4% (самозанятый)',
                    6: '6% (УСН доходы)',
                    13: '13% (НДФЛ)',
                    15: '15% (УСН доходы-расходы)',
                    20: '20% (НДС + прибыль)'
                };

                valueEl.textContent = labels[value] || `${value}% (индивидуальная ставка)`;
            }

            // Синхронизация состояния с UI
            syncStateToUI() {
                const state = this.stateManager.getState();

                // Радиокнопки режима
                const modeRadio = document.querySelector(`input[name="calculatorMode"][value="${state.mode}"]`);
                if (modeRadio) modeRadio.checked = true;

                // Метод ценообразования
                const pricingRadio = document.querySelector(`input[name="pricingMethod"][value="${state.pricingMethod}"]`);
                if (pricingRadio) pricingRadio.checked = true;

                // Поля ввода
                const hourlyRateInput = Utils.safeGetElement('hourlyRate');
                if (hourlyRateInput) hourlyRateInput.value = state.hourlyRate;

                const complexitySelect = Utils.safeGetElement('projectComplexity');
                if (complexitySelect) complexitySelect.value = state.projectComplexity;

                // Ползунки
                const discountRange = Utils.safeGetElement('discountRate');
                if (discountRange) discountRange.value = state.discountRate;

                const taxRange = Utils.safeGetElement('taxRate');
                if (taxRange) taxRange.value = state.taxRate;

                // Чекбоксы
                const volumeCheckbox = Utils.safeGetElement('enableVolumeDiscounts');
                if (volumeCheckbox) volumeCheckbox.checked = state.enableVolumeDiscounts;

                const taxCheckbox = Utils.safeGetElement('showTaxSeparately');
                if (taxCheckbox) taxCheckbox.checked = state.showTaxSeparately;

                // Обновляем отображения
                this.updateDiscountDisplay(state.discountRate);
                this.updateTaxDisplay(state.taxRate);
                this.updateModeInterface();
            }

            // Модальные окна
            showSaveModal() {
                const modal = Utils.safeGetElement('saveModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                    
                    const nameInput = Utils.safeGetElement('saveName');
                    if (nameInput) nameInput.focus();
                }
            }

            hideSaveModal() {
                const modal = Utils.safeGetElement('saveModal');
                if (modal) {
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
            }

            showLoadModal() {
                const modal = Utils.safeGetElement('loadModal');
                if (modal) {
                    this.updateSavedCalculationsList();
                    modal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
            }

            hideLoadModal() {
                const modal = Utils.safeGetElement('loadModal');
                if (modal) {
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
            }

            // Обновление списка сохраненных расчетов
            updateSavedCalculationsList() {
                const container = Utils.safeGetElement('savedCalculations');
                if (!container) return;

                const saved = JSON.parse(localStorage.getItem(CALCULATIONS_KEY) || '[]');
                
                if (saved.length === 0) {
                    container.innerHTML = '<div class="text-gray-500 text-sm text-center">Сохраненных расчетов пока нет</div>';
                    return;
                }

                container.innerHTML = saved.map(calc => `
                    <div class="saved-calculation-item" data-id="${calc.id}">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold">${calc.name}</h4>
                            <span class="text-xs text-gray-500">${new Date(calc.date).toLocaleDateString('ru-RU')}</span>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">${calc.description || 'Без описания'}</div>
                        <div class="text-sm text-blue-600 mb-3">
                            ${Utils.formatCurrency(calc.totalCost)} • ${Utils.formatHours(calc.totalHours)}
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-sm btn-primary" onclick="uiManager.loadCalculation('${calc.id}')">
                                Загрузить
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="uiManager.deleteCalculation('${calc.id}')">
                                Удалить
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // Сохранение расчета
            saveCalculation() {
                const nameInput = Utils.safeGetElement('saveName');
                const descInput = Utils.safeGetElement('saveDescription');
                
                if (!nameInput?.value.trim()) {
                    Utils.showToast('Введите название расчета', 'error');
                    return;
                }

                const state = this.stateManager.getState();
                const calculation = {
                    id: Date.now().toString(),
                    name: nameInput.value.trim(),
                    description: descInput?.value.trim() || '',
                    date: new Date().toISOString(),
                    state: state,
                    totalCost: state.totalCost,
                    totalHours: state.totalHours
                };

                const saved = JSON.parse(localStorage.getItem(CALCULATIONS_KEY) || '[]');
                saved.unshift(calculation);
                
                // Ограничиваем количество сохраненных расчетов
                if (saved.length > 50) {
                    saved.splice(50);
                }

                localStorage.setItem(CALCULATIONS_KEY, JSON.stringify(saved));
                
                this.hideSaveModal();
                Utils.showToast('Расчет сохранен');
                
                // Очищаем форму
                if (nameInput) nameInput.value = '';
                if (descInput) descInput.value = '';
            }

            // Загрузка расчета
            loadCalculation(id) {
                const saved = JSON.parse(localStorage.getItem(CALCULATIONS_KEY) || '[]');
                const calculation = saved.find(calc => calc.id === id);
                
                if (!calculation) {
                    Utils.showToast('Расчет не найден', 'error');
                    return;
                }

                // Обновляем состояние
                Object.keys(calculation.state).forEach(key => {
                    this.stateManager.update({ [key]: calculation.state[key] });
                });

                // Синхронизируем UI
                this.syncStateToUI();
                
                // Пересчитываем
                calculator.calculate();
                
                this.hideLoadModal();
                Utils.showToast(`Загружен расчет "${calculation.name}"`);
            }

            // Удаление расчета
            deleteCalculation(id) {
                if (!confirm('Удалить сохраненный расчет?')) return;

                const saved = JSON.parse(localStorage.getItem(CALCULATIONS_KEY) || '[]');
                const filtered = saved.filter(calc => calc.id !== id);
                
                localStorage.setItem(CALCULATIONS_KEY, JSON.stringify(filtered));
                this.updateSavedCalculationsList();
                
                Utils.showToast('Расчет удален');
            }

            // Копирование в буфер обмена
            copyCalculationToClipboard() {
                const text = this.generateClientText();
                
                if (!text) {
                    Utils.showToast('Нет данных для копирования', 'error');
                    return;
                }

                navigator.clipboard.writeText(text).then(() => {
                    Utils.showToast('Расчет скопирован в буфер обмена');
                    
                    const statusEl = Utils.safeGetElement('copyStatus');
                    if (statusEl) {
                        statusEl.classList.remove('hidden');
                        setTimeout(() => statusEl.classList.add('hidden'), 3000);
                    }
                }).catch(() => {
                    // Fallback для старых браузеров
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    Utils.showToast('Расчет скопирован в буфер обмена');
                });
            }

            // Генерация текста для клиента
            generateClientText() {
                const state = this.stateManager.getState();
                
                if (state.totalCost === 0) return '';

                let text = `РАСЧЕТ СТОИМОСТИ МЕТОДИЧЕСКИХ УСЛУГ\n`;
                text += `Дата: ${new Date().toLocaleDateString('ru-RU')}\n\n`;
                
                text += `ОБЩИЕ ПОКАЗАТЕЛИ:\n`;
                text += `• Общее время выполнения: ${Utils.formatHours(state.totalHours)}\n`;
                text += `• Итоговая стоимость: ${Utils.formatCurrency(state.totalCost)}\n\n`;
                
                if (state.breakdown) {
                    text += `ДЕТАЛИЗАЦИЯ:\n`;
                    text += `• Базовая стоимость: ${Utils.formatCurrency(state.breakdown.subtotal)}\n`;
                    
                    if (state.breakdown.complexityMultiplier !== 1.0) {
                        text += `• Коэффициент сложности: ×${state.breakdown.complexityMultiplier.toFixed(2)}\n`;
                    }
                    
                    if (state.breakdown.discountAmount !== 0) {
                        const label = state.breakdown.discountAmount > 0 ? 'Наценка' : 'Скидка';
                        text += `• ${label}: ${state.breakdown.discountAmount > 0 ? '+' : ''}${Utils.formatCurrency(Math.abs(state.breakdown.discountAmount))}\n`;
                    }
                    
                    if (state.showTaxSeparately && state.breakdown.taxAmount > 0) {
                        text += `• Налог (${state.taxRate}%): +${Utils.formatCurrency(state.breakdown.taxAmount)}\n`;
                    }
                    
                    text += `\n`;
                }
                
                text += `УСЛОВИЯ:\n`;
                text += `• Часовая ставка: ${state.hourlyRate} ₽/час\n`;
                text += `• Оплата по факту выполнения этапов\n`;
                text += `• Сроки уточняются при заключении договора\n`;
                text += `• Стоимость действительна в течение 30 дней\n\n`;
                
                text += `Данный расчет носит предварительный характер.\n`;
                text += `Финальная стоимость может быть скорректирована после детального обсуждения требований.`;
                
                return text;
            }
        }

        // ===========================================
        // МЕНЕДЖЕР ХРАНЕНИЯ
        // ===========================================

        class StorageManager {
            constructor(stateManager) {
                this.stateManager = stateManager;
                this.autosaveEnabled = true;
                this.autosaveTimeout = null;
            }

            // Автосохранение состояния
            enableAutosave() {
                this.stateManager.subscribe((state) => {
                    if (!this.autosaveEnabled) return;
                    
                    clearTimeout(this.autosaveTimeout);
                    this.autosaveTimeout = setTimeout(() => {
                        this.saveState(state);
                    }, 1000);
                });
            }

            // Сохранение состояния
            saveState(state) {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                } catch (error) {
                    console.warn('Failed to save state:', error);
                }
            }

            // Загрузка состояния
            loadState() {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    return saved ? JSON.parse(saved) : null;
                } catch (error) {
                    console.warn('Failed to load state:', error);
                    return null;
                }
            }

            // Очистка сохраненного состояния
            clearState() {
                localStorage.removeItem(STORAGE_KEY);
            }
        }

        // ===========================================
        // СТИЛИ ДЛЯ МОДАЛЬНЫХ ОКОН
        // ===========================================

        const modalStyles = `
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }

            .modal {
                background: white;
                border-radius: 12px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow: hidden;
                animation: modalAppear 0.3s ease-out;
            }

            @keyframes modalAppear {
                from {
                    opacity: 0;
                    transform: scale(0.9) translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
            }

            .modal-header {
                padding: 20px 25px 15px;
                border-bottom: 1px solid #e5e7eb;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .modal-header h3 {
                margin: 0;
                font-size: 1.2rem;
                font-weight: 700;
                color: #1f2937;
            }

            .modal-close {
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: #6b7280;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 6px;
                transition: all 0.2s;
            }

            .modal-close:hover {
                background: #f3f4f6;
                color: #374151;
            }

            .modal-body {
                padding: 20px 25px;
                max-height: 60vh;
                overflow-y: auto;
            }

            .modal-footer {
                padding: 15px 25px 20px;
                border-top: 1px solid #e5e7eb;
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }

            .saved-calculation-item {
                background: #f9fafb;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 15px;
                transition: all 0.2s;
            }

            .saved-calculation-item:hover {
                background: #f3f4f6;
                border-color: #d1d5db;
            }
        `;

        // Добавляем стили в head
        const styleSheet = document.createElement('style');
        styleSheet.textContent = modalStyles;
        document.head.appendChild(styleSheet);

        // ===========================================
        // ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ
        // ===========================================

        // Глобальные переменные
       let stateManager, calculator, uiManager, storageManager, componentsManager;

        // Инициализация после загрузки DOM
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Создаем экземпляры классов
                stateManager = new StateManager();
                calculator = new Calculator(stateManager);
                uiManager = new UIManager(stateManager);
                storageManager = new StorageManager(stateManager);
                componentsManager = new ComponentsManager(stateManager);

                // Загружаем сохраненное состояние
                const savedState = storageManager.loadState();
                if (savedState) {
                    Object.keys(savedState).forEach(key => {
                        if (savedState[key] !== undefined) {
                            stateManager.update({ [key]: savedState[key] });
                        }
                    });
                    uiManager.syncStateToUI();
                }

                // Включаем автосохранение
                storageManager.enableAutosave();

                // Обработчики модальных окон
                setupModalHandlers();

                // Обновляем цены при изменении ставки
                stateManager.subscribe((state, changedFields) => {
                    if (changedFields.includes('hourlyRate')) {
                        componentsManager.updateAllPrices();
                    }
                });
                
                // Первичный расчет
                calculator.calculate();

                Utils.showToast('Калькулятор готов к работе');

            } catch (error) {
                console.error('Initialization error:', error);
                Utils.showToast('Ошибка инициализации приложения', 'error');
            }
        });

        // Настройка обработчиков модальных окон
        function setupModalHandlers() {
            // Сохранение
            const closeSaveBtn = Utils.safeGetElement('closeSaveModal');
            const cancelSaveBtn = Utils.safeGetElement('cancelSave');
            const confirmSaveBtn = Utils.safeGetElement('confirmSave');

            if (closeSaveBtn) closeSaveBtn.onclick = () => uiManager.hideSaveModal();
            if (cancelSaveBtn) cancelSaveBtn.onclick = () => uiManager.hideSaveModal();
            if (confirmSaveBtn) confirmSaveBtn.onclick = () => uiManager.saveCalculation();

            // Загрузка
            const closeLoadBtn = Utils.safeGetElement('closeLoadModal');
            const cancelLoadBtn = Utils.safeGetElement('cancelLoad');

            if (closeLoadBtn) closeLoadBtn.onclick = () => uiManager.hideLoadModal();
            if (cancelLoadBtn) cancelLoadBtn.onclick = () => uiManager.hideLoadModal();

            // Закрытие по клику на overlay
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    uiManager.hideSaveModal();
                    uiManager.hideLoadModal();
                }
            });

            // Закрытие по Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    uiManager.hideSaveModal();
                    uiManager.hideLoadModal();
                }
            });

            // Enter в поле названия сохранения
            const saveNameInput = Utils.safeGetElement('saveName');
            if (saveNameInput) {
                saveNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        uiManager.saveCalculation();
                    }
                });
            }
        }

        // Обработка ошибок
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            Utils.showToast('Произошла ошибка. Проверьте консоль для деталей.', 'error');
        });

        // Предотвращение потери данных при закрытии страницы
        window.addEventListener('beforeunload', (e) => {
            const state = stateManager?.getState();
            if (state && (state.totalCost > 0 || state.totalHours > 0)) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // ===========================================
        // МЕНЕДЖЕР КОМПОНЕНТОВ И ПРЕСЕТОВ
        // ===========================================

        class ComponentsManager {
            constructor(stateManager) {
                this.stateManager = stateManager;
                this.customServices = [];
                this.customServiceCounter = 0;
                this.autoActivatedComponents = new Set();
                
                this.initializeData();
                this.render();
                this.setupEventListeners();
            }

            initializeData() {
                // Конфигурация пресетов
                this.presets = {
                    textLesson: {
                        name: 'Текстовый урок',
                        description: 'Статья для самостоятельного изучения теории и концепций (20-40 мин чтения)',
                        includes: 'Лонгрид + Упражнения + Иллюстрации + Квизы',
                        components: ['longread', 'exercises', 'illustrations', 'quizzes'],
                        baseHours: 5.5,
                        defaultDuration: 30,
                        icon: '📝'
                    },
                    videoLesson: {
                        name: 'Видео урок',
                        description: 'Видеоурок с презентацией для объяснения процессов и демонстрации (30-90 мин)',
                        includes: 'Скрипт + Презентация + Иллюстрации',
                        components: ['script', 'presentation', 'illustrations'],
                        baseHours: 10.5,
                        defaultDuration: 60,
                        icon: '🎥'
                    },
                    webinar: {
                        name: 'Вебинар',
                        description: 'Живое онлайн-обучение с интерактивным взаимодействием с аудиторией (60-120 мин)',
                        includes: 'Презентация + Иллюстрации + Механики вовлечения',
                        components: ['presentation', 'illustrations', 'engagementMechanics'],
                        baseHours: 8.5,
                        defaultDuration: 90,
                        icon: '📡'
                    },
                    workshop: {
                        name: 'Практикум',
                        description: 'Воркшоп для отработки навыков с пошаговыми инструкциями (60-180 мин)',
                        includes: 'Инструкции + Шаблоны + Упражнения + Примеры',
                        components: ['instructions', 'templates', 'exercises', 'examples'],
                        baseHours: 8,
                        defaultDuration: 60,
                        icon: '🛠️'
                    },
                    caseStudy: {
                        name: 'Кейс-стади',
                        description: 'Разбор реальной ситуации для анализа и обсуждения решений (30-60 мин)',
                        includes: 'Описание кейса + Вопросы + Разбор решения',
                        components: ['caseDescription', 'caseQuestions', 'caseSolution'],
                        baseHours: 5,
                        defaultDuration: 45,
                        icon: '📊'
                    },
                    masterClass: {
                        name: 'Мастер-класс',
                        description: 'Демонстрация экспертного подхода на конкретном примере (45-90 мин)',
                        includes: 'Разбор кейса + Вопросы для анализа + Разбор решения',
                        components: ['caseDescription', 'caseQuestions', 'caseSolution'],
                        baseHours: 5,
                        defaultDuration: 60,
                        icon: '🎭'
                    }
                };

                // Конфигурация компонентов
                this.components = {
                    longread: {
                        name: 'Лонгрид',
                        description: 'Структурированная статья урока объемом 1500-2000 знаков для самостоятельного изучения',
                        defaultHours: 2.5,
                        icon: '📄',
                        tags: ['Текстовые уроки'],
                        extraControls: ['pages']
                    },
                    script: {
                        name: 'Скрипт для записи',
                        description: 'Готовый текст с разметкой и комментариями для записи видеоурока длительностью 30-90 минут',
                        defaultHours: 4,
                        icon: '📜',
                        tags: ['Видео уроки']
                    },
                    presentation: {
                        name: 'Презентация',
                        description: 'Слайд-дека из 15-25 слайдов с текстом и структурой для урока или вебинара',
                        defaultHours: 6,
                        icon: '📊',
                        tags: ['Видео уроки', 'Вебинары']
                    },
                    exercises: {
                        name: 'Упражнения',
                        description: 'Практические задания на отработку навыков внутри урока с инструкциями и примерами',
                        defaultHours: 1,
                        icon: '💪',
                        tags: ['Текстовые уроки', 'Практикумы']
                    },
                    illustrations: {
                        name: 'Иллюстрации',
                        description: 'Подбор и адаптация 5-10 визуальных материалов для поддержки контента урока',
                        defaultHours: 0.5,
                        icon: '🎨',
                        tags: ['Все типы']
                    },
                    quizzes: {
                        name: 'Квизы',
                        description: 'Интерактивная проверка из 5-10 вопросов для закрепления материала урока',
                        defaultHours: 1.5,
                        icon: '❓',
                        tags: ['Текстовые уроки'],
                        extraControls: ['questions']
                    },
                            instructions: {
                        name: 'Пошаговые инструкции',
                        description: 'Детальный алгоритм действий с пошаговым разбором для самостоятельного выполнения',
                        defaultHours: 3,
                        icon: '📝',
                        tags: ['Практикумы']
                    },
                    templates: {
                        name: 'Шаблоны/Канвасы',
                        description: 'Готовые бланки и формы для заполнения участниками во время практических занятий',
                        defaultHours: 2,
                        icon: '📋',
                        tags: ['Практикумы']
                    },
                    examples: {
                        name: 'Разбор примера',
                        description: 'Детальный анализ реального или учебного кейса с объяснением решений и выводов',
                        defaultHours: 2,
                        icon: '💡',
                        tags: ['Практикумы']
                    },
                    caseDescription: {
                        name: 'Разбор кейса',
                        description: 'Структурированное описание ситуации с контекстом и данными для анализа участниками',
                        defaultHours: 3,
                        icon: '📑',
                        tags: ['Кейс-стади', 'Мастер-классы']
                    },
                    caseQuestions: {
                        name: 'Вопросы для анализа',
                        description: 'Набор из 5-8 направляющих вопросов для самостоятельного разбора кейса участниками',
                        defaultHours: 1,
                        icon: '❔',
                        tags: ['Кейс-стади', 'Мастер-классы']
                    },
                    caseSolution: {
                        name: 'Разбор решения',
                        description: 'Экспертный комментарий с объяснением правильного решения кейса и альтернативных вариантов',
                        defaultHours: 1,
                        icon: '✅',
                        tags: ['Кейс-стади', 'Мастер-классы']
                    },
                    engagementMechanics: {
                        name: 'Механики вовлечения',
                        description: 'Интерактивные элементы для удержания внимания: опросы, чаты, голосования, мини-игры',
                        defaultHours: 2,
                        icon: '🎯',
                        tags: ['Вебинары']
                    }
                };

                // Конфигурация проверок знаний
                this.assessments = {
                    currentTests: {
                        name: 'Текущая проверка',
                        description: 'Тесты и домашние задания на 10-15 вопросов для закрепления материала каждого урока',
                        defaultHours: 2,
                        icon: '📝'
                    },
                    moduleProjects: {
                        name: 'Промежуточная проверка',
                        description: 'Практические проекты и кейсы для проверки навыков в конце модуля или блока уроков',
                        defaultHours: 4,
                        icon: '📊'
                    },
                    finalAssessment: {
                        name: 'Итоговая проверка',
                        description: 'Комплексная аттестация знаний и навыков в конце программы обучения с оценкой результатов',
                        defaultHours: 6,
                        icon: '🎯'
                    }
                };

                // Конфигурация дополнительных услуг
                this.services = {
                    research: {
                        name: 'Кабинетное исследование',
                        description: 'Изучение предметной области, анализ конкурентов и лучших практик для создания актуального контента',
                        defaultHours: 6,
                        icon: '🔍'
                    },
                    audit: {
                        name: 'Методический аудит',
                        description: 'Экспертная оценка существующих материалов с рекомендациями по улучшению структуры и качества',
                        defaultHours: 6,
                        icon: '🔍'
                    },
                    methodology: {
                        name: 'Методические артефакты',
                        description: 'Карта образовательных результатов и детальный тематический план программы обучения',
                        defaultHours: 5,
                        icon: '📋'
                    },
                    speakerPrep: {
                        name: 'Подготовка спикера к записи урока',
                        description: 'Тренировка подачи материала, работа с речью и подготовка к качественной записи контента',
                        defaultHours: 4,
                        icon: '🎤'
                    }
                };

                // Инициализация состояния компонентов
                this.stateManager.update({
                    presets: {},
                    components: {},
                    assessments: {},
                    services: {},
                    customServices: []
                });
            }

            render() {
                this.renderPresets();
                this.renderComponents();
                this.renderAssessments();
                this.renderServices();
            }

            renderPresets() {
                const container = Utils.safeGetElement('presetGrid');
                if (!container) return;

                container.innerHTML = Object.keys(this.presets).map(presetId => {
                    const preset = this.presets[presetId];
                    return `
                        <div class="preset-item" data-type="${presetId}" data-preset="${presetId}">
                            <div class="preset-header">
                                <div>
                                    <div class="preset-title">
                                        ${preset.icon} ${preset.name}
                                    </div>
                                </div>
                                <div class="preset-price" id="${presetId}Price">
                                    0 ₽/шт
                                </div>
                            </div>
                            
                            <div class="preset-description">
                                ${preset.description}
                            </div>
                            
                            <div class="preset-includes">
                                <div class="preset-includes-title">Базово включает:</div>
                                <div class="preset-includes-list">${preset.includes}</div>
                            </div>
                            
                            <div class="preset-controls">
                                <div class="preset-control">
                                    <label class="preset-control-label">Количество:</label>
                                    <input type="number" 
                                           class="preset-control-input" 
                                           id="${presetId}Count" 
                                           value="0" 
                                           min="0" 
                                           max="50"
                                           data-preset="${presetId}">
                                </div>
                                <div class="preset-control">
                                    <label class="preset-control-label">Длительность (мин):</label>
                                    <input type="number" 
                                           class="preset-control-input" 
                                           id="${presetId}Duration" 
                                           value="${preset.defaultDuration}" 
                                           min="10" 
                                           max="240"
                                           data-preset="${presetId}">
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderComponents() {
                const container = Utils.safeGetElement('componentsGrid');
                if (!container) return;

                container.innerHTML = Object.keys(this.components).map(componentId => {
                    const component = this.components[componentId];
                    const state = this.stateManager.getState();
                    const hourlyRate = state.hourlyRate || 220;
                    const pricePerUnit = Math.round(component.defaultHours * hourlyRate);

                    return `
                        <div class="component-item" data-component="${componentId}">
                            <div class="component-header">
                                <input type="checkbox" 
                                       class="component-checkbox" 
                                       id="${componentId}Checkbox"
                                       data-component="${componentId}">
                                <div class="component-main">
                                    <div class="component-title">
                                        ${component.icon} ${component.name}
                                    </div>
                                    <div class="component-meta">
                                        <span class="component-hours" id="${componentId}Hours">${component.defaultHours}ч/шт</span>
                                        <span class="component-price" id="${componentId}Price">${pricePerUnit.toLocaleString('ru-RU')} ₽/шт</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="component-description">
                                ${component.description}
                            </div>
                            
                            <div class="component-tags">
                                ${component.tags.map(tag => `<span class="component-tag">${tag}</span>`).join('')}
                            </div>
                            
                            <div class="component-controls" id="${componentId}Controls">
                                <div class="component-control">
                                    <label class="component-control-label">Время (ч):</label>
                                    <input type="number" 
                                           class="component-control-input" 
                                           id="${componentId}HoursInput" 
                                           value="${component.defaultHours}" 
                                           min="0.1" 
                                           max="20" 
                                           step="0.1"
                                           data-component="${componentId}">
                                </div>
                                <div class="component-control">
                                    <label class="component-control-label">Количество:</label>
                                    <input type="number" 
                                           class="component-control-input" 
                                           id="${componentId}CountInput" 
                                           value="1" 
                                           min="1" 
                                           max="50"
                                           data-component="${componentId}">
                                </div>
                                ${component.extraControls?.includes('pages') ? `
                                    <div class="component-control">
                                        <label class="component-control-label">Листы А4:</label>
                                        <input type="number" 
                                               class="component-control-input" 
                                               id="${componentId}Pages" 
                                               value="1" 
                                               min="0.5" 
                                               max="10" 
                                               step="0.5"
                                               data-component="${componentId}">
                                    </div>
                                ` : ''}
                                ${component.extraControls?.includes('questions') ? `
                                    <div class="component-control">
                                        <label class="component-control-label">Вопросов:</label>
                                        <input type="number" 
                                               class="component-control-input" 
                                               id="${componentId}Questions" 
                                               value="7" 
                                               min="1" 
                                               max="20"
                                               data-component="${componentId}">
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderAssessments() {
                const container = Utils.safeGetElement('assessmentsGrid');
                if (!container) return;

                container.innerHTML = Object.keys(this.assessments).map(assessmentId => {
                    const assessment = this.assessments[assessmentId];
                    const state = this.stateManager.getState();
                    const hourlyRate = state.hourlyRate || 220;
                    const pricePerUnit = Math.round(assessment.defaultHours * hourlyRate);

                    return `
                        <div class="assessment-item" data-assessment="${assessmentId}">
                            <div class="assessment-header">
                                <input type="checkbox" 
                                       class="assessment-checkbox" 
                                       id="${assessmentId}Checkbox"
                                       data-assessment="${assessmentId}">
                                <div class="assessment-main">
                                    <div class="assessment-title">
                                        ${assessment.icon} ${assessment.name}
                                    </div>
                                    <div class="assessment-meta">
                                        <span class="assessment-hours" id="${assessmentId}Hours">${assessment.defaultHours}ч/шт</span>
                                        <span class="component-price" id="${assessmentId}Price">${pricePerUnit.toLocaleString('ru-RU')} ₽/шт</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="assessment-description">
                                ${assessment.description}
                            </div>
                            
                            <div class="assessment-controls" id="${assessmentId}Controls">
                                <div class="component-control">
                                    <label class="component-control-label">Время (ч):</label>
                                    <input type="number" 
                                           class="component-control-input" 
                                           id="${assessmentId}HoursInput" 
                                           value="${assessment.defaultHours}" 
                                           min="0.1" 
                                           max="20" 
                                           step="0.1"
                                           data-assessment="${assessmentId}">
                                </div>
                                <div class="component-control">
                                    <label class="component-control-label">Количество:</label>
                                    <input type="number" 
                                           class="component-control-input" 
                                           id="${assessmentId}CountInput" 
                                           value="1" 
                                           min="1" 
                                           max="30"
                                           data-assessment="${assessmentId}">
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderServices() {
                const container = Utils.safeGetElement('servicesGrid');
                if (!container) return;

                container.innerHTML = Object.keys(this.services).map(serviceId => {
                    const service = this.services[serviceId];
                    const state = this.stateManager.getState();
                    const hourlyRate = state.hourlyRate || 220;
                    const price = Math.round(service.defaultHours * hourlyRate);

                    return `
                        <div class="service-item" data-service="${serviceId}">
                            <div class="service-header">
                                <input type="checkbox" 
                                       class="service-checkbox" 
                                       id="${serviceId}Checkbox"
                                       data-service="${serviceId}">
                                <div class="service-main">
                                    <div class="service-title">
                                        ${service.icon} ${service.name}
                                    </div>
                                    <div class="service-meta">
                                        <span class="service-hours" id="${serviceId}Hours">${service.defaultHours}ч</span>
                                        <span class="component-price" id="${serviceId}Price">${price.toLocaleString('ru-RU')} ₽</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="service-description">
                                ${service.description}
                            </div>
                            
                            <div class="service-controls" id="${serviceId}Controls">
                                <div class="component-control">
                                    <label class="component-control-label">Время (ч):</label>
                                    <input type="number" 
                                           class="component-control-input" 
                                           id="${serviceId}HoursInput" 
                                           value="${service.defaultHours}" 
                                           min="0.1" 
                                           max="20" 
                                           step="0.1"
                                           data-service="${serviceId}">
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            setupEventListeners() {
                // Пресеты
                document.addEventListener('click', (e) => {
                    const presetItem = e.target.closest('.preset-item');
                    if (presetItem && !e.target.closest('.preset-controls')) {
                        this.togglePreset(presetItem);
                    }
                });

                  // Компоненты
                document.addEventListener('click', (e) => {
                    const componentItem = e.target.closest('.component-item');
                    if (componentItem && !e.target.closest('.component-controls') && !e.target.classList.contains('component-checkbox')) {
                        this.toggleComponent(componentItem);
                    }
                });

                // Проверки знаний
                document.addEventListener('click', (e) => {
                    const assessmentItem = e.target.closest('.assessment-item');
                    if (assessmentItem && !e.target.closest('.assessment-controls') && !e.target.classList.contains('assessment-checkbox')) {
                        this.toggleAssessment(assessmentItem);
                    }
                });

                // Услуги
                document.addEventListener('click', (e) => {
                    const serviceItem = e.target.closest('.service-item');
                    if (serviceItem && !e.target.closest('.service-controls') && !e.target.classList.contains('service-checkbox')) {
                        this.toggleService(serviceItem);
                    }
                });

                // Изменение значений в контролах
                document.addEventListener('input', (e) => {
                    if (e.target.dataset.preset) {
                        this.handlePresetChange(e.target);
                    } else if (e.target.dataset.component) {
                        this.handleComponentChange(e.target);
                    } else if (e.target.dataset.assessment) {
                        this.handleAssessmentChange(e.target);
                    } else if (e.target.dataset.service) {
                        this.handleServiceChange(e.target);
                    }
                });

                // Чекбоксы
                document.addEventListener('change', (e) => {
                    if (e.target.classList.contains('component-checkbox')) {
                        this.handleComponentCheckbox(e.target);
                    } else if (e.target.classList.contains('assessment-checkbox')) {
                        this.handleAssessmentCheckbox(e.target);
                    } else if (e.target.classList.contains('service-checkbox')) {
                        this.handleServiceCheckbox(e.target);
                    }
                });

                // Правки
                const clientTypeSelect = Utils.safeGetElement('clientType');
                if (clientTypeSelect) {
                    clientTypeSelect.addEventListener('change', () => {
                        calculator.calculate();
                    });
                }
            }

            togglePreset(presetItem) {
                const presetId = presetItem.dataset.preset;
                const countInput = Utils.safeGetElement(`${presetId}Count`);
                
                if (countInput) {
                    const currentCount = parseInt(countInput.value) || 0;
                    countInput.value = currentCount === 0 ? 1 : 0;
                    this.handlePresetChange(countInput);
                }
            }

            toggleComponent(componentItem) {
                const componentId = componentItem.dataset.component;
                const checkbox = Utils.safeGetElement(`${componentId}Checkbox`);
                
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    this.handleComponentCheckbox(checkbox);
                }
            }

            toggleAssessment(assessmentItem) {
                const assessmentId = assessmentItem.dataset.assessment;
                const checkbox = Utils.safeGetElement(`${assessmentId}Checkbox`);
                
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    this.handleAssessmentCheckbox(checkbox);
                }
            }

            toggleService(serviceItem) {
                const serviceId = serviceItem.dataset.service;
                const checkbox = Utils.safeGetElement(`${serviceId}Checkbox`);
                
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    this.handleServiceCheckbox(checkbox);
                }
            }

            handlePresetChange(input) {
                const presetId = input.dataset.preset;
                const presetItem = input.closest('.preset-item');
                const count = parseInt(Utils.safeGetValue(`${presetId}Count`, 0));
                
                if (count > 0) {
                    presetItem.classList.add('active');
                    this.suggestComponentsForPreset(presetId);
                } else {
                    presetItem.classList.remove('active');
                    this.removeAutoSuggestionsForPreset(presetId);
                }
                
                this.updatePresetPrices();
                calculator.calculate();
            }

            handleComponentCheckbox(checkbox) {
                const componentId = checkbox.dataset.component;
                const componentItem = checkbox.closest('.component-item');
                const controls = Utils.safeGetElement(`${componentId}Controls`);
                
                if (checkbox.checked) {
                    componentItem.classList.add('selected');
                    componentItem.classList.remove('auto-selected');
                    controls?.classList.add('visible');
                    this.autoActivatedComponents.delete(componentId);
                    this.removeAutoBadge(componentItem);
                } else {
                    componentItem.classList.remove('selected', 'auto-selected');
                    controls?.classList.remove('visible');
                    this.autoActivatedComponents.delete(componentId);
                    this.removeAutoBadge(componentItem);
                }
                
                calculator.calculate();
            }

            handleAssessmentCheckbox(checkbox) {
                const assessmentId = checkbox.dataset.assessment;
                const assessmentItem = checkbox.closest('.assessment-item');
                const controls = Utils.safeGetElement(`${assessmentId}Controls`);
                
                if (checkbox.checked) {
                    assessmentItem.classList.add('selected');
                    controls?.classList.add('visible');
                } else {
                    assessmentItem.classList.remove('selected', 'auto-selected');
                    controls?.classList.remove('visible');
                }
                
                calculator.calculate();
            }

            handleServiceCheckbox(checkbox) {
                const serviceId = checkbox.dataset.service;
                const serviceItem = checkbox.closest('.service-item');
                const controls = Utils.safeGetElement(`${serviceId}Controls`);
                
                if (checkbox.checked) {
                    serviceItem.classList.add('selected');
                    serviceItem.classList.remove('auto-selected');
                    controls?.classList.add('visible');
                } else {
                    serviceItem.classList.remove('selected', 'auto-selected');
                    controls?.classList.remove('visible');
                }
                
                calculator.calculate();
            }

            handleComponentChange() {
                this.updateComponentPrices();
                calculator.calculate();
            }

            handleAssessmentChange() {
                this.updateAssessmentPrices();
                calculator.calculate();
            }

            handleServiceChange() {
                this.updateServicePrices();
                calculator.calculate();
            }

            suggestComponentsForPreset(presetId) {
                const preset = this.presets[presetId];
                if (!preset) return;

                 // Автоматически предлагаем связанные компоненты
                preset.components.forEach(componentId => {
                    const checkbox = Utils.safeGetElement(`${componentId}Checkbox`);
                    const componentItem = checkbox?.closest('.component-item');
                    
                    if (checkbox && !checkbox.checked) {
                        this.autoActivatedComponents.add(componentId);
                        componentItem?.classList.add('auto-selected');
                        this.addAutoBadge(componentItem, componentId);
                    }
                });

                // Предлагаем услуги на основе логики
                this.suggestServicesForPreset(presetId);
            }

            suggestServicesForPreset(presetId) {
                const state = this.stateManager.getState();
                
                // Логика автопредложений услуг
                if (state.projectType === 1.0) {
                    // Новая программа → исследование + методические артефакты
                    this.autoActivateService('research');
                    this.autoActivateService('methodology');
                } else {
                    // Доработка/чужая методика → аудит
                    this.autoActivateService('audit');
                }
                
                // Видеоуроки → подготовка спикера
                const videoCount = parseInt(Utils.safeGetValue('videoLessonCount', 0));
                if (videoCount > 0 || presetId === 'videoLesson') {
                    this.autoActivateService('speakerPrep');
                }
            }

            autoActivateService(serviceId) {
                const checkbox = Utils.safeGetElement(`${serviceId}Checkbox`);
                const serviceItem = checkbox?.closest('.service-item');
                
                if (checkbox && !checkbox.checked) {
                    serviceItem?.classList.add('auto-selected');
                    this.addAutoBadge(serviceItem, serviceId);
                }
            }

            removeAutoSuggestionsForPreset(presetId) {
                const preset = this.presets[presetId];
                if (!preset) return;

                preset.components.forEach(componentId => {
                    if (this.autoActivatedComponents.has(componentId)) {
                        const componentItem = document.querySelector(`[data-component="${componentId}"]`);
                        componentItem?.classList.remove('auto-selected');
                        this.removeAutoBadge(componentItem);
                        this.autoActivatedComponents.delete(componentId);
                    }
                });
            }

            addAutoBadge(item, id) {
                if (!item) return;
                
                const title = item.querySelector('.component-title, .service-title, .assessment-title');
                if (title && !title.querySelector('.auto-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'auto-badge';
                    badge.textContent = 'АВТО';
                    title.appendChild(badge);
                }
            }

            removeAutoBadge(item) {
                if (!item) return;
                
                const badge = item.querySelector('.auto-badge');
                if (badge) {
                    badge.remove();
                }
            }

            updatePresetPrices() {
                const state = this.stateManager.getState();
                const hourlyRate = state.hourlyRate || 220;
                
                Object.keys(this.presets).forEach(presetId => {
                    const preset = this.presets[presetId];
                    const count = parseInt(Utils.safeGetValue(`${presetId}Count`, 0));
                    const duration = parseInt(Utils.safeGetValue(`${presetId}Duration`, preset.defaultDuration));
                    
                    if (count > 0) {
                        const durationFactor = duration / preset.defaultDuration;
                        const basePrice = preset.baseHours * hourlyRate * durationFactor;
                        const volumeDiscount = this.getVolumeDiscount(count);
                        const pricePerUnit = Math.round(basePrice * volumeDiscount);
                        
                        const priceElement = Utils.safeGetElement(`${presetId}Price`);
                        if (priceElement) {
                            priceElement.textContent = `${pricePerUnit.toLocaleString('ru-RU')} ₽/шт`;
                        }
                    }
                });
            }

           updateComponentPrices() {
                const state = this.stateManager.getState();
                const hourlyRate = state.hourlyRate || 220;
                
                Object.keys(this.components).forEach(componentId => {
                    const component = this.components[componentId];
                    const hours = Utils.safeGetValue(`${componentId}HoursInput`, component.defaultHours);
                    const count = parseInt(Utils.safeGetValue(`${componentId}CountInput`, 1));
                    
                    let volumeFactor = 1.0;
                    if (componentId === 'longread') {
                        const pages = Utils.safeGetValue(`${componentId}Pages`, 1);
                        volumeFactor = pages;
                    } else if (componentId === 'quizzes') {
                        const questions = parseInt(Utils.safeGetValue(`${componentId}Questions`, 7));
                        volumeFactor = questions / 7;
                    }
                    
                    const volumeDiscount = this.getVolumeDiscount(count);
                    const adjustedHours = hours * volumeFactor * volumeDiscount;
                    const pricePerUnit = Math.round(adjustedHours * hourlyRate);
                    
                    const hoursElement = Utils.safeGetElement(`${componentId}Hours`);
                    const priceElement = Utils.safeGetElement(`${componentId}Price`);
                    
                    if (hoursElement) {
                        hoursElement.textContent = `${adjustedHours.toFixed(1)}ч/шт`;
                    }
                    if (priceElement) {
                        priceElement.textContent = `${pricePerUnit.toLocaleString('ru-RU')} ₽/шт`;
                    }
                });
            }

            updateAssessmentPrices() {
                const state = this.stateManager.getState();
                const hourlyRate = state.hourlyRate || 220;
                
                Object.keys(this.assessments).forEach(assessmentId => {
                    const assessment = this.assessments[assessmentId];
                    const hours = Utils.safeGetValue(`${assessmentId}HoursInput`, assessment.defaultHours);
                    const count = parseInt(Utils.safeGetValue(`${assessmentId}CountInput`, 1));
                    const volumeDiscount = this.getVolumeDiscount(count);
                    const adjustedHours = hours * volumeDiscount;
                    const pricePerUnit = Math.round(adjustedHours * hourlyRate);
                    
                    const hoursElement = Utils.safeGetElement(`${assessmentId}Hours`);
                    const priceElement = Utils.safeGetElement(`${assessmentId}Price`);
                    
                    if (hoursElement) {
                        hoursElement.textContent = `${adjustedHours.toFixed(1)}ч/шт`;
                    }
                    if (priceElement) {
                        priceElement.textContent = `${pricePerUnit.toLocaleString('ru-RU')} ₽/шт`;
                    }
                });
            }

            updateServicePrices() {
                const state = this.stateManager.getState();
                const hourlyRate = state.hourlyRate || 220;
                
                Object.keys(this.services).forEach(serviceId => {
                    const service = this.services[serviceId];
                    const hours = Utils.safeGetValue(`${serviceId}HoursInput`, service.defaultHours);
                    const price = Math.round(hours * hourlyRate);
                    
                    const hoursElement = Utils.safeGetElement(`${serviceId}Hours`);
                    const priceElement = Utils.safeGetElement(`${serviceId}Price`);
                    
                    if (hoursElement) {
                        hoursElement.textContent = `${hours}ч`;
                    }
                    if (priceElement) {
                        priceElement.textContent = `${price.toLocaleString('ru-RU')} ₽`;
                    }
                });
            }

            getVolumeDiscount(quantity) {
                const state = this.stateManager.getState();
                if (!state.enableVolumeDiscounts) return 1.0;
                
                if (quantity <= 5) return 1.0;
                if (quantity <= 15) return 0.9;
                if (quantity <= 30) return 0.8;
                return 0.7;
            }

               // Кастомные услуги
            addCustomService() {
                const nameInput = Utils.safeGetElement('customServiceName');
                const descInput = Utils.safeGetElement('customServiceDescription');
                const hoursInput = Utils.safeGetElement('customServiceHours');
                const countInput = Utils.safeGetElement('customServiceCount');
                const priceInput = Utils.safeGetElement('customServicePrice');
                
                if (!nameInput?.value.trim()) {
                    Utils.showToast('Введите название услуги', 'error');
                    nameInput?.focus();
                    return;
                }
                
                const customService = {
                    id: `custom_${++this.customServiceCounter}`,
                    name: nameInput.value.trim(),
                    description: descInput?.value.trim() || '',
                    hours: parseFloat(hoursInput?.value) || 1,
                    count: parseInt(countInput?.value) || 1,
                    pricePerUnit: parseFloat(priceInput?.value) || 220
                };
                
                this.customServices.push(customService);
                this.renderCustomServices();
                this.clearCustomServiceForm();
                calculator.calculate();
                
                Utils.showToast('Кастомная услуга добавлена');
            }

            removeCustomService(id) {
                this.customServices = this.customServices.filter(service => service.id !== id);
                this.renderCustomServices();
                calculator.calculate();
                Utils.showToast('Услуга удалена');
            }

            renderCustomServices() {
                const container = Utils.safeGetElement('customServicesList');
                if (!container) return;
                
                container.innerHTML = this.customServices.map(service => {
                    const totalCost = service.pricePerUnit * service.count;
                    
                    return `
                        <div class="custom-service-item">
                            <div class="custom-service-header">
                                <div class="custom-service-title">⚙️ ${service.name}</div>
                                <div class="custom-service-price">${totalCost.toLocaleString('ru-RU')} ₽</div>
                            </div>
                            <div class="custom-service-description">
                                ${service.description || 'Кастомная услуга'}
                            </div>
                            <div class="custom-service-meta">
                                <span>${service.hours}ч × ${service.count}шт = ${service.pricePerUnit.toLocaleString('ru-RU')} ₽/шт</span>
                                <button class="custom-service-remove" onclick="componentsManager.removeCustomService('${service.id}')">
                                    Удалить
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            clearCustomServiceForm() {
                const inputs = ['customServiceName', 'customServiceDescription'];
                inputs.forEach(inputId => {
                    const input = Utils.safeGetElement(inputId);
                    if (input) input.value = '';
                });
                
                // Сброс числовых значений к дефолтным
                const hoursInput = Utils.safeGetElement('customServiceHours');
                const countInput = Utils.safeGetElement('customServiceCount');
                const priceInput = Utils.safeGetElement('customServicePrice');
                
                if (hoursInput) hoursInput.value = '1';
                if (countInput) countInput.value = '1';
                if (priceInput) priceInput.value = '220';
            }

            // Получение данных для расчета
            getCalculationData() {
                const data = {
                    presets: {},
                    components: {},
                    assessments: {},
                    services: {},
                    customServices: this.customServices,
                    revisions: parseInt(Utils.safeGetValue('clientType', 20))
                };

                // Собираем данные пресетов
                Object.keys(this.presets).forEach(presetId => {
                    const count = parseInt(Utils.safeGetValue(`${presetId}Count`, 0));
                    if (count > 0) {
                        data.presets[presetId] = {
                            count,
                            duration: parseInt(Utils.safeGetValue(`${presetId}Duration`, this.presets[presetId].defaultDuration)),
                            baseHours: this.presets[presetId].baseHours
                        };
                    }
                });

                // Собираем данные компонентов
                Object.keys(this.components).forEach(componentId => {
                    const checkbox = Utils.safeGetElement(`${componentId}Checkbox`);
                    if (checkbox?.checked) {
                        const hours = Utils.safeGetValue(`${componentId}HoursInput`, this.components[componentId].defaultHours);
                        const count = parseInt(Utils.safeGetValue(`${componentId}CountInput`, 1));
                        
                        let volumeFactor = 1.0;
                        if (componentId === 'longread') {
                            volumeFactor = Utils.safeGetValue(`${componentId}Pages`, 1);
                        } else if (componentId === 'quizzes') {
                            volumeFactor = parseInt(Utils.safeGetValue(`${componentId}Questions`, 7)) / 7;
                        }
                        
                        data.components[componentId] = {
                            hours,
                            count,
                            volumeFactor,
                            name: this.components[componentId].name
                        };
                    }
                });

                // Собираем данные проверок знаний
                Object.keys(this.assessments).forEach(assessmentId => {
                    const checkbox = Utils.safeGetElement(`${assessmentId}Checkbox`);
                    if (checkbox?.checked) {
                        data.assessments[assessmentId] = {
                            hours: Utils.safeGetValue(`${assessmentId}HoursInput`, this.assessments[assessmentId].defaultHours),
                            count: parseInt(Utils.safeGetValue(`${assessmentId}CountInput`, 1)),
                            name: this.assessments[assessmentId].name
                        };
                    }
                });

                // Собираем данные услуг
                Object.keys(this.services).forEach(serviceId => {
                    const checkbox = Utils.safeGetElement(`${serviceId}Checkbox`);
                    if (checkbox?.checked || document.querySelector(`[data-service="${serviceId}"]`)?.classList.contains('auto-selected')) {
                        data.services[serviceId] = {
                            hours: Utils.safeGetValue(`${serviceId}HoursInput`, this.services[serviceId].defaultHours),
                            name: this.services[serviceId].name,
                            isAuto: document.querySelector(`[data-service="${serviceId}"]`)?.classList.contains('auto-selected')
                        };
                    }
                });

                return data;
            }

            // Обновление всех цен
            updateAllPrices() {
                this.updatePresetPrices();
                this.updateComponentPrices();
                this.updateAssessmentPrices();
                this.updateServicePrices();
            }
        }

        // ===========================================
        // УЛУЧШЕННЫЙ КАЛЬКУЛЯТОР
        // ===========================================

        class Calculator {
            constructor(stateManager) {
                this.stateManager = stateManager;
            }

            calculate() {
                const state = this.stateManager.getState();
                const data = componentsManager.getCalculationData();
                
                try {
                    let totalContentCost = 0;
                    let totalContentHours = 0;
                    let totalServiceCost = 0;
                    let totalServiceHours = 0;
                    
                    const breakdown = {
                        presets: [],
                        components: [],
                        assessments: [],
                        services: [],
                        customServices: []
                    };

                    const complexityMultiplier = this.calculateComplexityMultiplier(state);
                    const hourlyRate = state.hourlyRate;

                    // Расчет пресетов
                    Object.keys(data.presets).forEach(presetId => {
                        const preset = data.presets[presetId];
                        const durationFactor = preset.duration / componentsManager.presets[presetId].defaultDuration;
                        const volumeDiscount = componentsManager.getVolumeDiscount(preset.count);
                        
                        const baseHours = preset.baseHours * durationFactor;
                        const adjustedHours = baseHours * complexityMultiplier * volumeDiscount;
                        const cost = adjustedHours * preset.count * hourlyRate;
                        
                        totalContentCost += cost;
                        totalContentHours += adjustedHours * preset.count;
                        
                        breakdown.presets.push({
                            name: componentsManager.presets[presetId].name,
                            count: preset.count,
                            hours: adjustedHours,
                            cost
                        });
                    });

                    // Расчет компонентов
                    Object.keys(data.components).forEach(componentId => {
                        const component = data.components[componentId];
                        const volumeDiscount = componentsManager.getVolumeDiscount(component.count);
                        
                        const adjustedHours = component.hours * component.volumeFactor * complexityMultiplier * volumeDiscount;
                        const cost = adjustedHours * component.count * hourlyRate;
                        
                        totalContentCost += cost;
                        totalContentHours += adjustedHours * component.count;
                        
                        breakdown.components.push({
                            name: component.name,
                            count: component.count,
                            hours: adjustedHours,
                            cost
                        });
                    });

                    // Расчет проверок знаний
                    Object.keys(data.assessments).forEach(assessmentId => {
                        const assessment = data.assessments[assessmentId];
                        const volumeDiscount = componentsManager.getVolumeDiscount(assessment.count);
                        
                        const adjustedHours = assessment.hours * complexityMultiplier * volumeDiscount;
                        const cost = adjustedHours * assessment.count * hourlyRate;
                        
                        totalContentCost += cost;
                        totalContentHours += adjustedHours * assessment.count;
                        
                        breakdown.assessments.push({
                            name: assessment.name,
                            count: assessment.count,
                            hours: adjustedHours,
                            cost
                        });
                    });

                    // Расчет услуг (без коэффициента сложности)
                    Object.keys(data.services).forEach(serviceId => {
                        const service = data.services[serviceId];
                        const cost = service.hours * hourlyRate;
                        
                        totalServiceCost += cost;
                        totalServiceHours += service.hours;
                        
                        breakdown.services.push({
                            name: service.name,
                            hours: service.hours,
                            cost,
                            isAuto: service.isAuto
                        });
                    });

                    // Расчет кастомных услуг
                    data.customServices.forEach(service => {
                        const cost = service.pricePerUnit * service.count;
                        
                        totalServiceCost += cost;
                        totalServiceHours += service.hours * service.count;
                        
                        breakdown.customServices.push({
                            name: service.name,
                            count: service.count,
                            hours: service.hours,
                            cost
                        });
                    });

                    // Применяем правки к контенту
                    const revisionFactor = data.revisions / 100;
                    const contentWithRevisions = totalContentCost * (1 + revisionFactor);
                    const revisionCost = totalContentCost * revisionFactor;

                    // Итоговые расчеты
                    const subtotal = contentWithRevisions + totalServiceCost;
                    const discountAmount = subtotal * (state.discountRate / 100);
                    const afterDiscount = subtotal + discountAmount;
                    const taxAmount = afterDiscount * (state.taxRate / 100);
                    const totalCost = state.showTaxSeparately ? afterDiscount + taxAmount : afterDiscount;
                    const totalHours = totalContentHours + totalServiceHours;

                    // Обновляем состояние
                    this.stateManager.update({
                        totalCost,
                        totalHours,
                        breakdown: {
                            ...breakdown,
                            subtotal,
                            discountAmount,
                            afterDiscount,
                            taxAmount,
                            complexityMultiplier,
                            revisionCost,
                            contentCost: totalContentCost,
                            serviceCost: totalServiceCost
                        }
                    });

                } catch (error) {
                    console.error('Calculation error:', error);
                    Utils.showToast('Ошибка при расчете', 'error');
                }
            }

            calculateComplexityMultiplier(state) {
                if (state.mode === 'express') {
                    return parseFloat(state.projectComplexity);
                }

                // Детальный расчет с весами
                const weights = {
                    domain: 0.6,
                    project: 0.8,
                    urgency: 0.5
                };

                const totalWeight = Object.values(weights).reduce((sum, weight) => sum + weight, 0);
                const normalizedWeights = {};
                Object.keys(weights).forEach(key => {
                    normalizedWeights[key] = weights[key] / totalWeight;
                });

                const weightedSum = 1.0 + 
                    (state.domainKnowledge - 1) * normalizedWeights.domain +
                    (state.projectType - 1) * normalizedWeights.project +
                    (state.urgency - 1) * normalizedWeights.urgency;

                let result = weightedSum * state.methodistRole;

                // Ограничения для разных методов
                if (state.pricingMethod === 'fixed') {
                    result = Math.min(result, 1.5);
                } else {
                    if (result > 3.0) {
                        result = 3.0 + (result - 3.0) * 0.3;
                    }
                    result = Math.min(result, 4.0);
                }

                return result;
            }
        }

        // ===========================================
        // ОБНОВЛЕННЫЙ UI MANAGER
        // ===========================================

        // Обновляем класс UIManager для работы с новыми компонентами
        UIManager.prototype.updateProjectComposition = function(state) {
            const compositionEl = Utils.safeGetElement('projectComposition');
            if (!compositionEl || !state.breakdown) return;

            let html = '';
            const breakdown = state.breakdown;

            if (breakdown.presets.length > 0) {
                html += '<div class="mb-2"><strong>Пресеты:</strong></div>';
                breakdown.presets.forEach(item => {
                    html += `<div class="text-sm text-gray-600">• ${item.name} (${item.count} шт.)</div>`;
                });
            }

            if (breakdown.components.length > 0) {
                html += '<div class="mb-2 mt-3"><strong>Дополнительные компоненты:</strong></div>';
                breakdown.components.forEach(item => {
                    html += `<div class="text-sm text-gray-600">• ${item.name} (${item.count} шт.)</div>`;
                });
            }

            if (breakdown.assessments.length > 0) {
                html += '<div class="mb-2 mt-3"><strong>Проверки знаний:</strong></div>';
                breakdown.assessments.forEach(item => {
                    html += `<div class="text-sm text-gray-600">• ${item.name} (${item.count} шт.)</div>`;
                });
            }

            if (breakdown.services.length > 0) {
                html += '<div class="mb-2 mt-3"><strong>Дополнительные услуги:</strong></div>';
                breakdown.services.forEach(item => {
                    const autoLabel = item.isAuto ? ' <span class="auto-badge" style="font-size: 0.6rem;">АВТО</span>' : '';
                    html += `<div class="text-sm text-gray-600">• ${item.name}${autoLabel}</div>`;
                });
            }

            if (breakdown.customServices.length > 0) {
                html += '<div class="mb-2 mt-3"><strong>Кастомные услуги:</strong></div>';
                breakdown.customServices.forEach(item => {
                    html += `<div class="text-sm text-gray-600">• ${item.name} (${item.count} шт.)</div>`;
                });
            }

            if (html === '') {
                html = '<div class="text-gray-500 text-sm" style="font-style: italic;">Выберите компоненты для расчета</div>';
            }

            compositionEl.innerHTML = html;
        };

        // Переопределяем метод обновления breakdown
        UIManager.prototype.updateBreakdown = function(state) {
            const breakdownEl = Utils.safeGetElement('breakdown');
            if (!breakdownEl || !state.breakdown) return;

            const breakdown = state.breakdown;
            let html = '<div class="space-y-2 text-sm">';

            // Показываем секции, если есть элементы
            if (breakdown.presets.length > 0) {
                html += '<div class="font-semibold text-blue-600 mb-2">Пресеты:</div>';
                breakdown.presets.forEach(item => {
                    html += `<div class="flex justify-between">
                        <span>${item.name} (${item.count} шт.)</span>
                        <span class="font-semibold">${Utils.formatCurrency(item.cost)}</span>
                    </div>`;
                });
                html += '<div class="mb-3"></div>';
            }

            if (breakdown.components.length > 0) {
                html += '<div class="font-semibold text-blue-600 mb-2">Компоненты:</div>';
                breakdown.components.forEach(item => {
                    html += `<div class="flex justify-between">
                        <span>${item.name} (${item.count} шт.)</span>
                        <span class="font-semibold">${Utils.formatCurrency(item.cost)}</span>
                    </div>`;
                });
                html += '<div class="mb-3"></div>';
            }

            if (breakdown.assessments.length > 0) {
                html += '<div class="font-semibold text-blue-600 mb-2">Проверки знаний:</div>';
                breakdown.assessments.forEach(item => {
                    html += `<div class="flex justify-between">
                        <span>${item.name} (${item.count} шт.)</span>
                        <span class="font-semibold">${Utils.formatCurrency(item.cost)}</span>
                    </div>`;
                });
                html += '<div class="mb-3"></div>';
            }

            if (breakdown.services.length > 0) {
                html += '<div class="font-semibold text-blue-600 mb-2">Услуги:</div>';
                breakdown.services.forEach(item => {
                    const autoLabel = item.isAuto ? ' <span class="auto-badge" style="font-size: 0.6rem;">АВТО</span>' : '';
                    html += `<div class="flex justify-between">
                        <span>${item.name}${autoLabel}</span>
                        <span class="font-semibold">${Utils.formatCurrency(item.cost)}</span>
                    </div>`;
                });
                html += '<div class="mb-3"></div>';
            }

            if (breakdown.customServices.length > 0) {
                html += '<div class="font-semibold text-blue-600 mb-2">Кастомные услуги:</div>';
                breakdown.customServices.forEach(item => {
                    html += `<div class="flex justify-between">
                        <span>${item.name} (${item.count} шт.)</span>
                        <span class="font-semibold">${Utils.formatCurrency(item.cost)}</span>
                    </div>`;
                });
                html += '<div class="mb-3"></div>';
            }

            // Правки
            if (breakdown.revisionCost > 0) {
                html += `<div class="flex justify-between text-orange-600">
                    <span>Правки:</span>
                    <span class="font-semibold">+${Utils.formatCurrency(breakdown.revisionCost)}</span>
                </div>`;
            }

            // Коэффициент сложности
            if (breakdown.complexityMultiplier !== 1.0) {
                html += `<div class="flex justify-between text-blue-600">
                    <span>Коэффициент сложности:</span>
                    <span class="font-semibold">×${breakdown.complexityMultiplier.toFixed(2)}</span>
                </div>`;
            }

            // Скидка/наценка
            if (breakdown.discountAmount !== 0) {
                const sign = breakdown.discountAmount > 0 ? '+' : '';
                const label = breakdown.discountAmount > 0 ? 'Наценка:' : 'Скидка:';
                html += `<div class="flex justify-between ${breakdown.discountAmount > 0 ? 'text-red-600' : 'text-green-600'}">
                    <span>${label}</span>
                    <span class="font-semibold">${sign}${Utils.formatCurrency(Math.abs(breakdown.discountAmount))}</span>
                </div>`;
            }

            // Налог
            if (state.showTaxSeparately && breakdown.taxAmount > 0) {
                html += `<div class="flex justify-between text-gray-600">
                    <span>Налог (${state.taxRate}%):</span>
                    <span class="font-semibold">+${Utils.formatCurrency(breakdown.taxAmount)}</span>
                </div>`;
            }

            // Итого
            html += `<div class="flex justify-between border-t pt-2 font-bold text-lg">
                <span>Итого:</span>
                <span class="text-blue-600">${Utils.formatCurrency(state.totalCost)}</span>
            </div>`;

            html += '</div>';
            
            breakdownEl.innerHTML = html;
        };

        // Переопределяем метод обновления состояния
        UIManager.prototype.setupStateSubscription = function() {
            this.stateManager.subscribe((state, changedFields) => {
                if (changedFields.includes('mode')) {
                    this.updateModeInterface();
                }

                if (changedFields.includes('totalCost') || changedFields.includes('totalHours')) {
                    this.updateResults(state);
                    this.updateProjectComposition(state);
                }

                if (changedFields.includes('discountRate')) {
                    this.updateDiscountDisplay(state.discountRate);
                }

                if (changedFields.includes('taxRate')) {
                    this.updateTaxDisplay(state.taxRate);
                }

                if (changedFields.includes('hourlyRate')) {
                    componentsManager.updateAllPrices();
                }
            });
        };
          
    </script>

</body>
</html>
